<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>KK网盘 · 申请推广</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI', Roboto, sans-serif;background:#f6f7fb;min-height:100vh;color:#333}
        .header{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;background:#fff;border-bottom:1px solid #f0f2f5;position:sticky;top:0;z-index:10}
        .back{width:40px;height:40px;border-radius:50%;background:#eef2ff;color:#667eea;display:flex;align-items:center;justify-content:center;text-decoration:none}
        .title{font-weight:700}
        .container{max-width:640px;margin:12px auto;padding:0 12px}
        .card{background:#fff;border:1px solid #eef2f7;border-radius:12px;box-shadow:0 8px 20px rgba(0,0,0,.06);padding:14px}
        .form-group{margin-bottom:12px}
        .label{display:block;margin-bottom:6px;font-weight:600;color:#374151}
        .input,.textarea,select{width:100%;padding:12px;border:1px solid #e5e7eb;border-radius:10px}
        .textarea{min-height:100px;resize:vertical}
        .btn{width:100%;padding:12px;border:none;border-radius:10px;background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;font-weight:700}
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="keyword-sync-manager.js"></script>
    <script>
    (function(){
        let supabaseClient=null;
        const SUPABASE_URL='https://ybrveusbwjusnrzgfnok.supabase.co';
        const SUPABASE_ANON='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlicnZldXNid2p1c25yemdmbm9rIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY0ODU1NjIsImV4cCI6MjA3MjA2MTU2Mn0.JKPSUli-q9wRuDagE6kwltLk9XgfygE8yznm-Ca82Qk';
        document.addEventListener('DOMContentLoaded',()=>{ try{ if(window.supabase){ supabaseClient=window.supabase.createClient(SUPABASE_URL,SUPABASE_ANON); } }catch(_){ } });
        function ensureUser(){ try{ const u=localStorage.getItem('currentUser'); if(!u) localStorage.setItem('currentUser', JSON.stringify({id:'555',username:'555'})); }catch(_){ localStorage.setItem('currentUser', JSON.stringify({id:'555',username:'555'})); } }
        function showToast(msg){ alert(msg); }
        let bindImgData = '';
        window.chooseBindImg = function(){ try{ document.getElementById('bindImg').click(); }catch(_){ } }
        window.onBindImgChange = function(e){ try{ const f=e.target.files&&e.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{ bindImgData = r.result||''; const p=document.getElementById('bindImgPreview'); if(p){ p.textContent = '已选择图片'; } }; r.readAsDataURL(f); }catch(_){ bindImgData=''; } }
        window.submitKD = async function(){
            const quarkUid=(document.getElementById('quarkUid')?.value||'').trim();
            const quarkPhone=(document.getElementById('quarkPhone')?.value||'').trim();
            const realName=(document.getElementById('realName')?.value||'').trim();
            const chan=(document.getElementById('chan')?.value||'').trim();
            if(!quarkUid){ showToast('请填写夸克uid'); return; }
            if(!quarkPhone){ showToast('请填写夸克手机号'); return; }
            if(!realName){ showToast('请填写姓名'); return; }
            if(!chan){ showToast('请选择推广渠道'); return; }
            if(!bindImgData){ showToast('请上传绑定5008成功截图'); return; }
            ensureUser();
            const u=JSON.parse(localStorage.getItem('currentUser')||'{"id":"555","username":"555"}');
            const id='KD'+Date.now().toString().slice(-10);
            const data={ id, userId:u.id, username:u.username, channel:chan, category:'网盘', status:'pending', task_type:'KK网盘任务', submitTime:new Date().toISOString(), created_at:new Date().toISOString(), quark_uid:quarkUid, quark_phone:quarkPhone, real_name:realName, bind_screenshot: bindImgData };
            try{
                if(window.KeywordSyncManager){
                    const result = await window.KeywordSyncManager.saveKeywordApplication(data);
                    if(result.databaseSaved) showToast('申请提交成功'); else showToast('已保存到本地');
                }else{
                    // 直写数据库（可选）
                    if(supabaseClient){
                        const row={ id:data.id, user_id:data.userId, username:data.username, keywords:'', experience:'unknown', promotion_channel:data.channel, task_type:data.task_type, status:data.status, created_at:data.created_at, updated_at:data.created_at };
                        try{ await supabaseClient.from('keyword_applications').insert([row]); }catch(_){ }
                    }
                    const key='keywords_'+u.id; const list=JSON.parse(localStorage.getItem(key)||'[]'); list.unshift(data); localStorage.setItem(key, JSON.stringify(list));
                    const gk='promotionApplications'; const gl=JSON.parse(localStorage.getItem(gk)||'[]'); gl.unshift(data); localStorage.setItem(gk, JSON.stringify(gl));
                    showToast('申请已保存');
                }
                setTimeout(()=>{ window.location.href='my-keywords.html?task=kkdisk'; }, 600);
            }catch(e){ console.error(e); showToast('提交失败，请重试'); }
        }
    })();
    </script>
</head>
<body>
    <div class="header">
        <a href="quark-cloud-drive-task.html" class="back">←</a>
        <div class="title">KK网盘 · 申请推广</div>
        <div style="width:40px"></div>
    </div>
    <div class="container">
        <div class="card" style="margin-bottom:12px">
            <div style="font-weight:700;margin-bottom:8px;">一、申请推广权限流程：</div>
            <div style="line-height:1.6;color:#374151;">
                第一步：点下方链接用夸克打开，绑定服务商（标识必须为: <b>5008</b>），非常重要，绑定成功才能归因数据！<br>
                <span style="color:#ef4444">(绑定后不可解绑，解绑无法出数据，同时该UID无法再次绑定。)</span>
            </div>
            <div style="margin-top:10px;">
                <a href="https://b.quark.cn/apps/c3qMkYerj/routes/La5RJ3wvf?uc_param_str=dsdnfrpfbivesscpgimibtbmnijblauputogpintnwktprchmt&uc_biz_str=S%3Acustom%7CC%3Atitlebar_hover_2" target="_blank" style="display:inline-block;padding:10px 12px;border:1px solid #d1d5db;border-radius:10px;background:#f8fafc;text-decoration:none;color:#2563eb;">打开夸克进行绑定（服务商标识：5008）</a>
            </div>
        </div>
        <div class="card">
            <div class="form-group">
                <label class="label">夸克uid <span style="color:#ef4444">*</span></label>
                <input id="quarkUid" class="input" placeholder="请输入夸克uid">
                <div class="muted" style="margin-top:6px;color:#6b7280;">填写夸克uid。</div>
            </div>
            <div class="form-group">
                <label class="label">夸克手机号 <span style="color:#ef4444">*</span></label>
                <input id="quarkPhone" class="input" placeholder="请输入夸克手机号">
                <div class="muted" style="margin-top:6px;color:#6b7280;">填写夸克手机号。</div>
            </div>
            <div class="form-group">
                <label class="label">姓名 <span style="color:#ef4444">*</span></label>
                <input id="realName" class="input" placeholder="请输入姓名">
                <div class="muted" style="margin-top:6px;color:#6b7280;">填写姓名。</div>
            </div>
            <div class="form-group">
                <label class="label">推广渠道 <span style="color:#ef4444">*</span></label>
                <select id="chan" class="input">
                    <option value="">请选择</option>
                    <option value="抖音平台">抖音平台</option>
                    <option value="微信朋友圈">微信朋友圈</option>
                    <option value="快手平台">快手平台</option>
                    <option value="QQ群/空间">QQ群/空间</option>
                </select>
            </div>
            <div class="form-group">
                <label class="label">绑定5008成功截图 <span style="color:#ef4444">*</span></label>
                <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
                    <input id="bindImg" type="file" accept="image/*" style="display:none" onchange="onBindImgChange(event)">
                    <button class="btn" style="width:auto" onclick="chooseBindImg()" type="button">上传图片</button>
                    <span id="bindImgPreview" style="color:#6b7280;">未选择图片</span>
                </div>
            </div>
            <button class="btn" onclick="submitKD()">提交申请</button>
        </div>
    </div>
</body>
</html>

