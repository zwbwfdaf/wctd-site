<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#4f46e5">
    <title>Áî≥ËØ∑ÊèêÁé∞</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="mobile-optimizations.css">
    <link rel="stylesheet" href="theme.css">
    <link rel="manifest" href="mobile-manifest.json">
    <link rel="preconnect" href="https://ybrveusbwjusnrzgfnok.supabase.co">
    <link rel="dns-prefetch" href="https://ybrveusbwjusnrzgfnok.supabase.co">
    <style>
        body {
            background-color: #f5f7fa;
            font-family: 'PingFang SC', 'Helvetica Neue', Arial, sans-serif;
        }
        
        .top-bar {
            background: linear-gradient(135deg, #4f46e5 0%, #6366f1 100%);
            padding-top: env(safe-area-inset-top);
            padding-bottom: 12px;
        }
        
        .nav-button {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            cursor: pointer;
        }
        
        .form-section {
            background: white;
            border-radius: 16px;
            margin: 16px;
            padding: 16px;
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        
        .form-input {
            background-color: #f8fafc;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            padding: 12px 16px;
            width: 100%;
            font-size: 16px;
            outline: none;
        }
        
        .form-input:focus {
            border-color: #6366f1;
            box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2);
        }
        
        .submit-btn {
            background: linear-gradient(135deg, #4f46e5 0%, #6366f1 100%);
            color: white;
            border: none;
            width: 100%;
            padding: 14px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            margin-top: 20px;
        }
        
        .submit-btn:disabled,
        .submit-btn[data-disabled="true"] {
            background: #9ca3af !important;
            opacity: 0.7;
            cursor: not-allowed;
        }
        
        .info-list {
            padding: 0;
            list-style: none;
        }
        
        .info-list li {
            position: relative;
            padding-left: 20px;
            margin-bottom: 12px;
            color: #64748b;
            font-size: 14px;
            line-height: 1.6;
        }
        
        .info-list li:before {
            content: "‚Ä¢";
            position: absolute;
            left: 0;
            color: #94a3b8;
        }
        
        .withdraw-info {
            font-size: 14px;
            color: #64748b;
            padding: 12px 0;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .payment-method li::before {
            content: "‚Ä¢";
            color: #3b5de7;
            font-weight: bold;
            margin-right: 0.5rem;
        }
        
        .qr-upload {
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: border-color 0.2s;
        }
        
        .qr-upload:hover {
            border-color: #3b5de7;
        }
        
        .qr-upload.dragover {
            border-color: #3b5de7;
            background-color: rgba(59, 93, 231, 0.05);
        }
        
        .qr-preview {
            max-width: 200px;
            max-height: 200px;
            margin: 1rem auto;
            border-radius: 8px;
        }
        
        /* ÊèêÁé∞ÊñπÂºèÈÄâÊã©Ê†∑Âºè */
        .payment-option {
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .payment-option.active {
            border-color: #3b5de7;
            background-color: #eff6ff;
            color: #1d4ed8;
        }
        
        .payment-option:not(.active):hover {
            border-color: #94a3b8;
            background-color: #f8fafc;
        }
        
        .hidden {
            display: none !important;
        }
        
        /* ÊèêÁé∞Áä∂ÊÄÅ‰ø°ÊÅØ */
        .status-message {
            margin-top: 12px;
            padding: 10px 12px;
            border-radius: 10px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .status-pending {
            background: #eef2ff;
            color: #3730a3;
            border: 1px solid #c7d2fe;
        }
        .status-processing {
            background: #eff6ff;
            color: #1d4ed8;
            border: 1px solid #bfdbfe;
        }
        .status-success {
            background: #ecfdf5;
            color: #065f46;
            border: 1px solid #a7f3d0;
        }
        .status-failed {
            background: #fef2f2;
            color: #991b1b;
            border: 1px solid #fecaca;
        }
        
        /* üéâ ÊàêÂäüÊïàÊûúÊ†∑Âºè */
        .success-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            animation: fadeIn 0.3s ease-in;
        }
        
        .success-modal {
            background: white;
            border-radius: 16px;
            padding: 32px 24px;
            text-align: center;
            max-width: 320px;
            width: 90%;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            animation: scaleIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        
        .success-icon {
            width: 80px;
            height: 80px;
            margin: 0 auto 20px;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: bounceIn 0.6s ease-out 0.2s both;
        }
        
        .success-icon i {
            font-size: 36px;
            color: white;
        }
        
        .success-title {
            font-size: 20px;
            font-weight: 600;
            color: #111827;
            margin-bottom: 12px;
        }
        
        .success-message {
            font-size: 14px;
            color: #6b7280;
            margin-bottom: 24px;
            line-height: 1.5;
        }
        
        .success-button {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            padding: 12px 32px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .success-button:hover {
            transform: translateY(-1px);
        }
        
        .success-badge {
            display: inline-flex;
            align-items: center;
            background: #dcfce7;
            color: #16a34a;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            margin-left: 8px;
            animation: slideInRight 0.5s ease-out;
        }
        
        .success-badge i {
            margin-right: 4px;
            font-size: 10px;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes scaleIn {
            from { 
                opacity: 0;
                transform: scale(0.8);
            }
            to { 
                opacity: 1;
                transform: scale(1);
            }
        }
        
        @keyframes bounceIn {
            0% {
                opacity: 0;
                transform: scale(0.3);
            }
            50% {
                opacity: 1;
                transform: scale(1.1);
            }
            100% {
                opacity: 1;
                transform: scale(1);
            }
        }
        
        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        /* ÂæÆ‰ø°Êî∂Ê¨æÁ†Å‰∏ä‰º†ËøõÂ∫¶‰∏éÁä∂ÊÄÅ */
        .upload-status {
            margin-top: 10px;
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 10px;
            padding: 10px 12px;
        }
        .upload-status .progress {
            width: 100%;
            background: #eef2ff;
            border-radius: 8px;
            overflow: hidden;
            height: 10px;
        }
        .upload-status .progress-bar {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, #60a5fa, #3b82f6);
            transition: width 0.2s ease;
        }
        .upload-status .progress-text {
            margin-top: 8px;
            font-size: 12px;
            color: #374151;
        }

        /* üì± ÊâãÊú∫Á´Ø‰∏ìÁî®ToastÊ†∑Âºè - Áõ¥Êé•Â∫ïÈÉ®ÊòæÁ§∫ */
        .toast-container {
            position: fixed;
            bottom: 120px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 350px;
            z-index: 99999;
        }

        .toast-message {
            padding: 16px 20px;
            border-radius: 12px;
            color: white;
            font-weight: 500;
            font-size: 16px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.4);
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.3s ease;
            display: none;
            width: 100%;
            text-align: center;
            margin: 0;
            min-width: auto;
        }

        .toast-message.show {
            display: block;
            opacity: 1;
            transform: translateY(0);
        }
    </style>
    <style>
    /* Âº∫Âà∂ÈöêËóèÊµèËßàÂô®ËÆæÂ§áÊ®°ÂºèÁöÑËß¶Êë∏ÁÇπÂè†Âä†ÔºàÈÅøÂÖçËØØËÆ§‰∏∫Âú®ËΩ¨ÂúàÔºâ */
    body .devtools-touch, body .devtools-touch-point, body ._devtools-touch-point_ {
        display: none !important;
        opacity: 0 !important;
    }
/* Ê∞∏‰πÖÂÖ≥Èó≠È°µÈù¢ÂÜÖÂä†ËΩΩÈÅÆÁΩ©ÁöÑÂèØËßÅÊÄß‰∏éÁÇπÂáªÊã¶Êà™ */
#loadingIndicator{ display:none !important; pointer-events:none !important; background:transparent !important; }
    </style>
</head>
<body class="page-transition">
    <!-- ToastÊ∂àÊÅØÊèêÁ§∫ÂÆπÂô® -->
    <div class="toast-container">
        <div class="toast-message" id="toastMessage"></div>
    </div>

    <!-- Âä†ËΩΩÊåáÁ§∫Âô® -->
    <div class="loading-container" id="loadingIndicator" style="display: none;">
        <!-- ÂΩªÂ∫ïÁßªÈô§ËßÜËßâ‰∏äÁöÑËΩ¨ÂúàÔºå‰øùÁïôÂÆπÂô®Áî®‰∫éÁÇπÂáªÂ±èËîΩ -->
        <div style="display:none"></div>
    </div>

    <!-- È°∂ÈÉ®Áä∂ÊÄÅÊ†è -->
    <div class="top-bar text-white p-4">
        <div class="flex items-center justify-between">
            <div class="flex items-center">
                <button onclick="history.back()" class="nav-button mr-3">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <div class="flex items-center">
                    <span class="text-lg font-medium">Áî≥ËØ∑ÊèêÁé∞</span>
                </div>
            </div>
            <button class="nav-button">
                <i class="fas fa-ellipsis-h"></i>
            </button>
        </div>
    </div>
    
    <!-- ‰∏ª‰ΩìÂÜÖÂÆπ -->
    <div class="mt-4">
        <!-- ÊèêÁé∞ÊñπÂºèÈÄâÊã© -->
        <div class="form-section">
            <h3 class="text-gray-800 font-medium mb-4">ÊèêÁé∞ÊñπÂºè</h3>
            <div class="flex space-x-3 mb-4">
                <button id="alipay-option" class="payment-option active flex-1 py-3 px-4 rounded-lg border-2 border-blue-500 bg-blue-50 text-blue-700 font-medium">
                    <i class="fab fa-alipay mr-2"></i>ÊîØ‰ªòÂÆù
                </button>
                <button id="wechat-option" class="payment-option flex-1 py-3 px-4 rounded-lg border-2 border-gray-200 bg-white text-gray-600 font-medium">
                    <i class="fab fa-weixin mr-2"></i>ÂæÆ‰ø°
                </button>
            </div>
        </div>

        <!-- ÊîØ‰ªòÂÆùÊèêÁé∞‰ø°ÊÅØ -->
        <div id="alipay-section" class="form-section">
            <div class="section-header">
                <span class="text-gray-800 font-medium flex items-center">
                    ÊîØ‰ªòÂÆùÊèêÁé∞‰ø°ÊÅØ
                    <span id="alipay-status-badge" class="ml-2 px-2 py-1 text-xs rounded-full bg-red-100 text-red-600">
                        ‚ùå Êú™ËÆæÁΩÆ
                    </span>
                </span>
                <a href="#" id="change-alipay-btn" class="text-blue-500 text-sm flex items-center">
                    ‰øÆÊîπ <i class="fas fa-chevron-right ml-1 text-xs"></i>
                </a>
            </div>
            
            <div class="flex justify-between items-center">
                <div>
                    <p class="text-sm text-gray-500">ÊîØ‰ªòÂÆùË¥¶Âè∑</p>
                    <p id="alipay-account" class="text-base text-gray-800 font-medium mt-1">ËØ∑ÂÖàËÆæÁΩÆ</p>
                </div>
                <div>
                    <p class="text-sm text-gray-500">ÁúüÂÆûÂßìÂêç</p>
                    <p id="user-real-name" class="text-base text-gray-800 font-medium mt-1">ËØ∑ÂÖàËÆæÁΩÆ</p>
                </div>
            </div>
            
            <!-- ËÆæÁΩÆÊèêÁ§∫ -->
            <div id="alipay-setup-hint" class="mt-3 p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
                <div class="flex items-center">
                    <i class="fas fa-exclamation-triangle text-yellow-500 mr-2"></i>
                    <span class="text-sm text-yellow-700">
                        ËØ∑ÂÖàÁÇπÂáª"‰øÆÊîπ"ËÆæÁΩÆÊîØ‰ªòÂÆùË¥¶Âè∑ÂíåÁúüÂÆûÂßìÂêçÔºåËÆæÁΩÆÂÆåÊàêÂêéÂç≥ÂèØÊèêÁé∞
                    </span>
                </div>
            </div>
        </div>

        <!-- ÂæÆ‰ø°ÊèêÁé∞‰ø°ÊÅØ -->
        <div id="wechat-section" class="form-section hidden">
            <div class="section-header">
                <span class="text-gray-800 font-medium">ÂæÆ‰ø°ÊèêÁé∞‰ø°ÊÅØ</span>
                <a href="#" id="change-wechat-btn" class="text-blue-500 text-sm flex items-center">
                    ‰øÆÊîπ <i class="fas fa-chevron-right ml-1 text-xs"></i>
                </a>
            </div>
            
            <div class="text-center">
                <p class="text-sm text-gray-500 mb-3">Êî∂Ê¨æÁ†Å</p>
                <div id="qr-code-display" class="mb-3">
                    <p class="text-gray-400">ËØ∑ÂÖà‰∏ä‰º†Êî∂Ê¨æÁ†Å</p>
                </div>
                <!-- ‰∏ä‰º†Áä∂ÊÄÅÊ†èÔºàÂÜÖÈ°µÂ±ïÁ§∫Ôºâ -->
                <div id="wechat-upload-status" class="upload-status hidden" aria-live="polite">
                    <div class="progress"><div class="progress-bar" id="wechat-upload-bar"></div></div>
                    <div class="progress-text" id="wechat-upload-text">ÂæÖ‰∏ä‰º†</div>
                </div>
            </div>
        </div>
        
        <!-- ÊèêÁé∞ÈáëÈ¢ù -->
        <div class="form-section">
            <h3 class="text-gray-800 font-medium mb-4">ÊèêÁé∞ÈáëÈ¢ù</h3>
            <div class="flex items-center mb-4">
                <span class="text-2xl font-bold mr-2">¬•</span>
                <input type="number" id="withdraw-amount" class="form-input text-xl" placeholder="ËæìÂÖ•ÊèêÁé∞ÈáëÈ¢ù" step="0.01" min="10">
            </div>
            
            <div class="withdraw-info flex justify-between items-center">
                <span>ÂΩìÂâçÂèØÊèêÁé∞ÈáëÈ¢ù<span id="withdrawable-amount" class="font-medium text-gray-800">0.00</span>ÂÖÉ</span>
                <a href="#" id="withdraw-all-btn" class="text-blue-500">ÂÖ®ÈÉ®ÊèêÁé∞</a>
            </div>
            
            <!-- ÊèêÁé∞ËØ¥Êòé -->
            <ul class="info-list mt-4">
                <li>ËØ∑ËÆ§ÁúüÂ°´ÂÜôÁõ∏ÂÖ≥Ë¥¶Âè∑‰ø°ÊÅØÔºå‰ª•ÂÖçÊâìÊ¨æÂ§±Ë¥•Ôºõ</li>
                <li>ÊØèÊ¨°ÊèêÁé∞ÈáëÈ¢ù‰∏çËÉΩ‰Ωé‰∫é10ÂÖÉÔºõ</li>
                <li>ÂêåÊó∂Âè™ËÉΩÊúâ‰∏ÄÁ¨îÊèêÁé∞ÔºåÈúÄÊâìÊ¨æ‰πãÂêéÊâçËÉΩÊèêÁé∞Ôºõ</li>
                <li>ÊèêÁé∞‰ºöÂú®3‰∏™Â∑•‰ΩúÊó•ÂÜÖÂÆåÊàêÊâìÊ¨æÔºåËäÇÂÅáÊó•È°∫Âª∂„ÄÇ</li>
            </ul>
            
            <!-- ÊèêÁé∞Áä∂ÊÄÅÊòæÁ§∫Âå∫Âüü -->
            <div id="withdraw-status" class="status-message hidden status-pending">
                <i id="withdraw-status-icon" class="fas fa-info-circle"></i>
                <span id="withdraw-status-text">ÂæÖÂ§ÑÁêÜ</span>
            </div>
            
            <button id="submit-withdrawal-btn" class="submit-btn" data-disabled="true">ÊèêÁé∞</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // ÂàùÂßãÂåñ Supabase ÂÆ¢Êà∑Á´Ø
        console.log('ÂºÄÂßãÂàùÂßãÂåñSupabaseÂÆ¢Êà∑Á´Ø...');
        const SUPABASE_URL = 'https://ybrveusbwjusnrzgfnok.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlicnZldXNid2p1c25yemdmbm9rIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY0ODU1NjIsImV4cCI6MjA3MjA2MTU2Mn0.JKPSUli-q9wRuDagE6kwltLk9XgfygE8yznm-Ca82Qk';
        // ‰øùÂ≠òsupabaseÂØπË±°‰ª•‰æøÂÖ∂‰ªñËÑöÊú¨‰ΩøÁî®
        window.supabaseJs = window.supabase;
        // ÂàõÂª∫SupabaseÂÆ¢Êà∑Á´Ø
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        // Â∞ÜÂàõÂª∫ÁöÑÂÆ¢Êà∑Á´ØÊåÇËΩΩÂà∞ÂÖ®Â±Ä
        window.supabase = supabase;
        console.log('SupabaseÂÆ¢Êà∑Á´ØÂàùÂßãÂåñÂÆåÊàê');
    </script>
    <script defer src="mobile-optimizer.js"></script>
    <script defer src="mobile-interactions.js"></script>
    <script src="wallet-synchronizer.js"></script>
    <script src="fix-wallet-inconsistency.js"></script>
    <script src="fix-withdrawals-table-missing.js"></script>
    <script src="mobile-withdrawal.js"></script>
    <script src="update-mobile-withdrawal.js"></script>
    <script>
        // ÂÖ®Â±ÄÂèòÈáè
        let currentUser = null;
        let withdrawableAmount = 0;
        
        // ÊèêÁé∞Áä∂ÊÄÅÁÆ°ÁêÜÂô®
        const WithdrawalStatus = (() => {
            const states = { pending: 'pending', processing: 'processing', success: 'success', failed: 'failed' };
            const icons = { pending: 'fas fa-info-circle', processing: 'fas fa-spinner fa-spin', success: 'fas fa-check-circle', failed: 'fas fa-times-circle' };
            function setState(state, text) {
                const box = document.getElementById('withdraw-status');
                const label = document.getElementById('withdraw-status-text');
                const icon = document.getElementById('withdraw-status-icon');
                if (!box || !label || !icon) return;
                box.classList.remove('hidden','status-pending','status-processing','status-success','status-failed');
                box.classList.add('status-message', `status-${state}`);
                label.textContent = text ||
                    (state === 'processing' ? 'ÊèêÁé∞‰∏≠ÔºåËØ∑Á®çÂÄô...' : state === 'success' ? 'ÊèêÁé∞ÊàêÂäüÔºåÂ∑≤Êèê‰∫§ÂÆ°Ê†∏' : state === 'failed' ? 'ÊèêÁé∞Â§±Ë¥•ÔºåËØ∑Á®çÂêéÈáçËØï' : 'ÂæÖÂ§ÑÁêÜ');
                icon.className = icons[state] || icons.pending;
            }
            return {
                states,
                pending: (msg) => setState(states.pending, msg),
                processing: (msg) => setState(states.processing, msg),
                success: (msg) => setState(states.success, msg),
                failed: (msg) => setState(states.failed, msg)
            };
        })();

        // =====================
        // ÊîØ‰ªòÊï∞ÊçÆÂêåÊ≠•‰∏é‰∏ÄËá¥ÊÄßÊ£ÄÊü•
        // =====================
        const PaymentDataSync = (() => {
            let fieldMap = { idField: 'id', alipayField: 'alipay_account', nameField: 'real_name', availableFields: [] };
            const altAlipayField = 'ÊîØ‰ªòÂÆùË¥¶Âè∑';
            const altNameField = 'ÁúüÂÆûÂßìÂêç';
            const altIdField = 'Áî®Êà∑ID';
            
            function isReady() {
                return !!(window.supabase && typeof window.supabase.from === 'function');
            }
            
            async function detectFields() {
                if (!isReady()) return fieldMap;
                try {
                    const { data, error } = await window.supabase.from('users').select('*').limit(1);
                    if (error || !Array.isArray(data)) return fieldMap;
                    const sample = data[0] || {};
                    const keys = Object.keys(sample);
                    fieldMap.availableFields = keys;
                    fieldMap.idField = keys.includes(altIdField) ? altIdField : 'id';
                    fieldMap.alipayField = keys.includes(altAlipayField) ? altAlipayField : 'alipay_account';
                    fieldMap.nameField = keys.includes(altNameField) ? altNameField : 'real_name';
                } catch (_) {
                    // ÂøΩÁï•Ê£ÄÊµãÂºÇÂ∏∏Ôºå‰øùÁïôÈªòËÆ§Êò†Â∞Ñ
                }
                return fieldMap;
            }
            
            function validate(account, name) {
                if (!account || !name) return { ok: false, message: '‰ø°ÊÅØ‰∏çÂÆåÊï¥' };
                const trimmedAcc = String(account).trim();
                const trimmedName = String(name).trim();
                if (trimmedAcc.length < 3) return { ok: false, message: 'ÊîØ‰ªòÂÆùË¥¶Âè∑ËøáÁü≠' };
                if (trimmedName.length < 2) return { ok: false, message: 'ÁúüÂÆûÂßìÂêçËøáÁü≠' };
                return { ok: true };
            }
            
            async function readBack(userId) {
                const map = await detectFields();
                const { data, error } = await window.supabase
                    .from('users')
                    .select('*')
                    .eq(map.idField, userId)
                    .single();
                return { data, error };
            }
            
            async function syncAlipayInfo(user, account, name) {
                if (!isReady()) return { ok: false, error: new Error('supabaseÊú™Â∞±Áª™') };
                const v = validate(account, name);
                if (!v.ok) return { ok: false, error: new Error(v.message) };
                const map = await detectFields();
                const userId = user.id || user[altIdField];
                if (!userId) return { ok: false, error: new Error('Áî®Êà∑IDÁº∫Â§±') };
                
                // ‰ªÖÊõ¥Êñ∞Â∑≤Â≠òÂú®Â≠óÊÆµÔºõËã•‰∏≠Ëã±Â≠óÊÆµÂêåÊó∂Â≠òÂú®ÔºåÂêåÊó∂ÂÜôÂÖ•‰∏§‰ªΩ‰ª•ÂÖºÂÆπÂêéÂè∞ËØªÂèñ
                const updateData = {};
                const keys = map.availableFields || [];
                const hasEnAlipay = keys.includes('alipay_account');
                const hasZhAlipay = keys.includes(altAlipayField);
                const hasEnName = keys.includes('real_name');
                const hasZhName = keys.includes(altNameField);
                if (hasEnAlipay) updateData['alipay_account'] = account;
                if (hasZhAlipay) updateData[altAlipayField] = account;
                if (hasEnName) updateData['real_name'] = name;
                if (hasZhName) updateData[altNameField] = name;
                if (Object.keys(updateData).length === 0) {
                    return { ok: false, error: new Error('ÊúçÂä°Âô®Áº∫Â∞ëÊâÄÈúÄÂ≠óÊÆµ') };
                }
                
                const { error: updErr } = await window.supabase
                    .from('users')
                    .update(updateData)
                    .eq(map.idField, userId)
                    .select();
                if (updErr) return { ok: false, error: updErr };
                
                // ÂõûËØªÊ†°È™å
                const { data: row, error: readErr } = await readBack(userId);
                if (readErr) return { ok: false, error: readErr };
                const serverAcc = row['alipay_account'] ?? row[altAlipayField];
                const serverName = row['real_name'] ?? row[altNameField];
                const ok = serverAcc === account && serverName === name;
                return { ok, data: row };
            }
            
            async function ensureConsistency(user) {
                if (!isReady() || !user) return;
                const map = await detectFields();
                const userId = user.id || user[altIdField];
                if (!userId) return;
                try {
                    const { data: row } = await readBack(userId);
                    if (!row) return;
                    const serverAcc = row[map.alipayField] ?? row[altAlipayField];
                    const serverName = row[map.nameField] ?? row[altNameField];
                    const localAcc = user.alipay_account || user[altAlipayField];
                    const localName = user.real_name || user[altNameField];
                    
                    // ‰ª•ÊúçÂä°Á´Ø‰∏∫ÂáÜËøõË°åÂØπÈΩê
                    if ((serverAcc && serverAcc !== localAcc) || (serverName && serverName !== localName)) {
                        user.alipay_account = serverAcc || localAcc || '';
                        user.real_name = serverName || localName || '';
                        user[altAlipayField] = user.alipay_account;
                        user[altNameField] = user.real_name;
                        localStorage.setItem('currentUser', JSON.stringify(user));
                        updateAlipayDisplay(user.alipay_account, user.real_name);
                    }
                } catch (_) { /* ÂøΩÁï• */ }
            }
            
            return { isReady, detectFields, validate, syncAlipayInfo, ensureConsistency };
        })();

        // =====================
        // ÊèêÁé∞ËÆ∞ÂΩïÂõûÂ°´Ôºà‰øùËØÅÂêéÂè∞ÂèØËßÅÔºâ
        // =====================
        const WithdrawalBackfill = (() => {
            let availableFields = [];
            async function detectFields() {
                try {
                    const { data, error } = await window.supabase
                        .from('withdrawals')
                        .select('*')
                        .limit(1);
                    if (!error && Array.isArray(data)) {
                        availableFields = Object.keys(data[0] || {});
                    }
                } catch (_) {}
                return availableFields;
            }
            function buildUpdate(account, name, paymentMethod) {
                const fields = {};
                if (availableFields.includes('alipay_account')) fields['alipay_account'] = account;
                if (availableFields.includes('real_name')) fields['real_name'] = name;
                if (availableFields.includes('payment_method')) fields['payment_method'] = paymentMethod || 'alipay';
                return fields;
            }
            async function backfillPendingForUser(userId, account, name) {
                if (!window.supabase || !userId) return;
                await detectFields();
                const updateData = buildUpdate(account, name, 'alipay');
                if (Object.keys(updateData).length === 0) return; // Êó†ÂèØÁî®Â≠óÊÆµÊó∂Ë∑≥Ëøá
                try {
                    await window.supabase
                        .from('withdrawals')
                        .update(updateData)
                        .eq('user_id', userId)
                        .eq('status', 'pending');
                    console.log('‚úÖ Â∑≤ÂõûÂ°´ÊèêÁé∞ËÆ∞ÂΩïÊîØ‰ªòÂ≠óÊÆµ');
                } catch (e) {
                    console.warn('ÂõûÂ°´ÊèêÁé∞ËÆ∞ÂΩïÂ§±Ë¥•:', e?.message || e);
                }
            }
            return { backfillPendingForUser };
        })();

        // =====================
        // ÊèêÁé∞ÊñπÂºèÂêåÊ≠•‰∏é‰∏ÄËá¥ÊÄßÊ£ÄÊü•
        // =====================
        const WithdrawalMethodSync = (() => {
            let detected = null;
            async function detectWithdrawalsFields() {
                if (detected) return detected;
                try {
                    const { data, error } = await window.supabase
                        .from('withdrawals')
                        .select('*')
                        .limit(1);
                    const sample = (!error && Array.isArray(data) && data[0]) ? data[0] : {};
                    const keys = Object.keys(sample);
                    detected = {
                        hasPaymentMethod: keys.includes('payment_method') || keys.includes('method') || keys.includes('ÊèêÁé∞ÊñπÂºè'),
                        methodField: keys.includes('payment_method') ? 'payment_method' : (keys.includes('method') ? 'method' : (keys.includes('ÊèêÁé∞ÊñπÂºè') ? 'ÊèêÁé∞ÊñπÂºè' : null)),
                        hasAlipayAccount: keys.includes('alipay_account'),
                        hasRealName: keys.includes('real_name'),
                        hasWechatQR: keys.includes('wechat_qr_code') || keys.includes('qr_code_url'),
                        keys
                    };
                } catch (e) {
                    detected = { hasPaymentMethod: true, methodField: 'payment_method', hasAlipayAccount: true, hasRealName: true, hasWechatQR: true, keys: [] };
                }
                // ÁªìÊûúÁºìÂ≠òÔºåÈÅøÂÖçÈáçÂ§çÊü•ËØ¢
                try { localStorage.setItem('withdrawals_fields_cache', JSON.stringify(detected)); } catch (_) {}
                return detected;
            }
            function getSelectedMethod() {
                const isWechatSelected = document.getElementById('wechat-option')?.classList.contains('active');
                return isWechatSelected ? 'wechat' : 'alipay';
            }
            function validateForMethod(method, user) {
                if (method === 'wechat') {
                    const wechatQR = user.wechat_qr_code || user['ÂæÆ‰ø°Êî∂Ê¨æÁ†Å'];
                    if (!wechatQR) return { ok: false, message: 'ËØ∑ÂÖà‰∏ä‰º†ÂæÆ‰ø°Êî∂Ê¨æÁ†Å' };
                } else {
                    const alipayAcc = user.alipay_account || user['ÊîØ‰ªòÂÆùË¥¶Âè∑'];
                    const realName = user.real_name || user['ÁúüÂÆûÂßìÂêç'];
                    if (!alipayAcc || !realName) return { ok: false, message: 'ËØ∑ÂÖàËÆæÁΩÆÊîØ‰ªòÂÆùË¥¶Âè∑ÂíåÁúüÂÆûÂßìÂêç' };
                }
                return { ok: true };
            }
            async function buildInsertPayload(base) {
                const fields = await detectWithdrawalsFields();
                const method = getSelectedMethod();
                const payload = { ...base };
                if (fields.methodField) payload[fields.methodField] = method;
                // Â∞ΩÂèØËÉΩÂ∏¶‰∏äÊîØ‰ªò‰ø°ÊÅØÔºåËÆ©ÂêéÂè∞Á´ãÂàªÂèØËßÅ
                const alipayAcc = currentUser.alipay_account || currentUser['ÊîØ‰ªòÂÆùË¥¶Âè∑'] || '';
                const realName = currentUser.real_name || currentUser['ÁúüÂÆûÂßìÂêç'] || '';
                const wechatQR = currentUser.wechat_qr_code || currentUser['ÂæÆ‰ø°Êî∂Ê¨æÁ†Å'] || '';
                if (fields.hasAlipayAccount) payload['alipay_account'] = alipayAcc;
                if (fields.hasRealName) payload['real_name'] = realName;
                if (fields.hasWechatQR) payload['wechat_qr_code'] = wechatQR;
                return payload;
            }
            async function ensureRecordHasMethod(withdrawalId) {
                const fields = await detectWithdrawalsFields();
                if (!fields.methodField || !withdrawalId) return;
                const method = getSelectedMethod();
                try {
                    const { error } = await window.supabase
                        .from('withdrawals')
                        .update({ [fields.methodField]: method })
                        .eq('id', withdrawalId);
                    if (!error) console.log('‚úÖ Â∑≤Ë°•ÂÜôÊèêÁé∞ÊñπÂºèÂà∞ËÆ∞ÂΩï:', withdrawalId, method);
                } catch (e) {
                    console.warn('ÂõûÂ°´ÊèêÁé∞ÊñπÂºèÂ§±Ë¥•:', e?.message || e);
                }
            }
            function rememberSelection() {
                try { localStorage.setItem('selected_payment_method', getSelectedMethod()); } catch (_) {}
            }
            return { detectWithdrawalsFields, getSelectedMethod, validateForMethod, buildInsertPayload, ensureRecordHasMethod, rememberSelection };
        })();
        
        // È°µÈù¢Âä†ËΩΩÂÆåÊàêÂêéÂàùÂßãÂåñ
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('ÊèêÁé∞È°µÈù¢Âä†ËΩΩÂÆåÊàêÔºåÂàùÂßãÂåñ...');
            // ÂàùÂßãÁä∂ÊÄÅ
            WithdrawalStatus.pending('ÂæÖÂ§ÑÁêÜ');
            try { hideLoading(); } catch(_) {}
            
            // üö® È°µÈù¢Âä†ËΩΩÊó∂Á´ãÂç≥Âº∫Âà∂ËÆæÁΩÆToast‰ΩçÁΩÆ
            const toastContainer = document.querySelector('.toast-container');
            if (toastContainer) {
                console.log('üîß È°µÈù¢Âä†ËΩΩÊó∂Âº∫Âà∂ËÆæÁΩÆToastÂà∞Â∫ïÈÉ®‰ΩçÁΩÆ');
                toastContainer.style.position = 'fixed';
                toastContainer.style.top = 'auto';
                toastContainer.style.bottom = '120px';
                toastContainer.style.left = '50%';
                toastContainer.style.transform = 'translateX(-50%)';
                toastContainer.style.width = '90%';
                toastContainer.style.maxWidth = '350px';
                toastContainer.style.zIndex = '99999';
                
                // Áîü‰∫ßÁéØÂ¢É‰∏çÊ∑ªÂä†‰ªª‰ΩïËæπÊ°ÜÊ†áËØÜ
                
                // 3ÁßíÂêéÁßªÈô§Á∫¢Ëâ≤ËæπÊ°Ü
                setTimeout(() => {
                    toastContainer.style.border = '';
                    console.log('üîÑ Á∫¢Ëâ≤ËæπÊ°ÜÂ∑≤ÁßªÈô§');
                }, 3000);
            } else {
                console.error('‚ùå Êâæ‰∏çÂà∞toast-containerÂÖÉÁ¥†');
            }
            
            // Ê£ÄÊü•Áî®Êà∑ÁôªÂΩïÁä∂ÊÄÅ
            await checkUserLogin();
            try { hideLoading(); } catch(_) {}
            
            // Âä†ËΩΩÁî®Êà∑Ë¥¶Êà∑‰ø°ÊÅØ
            loadAccountInfo();
            
            // ÁªëÂÆöË°®Âçï‰∫ã‰ª∂
            bindFormEvents();
            
            // ÁªëÂÆöÊèêÁé∞ÊñπÂºèÂàáÊç¢‰∫ã‰ª∂
            bindPaymentMethodEvents();
            
            // üéØ È°µÈù¢Âä†ËΩΩÂÆåÊàêÂêéÂº∫Âà∂ÂêåÊ≠•ÈáëÈ¢ùÊòæÁ§∫
            setTimeout(() => {
                console.log('üîß È°µÈù¢Âä†ËΩΩÂÆåÊàêÔºåÂº∫Âà∂ÂêåÊ≠•ÈáëÈ¢ùÊòæÁ§∫');
                const amountInput = document.getElementById('withdraw-amount');
                const amountDisplay = document.getElementById('withdrawable-amount');
                
                if (amountInput && amountDisplay && withdrawableAmount > 0) {
                    // Â¶ÇÊûúËæìÂÖ•Ê°Ü‰∏∫Á©∫ÊàñÊòæÁ§∫0.00ÔºåÂàôËÆæÁΩÆ‰∏∫ÂèØÊèêÁé∞ÈáëÈ¢ù
                    const currentValue = parseFloat(amountInput.value) || 0;
                    if (currentValue === 0) {
                        amountInput.value = withdrawableAmount.toFixed(2);
                        console.log('‚úÖ È°µÈù¢Âä†ËΩΩÂÆåÊàêÂêéÂ∑≤ÂêåÊ≠•ËæìÂÖ•Ê°ÜÈáëÈ¢ù:', withdrawableAmount.toFixed(2));
                    }
                }
            }, 1000);
        });
        
        // Ê£ÄÊü•Áî®Êà∑ÁôªÂΩïÁä∂ÊÄÅ
        async function checkUserLogin() {
            const userDataStr = localStorage.getItem('currentUser');
            
            if (!userDataStr) {
                // Áî®Êà∑Êú™ÁôªÂΩïÔºåÈáçÂÆöÂêëÂà∞ÁôªÂΩïÈ°µÈù¢
                window.location.href = 'login.html';
                return;
            }
            
            // Ëß£ÊûêÁî®Êà∑Êï∞ÊçÆ
            currentUser = JSON.parse(userDataStr);
            console.log('ÂΩìÂâçÁôªÂΩïÁî®Êà∑:', currentUser);
            // ÂêØÂä®‰∏ÄÊ¨°‰∏éÊúçÂä°Á´ØÁöÑÊï∞ÊçÆÂØπÈΩêÔºåÈÅøÂÖçÊòæÁ§∫ËøáÊúü‰ø°ÊÅØ
            PaymentDataSync.ensureConsistency(currentUser);
            
            // Ëé∑ÂèñÂèØÊèêÁé∞ÈáëÈ¢ù
            await loadWithdrawableAmount();
        }
        
        // Âä†ËΩΩÁî®Êà∑Ë¥¶Êà∑‰ø°ÊÅØ
        function loadAccountInfo() {
            console.log('üìã Âä†ËΩΩÁî®Êà∑Ë¥¶Êà∑‰ø°ÊÅØ...');
            
            // Êñ∞Ê≥®ÂÜåÁî®Êà∑ÈªòËÆ§Ê≤°ÊúâËÆæÁΩÆÊîØ‰ªòÂÆùÂíåÂæÆ‰ø°‰ø°ÊÅØ
            const alipayAccount = currentUser.alipay_account || currentUser.ÊîØ‰ªòÂÆùË¥¶Âè∑ || '';
            const realName = currentUser.real_name || currentUser.ÁúüÂÆûÂßìÂêç || '';
            const wechatQRCode = currentUser.wechat_qr_code || currentUser.ÂæÆ‰ø°Êî∂Ê¨æÁ†Å || '';
            
            console.log('üí≥ ÊîØ‰ªòÂÆù‰ø°ÊÅØÁä∂ÊÄÅ:', {
                account: alipayAccount ? 'Â∑≤ËÆæÁΩÆ' : 'Êú™ËÆæÁΩÆ',
                name: realName ? 'Â∑≤ËÆæÁΩÆ' : 'Êú™ËÆæÁΩÆ',
                complete: !!(alipayAccount && realName)
            });
            
            // Êõ¥Êñ∞ÊîØ‰ªòÂÆù‰ø°ÊÅØÊòæÁ§∫ÂíåÁä∂ÊÄÅ
            const statusBadge = document.getElementById('alipay-status-badge');
            const setupHint = document.getElementById('alipay-setup-hint');
            
            if (alipayAccount && realName) {
                // ‚úÖ ÊîØ‰ªòÂÆù‰ø°ÊÅØÂÆåÊï¥
                document.getElementById('alipay-account').textContent = alipayAccount;
                document.getElementById('user-real-name').textContent = realName;
                
                // Êõ¥Êñ∞Áä∂ÊÄÅÂæΩÁ´†‰∏∫ÁªøËâ≤
                if (statusBadge) {
                    statusBadge.className = 'ml-2 px-2 py-1 text-xs rounded-full bg-green-100 text-green-600';
                    statusBadge.textContent = '‚úÖ Â∑≤ËÆæÁΩÆ';
                }
                
                // ÈöêËóèËÆæÁΩÆÊèêÁ§∫
                if (setupHint) {
                    setupHint.style.display = 'none';
                }
                
                console.log('‚úÖ ÊîØ‰ªòÂÆù‰ø°ÊÅØÂÆåÊï¥ÔºåÂ∑≤Êõ¥Êñ∞ÊòæÁ§∫ÂíåÁä∂ÊÄÅ');
            } else {
                // ‚ùå ÊîØ‰ªòÂÆù‰ø°ÊÅØ‰∏çÂÆåÊï¥
                document.getElementById('alipay-account').textContent = 'ËØ∑ÂÖàËÆæÁΩÆ';
                document.getElementById('user-real-name').textContent = 'ËØ∑ÂÖàËÆæÁΩÆ';
                
                // Êõ¥Êñ∞Áä∂ÊÄÅÂæΩÁ´†‰∏∫Á∫¢Ëâ≤
                if (statusBadge) {
                    statusBadge.className = 'ml-2 px-2 py-1 text-xs rounded-full bg-red-100 text-red-600';
                    statusBadge.textContent = '‚ùå Êú™ËÆæÁΩÆ';
                }
                
                // ÊòæÁ§∫ËÆæÁΩÆÊèêÁ§∫
                if (setupHint) {
                    setupHint.style.display = 'block';
                }
                
                // Â¶ÇÊûúÈªòËÆ§ÈÄâÊã©ÊîØ‰ªòÂÆù‰ΩÜÊ≤°ÊúâËÆæÁΩÆ‰ø°ÊÅØÔºåÁ¶ÅÁî®ÊèêÁé∞ÊåâÈíÆÂπ∂ÊèêÁ§∫
                if (document.getElementById('alipay-option').classList.contains('active')) {
                    const submitBtn = document.getElementById('submit-withdrawal-btn');
                    submitBtn.setAttribute('data-disabled', 'true');
                    console.log('‚ö†Ô∏è ÊîØ‰ªòÂÆù‰ø°ÊÅØÊú™ËÆæÁΩÆÔºåÁ¶ÅÁî®ÊèêÁé∞ÊåâÈíÆ');
                    
                    // 3ÁßíÂêéÊòæÁ§∫ËÆæÁΩÆÊèêÁ§∫
                    setTimeout(() => {
                        showToast('üí° ËØ∑ÂÖàÁÇπÂáª"‰øÆÊîπ"ËÆæÁΩÆÊîØ‰ªòÂÆù‰ø°ÊÅØÊâçËÉΩÊèêÁé∞', 'warning');
                    }, 2000);
                }
            }
            
            console.log('üì± ÂæÆ‰ø°‰ø°ÊÅØÁä∂ÊÄÅ:', {
                qrCode: wechatQRCode ? 'Â∑≤ËÆæÁΩÆ' : 'Êú™ËÆæÁΩÆ'
            });
            
            // Êõ¥Êñ∞ÂæÆ‰ø°Êî∂Ê¨æÁ†ÅÊòæÁ§∫
            if (wechatQRCode) {
                document.getElementById('qr-code-display').innerHTML = `<img src="${wechatQRCode}" alt="ÂæÆ‰ø°Êî∂Ê¨æÁ†Å" class="qr-preview">`;
                console.log('‚úÖ ÂæÆ‰ø°Êî∂Ê¨æÁ†ÅÂ∑≤ËÆæÁΩÆ');
            } else {
                document.getElementById('qr-code-display').innerHTML = '<p class="text-gray-400">ËØ∑ÂÖà‰∏ä‰º†Êî∂Ê¨æÁ†Å</p>';
                console.log('‚ö†Ô∏è ÂæÆ‰ø°Êî∂Ê¨æÁ†ÅÊú™ËÆæÁΩÆ');
                
                // Â¶ÇÊûúÈÄâÊã©ÂæÆ‰ø°ÊèêÁé∞‰ΩÜÊ≤°Êúâ‰∏ä‰º†Êî∂Ê¨æÁ†ÅÔºåÁ¶ÅÁî®ÊèêÁé∞ÊåâÈíÆÂπ∂Ê∑ªÂä†ÊèêÁ§∫
                if (document.getElementById('wechat-option').classList.contains('active')) {
                    const submitBtn = document.getElementById('submit-withdrawal-btn');
                    submitBtn.setAttribute('data-disabled', 'true');
                    console.log('‚ö†Ô∏è ÂæÆ‰ø°Êî∂Ê¨æÁ†ÅÊú™ËÆæÁΩÆÔºåÁ¶ÅÁî®ÊèêÁé∞ÊåâÈíÆ');
                }
            }
        }
        
        // Âä†ËΩΩÁî®Êà∑ÂèØÊèêÁé∞ÈáëÈ¢ù
        async function loadWithdrawableAmount() {
            try {
                console.log('Âä†ËΩΩÁî®Êà∑ÂèØÊèêÁé∞ÈáëÈ¢ù...');
                showLoading();
                
                // Ëé∑ÂèñÁî®Êà∑ID
                const userId = currentUser.id || currentUser.Áî®Êà∑ID;
                
                if (!userId) {
                    console.error('Êó†Ê≥ïËé∑ÂèñÁî®Êà∑ID');
                    hideLoading();
                    return;
                }
                
                // ÂàõÂª∫‰∏Ä‰∏™Êú¨Âú∞Â§á‰ªΩÊï∞ÊçÆÂèòÈáèÔºå‰ª•Á°Æ‰øùAPIÈîôËØØÊó∂‰ªçËÉΩÊòæÁ§∫Êï∞ÊçÆ
                let localBackupAmount = 0;
                
                // Â∞ùËØï‰ªéÊú¨Âú∞Â≠òÂÇ®‰∏≠Ëé∑ÂèñÂ§á‰ªΩÈáëÈ¢ù
                try {
                    const backupData = localStorage.getItem('withdrawable_amount_backup');
                    if (backupData) {
                        const parsedData = JSON.parse(backupData);
                        if (parsedData.userId === userId && parsedData.amount) {
                            localBackupAmount = parseFloat(parsedData.amount);
                            console.log('Â∑≤‰ªéÊú¨Âú∞Â§á‰ªΩËé∑ÂèñÂèØÊèêÁé∞ÈáëÈ¢ù:', localBackupAmount);
                        }
                    }
                } catch (backupError) {
                    console.warn('ËØªÂèñÊú¨Âú∞Â§á‰ªΩÈáëÈ¢ùÂ§±Ë¥•:', backupError);
                }
                
                // ÂÆûÁé∞Â§öÁßçAPIË∞ÉÁî®ÊñπÊ≥ï‰Ωú‰∏∫Â§áÈÄâÊñπÊ°à
                
                // ÊñπÊ≥ï1: Ê≠£Á°ÆËÆ°ÁÆóÂèØÊèêÁé∞ÈáëÈ¢ùÔºàÊÄªÊî∂Áõä - ÊÄªÊèêÁé∞Ôºâ
                let method1Success = false;
                try {
                    console.log('üîÑ ÊñπÊ≥ï1Ôºö‰ΩøÁî®‰∏éÈí±ÂåÖÈ°µÈù¢‰∏ÄËá¥ÁöÑËÆ°ÁÆóÈÄªËæë...');
                    
                    // Ëé∑ÂèñÊâÄÊúâÂ∑≤ÂÆåÊàêÁöÑÊî∂ÁõäËÆ∞ÂΩï
                    const { data: earnings, error: earningsError } = await window.supabase
                        .from('earnings')
                        .select('*')
                        .eq('user_id', userId)
                        .or('status.eq.Â∑≤ÂÆåÊàê,status.eq.completed');
                        
                    if (earningsError) {
                        throw new Error('Ëé∑ÂèñÊî∂ÁõäËÆ∞ÂΩïÂ§±Ë¥•: ' + earningsError.message);
                    }
                    
                    // ËÆ°ÁÆóÊÄªÊî∂Áõä
                    let totalEarnings = 0;
                    earnings?.forEach(earning => {
                        const amount = parseFloat(earning.amount || earning.ÈáëÈ¢ù || 0);
                        totalEarnings += amount;
                    });
                    
                    // Ëé∑ÂèñÊâÄÊúâÊèêÁé∞ËÆ∞ÂΩï
                    const { data: withdrawals, error: withdrawalsError } = await window.supabase
                        .from('withdrawals')
                        .select('*')
                        .eq('user_id', userId);
                        
                    if (withdrawalsError) {
                        throw new Error('Ëé∑ÂèñÊèêÁé∞ËÆ∞ÂΩïÂ§±Ë¥•: ' + withdrawalsError.message);
                    }
                    
                    // ËÆ°ÁÆóÊÄªÊèêÁé∞
                    let totalWithdrawn = 0;
                    withdrawals?.forEach(withdrawal => {
                        const amount = parseFloat(withdrawal.amount || withdrawal.ÈáëÈ¢ù || 0);
                        totalWithdrawn += amount;
                    });
                    
                    // ËÆ°ÁÆóÂÆûÈôÖÂèØÊèêÁé∞‰ΩôÈ¢ùÔºà‰∏éÈí±ÂåÖÈ°µÈù¢ÈÄªËæë‰∏ÄËá¥Ôºâ
                    withdrawableAmount = totalEarnings - totalWithdrawn;
                    
                    console.log('üí∞ Êî∂ÁõäËÆ°ÁÆóËØ¶ÊÉÖ:', {
                        totalEarnings: totalEarnings,
                        totalWithdrawn: totalWithdrawn,
                        withdrawableAmount: withdrawableAmount,
                        earningsCount: earnings?.length || 0,
                        withdrawalsCount: withdrawals?.length || 0
                    });
                    
                    console.log('‚úÖ ÊñπÊ≥ï1ÊàêÂäüÔºöËÆ°ÁÆóÂèØÊèêÁé∞ÈáëÈ¢ù:', withdrawableAmount);
                    method1Success = true;
                    
                    // ‰øùÂ≠òÂà∞Êú¨Âú∞Â§á‰ªΩ
                    saveLocalBackup(userId, withdrawableAmount);
                    
                } catch (method1Error) {
                    console.error('‚ùå ÊñπÊ≥ï1ÂºÇÂ∏∏Ôºö', method1Error);
                }
                
                // ÊñπÊ≥ï2: ‰ΩøÁî®RPCÂáΩÊï∞
                if (!method1Success) {
                    try {
                        const { data: rpcData, error: rpcError } = await window.supabase
                            .rpc('get_withdrawable_amount', { user_id_param: userId });
                            
                        if (!rpcError && rpcData !== null) {
                            withdrawableAmount = parseFloat(rpcData);
                            console.log('ÊñπÊ≥ï2ÊàêÂäüÔºö‰ªéRPCËé∑ÂèñÂèØÊèêÁé∞ÈáëÈ¢ù:', withdrawableAmount);
                            
                            // ‰øùÂ≠òÂà∞Êú¨Âú∞Â§á‰ªΩ
                            saveLocalBackup(userId, withdrawableAmount);
                        } else {
                            console.warn('ÊñπÊ≥ï2Â§±Ë¥•ÔºöRPCË∞ÉÁî®Â§±Ë¥•:', rpcError);
                        }
                    } catch (method2Error) {
                        console.error('ÊñπÊ≥ï2ÂºÇÂ∏∏Ôºö', method2Error);
                    }
                }
                
                // ÊñπÊ≥ï3: ‰ªéÁî®Êà∑Ë°®‰∏≠Ëé∑Âèñ
                if (!method1Success) {
                    try {
                        const { data: userData, error: userError } = await window.supabase
                            .from('users')
                            .select('*')
                            .eq(userId.includes('-') ? 'id' : 'Áî®Êà∑ID', userId)
                            .single();
                            
                        if (!userError && userData) {
                            const walletField = getWalletField(userData);
                            withdrawableAmount = parseFloat(userData[walletField] || 0);
                            console.log('ÊñπÊ≥ï3ÊàêÂäüÔºö‰ªéÁî®Êà∑Ë°®Ëé∑ÂèñÂèØÊèêÁé∞ÈáëÈ¢ù:', withdrawableAmount);
                            
                            // ‰øùÂ≠òÂà∞Êú¨Âú∞Â§á‰ªΩ
                            saveLocalBackup(userId, withdrawableAmount);
                        } else {
                            console.warn('ÊñπÊ≥ï3Â§±Ë¥•ÔºöËé∑ÂèñÁî®Êà∑Êï∞ÊçÆÂ§±Ë¥•:', userError);
                        }
                    } catch (method3Error) {
                        console.error('ÊñπÊ≥ï3ÂºÇÂ∏∏Ôºö', method3Error);
                    }
                }
                
                // Â¶ÇÊûúÊâÄÊúâÊñπÊ≥ïÈÉΩÂ§±Ë¥•Ôºå‰ΩøÁî®Êú¨Âú∞Â§á‰ªΩ
                if (!method1Success && isNaN(withdrawableAmount) || withdrawableAmount === 0) {
                    console.log('ÊâÄÊúâAPIÊñπÊ≥ïÈÉΩÂ§±Ë¥•Ôºå‰ΩøÁî®Êú¨Âú∞Â§á‰ªΩÈáëÈ¢ù:', localBackupAmount);
                    withdrawableAmount = localBackupAmount;
                    
                    // Â¶ÇÊûúÊú¨Âú∞Â§á‰ªΩ‰πüÊ≤°ÊúâÔºåÂàô‰ΩøÁî®Áî®Êà∑Êï∞ÊçÆ‰∏≠ÁöÑÈí±ÂåÖ‰ΩôÈ¢ù
                    if (withdrawableAmount === 0) {
                        const walletField = getWalletField(currentUser);
                        withdrawableAmount = parseFloat(currentUser[walletField] || 0);
                        console.log('‰ΩøÁî®Áî®Êà∑Êï∞ÊçÆ‰∏≠ÁöÑÈí±ÂåÖ‰ΩôÈ¢ù‰Ωú‰∏∫ÂèØÊèêÁé∞ÈáëÈ¢ù:', withdrawableAmount);
                    }
                }
                
                console.log('ÊúÄÁªàËÆ°ÁÆóÁöÑÂèØÊèêÁé∞ÈáëÈ¢ù:', withdrawableAmount);
                
                // üíæ Á°Æ‰øùÊï∞ÊçÆÂêåÊ≠•Âà∞localStorageÔºàÁßªÈô§Á°¨ÁºñÁ†ÅÊÅ¢Â§çÈÄªËæëÔºâ
                if (withdrawableAmount >= 0) {
                    // Êõ¥Êñ∞Áî®Êà∑Êï∞ÊçÆ‰∏≠ÁöÑÈí±ÂåÖ‰ΩôÈ¢ù
                    if (currentUser) {
                        const walletField = getWalletField(currentUser);
                        currentUser[walletField] = withdrawableAmount;
                        // ÂêåÊó∂Êõ¥Êñ∞ÂêÑÁßçÂèØËÉΩÁöÑÂ≠óÊÆµÂêç
                        currentUser.wallet_balance = withdrawableAmount;
                        currentUser.Èí±ÂåÖ‰ΩôÈ¢ù = withdrawableAmount;
                        localStorage.setItem('currentUser', JSON.stringify(currentUser));
                        console.log('‚úÖ Áî®Êà∑Êï∞ÊçÆÂ∑≤ÂêåÊ≠•Âà∞localStorage');
                    }
                    
                    // ‰øùÂ≠òÂ§á‰ªΩÊï∞ÊçÆ
                    const userId = currentUser ? (currentUser.id || currentUser.Áî®Êà∑ID) : 'user_' + Date.now();
                    saveLocalBackup(userId, withdrawableAmount);
                } else {
                    console.warn('‚ö†Ô∏è ËÆ°ÁÆóÂá∫ÁöÑÂèØÊèêÁé∞ÈáëÈ¢ù‰∏∫Ë¥üÊï∞:', withdrawableAmount);
                    withdrawableAmount = 0; // Á°Æ‰øù‰∏çÊòæÁ§∫Ë¥üÊï∞
                }
                
                // Êõ¥Êñ∞ÊòæÁ§∫
                updateAmountDisplay();
                
                hideLoading();
            } catch (error) {
                console.error('Âä†ËΩΩÂèØÊèêÁé∞ÈáëÈ¢ùÊó∂Âá∫Èîô:', error);
                hideLoading();
                
                // ‰ΩøÁî®ÈªòËÆ§ÂÄºÊàñÊú¨Âú∞Â≠òÂÇ®ÁöÑÂ§á‰ªΩÂÄº
                try {
                    const backupData = localStorage.getItem('withdrawable_amount_backup');
                    if (backupData) {
                        const parsedData = JSON.parse(backupData);
                        if (parsedData.userId === (currentUser.id || currentUser.Áî®Êà∑ID)) {
                            withdrawableAmount = parseFloat(parsedData.amount);
                            console.log('‰ΩøÁî®Êú¨Âú∞Â§á‰ªΩÁöÑÂèØÊèêÁé∞ÈáëÈ¢ù:', withdrawableAmount);
                        }
                    }
                } catch (backupError) {
                    console.warn('ËØªÂèñÊú¨Âú∞Â§á‰ªΩÈáëÈ¢ùÂ§±Ë¥•:', backupError);
                    withdrawableAmount = 0;
                }
                
                // üí° Â¶ÇÊûú‰ΩôÈ¢ù‰∏∫0ÔºåÊòæÁ§∫ÊèêÁ§∫‰ø°ÊÅØ‰ΩÜ‰∏çÂº∫Âà∂‰øÆÊîπ
                if (withdrawableAmount === 0) {
                    console.log('‚ÑπÔ∏è ÂΩìÂâçÂèØÊèêÁé∞‰ΩôÈ¢ù‰∏∫0ÔºåÂèØËÉΩÁöÑÂéüÂõ†Ôºö');
                    console.log('   - Ê≤°ÊúâÂ∑≤ÂÆåÊàêÁöÑÊî∂ÁõäËÆ∞ÂΩï');
                    console.log('   - ÊâÄÊúâÊî∂ÁõäÈÉΩÂ∑≤ÊèêÁé∞');
                    console.log('   - Êï∞ÊçÆÂ∫ìËøûÊé•ÈóÆÈ¢ò');
                    
                    // Â∞ùËØï‰ªélocalStorageËé∑ÂèñÈí±ÂåÖÈ°µÈù¢ÁöÑ‰ΩôÈ¢ùËøõË°åÂØπÊØî
                    const walletBalance = localStorage.getItem('wallet_balance');
                    if (walletBalance && parseFloat(walletBalance) > 0) {
                        console.log('üí° Èí±ÂåÖÈ°µÈù¢ÊòæÁ§∫‰ΩôÈ¢ù:', walletBalance, '‰ΩÜÊèêÁé∞È°µÈù¢ËÆ°ÁÆó‰∏∫0ÔºåÂª∫ËÆÆÊ£ÄÊü•Êï∞ÊçÆ‰∏ÄËá¥ÊÄß');
                    }
                }
                
                updateAmountDisplay();
            }
        }
        
        // ‰øùÂ≠òÊú¨Âú∞Â§á‰ªΩ
        function saveLocalBackup(userId, amount) {
            try {
                const backupData = {
                    userId: userId,
                    amount: amount,
                    timestamp: new Date().getTime()
                };
                
                localStorage.setItem('withdrawable_amount_backup', JSON.stringify(backupData));
                console.log('ÂèØÊèêÁé∞ÈáëÈ¢ùÂ∑≤‰øùÂ≠òÂà∞Êú¨Âú∞Â§á‰ªΩ');
            } catch (error) {
                console.error('‰øùÂ≠òÊú¨Âú∞Â§á‰ªΩÂ§±Ë¥•:', error);
            }
        }
        
        // Êõ¥Êñ∞ÈáëÈ¢ùÊòæÁ§∫ - ÂêåÊ≠•Êõ¥Êñ∞ËæìÂÖ•Ê°ÜÂíåÊòæÁ§∫ÈáëÈ¢ù
        function updateAmountDisplay() {
            const amountDisplay = document.getElementById('withdrawable-amount');
            const amountInput = document.getElementById('withdraw-amount');
            
            if (amountDisplay) {
                amountDisplay.textContent = withdrawableAmount.toFixed(2);
            }
            
            // üéØ ÂêåÊ≠•Êõ¥Êñ∞ËæìÂÖ•Ê°ÜÔºåËÆ©‰∏§ËæπÈáëÈ¢ù‰∏ÄËá¥
            if (amountInput && withdrawableAmount > 0) {
                // Â¶ÇÊûúËæìÂÖ•Ê°Ü‰∏∫Á©∫ÊàñËÄÖ‰∏∫0ÔºåÂàôËÆæÁΩÆ‰∏∫ÂèØÊèêÁé∞ÈáëÈ¢ù
                const currentValue = parseFloat(amountInput.value) || 0;
                if (currentValue === 0) {
                    amountInput.value = withdrawableAmount.toFixed(2);
                    console.log('‚úÖ Â∑≤ÂêåÊ≠•ËæìÂÖ•Ê°ÜÈáëÈ¢ù‰∏∫:', withdrawableAmount.toFixed(2));
                }
            }
        }
        
        // Ëé∑ÂèñÈí±ÂåÖÂ≠óÊÆµÂêç
        function getWalletField(userData) {
            const possibleFields = ['wallet_balance', 'Èí±ÂåÖ‰ΩôÈ¢ù', 'balance', '‰ΩôÈ¢ù', 'wallet'];
            
            for (const field of possibleFields) {
                if (field in userData && userData[field] !== null) {
                    return field;
                }
            }
            
            return 'wallet_balance'; // ÈªòËÆ§Â≠óÊÆµÂêç
        }
        
        // ÁªëÂÆöË°®Âçï‰∫ã‰ª∂
        function bindFormEvents() {
            const amountInput = document.getElementById('withdraw-amount');
            const withdrawAllBtn = document.getElementById('withdraw-all-btn');
            const submitBtn = document.getElementById('submit-withdrawal-btn');
            const changeAlipayBtn = document.getElementById('change-alipay-btn');
            const changeWechatBtn = document.getElementById('change-wechat-btn');
            const alipaySection = document.getElementById('alipay-section');
            const wechatSection = document.getElementById('wechat-section');
            
            // üéØ ÊåâÁî®Êà∑Ë¶ÅÊ±ÇÔºöÂè™Âú®ÁÇπÂáªÊó∂ÊòæÁ§∫Ë≠¶ÂëäÔºåËæìÂÖ•Êó∂Âè™ÊéßÂà∂ÊåâÈíÆÁä∂ÊÄÅ
            // ÈáëÈ¢ùËæìÂÖ•‰∫ã‰ª∂ - ‰ªÖÊéßÂà∂ÊåâÈíÆÁä∂ÊÄÅÔºå‰∏çÊòæÁ§∫Ë≠¶Âëä
            amountInput.addEventListener('input', function() {
                const value = parseFloat(this.value);
                console.log('Áî®Êà∑ËæìÂÖ•ÈáëÈ¢ù:', value);
                
                // Ê†°È™åËæìÂÖ•ÈáëÈ¢ù - Âè™ÊéßÂà∂ÊåâÈíÆÁä∂ÊÄÅÔºå‰∏çÊòæÁ§∫Ë≠¶ÂëäÊèêÁ§∫
                if (!isNaN(value) && value > 0) {
                    if (value < 10) {
                        // Â∞è‰∫é10ÂÖÉÊó∂Á¶ÅÁî®ÊåâÈíÆÔºå‰ΩÜ‰∏çÊòæÁ§∫Ë≠¶Âëä
                        submitBtn.setAttribute('data-disabled', 'true');
                        console.log('‚ùå ÈáëÈ¢ùÂ∞è‰∫é10ÂÖÉÔºåÁ¶ÅÁî®ÊåâÈíÆÔºà‰∏çÊòæÁ§∫Ë≠¶ÂëäÔºâ');
                    } else if (value > withdrawableAmount) {
                        // Â§ß‰∫éÂèØÊèêÁé∞ÈáëÈ¢ùÊó∂Á¶ÅÁî®ÊåâÈíÆÔºå‰ΩÜ‰∏çÊòæÁ§∫Ë≠¶Âëä
                        submitBtn.setAttribute('data-disabled', 'true');
                        console.log('‚ùå ÈáëÈ¢ùË∂ÖËøá‰ΩôÈ¢ùÔºåÁ¶ÅÁî®ÊåâÈíÆÔºà‰∏çÊòæÁ§∫Ë≠¶ÂëäÔºâ');
                    } else {
                        // ÈáëÈ¢ùÊúâÊïàÔºåÂêØÁî®ÊåâÈíÆ
                        submitBtn.removeAttribute('data-disabled');
                        console.log('‚úÖ ÈáëÈ¢ùÊúâÊïàÔºåÂêØÁî®ÊèêÁé∞ÊåâÈíÆ');
                    }
                } else {
                    submitBtn.setAttribute('data-disabled', 'true');
                    console.log('‚ö†Ô∏è Êó†ÊïàÈáëÈ¢ùÔºåÁ¶ÅÁî®ÊåâÈíÆ');
                }
            });
            
            // ÂÖ®ÈÉ®ÊèêÁé∞ÁÇπÂáª‰∫ã‰ª∂
            withdrawAllBtn.addEventListener('click', function(e) {
                e.preventDefault();
                
                if (withdrawableAmount > 0) {
                    amountInput.value = withdrawableAmount.toFixed(2);
                    submitBtn.removeAttribute('data-disabled');
                } else {
                    amountInput.value = '0.00';
                    submitBtn.setAttribute('data-disabled', 'true');
                }
            });
            
            // ‰øÆÊîπÊîØ‰ªòÂÆù‰ø°ÊÅØÁÇπÂáª‰∫ã‰ª∂
            changeAlipayBtn.addEventListener('click', function(e) {
                e.preventDefault();
                showAlipaySettingsModal();
            });
            
            // ‰øÆÊîπÂæÆ‰ø°‰ø°ÊÅØÁÇπÂáª‰∫ã‰ª∂
            changeWechatBtn.addEventListener('click', function(e) {
                e.preventDefault();
                showWechatSettingsModal();
            });
            
            // üö® Á¥ßÊÄ•‰øÆÂ§çÔºöÁÆÄÂåñÊèê‰∫§ÊåâÈíÆÁÇπÂáª‰∫ã‰ª∂
            submitBtn.addEventListener('click', async function() {
                console.log('Áî®Êà∑ÁÇπÂáª‰∫ÜÊèêÁé∞ÊåâÈíÆ');
                
                // Ê£ÄÊü•ÊåâÈíÆÊòØÂê¶Ë¢´Á¶ÅÁî® - ‰ΩøÁî®ÂèåÈáçË≠¶ÂëäÁ°Æ‰øùÁî®Êà∑ËÉΩÁúãÂà∞
                if (submitBtn.getAttribute('data-disabled') === 'true') {
                    const amount = parseFloat(amountInput.value);
                    console.log('ÊåâÈíÆË¢´Á¶ÅÁî®ÔºåËæìÂÖ•ÁöÑÈáëÈ¢ù:', amount);
                    
                    if (isNaN(amount) || amount <= 0) {
                        showToast('ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑÊèêÁé∞ÈáëÈ¢ù', 'warning');
                        alert('‚ö†Ô∏è ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑÊèêÁé∞ÈáëÈ¢ù');
                        console.log('Êó†ÊïàÈáëÈ¢ù');
                    } else if (amount < 10) {
                        showToast('ÊèêÁé∞ÈáëÈ¢ù‰∏çËÉΩ‰Ωé‰∫é10ÂÖÉ', 'warning');
                        alert('‚ö†Ô∏è ÊèêÁé∞ÈáëÈ¢ù‰∏çËÉΩ‰Ωé‰∫é10ÂÖÉ');
                        console.log('ÈáëÈ¢ùÂ∞è‰∫é10ÂÖÉ');
                    } else if (amount > withdrawableAmount) {
                        showToast('ÊèêÁé∞ÈáëÈ¢ù‰∏çËÉΩÂ§ß‰∫éÂèØÊèêÁé∞‰ΩôÈ¢ù', 'warning');
                        alert('‚ö†Ô∏è ÊèêÁé∞ÈáëÈ¢ù‰∏çËÉΩÂ§ß‰∫éÂèØÊèêÁé∞‰ΩôÈ¢ù');
                        console.log('ÈáëÈ¢ùË∂ÖËøáÂèØÊèêÁé∞‰ΩôÈ¢ù');
                    } else {
                        // Ê£ÄÊü•ÊîØ‰ªòÊñπÂºèËÆæÁΩÆ
                        if (document.getElementById('alipay-option').classList.contains('active')) {
                            showToast('ËØ∑ÂÖàËÆæÁΩÆÊîØ‰ªòÂÆùË¥¶Âè∑ÂíåÁúüÂÆûÂßìÂêçÊâçËÉΩÊèêÁé∞', 'warning');
                            alert('‚ö†Ô∏è ËØ∑ÂÖàËÆæÁΩÆÊîØ‰ªòÂÆùË¥¶Âè∑ÂíåÁúüÂÆûÂßìÂêçÊâçËÉΩÊèêÁé∞');
                        } else if (document.getElementById('wechat-option').classList.contains('active')) {
                            showToast('ËØ∑ÂÖà‰∏ä‰º†ÂæÆ‰ø°Êî∂Ê¨æÁ†ÅÊâçËÉΩÊèêÁé∞', 'warning');
                            alert('‚ö†Ô∏è ËØ∑ÂÖà‰∏ä‰º†ÂæÆ‰ø°Êî∂Ê¨æÁ†ÅÊâçËÉΩÊèêÁé∞');
                        }
                        console.log('ÊîØ‰ªòÊñπÂºèÊú™ËÆæÁΩÆ');
                    }
                    return;
                }
                
                console.log('ÊåâÈíÆÂèØÁî®ÔºåÂºÄÂßãÂ§ÑÁêÜÊèêÁé∞');
                
                const amount = parseFloat(amountInput.value);
                
                if (isNaN(amount) || amount < 10) {
                    showToast('ÊèêÁé∞ÈáëÈ¢ù‰∏çËÉΩ‰Ωé‰∫é10ÂÖÉ', 'warning');
                    alert('‚ö†Ô∏è ÊèêÁé∞ÈáëÈ¢ù‰∏çËÉΩ‰Ωé‰∫é10ÂÖÉ');
                    return;
                }
                
                if (amount > withdrawableAmount) {
                    showToast('ÊèêÁé∞ÈáëÈ¢ù‰∏çËÉΩÂ§ß‰∫éÂèØÊèêÁé∞‰ΩôÈ¢ù', 'warning');
                    alert('‚ö†Ô∏è ÊèêÁé∞ÈáëÈ¢ù‰∏çËÉΩÂ§ß‰∫éÂèØÊèêÁé∞‰ΩôÈ¢ù');
                    return;
                }
                
                // Ê£ÄÊü•ÊòØÂê¶Â∑≤ÁªèËÆæÁΩÆÊèêÁé∞‰ø°ÊÅØ
                const isAlipaySelected = document.getElementById('alipay-option').classList.contains('active');
                const isWechatSelected = document.getElementById('wechat-option').classList.contains('active');
                
                // üîí ‰∏•Ê†ºÈ™åËØÅÔºöÊ†πÊçÆÁî®Êà∑ÈÄâÊã©ÁöÑÊèêÁé∞ÊñπÂºèÊ£ÄÊü•ËÆæÁΩÆ‰ø°ÊÅØÊòØÂê¶ÂÆåÊï¥
                if (isAlipaySelected) {
                    const alipayAccount = currentUser.alipay_account || currentUser.ÊîØ‰ªòÂÆùË¥¶Âè∑;
                    const realName = currentUser.real_name || currentUser.ÁúüÂÆûÂßìÂêç;
                    
                    console.log('üîç È™åËØÅÊîØ‰ªòÂÆù‰ø°ÊÅØ:', {
                        alipayAccount: alipayAccount ? 'Â∑≤ËÆæÁΩÆ' : 'Êú™ËÆæÁΩÆ',
                        realName: realName ? 'Â∑≤ËÆæÁΩÆ' : 'Êú™ËÆæÁΩÆ',
                        currentUser: currentUser
                    });
                    
                    if (!alipayAccount || !realName) {
                        // ÊîØ‰ªòÂÆù‰ø°ÊÅØ‰∏çÂÆåÊï¥ÔºåÂº∫Âà∂Áî®Êà∑ËÆæÁΩÆ
                        console.log('‚ùå ÊîØ‰ªòÂÆù‰ø°ÊÅØ‰∏çÂÆåÊï¥ÔºåÈòªÊ≠¢ÊèêÁé∞');
                        showToast('ËØ∑ÂÖàÂÆåÊï¥ËÆæÁΩÆÊîØ‰ªòÂÆùË¥¶Âè∑ÂíåÁúüÂÆûÂßìÂêçÊâçËÉΩÊèêÁé∞', 'error');
                        
                        // Á°Æ‰øùÊåâÈíÆË¢´Á¶ÅÁî®
                        const submitBtn = document.getElementById('submit-withdrawal-btn');
                        if (submitBtn) {
                            submitBtn.setAttribute('data-disabled', 'true');
                        }
                        
                        // Ëá™Âä®ÊòæÁ§∫ËÆæÁΩÆÂØπËØùÊ°Ü
                        setTimeout(() => {
                            showAlipaySettingsModal();
                        }, 1000);
                        return;
                    }
                    
                    // ‚úÖ ÊîØ‰ªòÂÆù‰ø°ÊÅØÂÆåÊï¥ÔºåËÆ∞ÂΩïÂà∞ÊéßÂà∂Âè∞
                    console.log('‚úÖ ÊîØ‰ªòÂÆù‰ø°ÊÅØÈ™åËØÅÈÄöËøá:', {
                        account: alipayAccount,
                        name: realName
                    });
                    
                } else if (isWechatSelected) {
                    const wechatQRCode = currentUser.wechat_qr_code || currentUser.ÂæÆ‰ø°Êî∂Ê¨æÁ†Å;
                    const wechatState = WechatUploadStatus.getState();
                    
                    console.log('üîç È™åËØÅÂæÆ‰ø°‰ø°ÊÅØ:', {
                        wechatQRCode: wechatQRCode ? 'Â∑≤ËÆæÁΩÆ' : 'Êú™ËÆæÁΩÆ',
                        state: wechatState
                    });
                    
                    if (!wechatQRCode) {
                        // ÂæÆ‰ø°Êî∂Ê¨æÁ†ÅÊú™ËÆæÁΩÆÔºåÂº∫Âà∂Áî®Êà∑ËÆæÁΩÆ
                        console.log('‚ùå ÂæÆ‰ø°Êî∂Ê¨æÁ†ÅÊú™ËÆæÁΩÆÔºåÈòªÊ≠¢ÊèêÁé∞');
                        showToast('ËØ∑ÂÖà‰∏ä‰º†ÂæÆ‰ø°Êî∂Ê¨æÁ†ÅÊâçËÉΩÊèêÁé∞', 'error');
                        
                        // Á°Æ‰øùÊåâÈíÆË¢´Á¶ÅÁî®
                        const submitBtn = document.getElementById('submit-withdrawal-btn');
                        if (submitBtn) {
                            submitBtn.setAttribute('data-disabled', 'true');
                        }
                        
                        // Ëá™Âä®ÊòæÁ§∫ËÆæÁΩÆÂØπËØùÊ°Ü
                        setTimeout(() => {
                            showWechatSettingsModal();
                        }, 1000);
                        return;
                    } else if (wechatState !== WechatUploadStatus.states.success) {
                        // Êî∂Ê¨æÁ†ÅÊúâÂÄº‰ΩÜÁä∂ÊÄÅÊú™ÊàêÂäüÔºà‰∏ä‰º†‰∏≠/Â§±Ë¥•/Êú™Áü•Ôºâ
                        console.log('‚ùå Êî∂Ê¨æÁ†ÅÁä∂ÊÄÅÊú™ÊàêÂäüÔºåÈòªÊ≠¢ÊèêÁé∞');
                        const msg = wechatState === WechatUploadStatus.states.uploading
                            ? 'Êî∂Ê¨æÁ†ÅÊ≠£Âú®‰∏ä‰º†ÔºåËØ∑Á®çÂÄôÂÆåÊàêÂêéÂÜçÊèêÁé∞'
                            : (wechatState === WechatUploadStatus.states.failed
                                ? 'Êî∂Ê¨æÁ†Å‰∏ä‰º†Â§±Ë¥•ÔºåËØ∑ÈáçÊñ∞‰∏ä‰º†'
                                : 'Êî∂Ê¨æÁ†ÅÁä∂ÊÄÅÂºÇÂ∏∏ÔºåËØ∑ÈáçÊñ∞‰∏ä‰º†');
                        showToast(msg, 'error');
                        const submitBtn = document.getElementById('submit-withdrawal-btn');
                        if (submitBtn) submitBtn.setAttribute('data-disabled', 'true');
                        return;
                    }
                    
                    console.log('‚úÖ ÂæÆ‰ø°‰ø°ÊÅØÈ™åËØÅÈÄöËøá');
                }
                
                // ÈÄöËøáÈ™åËØÅÔºåË∞ÉÁî®ÊèêÁé∞Â§ÑÁêÜÂáΩÊï∞ÔºàÁ≠âÂæÖÂÆåÊàêÔºåÈÅøÂÖçÂä†ËΩΩÈÅÆÁΩ©ÊÆãÁïôÔºâ
                WithdrawalStatus.processing('ÊèêÁé∞‰∏≠ÔºåËØ∑Á®çÂÄô...');
                try {
                    await processWithdrawal(amount);
                } catch(e) {
                    console.warn('ÊèêÁé∞ËøáÁ®ãÊäõÂá∫ÂºÇÂ∏∏(Â∑≤Âú®ÂÜÖÈÉ®Â§ÑÁêÜ):', e);
                }
            });
        }
        
        // ÁªëÂÆöÊèêÁé∞ÊñπÂºèÂàáÊç¢‰∫ã‰ª∂
        function bindPaymentMethodEvents() {
            const alipayOption = document.getElementById('alipay-option');
            const wechatOption = document.getElementById('wechat-option');
            const alipaySection = document.getElementById('alipay-section');
            const wechatSection = document.getElementById('wechat-section');
            const submitBtn = document.getElementById('submit-withdrawal-btn');
            
            // ÊîØ‰ªòÂÆùÈÄâÈ°πÁÇπÂáª‰∫ã‰ª∂
            alipayOption.addEventListener('click', function() {
                alipayOption.classList.add('active');
                wechatOption.classList.remove('active');
                alipaySection.classList.remove('hidden');
                wechatSection.classList.add('hidden');
                
                // Êõ¥Êñ∞ÊåâÈíÆÊ†∑Âºè
                alipayOption.className = 'payment-option active flex-1 py-3 px-4 rounded-lg border-2 border-blue-500 bg-blue-50 text-blue-700 font-medium';
                wechatOption.className = 'payment-option flex-1 py-3 px-4 rounded-lg border-2 border-gray-200 bg-white text-gray-600 font-medium';
                
                // Ê£ÄÊü•ÊîØ‰ªòÂÆùË¥¶Âè∑ÂíåÁúüÂÆûÂßìÂêçÊòØÂê¶Â∑≤ËÆæÁΩÆ
                const alipayAccount = currentUser.alipay_account || currentUser.ÊîØ‰ªòÂÆùË¥¶Âè∑;
                const realName = currentUser.real_name || currentUser.ÁúüÂÆûÂßìÂêç;
                
                // Â¶ÇÊûúÊîØ‰ªòÂÆù‰ø°ÊÅØÊú™ËÆæÁΩÆÔºåÁ¶ÅÁî®ÊèêÁé∞ÊåâÈíÆÂπ∂ÊèêÁ§∫
                if (!alipayAccount || !realName) {
                    submitBtn.setAttribute('data-disabled', 'true');
                    showToast('ËØ∑ÂÖàËÆæÁΩÆÊîØ‰ªòÂÆùË¥¶Âè∑ÂíåÁúüÂÆûÂßìÂêçÊâçËÉΩÊèêÁé∞', 'warning');
                    // ÂèØ‰ª•ÈÄâÊã©Ëá™Âä®ÊòæÁ§∫ËÆæÁΩÆÁïåÈù¢
                    // showAlipaySettingsModal();
                } else {
                    // ÈáçÊñ∞Ê£ÄÊü•ÊèêÁé∞ÈáëÈ¢ù
                    const amountInput = document.getElementById('withdraw-amount');
                    const value = parseFloat(amountInput.value);
                    if (!isNaN(value) && value >= 10 && value <= withdrawableAmount) {
                        submitBtn.removeAttribute('data-disabled');
                    }
                }
            });
            
            // ÂæÆ‰ø°ÈÄâÈ°πÁÇπÂáª‰∫ã‰ª∂
            wechatOption.addEventListener('click', function() {
                wechatOption.classList.add('active');
                alipayOption.classList.remove('active');
                wechatSection.classList.remove('hidden');
                alipaySection.classList.add('hidden');
                
                // Êõ¥Êñ∞ÊåâÈíÆÊ†∑Âºè
                wechatOption.className = 'payment-option active flex-1 py-3 px-4 rounded-lg border-2 border-blue-500 bg-blue-50 text-blue-700 font-medium';
                alipayOption.className = 'payment-option flex-1 py-3 px-4 rounded-lg border-2 border-gray-200 bg-white text-gray-600 font-medium';
                
                // Ê£ÄÊü•ÂæÆ‰ø°Êî∂Ê¨æÁ†ÅÊòØÂê¶Â∑≤ËÆæÁΩÆ
                const wechatQRCode = currentUser.wechat_qr_code || currentUser.ÂæÆ‰ø°Êî∂Ê¨æÁ†Å;
                
                // Â¶ÇÊûúÂæÆ‰ø°Êî∂Ê¨æÁ†ÅÊú™ËÆæÁΩÆÔºåÁ¶ÅÁî®ÊèêÁé∞ÊåâÈíÆÂπ∂ÊèêÁ§∫
                if (!wechatQRCode) {
                    submitBtn.setAttribute('data-disabled', 'true');
                    const state = WechatUploadStatus.getState();
                    const msg = state === WechatUploadStatus.states.uploading
                        ? 'Êî∂Ê¨æÁ†Å‰∏ä‰º†‰∏≠ÔºåËØ∑Á®çÂÄôÂÆåÊàêÂêéÂÜçÊèêÁé∞'
                        : 'ËØ∑ÂÖà‰∏ä‰º†ÂæÆ‰ø°Êî∂Ê¨æÁ†ÅÊâçËÉΩÊèêÁé∞';
                    showToast(msg, 'warning');
                    // ÂèØ‰ª•ÈÄâÊã©Ëá™Âä®ÊòæÁ§∫ËÆæÁΩÆÁïåÈù¢
                    // showWechatSettingsModal();
                } else {
                    // ÈáçÊñ∞Ê£ÄÊü•ÊèêÁé∞ÈáëÈ¢ù
                    const amountInput = document.getElementById('withdraw-amount');
                    const value = parseFloat(amountInput.value);
                    if (!isNaN(value) && value >= 10 && value <= withdrawableAmount) {
                        // ËøòÈúÄÊ†°È™å‰∏ä‰º†Áä∂ÊÄÅÂøÖÈ°ª‰∏∫ÊàêÂäü
                        if (WechatUploadStatus.getState() === WechatUploadStatus.states.success) {
                            submitBtn.removeAttribute('data-disabled');
                        } else {
                            submitBtn.setAttribute('data-disabled', 'true');
                        }
                    }
                }
            });
        }
        
        // ÊòæÁ§∫ÊîØ‰ªòÂÆùËÆæÁΩÆÂØπËØùÊ°Ü
        function showAlipaySettingsModal() {
            // ÂàõÂª∫ÂØπËØùÊ°ÜÂÖÉÁ¥†
            const dialog = document.createElement('div');
            dialog.className = 'fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50';
            
            dialog.innerHTML = `
                <div class="bg-white rounded-lg w-11/12 max-w-md p-5">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">ËÆæÁΩÆÊîØ‰ªòÂÆùÊèêÁé∞‰ø°ÊÅØ</h3>
                    
                    <div class="mb-4">
                        <label class="block text-gray-600 text-sm font-medium mb-2">ÊîØ‰ªòÂÆùË¥¶Âè∑</label>
                        <input type="text" id="new-alipay-account" class="form-input" placeholder="ËØ∑ËæìÂÖ•ÊîØ‰ªòÂÆùË¥¶Âè∑">
                        <p class="text-xs text-gray-400 mt-1">Âá∫‰∫éÂÆâÂÖ®ËÄÉËôëÔºåËØ•Â≠óÊÆµÂú®È°µÈù¢‰∏ä‰ºöÊòæÁ§∫‰∏∫Âç†‰ΩçÁ¨¶Ôºå‰øùÊä§ÊÇ®ÁöÑÈöêÁßÅ</p>
                    </div>
                    
                    <div class="mb-6">
                        <label class="block text-gray-600 text-sm font-medium mb-2">ÁúüÂÆûÂßìÂêç</label>
                        <input type="text" id="new-real-name" class="form-input" placeholder="ËØ∑ËæìÂÖ•ÁúüÂÆûÂßìÂêç">
                        <p class="text-xs text-gray-400 mt-1">Âá∫‰∫éÂÆâÂÖ®ËÄÉËôëÔºåËØ•Â≠óÊÆµÂú®È°µÈù¢‰∏ä‰ºöÊòæÁ§∫‰∏∫Âç†‰ΩçÁ¨¶Ôºå‰øùÊä§ÊÇ®ÁöÑÈöêÁßÅ</p>
                    </div>
                    
                    <div class="flex justify-end">
                        <button class="px-4 py-2 text-gray-500 mr-2" id="cancel-alipay-btn">ÂèñÊ∂à</button>
                        <button class="px-4 py-2 bg-blue-500 text-white rounded-md" id="confirm-alipay-btn">Á°ÆËÆ§</button>
                    </div>
                </div>
            `;
            
            // Ê∑ªÂä†Âà∞È°µÈù¢
            document.body.appendChild(dialog);
            
            // ÁªëÂÆö‰∫ã‰ª∂
            const cancelBtn = document.getElementById('cancel-alipay-btn');
            const confirmBtn = document.getElementById('confirm-alipay-btn');
            
            cancelBtn.addEventListener('click', function() {
                document.body.removeChild(dialog);
            });
            
            confirmBtn.addEventListener('click', function() {
                const alipayAccount = document.getElementById('new-alipay-account').value.trim();
                const realName = document.getElementById('new-real-name').value.trim();
                
                if (!alipayAccount) {
                    showToast('ËØ∑ËæìÂÖ•ÊîØ‰ªòÂÆùË¥¶Âè∑', 'warning');
                    return;
                }
                
                if (!realName) {
                    showToast('ËØ∑ËæìÂÖ•ÁúüÂÆûÂßìÂêç', 'warning');
                    return;
                }
                
                // ‰øùÂ≠òÊîØ‰ªòÂÆù‰ø°ÊÅØ
                saveAlipayInfo(alipayAccount, realName);
                document.body.removeChild(dialog);
            });
        }
        
        // ÊòæÁ§∫ÂæÆ‰ø°ËÆæÁΩÆÂØπËØùÊ°Ü
        function showWechatSettingsModal() {
            // ÂàõÂª∫ÂØπËØùÊ°ÜÂÖÉÁ¥†
            const dialog = document.createElement('div');
            dialog.className = 'fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50';
            
            dialog.innerHTML = `
                <div class="bg-white rounded-lg w-11/12 max-w-md p-5">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">ËÆæÁΩÆÂæÆ‰ø°ÊèêÁé∞‰ø°ÊÅØ</h3>
                    
                    <div class="mb-4">
                        <label class="block text-gray-600 text-sm font-medium mb-2">‰∏ä‰º†Êî∂Ê¨æÁ†Å</label>
                        <div class="border-2 border-dashed border-gray-300 rounded-lg p-4 text-center cursor-pointer" id="qr-upload-area">
                            <i class="fas fa-cloud-upload-alt text-2xl text-gray-400 mb-2"></i>
                            <p class="text-gray-500">ÁÇπÂáª‰∏ä‰º†Êî∂Ê¨æÁ†Å</p>
                            <p class="text-xs text-gray-400 mt-1">ÊîØÊåÅ JPG„ÄÅPNG Ê†ºÂºè</p>
                        </div>
                        <input type="file" id="qr-file-input" accept="image/*" style="display: none;">
                    </div>
                    
                    <div class="flex justify-end">
                        <button class="px-4 py-2 text-gray-500 mr-2" id="cancel-wechat-btn">ÂèñÊ∂à</button>
                        <button class="px-4 py-2 bg-green-500 text-white rounded-md" id="confirm-wechat-btn">Á°ÆËÆ§</button>
                    </div>
                </div>
            `;
            
            // Ê∑ªÂä†Âà∞È°µÈù¢
            document.body.appendChild(dialog);
            
            // ÁªëÂÆö‰∫ã‰ª∂
            const cancelBtn = document.getElementById('cancel-wechat-btn');
            const confirmBtn = document.getElementById('confirm-wechat-btn');
            const qrUploadArea = document.getElementById('qr-upload-area');
            const qrFileInput = document.getElementById('qr-file-input');
            // Ê®°ÊÄÅÊ°ÜÂÜÖÁöÑÁÆÄÊòìÁä∂ÊÄÅÊù°
            let modalStatus; (function(){
                modalStatus = document.createElement('div');
                modalStatus.className = 'upload-status';
                modalStatus.innerHTML = '<div class="progress"><div class="progress-bar" style="width:0%"></div></div><div class="progress-text">ÂæÖ‰∏ä‰º†</div>';
                const container = dialog.querySelector('.bg-white');
                container.appendChild(modalStatus);
            })();
            
            // ÁÇπÂáª‰∏ä‰º†Âå∫ÂüüËß¶ÂèëÊñá‰ª∂ÈÄâÊã©
            qrUploadArea.addEventListener('click', function() {
                qrFileInput.click();
            });
            
            // Êñá‰ª∂ÈÄâÊã©‰∫ã‰ª∂
            qrFileInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    if (file.type.startsWith('image/')) {
                        const reader = new FileReader();
                        reader.onloadstart = function(){
                            // ÂêØÂä®‰∏ä‰º†ËøõÂ∫¶
                            const bar = modalStatus.querySelector('.progress-bar');
                            const text = modalStatus.querySelector('.progress-text');
                            bar.style.width = '10%';
                            text.textContent = '‰∏ä‰º†‰∏≠...';
                            // ÂàáÊç¢ÂÖ®Â±ÄÁä∂ÊÄÅ‰∏∫‰∏ä‰º†‰∏≠ÔºåÁ¶ÅÁî®ÊèêÁé∞
                            WechatUploadStatus.uploading(10);
                        };
                        reader.onprogress = function(evt){
                            if (evt.lengthComputable) {
                                const percent = Math.max(10, Math.min(95, Math.floor((evt.loaded/evt.total)*95)));
                                modalStatus.querySelector('.progress-bar').style.width = percent + '%';
                            }
                        };
                        reader.onload = function(e) {
                            qrUploadArea.innerHTML = `
                                <img src="${e.target.result}" alt="Êî∂Ê¨æÁ†Å" class="w-32 h-32 object-contain mx-auto mb-2">
                                <p class="text-green-500 text-sm">Êî∂Ê¨æÁ†ÅÂ∑≤‰∏ä‰º†</p>
                            `;
                            modalStatus.querySelector('.progress-bar').style.width = '100%';
                            modalStatus.querySelector('.progress-text').textContent = '‰∏ä‰º†ÊàêÂäü';
                            // Á≠âÂæÖ‰øùÂ≠òÂà∞ÊúçÂä°Âô®ÂÆåÊàêÂêéÂÜçÁΩÆ‰∏∫ÊàêÂäüÔºåËøôÈáå‰ªÖÈ¢ÑËßàÂÆåÊàê
                        };
                        reader.readAsDataURL(file);
                    } else {
                        showToast('ËØ∑ÈÄâÊã©ÂõæÁâáÊñá‰ª∂', 'warning');
                    }
                }
            });
            
            cancelBtn.addEventListener('click', function() {
                document.body.removeChild(dialog);
            });
            
            confirmBtn.addEventListener('click', function() {
                const qrFile = qrFileInput.files[0];
                if (!qrFile) {
                    showToast('ËØ∑ÂÖà‰∏ä‰º†Êî∂Ê¨æÁ†Å', 'warning');
                    return;
                }
                
                // ‰øùÂ≠òÂæÆ‰ø°Êî∂Ê¨æÁ†Å
                saveWechatInfo(qrFile);
                document.body.removeChild(dialog);
            });
        }
        
        // üîß ‰øÆÂ§çÔºö‰øùÂ≠òÊîØ‰ªòÂÆù‰ø°ÊÅØÔºàÂ¢ûÂº∫ÂÅ•Â£ÆÊÄßÔºâ
        async function saveAlipayInfo(account, name) {
            showLoading();
            try {
                console.log('üîÑ ÂºÄÂßã‰øùÂ≠òÊîØ‰ªòÂÆù‰ø°ÊÅØ(‰∏ÄËá¥ÊÄßÊ†°È™å+ÊúçÂä°Á´ØÂõûËØª)...');
                if (!currentUser) throw new Error('Êú™ÁôªÂΩï');
                const result = await PaymentDataSync.syncAlipayInfo(currentUser, account, name);
                if (!result.ok) throw result.error || new Error('‰øùÂ≠òÂ§±Ë¥•');
                // ‰ª•ÊúçÂä°Á´ØÂÜôÂõûÁöÑÊï∞ÊçÆÂØπÈΩêÊú¨Âú∞
                currentUser.alipay_account = account;
                currentUser.real_name = name;
                currentUser['ÊîØ‰ªòÂÆùË¥¶Âè∑'] = account;
                currentUser['ÁúüÂÆûÂßìÂêç'] = name;
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                updateAlipayDisplay(account, name);
                // ÂõûÂ°´Âà∞ÊâÄÊúâÂæÖÂ§ÑÁêÜÊèêÁé∞ËÆ∞ÂΩïÔºå‰æø‰∫éÂêéÂè∞Á´ãÂàªÊòæÁ§∫
                try {
                    const uid = currentUser.id || currentUser['Áî®Êà∑ID'];
                    if (uid) await WithdrawalBackfill.backfillPendingForUser(uid, account, name);
                } catch (_) {}
                hideLoading();
                showAlipaySuccessEffect(account, name);
                showToast('ÊîØ‰ªòÂÆù‰ø°ÊÅØÂ∑≤‰øùÂ≠òÔºåÁé∞Âú®ÂèØ‰ª•ÊèêÁé∞‰∫ÜÔºÅ', 'success');
                // ÂêØÁî®ÊåâÈíÆÔºàËã•ÈáëÈ¢ùÊúâÊïàÔºâ
                const submitBtn = document.getElementById('submit-withdrawal-btn');
                const amountInput = document.getElementById('withdraw-amount');
                const currentAmount = parseFloat(amountInput.value);
                if (submitBtn && !isNaN(currentAmount) && currentAmount >= 10 && currentAmount <= withdrawableAmount) {
                    submitBtn.removeAttribute('data-disabled');
                }
            } catch (error) {
                console.error('‚ùå ‰øùÂ≠òÊîØ‰ªòÂÆù‰ø°ÊÅØÂ§±Ë¥•:', error);
                hideLoading();
                showToast('Êõ¥Êñ∞ÊîØ‰ªòÂÆù‰ø°ÊÅØÂ§±Ë¥•Ôºö' + (error.message || 'Êú™Áü•ÈîôËØØ'), 'error');
            }
        }
        
        // üîß ËæÖÂä©ÂáΩÊï∞ÔºöÊõ¥Êñ∞ÊîØ‰ªòÂÆù‰ø°ÊÅØÊòæÁ§∫
        function updateAlipayDisplay(account, name) {
            try {
                // Êõ¥Êñ∞ÊòæÁ§∫ÁöÑË¥¶Âè∑‰ø°ÊÅØÔºà‰ΩøÁî®ÈÉ®ÂàÜÈöêËóèÁöÑÊ†ºÂºèÔºâ
                const displayAccount = account.length > 8 
                    ? account.substring(0, 3) + '****' + account.substring(account.length - 4) 
                    : account;
                
                const displayName = name.length > 0 
                    ? name.charAt(0) + '*' + (name.length > 1 ? name.charAt(name.length-1) : '')
                    : name;
                
                const accountElement = document.getElementById('alipay-account');
                const nameElement = document.getElementById('user-real-name');
                
                if (accountElement) {
                    accountElement.textContent = displayAccount;
                    console.log('‚úÖ ÊîØ‰ªòÂÆùË¥¶Âè∑ÊòæÁ§∫Â∑≤Êõ¥Êñ∞');
                }
                
                if (nameElement) {
                    nameElement.textContent = displayName;
                    console.log('‚úÖ ÁúüÂÆûÂßìÂêçÊòæÁ§∫Â∑≤Êõ¥Êñ∞');
                }
                
                // üÜï Êõ¥Êñ∞Áä∂ÊÄÅÂæΩÁ´†‰∏∫ÁªøËâ≤ÔºàÂ∑≤ËÆæÁΩÆÔºâ
                const statusBadge = document.getElementById('alipay-status-badge');
                if (statusBadge) {
                    statusBadge.className = 'ml-2 px-2 py-1 text-xs rounded-full bg-green-100 text-green-600';
                    statusBadge.textContent = '‚úÖ Â∑≤ËÆæÁΩÆ';
                    console.log('‚úÖ ÊîØ‰ªòÂÆùÁä∂ÊÄÅÂæΩÁ´†Â∑≤Êõ¥Êñ∞‰∏∫Â∑≤ËÆæÁΩÆ');
                }
                
                // üÜï ÈöêËóèËÆæÁΩÆÊèêÁ§∫
                const setupHint = document.getElementById('alipay-setup-hint');
                if (setupHint) {
                    setupHint.style.display = 'none';
                    console.log('‚úÖ ÊîØ‰ªòÂÆùËÆæÁΩÆÊèêÁ§∫Â∑≤ÈöêËóè');
                }
                
            } catch (displayError) {
                console.error('‚ùå Êõ¥Êñ∞ÊòæÁ§∫Â§±Ë¥•:', displayError);
            }
        }
        
        // ÂõæÁâáÂéãÁº©Ôºà‰øùÊåÅÊ∏ÖÊô∞ÔºåÈôêÂà∂ÊúÄÂ§ßËæπÔºâ
        function compressImage(file, maxSide = 480) {
            return new Promise((resolve, reject) => {
                const fr = new FileReader();
                fr.onload = () => {
                    const img = new Image();
                    img.onload = () => {
                        let { width, height } = img;
                        if (Math.max(width, height) > maxSide) {
                            if (width >= height) {
                                height = Math.round(height * (maxSide / width));
                                width = maxSide;
                            } else {
                                width = Math.round(width * (maxSide / height));
                                height = maxSide;
                            }
                        }
                        const canvas = document.createElement('canvas');
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        try {
                            const dataUrl = canvas.toDataURL('image/png');
                            resolve(dataUrl);
                        } catch (e) {
                            reject(e);
                        }
                    };
                    img.onerror = reject;
                    img.src = fr.result;
                };
                fr.onerror = reject;
                fr.readAsDataURL(file);
            });
        }

        // üîß ‰øÆÂ§çÔºö‰øùÂ≠òÂæÆ‰ø°‰ø°ÊÅØÔºàÂ¢ûÂº∫ÂÅ•Â£ÆÊÄß + ÂéãÁº©‰∏ä‰º†Ôºâ
        async function saveWechatInfo(qrFile) {
            showLoading();
            try {
                console.log('üîÑ ÂºÄÂßã‰øùÂ≠òÂæÆ‰ø°Êî∂Ê¨æÁ†Å...');
                const userId = currentUser.id || currentUser.Áî®Êà∑ID;
                if (!userId) {
                    console.error('‚ùå Êó†Ê≥ïËé∑ÂèñÁî®Êà∑ID:', currentUser);
                    hideLoading();
                    showToast('Áî®Êà∑‰ø°ÊÅØÂºÇÂ∏∏ÔºåËØ∑ÈáçÊñ∞ÁôªÂΩï', 'error');
                    return;
                }
                console.log('üìã Áî®Êà∑ID:', userId);

                // ÂéãÁº©Âπ∂ÂáÜÂ§áÊï∞ÊçÆ
                WechatUploadStatus.uploading(10);
                let qrCodeData;
                try {
                    qrCodeData = await compressImage(qrFile, 640);
                    WechatUploadStatus.uploading(80);
                } catch (ce) {
                    console.warn('‚ö†Ô∏è ÂéãÁº©Â§±Ë¥•Ôºå‰ΩøÁî®ÂéüÂõæ:', ce?.message || ce);
                    // ÂõûÈÄÄÂéüÂõæ
                    const tmp = await new Promise((resolve, reject) => {
                        const r = new FileReader();
                        r.onload = () => resolve(r.result);
                        r.onerror = reject;
                        r.readAsDataURL(qrFile);
                    });
                    qrCodeData = tmp;
                    WechatUploadStatus.uploading(60);
                }
                console.log('üìã Êî∂Ê¨æÁ†ÅÊï∞ÊçÆÂ§ßÂ∞è:', qrCodeData.length, 'Â≠óÁ¨¶');

                // Â§öÁ≠ñÁï•‰øùÂ≠ò
                let saveSuccess = false;
                let saveError = null;

                // Á≠ñÁï•1: Ëã±ÊñáÂ≠óÊÆµ + id
                try {
                    const { error } = await window.supabase
                        .from('users')
                        .update({ wechat_qr_code: qrCodeData })
                        .eq('id', userId)
                        .select();
                    if (!error) saveSuccess = true; else saveError = error;
                } catch (e1) { saveError = e1; }

                // Á≠ñÁï•2: ‰∏≠ÊñáÂ≠óÊÆµ + Áî®Êà∑ID
                if (!saveSuccess) {
                    try {
                        const { error } = await window.supabase
                            .from('users')
                            .update({ 'ÂæÆ‰ø°Êî∂Ê¨æÁ†Å': qrCodeData })
                            .eq('Áî®Êà∑ID', userId)
                            .select();
                        if (!error) saveSuccess = true; else saveError = error;
                    } catch (e2) { saveError = e2; }
                }

                // Á≠ñÁï•3: Âä®ÊÄÅÊ£ÄÊµã
                if (!saveSuccess) {
                    try {
                        const { data: sampleData } = await window.supabase.from('users').select('*').limit(1);
                        const available = Array.isArray(sampleData) && sampleData[0] ? Object.keys(sampleData[0]) : [];
                        let qrField = available.includes('ÂæÆ‰ø°Êî∂Ê¨æÁ†Å') ? 'ÂæÆ‰ø°Êî∂Ê¨æÁ†Å' : 'wechat_qr_code';
                        let idField = available.includes('Áî®Êà∑ID') ? 'Áî®Êà∑ID' : 'id';
                        const updateData = {}; updateData[qrField] = qrCodeData;
                        const { error } = await window.supabase.from('users').update(updateData).eq(idField, userId).select();
                        if (!error) saveSuccess = true; else saveError = error;
                    } catch (e3) { saveError = e3; }
                }

                if (!saveSuccess) {
                    hideLoading();
                    WechatUploadStatus.failed();
                    let errorMessage = 'Êõ¥Êñ∞ÂæÆ‰ø°Êî∂Ê¨æÁ†ÅÂ§±Ë¥•';
                    if (saveError) {
                        const msg = saveError.message || '';
                        if (msg.includes('permission')) errorMessage = 'Êï∞ÊçÆÂ∫ìÊùÉÈôê‰∏çË∂≥ÔºåËØ∑ËÅîÁ≥ªÁÆ°ÁêÜÂëò';
                        else if (msg.includes('column') || msg.includes('Â≠óÊÆµ')) errorMessage = 'Êï∞ÊçÆÂ∫ìÂ≠óÊÆµ‰∏çÂ≠òÂú®ÔºåËØ∑ËÅîÁ≥ªÊäÄÊúØÊîØÊåÅ';
                        else if (msg.includes('network') || msg.includes('fetch')) errorMessage = 'ÁΩëÁªúËøûÊé•Â§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúÂêéÈáçËØï';
                    }
                    showToast(errorMessage, 'error');
                    // Êú¨Âú∞ÂÖúÂ∫ï
                    currentUser.wechat_qr_code = qrCodeData;
                    currentUser['ÂæÆ‰ø°Êî∂Ê¨æÁ†Å'] = qrCodeData;
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    updateWechatDisplay(qrCodeData);
                    WechatUploadStatus.success();
                    showToast('Ê∑ªÂä†ÊàêÂäü', 'success');
                    return;
                }

                // ÊàêÂäü
                currentUser.wechat_qr_code = qrCodeData;
                currentUser['ÂæÆ‰ø°Êî∂Ê¨æÁ†Å'] = qrCodeData;
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                updateWechatDisplay(qrCodeData);
                hideLoading();
                WechatUploadStatus.success();
                showWechatSuccessEffect();
                const submitBtn = document.getElementById('submit-withdrawal-btn');
                const amountInput = document.getElementById('withdraw-amount');
                const currentAmount = parseFloat(amountInput.value);
                if (submitBtn && !isNaN(currentAmount) && currentAmount >= 10 && currentAmount <= withdrawableAmount) {
                    submitBtn.removeAttribute('data-disabled');
                }
            } catch (error) {
                console.error('‚ùå ‰øùÂ≠òÂæÆ‰ø°‰ø°ÊÅØÊó∂ÂèëÁîüÊú™È¢ÑÊúüÈîôËØØ:', error);
                hideLoading();
                WechatUploadStatus.failed();
                showToast('Á≥ªÁªüÈîôËØØÔºåËØ∑Á®çÂêéÈáçËØï', 'error');
            }
        }
        
        // üîß ËæÖÂä©ÂáΩÊï∞ÔºöÊõ¥Êñ∞ÂæÆ‰ø°Êî∂Ê¨æÁ†ÅÊòæÁ§∫
        function updateWechatDisplay(qrCodeData) {
            try {
                const qrDisplay = document.getElementById('qr-code-display');
                if (qrDisplay) {
                    qrDisplay.innerHTML = `
                        <img src="${qrCodeData}" alt="ÂæÆ‰ø°Êî∂Ê¨æÁ†Å" class="qr-preview">
                    `;
                    console.log('‚úÖ ÂæÆ‰ø°Êî∂Ê¨æÁ†ÅÊòæÁ§∫Â∑≤Êõ¥Êñ∞');
                }
            } catch (displayError) {
                console.error('‚ùå Êõ¥Êñ∞Êî∂Ê¨æÁ†ÅÊòæÁ§∫Â§±Ë¥•:', displayError);
            }
        }
        
        // Â§ÑÁêÜÊèêÁé∞ËØ∑Ê±Ç
        async function processWithdrawal(amount) {
            showLoading();
            // ËøõÂÖ•Â§ÑÁêÜ‰∏≠Áä∂ÊÄÅ
            WithdrawalStatus.processing('ÊèêÁé∞‰∏≠ÔºåËØ∑Á®çÂÄô...');
            
            try {
                console.log('ÂºÄÂßãÂ§ÑÁêÜÊèêÁé∞ËØ∑Ê±ÇÔºåÈáëÈ¢ù:', amount);
                
                // Ëé∑ÂèñÂΩìÂâçÈÄâÊã©ÁöÑÊèêÁé∞ÊñπÂºè
                const isAlipaySelected = document.getElementById('alipay-option').classList.contains('active');
                const isWechatSelected = document.getElementById('wechat-option').classList.contains('active');
                
                // Ê£ÄÊü•ÊèêÁé∞‰ø°ÊÅØÊòØÂê¶ÂÆåÊï¥
                if (isAlipaySelected) {
                    // Ê£ÄÊü•ÊîØ‰ªòÂÆùË¥¶Âè∑ÂíåÁúüÂÆûÂßìÂêçÊòØÂê¶Â∑≤ËÆæÁΩÆ
                    const alipayAccount = currentUser.alipay_account || currentUser.ÊîØ‰ªòÂÆùË¥¶Âè∑;
                    const realName = currentUser.real_name || currentUser.ÁúüÂÆûÂßìÂêç;
                    
                    if (!alipayAccount || !realName) {
                        hideLoading();
                        showToast('ËØ∑ÂÖàËÆæÁΩÆÊîØ‰ªòÂÆùË¥¶Âè∑ÂíåÁúüÂÆûÂßìÂêç', 'warning');
                        showAlipaySettingsModal(); // Ëá™Âä®ÊòæÁ§∫ËÆæÁΩÆÂØπËØùÊ°Ü
                        return;
                    }
                } else if (isWechatSelected) {
                    // Ê£ÄÊü•ÂæÆ‰ø°Êî∂Ê¨æÁ†ÅÊòØÂê¶Â∑≤ËÆæÁΩÆ
                    const wechatQRCode = currentUser.wechat_qr_code || currentUser.ÂæÆ‰ø°Êî∂Ê¨æÁ†Å;
                    
                    if (!wechatQRCode) {
                        hideLoading();
                        showToast('ËØ∑ÂÖà‰∏ä‰º†ÂæÆ‰ø°Êî∂Ê¨æÁ†Å', 'warning');
                        showWechatSettingsModal(); // Ëá™Âä®ÊòæÁ§∫ËÆæÁΩÆÂØπËØùÊ°Ü
                        return;
                    }
                }
                
                // ËÆ∞ÂΩïÈÄâÊã©Ôºå‰æø‰∫éÂêéÁª≠ÂõûÂ°´
                WithdrawalMethodSync.rememberSelection();
                // Ë∞ÉÁî®ÁßªÂä®Á´ØÊèêÁé∞Â§ÑÁêÜÊ®°Âùó
                if (window.WithdrawalModule && typeof window.WithdrawalModule.processWithdrawal === 'function') {
                    await window.WithdrawalModule.processWithdrawal(amount);
                    
                    // ÊèêÁé∞ÊàêÂäüÂêéÊõ¥Êñ∞È°µÈù¢ÊòæÁ§∫
                    updatePageAfterWithdrawal(amount);
                } else {
                    // Â¶ÇÊûúÊ®°Âùó‰∏çÂèØÁî®ÔºåËá™Ë°åÂ§ÑÁêÜÊèêÁé∞ÈÄªËæë
                    await fallbackProcessWithdrawal(amount);
                }
                
                // Âº∫Âà∂ÂÖ≥Èó≠Âä†ËΩΩÊåáÁ§∫Âô®ÔºåÈÅøÂÖçÊÆãÁïô
                try { hideLoading(); } catch(_) {}
                
            } catch (error) {
                console.error('ÊèêÁé∞Â§ÑÁêÜÂ§±Ë¥•:', error);
                hideLoading(); // Âè™ÊúâÂú®Âá∫ÈîôÊó∂ÊâçÈöêËóèÂä†ËΩΩÊåáÁ§∫Âô®
                WithdrawalStatus.failed('ÊèêÁé∞Â§±Ë¥•Ôºö' + (error.message || 'Êú™Áü•ÈîôËØØ'));
                showToast('ÊèêÁé∞Â§±Ë¥•: ' + (error.message || 'Êú™Áü•ÈîôËØØ'), 'error');
            }
        }
        
        // ÊèêÁé∞ÊàêÂäüÂêéÊõ¥Êñ∞È°µÈù¢ÊòæÁ§∫
        function updatePageAfterWithdrawal(amount) {
            try {
                // Êõ¥Êñ∞ÂèØÊèêÁé∞ÈáëÈ¢ùÊòæÁ§∫
                const withdrawableAmountElement = document.getElementById('withdrawable-amount');
                if (withdrawableAmountElement) {
                    withdrawableAmountElement.textContent = '0.00';
                }
                
                // Ê∏ÖÁ©∫ÊèêÁé∞ÈáëÈ¢ùËæìÂÖ•Ê°Ü
                const amountInput = document.getElementById('withdraw-amount');
                if (amountInput) {
                    amountInput.value = '';
                }
                
                // Á¶ÅÁî®ÊèêÁé∞ÊåâÈíÆ
                const submitBtn = document.getElementById('submit-withdrawal-btn');
                if (submitBtn) {
                    submitBtn.setAttribute('data-disabled', 'true');
                }
                
                // ÊòæÁ§∫ÊàêÂäüÊèêÁ§∫
                WithdrawalStatus.success('ÊèêÁé∞ÊàêÂäüÔºåÁ≠âÂæÖÂÆ°Ê†∏ÊâìÊ¨æ');
                showToast('ÊèêÁé∞Áî≥ËØ∑Â∑≤Êèê‰∫§ÔºÅÈáëÈ¢ùÂ∑≤ÂÜªÁªìÔºåÁ≠âÂæÖÁÆ°ÁêÜÂëòÂÆ°Ê†∏ÂíåÊâìÊ¨æ', 'success');
                
                // 2ÁßíÂêéËøîÂõû‰∏ä‰∏ÄÈ°µ
                setTimeout(() => {
                    history.back();
                }, 2000);
                
            } catch (error) {
                console.error('Êõ¥Êñ∞È°µÈù¢ÊòæÁ§∫Êó∂Âá∫Èîô:', error);
                // Âç≥‰ΩøÊõ¥Êñ∞È°µÈù¢ÊòæÁ§∫Â§±Ë¥•Ôºå‰πü‰∏çÂΩ±ÂìçÊèêÁé∞ÁöÑÊàêÂäüÁä∂ÊÄÅ
            }
        }
        
        // Â§áÁî®ÊèêÁé∞Â§ÑÁêÜÈÄªËæë
        async function fallbackProcessWithdrawal(amount) {
            // 1. Ëé∑ÂèñÁî®Êà∑ID
            const userId = currentUser.id || currentUser.Áî®Êà∑ID;
            
            if (!userId) {
                throw new Error('Êó†Ê≥ïËé∑ÂèñÁî®Êà∑ID');
            }
            
            // 2. Á°ÆÂÆöÈí±ÂåÖÂ≠óÊÆµ
            const walletField = getWalletField(currentUser);
            
            // 3. ÂàõÂª∫ÊèêÁé∞ËÆ∞ÂΩïÔºàÂåÖÂê´ÊîØ‰ªòÂÆù‰ø°ÊÅØÂíåÊèêÁé∞ÊñπÂºèÔºâ
            
            // üéØ Ëé∑ÂèñÂΩìÂâçÈÄâÊã©ÁöÑÊèêÁé∞ÊñπÂºè
            const isAlipaySelected = document.getElementById('alipay-option').classList.contains('active');
            const isWechatSelected = document.getElementById('wechat-option').classList.contains('active');
            const paymentMethod = isWechatSelected ? 'wechat' : 'alipay';
            
            // üéØ Ëé∑ÂèñÊîØ‰ªòÂÆù‰ø°ÊÅØ
            const alipayAccount = currentUser.alipay_account || currentUser.ÊîØ‰ªòÂÆùË¥¶Âè∑ || '';
            const realName = currentUser.real_name || currentUser.ÁúüÂÆûÂßìÂêç || '';
            const wechatQRCode = currentUser.wechat_qr_code || currentUser.ÂæÆ‰ø°Êî∂Ê¨æÁ†Å || '';
            
            console.log('üí≥ ÊèêÁé∞ÊñπÂºè:', paymentMethod);
            console.log('üí∞ ÊîØ‰ªòÂÆùË¥¶Âè∑:', alipayAccount);
            console.log('üë§ ÁúüÂÆûÂßìÂêç:', realName);
            console.log('üì± ÂæÆ‰ø°Êî∂Ê¨æÁ†Å:', wechatQRCode ? 'Â∑≤ËÆæÁΩÆ' : 'Êú™ËÆæÁΩÆ');
            
            // üîß ÂÆπÈîôÁ≠ñÁï•ÔºöÂÖàÂ∞ùËØï‰øùÂ≠òÂÆåÊï¥‰ø°ÊÅØÔºåÂ§±Ë¥•ÂàôÂõûÈÄÄÂà∞Âü∫Á°ÄÂ≠óÊÆµ
            let insertError;
            
            // Á≠ñÁï•1ÔºöÂ∞ùËØï‰øùÂ≠òÂåÖÂê´ÊîØ‰ªò‰ø°ÊÅØÂíåÊèêÁé∞ÊñπÂºèÁöÑÂÆåÊï¥ËÆ∞ÂΩï
            try {
                console.log('üîÑ Â∞ùËØï‰øùÂ≠òÂÆåÊï¥ÊèêÁé∞ËÆ∞ÂΩïÔºàÂåÖÂê´ÊîØ‰ªò‰ø°ÊÅØÔºâ...');
                const base = { user_id: userId, amount, status: 'pending', created_at: new Date().toISOString() };
                const payload = await WithdrawalMethodSync.buildInsertPayload(base);
                const { data, error } = await window.supabase
                    .from('withdrawals')
                    .insert([payload])
                    .select();
                    
                if (error) {
                    console.warn('‚ö†Ô∏è ÂÆåÊï¥ËÆ∞ÂΩï‰øùÂ≠òÂ§±Ë¥•ÔºåÂèØËÉΩÊòØÂ≠óÊÆµ‰∏çÂ≠òÂú®:', error.message);
                    throw error; // Ëß¶ÂèëÂõûÈÄÄÁ≠ñÁï•
                }
                
                console.log('‚úÖ ÂÆåÊï¥ÊèêÁé∞ËÆ∞ÂΩï‰øùÂ≠òÊàêÂäüÔºÅ');
                try { if (data && data[0]?.id) await WithdrawalMethodSync.ensureRecordHasMethod(data[0].id); } catch(_) {}
                
            } catch (fullInsertError) {
                console.log('üîÑ ÂõûÈÄÄÂà∞Âü∫Á°ÄÂ≠óÊÆµ‰øùÂ≠òÁ≠ñÁï•...');
                
                // Á≠ñÁï•2ÔºöÂõûÈÄÄÂà∞Âè™‰øùÂ≠òÂü∫Á°ÄÂ≠óÊÆµ
                try {
                    const { data, error } = await window.supabase
                        .from('withdrawals')
                        .insert([{
                            user_id: userId,
                            amount: amount,
                            status: 'pending',
                            created_at: new Date().toISOString()
                        }])
                        .select();
                        
                    if (error) {
                        throw new Error('Âü∫Á°ÄÊèêÁé∞ËÆ∞ÂΩï‰øùÂ≠ò‰πüÂ§±Ë¥•: ' + error.message);
                    }
                    
                    console.log('‚úÖ Âü∫Á°ÄÊèêÁé∞ËÆ∞ÂΩï‰øùÂ≠òÊàêÂäüÔºàÊîØ‰ªò‰ø°ÊÅØÂ∞Ü‰ªéÁî®Êà∑Ë°®Ëé∑ÂèñÔºâ');
                    try { if (data && data[0]?.id) await WithdrawalMethodSync.ensureRecordHasMethod(data[0].id); } catch(_) {}
                    insertError = null;
                    
                } catch (basicInsertError) {
                    insertError = basicInsertError;
                    console.error('‚ùå ÊâÄÊúâÊèêÁé∞ËÆ∞ÂΩï‰øùÂ≠òÁ≠ñÁï•ÈÉΩÂ§±Ë¥•‰∫Ü:', basicInsertError);
                }
            }
                
            if (insertError) {
                console.error('ÂàõÂª∫ÊèêÁé∞ËÆ∞ÂΩïÂ§±Ë¥•:', insertError);
            }
            
            // üîß Êó†ËÆ∫Â¶Ç‰ΩïÔºåÈÉΩ‰øùÂ≠òÊîØ‰ªòÊñπÂºè‰ø°ÊÅØÂà∞localStorageÔºàÁî®‰∫éadminÊòæÁ§∫Ôºâ
            try {
                const withdrawalPaymentInfo = {
                    // ‰ΩøÁî®Êó∂Èó¥Êà≥‰Ωú‰∏∫‰∏¥Êó∂IDÔºåÂõ†‰∏∫Êàë‰ª¨Êó†Ê≥ïËé∑ÂèñÂÆûÈôÖÁöÑwithdrawal ID
                    withdrawalId: 'fallback_' + Date.now(),
                    paymentMethod: paymentMethod,
                    alipayAccount: alipayAccount,
                    realName: realName,
                    wechatQRCode: wechatQRCode,
                    timestamp: new Date().toISOString()
                };
                
                localStorage.setItem('lastWithdrawalPaymentInfo', JSON.stringify(withdrawalPaymentInfo));
                
                const withdrawalHistory = JSON.parse(localStorage.getItem('withdrawalPaymentHistory') || '[]');
                withdrawalHistory.push(withdrawalPaymentInfo);
                if (withdrawalHistory.length > 50) {
                    withdrawalHistory.splice(0, withdrawalHistory.length - 50);
                }
                localStorage.setItem('withdrawalPaymentHistory', JSON.stringify(withdrawalHistory));
                
                console.log('‚úÖ ÊîØ‰ªòÊñπÂºè‰ø°ÊÅØÂ∑≤‰øùÂ≠òÂà∞localStorage (fallback):', withdrawalPaymentInfo);
            } catch (e) {
                console.warn('‰øùÂ≠òÊîØ‰ªò‰ø°ÊÅØÂà∞localStorageÂ§±Ë¥•:', e);
            }
            
            // 4. Êõ¥Êñ∞ÂèØÊèêÁé∞ÈáëÈ¢ù
            withdrawableAmount -= amount;
            
            // 5. Êõ¥Êñ∞ÁïåÈù¢ÊòæÁ§∫
            document.getElementById('withdrawable-amount').textContent = withdrawableAmount.toFixed(2);
            document.getElementById('withdraw-amount').value = '';
            document.getElementById('submit-withdrawal-btn').setAttribute('data-disabled', 'true');
            
            // ÊòæÁ§∫ÊàêÂäüÊèêÁ§∫
            WithdrawalStatus.success('ÊèêÁé∞ÊàêÂäüÔºåÁ≠âÂæÖÂÆ°Ê†∏ÊâìÊ¨æ');
            showToast('ÊèêÁé∞Áî≥ËØ∑Â∑≤Êèê‰∫§ÔºåÂ∞ÜÂú®1-3‰∏™Â∑•‰ΩúÊó•ÂÜÖÂà∞Ë¥¶', 'success');
            
            // 2ÁßíÂêéËøîÂõû‰∏ä‰∏ÄÈ°µ
            setTimeout(() => {
                history.back();
            }, 2000);
        }
        
        // ÊòæÁ§∫Âä†ËΩΩÊåáÁ§∫Âô®
        function showLoading() {
            const loading = document.getElementById('loadingIndicator');
            if (loading) {
                loading.style.display = 'flex';
            }
        }
        
        // ÈöêËóèÂä†ËΩΩÊåáÁ§∫Âô®
        function hideLoading() {
            const loading = document.getElementById('loadingIndicator');
            if (loading) {
                loading.style.display = 'none';
            }
        }
        
        // üö® Âº∫Âà∂‰øÆÂ§çÔºöToastÊòæÁ§∫ÂáΩÊï∞ - Âº∫Âà∂Â∫ïÈÉ®ÊòæÁ§∫
        function showToast(message, type = 'info') {
            console.log('üö® showToastË¢´Ë∞ÉÁî®:', message, type);
            
            const toast = document.getElementById('toastMessage');
            const toastContainer = document.querySelector('.toast-container');
            
            if (!toast || !toastContainer) {
                console.error('‚ùå ToastÂÖÉÁ¥†‰∏çÂ≠òÂú®Ôºå‰ΩøÁî®alertÂ§áÁî®');
                alert('‚ö†Ô∏è ' + message);
                return;
            }
            
            // üö® Âº∫Âà∂ËÆæÁΩÆToastÂÆπÂô®‰ΩçÁΩÆÂà∞Â∫ïÈÉ®
            console.log('üîß Âº∫Âà∂ËÆæÁΩÆToastÂÆπÂô®Âà∞Â∫ïÈÉ®‰ΩçÁΩÆ');
            toastContainer.style.position = 'fixed';
            toastContainer.style.top = 'auto';
            toastContainer.style.bottom = '120px';
            toastContainer.style.left = '50%';
            toastContainer.style.transform = 'translateX(-50%)';
            toastContainer.style.width = '90%';
            toastContainer.style.maxWidth = '350px';
            toastContainer.style.zIndex = '99999';
            
            // üö® Âº∫Âà∂ËÆæÁΩÆToastÊ∂àÊÅØÊ†∑Âºè
            toast.style.padding = '16px 20px';
            toast.style.borderRadius = '12px';
            toast.style.fontSize = '16px';
            toast.style.fontWeight = '500';
            toast.style.boxShadow = '0 8px 24px rgba(0,0,0,0.4)';
            toast.style.width = '100%';
            toast.style.textAlign = 'center';
            toast.style.margin = '0';
            toast.style.minWidth = 'auto';
            
            // Ê∏ÖÈô§‰πãÂâçÁöÑÊòæÁ§∫Áä∂ÊÄÅ
            toast.classList.remove('show');
            
            // ËÆæÁΩÆÈ¢úËâ≤Ê†∑Âºè
            if (type === 'success') {
                toast.style.backgroundColor = '#10b981';
            } else if (type === 'error') {
                toast.style.backgroundColor = '#ef4444';
            } else if (type === 'warning') {
                toast.style.backgroundColor = '#f59e0b';
            } else {
                toast.style.backgroundColor = 'rgba(0,0,0,0.8)';
            }
            
            // ËÆæÁΩÆÊ∂àÊÅØÂÜÖÂÆπ
            toast.textContent = message;
            
            // Á´ãÂç≥ÊòæÁ§∫Toast
            setTimeout(() => {
                toast.classList.add('show');
                console.log('‚úÖ ToastÂ∑≤Âº∫Âà∂ÊòæÁ§∫Âú®Â∫ïÈÉ®:', message);
                
                // È™åËØÅ‰ΩçÁΩÆ
                const computedStyle = window.getComputedStyle(toastContainer);
                console.log('üîç Toast‰ΩçÁΩÆÈ™åËØÅ:', {
                    position: computedStyle.position,
                    top: computedStyle.top,
                    bottom: computedStyle.bottom,
                    left: computedStyle.left,
                    width: computedStyle.width
                });
            }, 10);
            
            // 3ÁßíÂêéËá™Âä®ÈöêËóè
            setTimeout(() => {
                toast.classList.remove('show');
                console.log('üîÑ ToastÂ∑≤ÈöêËóè');
            }, 3000);
        }
        
        // üéâ ÊòæÁ§∫ÊàêÂäüÊïàÊûúÂºπÁ™ó
        function showSuccessModal(title, message, onConfirm) {
            // ÂàõÂª∫ÊàêÂäüÂºπÁ™ó
            const overlay = document.createElement('div');
            overlay.className = 'success-overlay';
            
            overlay.innerHTML = `
                <div class="success-modal">
                    <div class="success-icon">
                        <i class="fas fa-check"></i>
                    </div>
                    <h3 class="success-title">${title}</h3>
                    <p class="success-message">${message}</p>
                    <button class="success-button" onclick="closeSuccessModal(this)">
                        <i class="fas fa-thumbs-up"></i> Á°ÆÂÆö
                    </button>
                </div>
            `;
            
            // Ê∑ªÂä†Âà∞È°µÈù¢
            document.body.appendChild(overlay);
            
            // ÁªëÂÆöÂÖ≥Èó≠‰∫ã‰ª∂
            overlay.addEventListener('click', function(e) {
                if (e.target === overlay) {
                    closeSuccessModal(overlay);
                }
            });
            
            // Ëá™Âä®ÂÖ≥Èó≠Ôºà3ÁßíÂêéÔºâ
            setTimeout(() => {
                if (document.body.contains(overlay)) {
                    closeSuccessModal(overlay);
                }
            }, 3000);
            
            // Â≠òÂÇ®ÂõûË∞ÉÂáΩÊï∞
            if (onConfirm) {
                overlay._onConfirm = onConfirm;
            }
        }
        
        // ÂÖ≥Èó≠ÊàêÂäüÂºπÁ™ó
        function closeSuccessModal(element) {
            const overlay = element.closest ? element.closest('.success-overlay') : element;
            
            if (overlay && overlay._onConfirm) {
                overlay._onConfirm();
            }
            
            if (overlay && overlay.parentNode) {
                overlay.style.opacity = '0';
                setTimeout(() => {
                    if (overlay.parentNode) {
                        overlay.parentNode.removeChild(overlay);
                    }
                }, 200);
            }
        }
        
        // üéâ Ê∑ªÂä†ÊàêÂäüÊ†áËØÜÂà∞‰ø°ÊÅØÊòæÁ§∫Âå∫Âüü
        function addSuccessBadge(targetElementId, text) {
            const targetElement = document.getElementById(targetElementId);
            if (targetElement) {
                // ÁßªÈô§Â∑≤Â≠òÂú®ÁöÑÊàêÂäüÊ†áËØÜ
                const existingBadge = targetElement.parentNode.querySelector('.success-badge');
                if (existingBadge) {
                    existingBadge.remove();
                }
                
                // ÂàõÂª∫Êñ∞ÁöÑÊàêÂäüÊ†áËØÜ
                const badge = document.createElement('span');
                badge.className = 'success-badge';
                badge.innerHTML = `<i class="fas fa-check-circle"></i>${text}`;
                
                // Ê∑ªÂä†Âà∞ÁõÆÊ†áÂÖÉÁ¥†ÂêéÈù¢
                targetElement.parentNode.appendChild(badge);
                
                // 5ÁßíÂêéËá™Âä®ÁßªÈô§
                setTimeout(() => {
                    if (badge.parentNode) {
                        badge.style.opacity = '0';
                        setTimeout(() => {
                            if (badge.parentNode) {
                                badge.parentNode.removeChild(badge);
                            }
                        }, 300);
                    }
                }, 5000);
            }
        }
        
        // üéâ ÊîØ‰ªòÂÆù‰ø°ÊÅØ‰øùÂ≠òÊàêÂäüÊïàÊûúÔºàÁÆÄÂåñÁâàÔºâ
        function showAlipaySuccessEffect(account, name) {
            // ÁÆÄÂçïÁöÑÊàêÂäüÊèêÁ§∫
            showToast('‰øÆÊîπÊàêÂäü', 'success');
            console.log('‚úÖ ÊîØ‰ªòÂÆù‰ø°ÊÅØ‰øÆÊîπÊàêÂäü');
        }
        
        // üéâ ÂæÆ‰ø°Êî∂Ê¨æÁ†Å‰øùÂ≠òÊàêÂäüÊïàÊûúÔºàÁÆÄÂåñÁâàÔºâ
        function showWechatSuccessEffect() {
            // ÁÆÄÂçïÁöÑÊàêÂäüÊèêÁ§∫
            showToast('Ê∑ªÂä†ÊàêÂäü', 'success');
            console.log('‚úÖ ÂæÆ‰ø°Êî∂Ê¨æÁ†ÅÊ∑ªÂä†ÊàêÂäü');
        }

        // =====================
        // ÂæÆ‰ø°Êî∂Ê¨æÁ†Å‰∏ä‰º†Áä∂ÊÄÅÁÆ°ÁêÜ
        // =====================
        const WechatUploadStatus = (() => {
            const states = { idle: 'idle', uploading: 'uploading', success: 'success', failed: 'failed' };
            let currentState = states.idle;
            const textMap = {
                idle: 'ÂæÖ‰∏ä‰º†',
                uploading: '‰∏ä‰º†‰∏≠...',
                success: '‰∏ä‰º†ÊàêÂäü',
                failed: '‰∏ä‰º†Â§±Ë¥•'
            };
            function set(state, progress) {
                const box = document.getElementById('wechat-upload-status');
                const bar = document.getElementById('wechat-upload-bar');
                const label = document.getElementById('wechat-upload-text');
                if (!box || !bar || !label) return;
                currentState = state;
                box.classList.remove('hidden');
                label.textContent = textMap[state] || '';
                if (state === states.uploading) {
                    bar.style.width = Math.max(5, Math.min(progress || 10, 95)) + '%';
                } else if (state === states.success) {
                    bar.style.width = '100%';
                } else if (state === states.failed) {
                    bar.style.width = '0%';
                } else {
                    bar.style.width = '0%';
                }
                // Ê†πÊçÆÁä∂ÊÄÅÊõ¥Êñ∞Êèê‰∫§ÊåâÈíÆÂèØÁî®ÊÄßÔºà‰ªÖÂΩìÈÄâÊã©‰∫ÜÂæÆ‰ø°ÊèêÁé∞Êó∂Ôºâ
                try { updateSubmitAvailabilityForWeChat(); } catch(_) {}
            }
            return {
                idle: () => set(states.idle, 0),
                uploading: (p) => set(states.uploading, p),
                success: () => set(states.success, 100),
                failed: () => set(states.failed, 0),
                getState: () => currentState,
                states
            };
        })();

        // Ê†πÊçÆÂæÆ‰ø°‰∏ä‰º†Áä∂ÊÄÅ‰∏éÈáëÈ¢ùÊúâÊïàÊÄßÊéßÂà∂Êèê‰∫§ÊåâÈíÆ
        function updateSubmitAvailabilityForWeChat() {
            const wechatSelected = document.getElementById('wechat-option')?.classList.contains('active');
            if (!wechatSelected) return;
            const submitBtn = document.getElementById('submit-withdrawal-btn');
            if (!submitBtn) return;
            const amountInput = document.getElementById('withdraw-amount');
            const value = parseFloat(amountInput?.value || '0');
            const amountOk = !isNaN(value) && value >= 10 && value <= withdrawableAmount;
            const qr = currentUser?.wechat_qr_code || currentUser?.['ÂæÆ‰ø°Êî∂Ê¨æÁ†Å'];
            const state = WechatUploadStatus.getState();
            if (!qr || state !== WechatUploadStatus.states.success || !amountOk) {
                submitBtn.setAttribute('data-disabled', 'true');
            } else {
                submitBtn.removeAttribute('data-disabled');
            }
        }
    </script>
    
    <!-- üîß ÊîØ‰ªòÂÆù‰ø°ÊÅØÊòæÁ§∫‰øÆÂ§çËÑöÊú¨ÔºàÊú¨Âú∞ÁâàÔºå‰∏ç‰æùËµñAPIÔºâ -->
    <script src="fix-alipay-display-local.js"></script>
</body>
</html>