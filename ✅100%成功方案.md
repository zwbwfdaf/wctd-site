# ✅ 100%成功方案 - 分步执行

## 🎯 问题原因

`auth.uid()` 在SQL编辑器中可能返回null，导致插入失败。

**解决方法**：分两步执行，手动替换UUID。

---

## 第1步：只创建表（100%成功）

**复制下面的SQL，粘贴到Supabase执行**：

```sql
-- 只创建表，不插入数据
CREATE TABLE IF NOT EXISTS leaders (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID NOT NULL UNIQUE,
  level VARCHAR(20) DEFAULT 'bronze',
  invite_code VARCHAR(10) UNIQUE NOT NULL,
  total_members INT DEFAULT 0,
  level1_members INT DEFAULT 0,
  level2_members INT DEFAULT 0,
  level3_members INT DEFAULT 0,
  total_commission DECIMAL(10,2) DEFAULT 0,
  pending_commission DECIMAL(10,2) DEFAULT 0,
  status VARCHAR(20) DEFAULT 'active',
  created_at TIMESTAMP DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS team_members (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  leader_id UUID NOT NULL,
  member_id UUID NOT NULL,
  level INT NOT NULL,
  contribution DECIMAL(10,2) DEFAULT 0,
  status VARCHAR(20) DEFAULT 'active',
  joined_at TIMESTAMP DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS leader_commissions (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  leader_id UUID NOT NULL,
  type VARCHAR(20) NOT NULL,
  amount DECIMAL(10,2) NOT NULL,
  source_user_id UUID NOT NULL,
  source_description TEXT,
  status VARCHAR(20) DEFAULT 'pending',
  created_at TIMESTAMP DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS leader_levels (
  level VARCHAR(20) PRIMARY KEY,
  name VARCHAR(50),
  required_members INT,
  commission_rate_1 DECIMAL(5,2)
);

INSERT INTO leader_levels VALUES
('bronze', '青铜团长', 0, 5.00),
('silver', '白银团长', 10, 8.00),
('gold', '黄金团长', 50, 10.00),
('platinum', '铂金团长', 100, 12.00),
('diamond', '钻石团长', 200, 15.00)
ON CONFLICT DO NOTHING;

SELECT '✅ 表创建成功！' as 结果;
```

**看到 "✅ 表创建成功！" 就OK！**

---

## 第2步：查询你的用户ID

**新建一个查询，执行**：

```sql
SELECT id, email FROM auth.users;
```

**你会看到类似这样的结果**：
```
id: be9d66f3-46bd-4702-a9e5-fc715cca5bfa
email: zwq200394@qq.com
```

**复制那个ID**（鼠标选中整个UUID → 右键复制）

例如：`be9d66f3-46bd-4702-a9e5-fc715cca5bfa`

---

## 第3步：添加团长数据（粘贴你的ID）

**复制下面的SQL**，**把第2行的UUID替换成你刚才复制的ID**，然后执行：

```sql
INSERT INTO leaders (user_id, level, invite_code, level1_members, total_members)
VALUES (
  'be9d66f3-46bd-4702-a9e5-fc715cca5bfa',  -- ⚠️ 粘贴你的UUID！
  'gold',
  'R8da6a3N',
  2,
  2
);

SELECT '✅ 团长添加成功！' as 结果;
SELECT * FROM leaders;
```

**应该看到你的团长数据！**

---

## 第4步：添加测试佣金

**先查询你的团长ID**：

```sql
SELECT id, user_id, invite_code FROM leaders;
```

**复制 leader_id**（第一列的UUID）

**然后执行**（替换leader_id和user_id）：

```sql
INSERT INTO leader_commissions (leader_id, type, amount, source_user_id, source_description)
VALUES (
  '这里粘贴leader_id',  -- ⚠️ 粘贴你的leader_id
  'level1',
  50.00,
  '这里粘贴user_id',    -- ⚠️ 粘贴你的user_id
  '测试佣金'
);

SELECT '✅ 佣金添加成功！' as 结果;
```

---

## ✅ 验证所有数据

```sql
-- 查看所有表的数据量
SELECT 
  'leaders' as 表名, COUNT(*) as 记录数 FROM leaders
UNION ALL
SELECT 'team_members', COUNT(*) FROM team_members
UNION ALL
SELECT 'leader_commissions', COUNT(*) FROM leader_commissions
UNION ALL
SELECT 'leader_levels', COUNT(*) FROM leader_levels;
```

**应该看到**：
```
leaders           | 1
team_members      | 0
leader_commissions| 1
leader_levels     | 5
```

---

## 🎯 完成检查清单

- [ ] 第1步：创建表 - 看到"表创建成功"
- [ ] 第2步：查询user_id - 复制到了UUID
- [ ] 第3步：添加团长 - 看到"团长添加成功"
- [ ] 第4步：添加佣金 - 看到"佣金添加成功"
- [ ] 验证：查询显示正确的记录数

---

## 📝 示例（跟着做）

### 假设你查到的ID是：`be9d66f3-46bd-4702-a9e5-fc715cca5bfa`

**添加团长**：
```sql
INSERT INTO leaders (user_id, level, invite_code, level1_members, total_members)
VALUES (
  'be9d66f3-46bd-4702-a9e5-fc715cca5bfa',  -- 你的真实ID
  'gold',
  'R8da6a3N',
  2,
  2
);
```

**添加佣金**：
```sql
-- 先查leaders表得到leader_id
SELECT id FROM leaders WHERE user_id = 'be9d66f3-46bd-4702-a9e5-fc715cca5bfa';
-- 假设得到 leader_id: xxx-yyy-zzz

INSERT INTO leader_commissions (leader_id, type, amount, source_user_id, source_description)
VALUES (
  'xxx-yyy-zzz',  -- leader_id
  'level1',
  50.00,
  'be9d66f3-46bd-4702-a9e5-fc715cca5bfa',  -- user_id
  '测试佣金'
);
```

---

## 🚨 重要提醒

### UUID格式要求
✅ 正确：`'be9d66f3-46bd-4702-a9e5-fc715cca5bfa'`（有单引号）  
❌ 错误：`be9d66f3-46bd-4702-a9e5-fc715cca5bfa`（没有引号）  
❌ 错误：`"be9d66f3-46bd-4702-a9e5-fc715cca5bfa"`（双引号）  
❌ 错误：`'你的user_id'`（没有替换）

---

## 🎉 成功后

所有步骤完成后，在SQL编辑器执行：

```sql
SELECT * FROM leaders WHERE invite_code = 'R8da6a3N';
```

应该能看到你的团长数据！

---

**立即开始第1步：创建表！** 复制上面第1步的SQL执行！

