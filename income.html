<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#667eea">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta name="income-version" content="2.4.0">
    <title>æ”¶ç›Šä¸­å¿ƒ - KKæœç´¢ä»»åŠ¡å¹³å°</title>
    <!-- ç´§æ€¥æ•°æ®åº“ä¿®å¤å™¨ -->
    <script src="emergency-database-fix.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="theme.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
        }
        
        /* é¡¶éƒ¨å¯¼èˆªæ  */
        .navbar {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            padding: 16px 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .navbar .title {
            color: white;
            font-size: 18px;
            font-weight: 600;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
        }
        
        .navbar .title i {
            margin-right: 8px;
        }
        
        /* æ”¶ç›Šæ€»è§ˆå¡ç‰‡ */
        .earnings-overview {
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .main-earnings-card {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(20px);
            border-radius: 24px;
            padding: 28px 24px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            position: relative;
            overflow: hidden;
        }
        
        .main-earnings-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #ff6b6b, #feca57, #48dbfb, #ff9ff3);
        }
        
        .main-balance {
            text-align: center;
            margin-bottom: 24px;
        }
        
        .balance-label {
            color: rgba(255, 255, 255, 0.9);
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 8px;
        }
        
        .balance-amount {
            color: white;
            font-size: 36px;
            font-weight: 700;
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            margin-bottom: 4px;
        }
        
        .sync-status {
            color: rgba(255, 255, 255, 0.8);
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        
        .earnings-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-top: 24px;
        }
        
        .stat-item {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 16px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .stat-label {
            color: rgba(255, 255, 255, 0.8);
            font-size: 12px;
            font-weight: 500;
            margin-bottom: 8px;
        }
        
        .stat-value {
            color: white;
            font-size: 20px;
            font-weight: 700;
            text-shadow: 0 1px 4px rgba(0, 0, 0, 0.2);
        }
        
        /* æ“ä½œæŒ‰é’®åŒºåŸŸ */
        .action-buttons {
            padding: 0 20px 20px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        
        .action-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 16px;
            padding: 14px 20px;
            color: white;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            backdrop-filter: blur(10px);
        }
        
        .action-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-1px);
        }
        
        .action-btn.primary {
            background: linear-gradient(135deg, #ff6b6b, #feca57);
            border-color: rgba(255, 255, 255, 0.3);
        }
        
        .action-btn.primary:hover {
            background: linear-gradient(135deg, #ff5252, #ff9800);
            box-shadow: 0 8px 24px rgba(255, 107, 107, 0.4);
        }
        
        /* ä¸»è¦å†…å®¹åŒºåŸŸ */
        .main-content {
            background: white;
            border-radius: 24px 24px 0 0;
            min-height: calc(100vh - 300px);
            padding: 24px 20px 120px;
            position: relative;
        }
        
        .content-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .content-title {
            font-size: 20px;
            font-weight: 700;
            color: #2d3748;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .view-more-btn {
            color: #667eea;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: color 0.3s ease;
        }
        
        .view-more-btn:hover {
            color: #5a67d8;
        }
        
        /* æ”¶ç›Šè®°å½•å¡ç‰‡ */
        .record-card {
            background: white;
            border-radius: 16px;
            padding: 16px 20px;
            margin-bottom: 12px;
            border: 1px solid rgba(0, 0, 0, 0.05);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .record-card:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
        }
        
        .record-card.earning::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: linear-gradient(135deg, #10b981, #34d399);
        }
        
        .record-card.withdrawal::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: linear-gradient(135deg, #ef4444, #f87171);
        }
        
        .record-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }
        
        .record-info h4 {
            font-size: 16px;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 4px;
        }
        
        .record-time {
            font-size: 12px;
            color: #718096;
        }
        
        .record-amount {
            font-size: 18px;
            font-weight: 700;
            text-align: right;
        }
        
        .record-amount.earning {
            color: #10b981;
        }
        
        .record-amount.withdrawal {
            color: #ef4444;
        }

        /* æ–°ç‰ˆè¡Œå¸ƒå±€ */
        .record-row { display:flex; align-items:center; gap:14px; }
        .record-icon { width:36px; height:36px; border-radius:12px; display:flex; align-items:center; justify-content:center; color:#fff; box-shadow:0 6px 16px rgba(0,0,0,0.08); font-size:14px; }
        .record-icon.earning { background: linear-gradient(135deg,#10b981,#34d399); }
        .record-icon.withdrawal { background: linear-gradient(135deg,#ef4444,#f97316); }
        .record-body { flex:1; }
        .record-title { font-size:15px; font-weight:700; color:#111827; }
        .record-sub { margin-top:4px; display:flex; align-items:center; gap:6px; color:#6b7280; font-size:12px; }
        .chip { padding:2px 8px; background:#f3f4f6; border:1px solid #e5e7eb; border-radius:999px; font-size:12px; color:#374151; }
        .chip.keyword { background:rgba(102,126,234,.08); border-color:rgba(102,126,234,.18); color:#4f46e5; }
        .chip.status-ok { background:rgba(16,185,129,.1); border-color:rgba(16,185,129,.2); color:#059669; }
        .chip.status-pending { background:rgba(245,158,11,.1); border-color:rgba(245,158,11,.2); color:#b45309; }
        .chip.status-fail { background:rgba(239,68,68,.1); border-color:rgba(239,68,68,.2); color:#dc2626; }
        .record-right { text-align:right; }
        .record-right .amount { font-size:18px; font-weight:800; }
        .record-right .amount.earning { color:#10b981; }
        .record-right .amount.withdrawal { color:#ef4444; }
        
        /* ç©ºçŠ¶æ€ */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6b7280;
        }
        
        .empty-state i {
            font-size: 64px;
            margin-bottom: 20px;
            color: #d1d5db;
        }
        
        .empty-state h3 {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #374151;
        }
        
        .empty-state p {
            font-size: 16px;
            margin-bottom: 24px;
        }
        
        /* åº•éƒ¨å¯¼èˆª */
        .bottom-navigation {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 1px solid #e2e8f0;
            padding: 16px 0 20px 0;
            box-shadow: 0 -4px 16px rgba(0, 0, 0, 0.1);
            z-index: 100;
        }
        
        .nav-container {
            display: flex;
            justify-content: space-around;
            align-items: center;
            max-width: 480px;
            margin: 0 auto;
            padding: 0 16px;
        }
        
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-decoration: none;
            color: #9ca3af;
            transition: all 0.3s ease;
            padding: 12px 16px;
            border-radius: 12px;
            min-width: 68px;
            flex: 1;
            max-width: 80px;
        }
        
        .nav-item.active {
            color: #667eea;
            background: rgba(102, 126, 234, 0.1);
        }
        
        .nav-item i {
            font-size: 22px;
            margin-bottom: 6px;
        }
        
        .nav-item span {
            font-size: 11px;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        /* ç§»åŠ¨ç«¯å¯¼èˆªä¼˜åŒ– */
        @media (max-width: 480px) {
            .bottom-navigation {
                padding: 16px 0 20px 0;
                padding-bottom: max(20px, env(safe-area-inset-bottom));
            }
            
            .nav-container {
                padding: 0 8px;
            }
            
            .nav-item {
                padding: 12px 8px;
                min-width: 55px;
                max-width: 68px;
            }
            
            .nav-item i {
                font-size: 20px;
                margin-bottom: 6px;
            }
            
            .nav-item span {
                font-size: 10px;
            }
        }

        /* åŠ è½½åŠ¨ç”» */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 40px;
        }
        
        .loader {
            width: 40px;
            height: 40px;
            border: 4px solid #e2e8f0;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* åŠ¨ç”»æ•ˆæœ */
        .fade-in {
            animation: fadeInUp 0.6s ease-out;
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* è„‰å†²åŠ¨ç”» */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .sync-icon {
            animation: pulse 2s infinite;
        }
        
        /* Tabåˆ‡æ¢åŒºåŸŸ */
        .earnings-tabs {
            display: flex;
            justify-content: space-around;
            border-bottom: 2px solid #e2e8f0;
            margin-bottom: 20px;
        }
        
        .tab-item {
            flex: 1;
            text-align: center;
            padding: 14px 0;
            font-size: 15px;
            font-weight: 600;
            color: #9ca3af;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .tab-item.active {
            color: #667eea;
        }
        
        .tab-item.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 50%;
            transform: translateX(-50%);
            width: 60px;
            height: 3px;
            background: #667eea;
            border-radius: 2px 2px 0 0;
        }
        
        .tab-item:hover {
            color: #667eea;
        }
        
        /* ä»»åŠ¡ç»Ÿè®¡å¡ç‰‡ */
        .task-stats-card {
            background: white;
            border-radius: 16px;
            padding: 18px 20px;
            margin-bottom: 14px;
            border: 1px solid rgba(0, 0, 0, 0.06);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
            transition: all 0.3s ease;
        }
        
        .task-stats-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
        }
        
        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        
        .task-name {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 16px;
            font-weight: 700;
            color: #2d3748;
        }
        
        .task-icon {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            background: linear-gradient(135deg, #667eea, #764ba2);
        }
        
        .view-detail-btn {
            color: #667eea;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: color 0.3s ease;
        }
        
        .view-detail-btn:hover {
            color: #5a67d8;
        }
        
        .task-stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 16px;
        }
        
        .stat-box {
            text-align: center;
            padding: 12px 8px;
            background: #f8fafc;
            border-radius: 12px;
        }
        
        .stat-number {
            font-size: 22px;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 6px;
        }
        
        .stat-number.earnings {
            color: #10b981;
            font-size: 20px;
        }
        
        .stat-desc {
            font-size: 12px;
            color: #718096;
            font-weight: 500;
        }
        
        /* Tabå†…å®¹åŒºåŸŸ */
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
            animation: fadeInUp 0.4s ease-out;
        }
        
        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 480px) {
            .main-earnings-card {
                padding: 20px 16px;
            }
            
            .balance-amount {
                font-size: 32px;
            }
            
            .stat-value {
                font-size: 18px;
            }
            
            .task-stats-grid {
                gap: 12px;
            }
            
            .stat-number {
                font-size: 18px;
            }
            
            .stat-number.earnings {
                font-size: 17px;
            }
            
            .stat-desc {
                font-size: 11px;
            }
        }
    </style>
</head>
<body>
    <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
    <nav class="navbar">
        <h1 class="title">
            <i class="fas fa-chart-line"></i>
            æ”¶ç›Šä¸­å¿ƒ
        </h1>
    </nav>
    
    <!-- æ”¶ç›Šæ€»è§ˆ -->
    <div class="earnings-overview fade-in">
        <div class="main-earnings-card">
            <div class="main-balance">
                <div class="balance-label">å¯æç°æ”¶ç›Š</div>
                <div class="balance-amount">Â¥<span id="withdrawable-amount">0.00</span></div>
                <div class="sync-status">
                    <i class="fas fa-sync-alt sync-icon"></i>
                    <span id="sync-status-text">æ­£åœ¨åŒæ­¥æ•°æ®...</span>
                </div>
            </div>
            
            <div class="earnings-stats">
                <div class="stat-item">
                    <div class="stat-label">ç´¯è®¡æ”¶ç›Š</div>
                    <div class="stat-value">Â¥<span id="total-income">0.00</span></div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">ä»Šæ—¥æ”¶ç›Š</div>
                    <div class="stat-value">Â¥<span id="today-income">0.00</span></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- æ“ä½œæŒ‰é’® -->
    <div class="action-buttons fade-in" style="animation-delay: 0.2s;">
        <button class="action-btn primary" onclick="calculateEarnings()">
            <i class="fas fa-calculator"></i>
            è®¡ç®—æ”¶ç›Š
        </button>
        <button class="action-btn" onclick="goToWallet()">
            <i class="fas fa-credit-card"></i>
            ç”³è¯·æç°
        </button>
    </div>
    
    <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
    <main class="main-content fade-in" style="animation-delay: 0.4s;">
        <!-- Tabåˆ‡æ¢ -->
        <div class="earnings-tabs">
            <div class="tab-item active" onclick="switchTab('my-data')">æˆ‘çš„æ•°æ®</div>
            <div class="tab-item" onclick="switchTab('activity')">æ´»åŠ¨æ”¶ç›Š</div>
            <div class="tab-item" onclick="switchTab('team')">å›¢é˜Ÿæ•°æ®</div>
        </div>
        
        <!-- Tabå†…å®¹ï¼šæˆ‘çš„æ•°æ® -->
        <div id="my-data-content" class="tab-content active">
            <div id="my-data-list">
                <div class="loading">
                    <div class="loader"></div>
                </div>
            </div>
        </div>
        
        <!-- Tabå†…å®¹ï¼šæ´»åŠ¨æ”¶ç›Š -->
        <div id="activity-content" class="tab-content">
            <div id="activity-list">
                <div class="loading">
                <div class="loader"></div>
                </div>
            </div>
        </div>
        
        <!-- Tabå†…å®¹ï¼šå›¢é˜Ÿæ•°æ® -->
        <div id="team-content" class="tab-content">
            <div id="team-list">
                <div class="loading">
                    <div class="loader"></div>
                </div>
            </div>
        </div>
    </main>
    
    <!-- åº•éƒ¨å¯¼èˆª -->
    <nav class="bottom-navigation">
        <div class="nav-container">
            <a href="index.html" class="nav-item">
                <i class="fas fa-home"></i>
                <span>é¦–é¡µ</span>
            </a>
            <a href="ranking.html" class="nav-item">
                <i class="fas fa-trophy"></i>
                <span>æ¦œå•</span>
            </a>
            <a href="income.html" class="nav-item active">
                <i class="fas fa-chart-line"></i>
                <span>æ”¶ç›Š</span>
            </a>
            <a href="profile.html" class="nav-item">
                <i class="fas fa-user"></i>
                <span>æˆ‘çš„</span>
            </a>
        </div>
    </nav>

    <!-- ç”± emergency-database-fix.js è´Ÿè´£åŠ è½½ Supabase SDK ä¸å®¢æˆ·ç«¯ -->
    <script>
        // ç¡®ä¿Supabaseå·²åŠ è½½
        function waitForSupabase() {
            return new Promise((resolve) => {
                const checkReady = () => {
                    try {
                        if (typeof window.getEmergencyClient === 'function' && window.getEmergencyClient()) return true;
                        if (window.supabase) return true;
                    } catch (_) {}
                    return false;
                };
                if (checkReady()) return resolve();
                const timer = setInterval(() => { if (checkReady()) { clearInterval(timer); resolve(); } }, 100);
                setTimeout(() => { try { clearInterval(timer); } catch(_){} resolve(); }, 10000);
            });
        }

        // æ£€æŸ¥ç”¨æˆ·ç™»å½•çŠ¶æ€ï¼ˆæœªç™»å½•ç›´æ¥è·³è½¬åˆ°ç™»å½•é¡µï¼‰
        async function checkUserLogin() {
            try {
                const raw = localStorage.getItem('currentUser');
                if (!raw) { window.location.replace('login.html?redirect=income'); return false; }
                const u = JSON.parse(raw);
                const uid = u && (u.id || u['ç”¨æˆ·ID']);
                if (!uid || u.isTemp) { window.location.replace('login.html?redirect=income'); return false; }
                return true;
            } catch (_) {
                window.location.replace('login.html?redirect=income');
                return false;
            }
        }

        // åˆå§‹åŒ–Supabaseï¼ˆèµ°åº”æ€¥å®¢æˆ·ç«¯ï¼‰
        async function initializeSupabase() {
            try {
                if (typeof window.emergencyInitDatabase === 'function') {
                    await window.emergencyInitDatabase();
                    console.log('Supabaseåˆå§‹åŒ–æˆåŠŸ (emergency)');
                }
            } catch (error) {
                console.warn('Supabaseåˆå§‹åŒ–è­¦å‘Š:', error);
            }
            return true;
        }

        // è·å–ç»Ÿä¸€çš„ Supabase å®¢æˆ·ç«¯
        async function ensureClient() {
            try {
                if (typeof window.getEmergencyClient === 'function') {
                    const c1 = window.getEmergencyClient();
                    if (c1 && typeof c1.from === 'function') return c1;
                }
                if (typeof window.emergencyInitDatabase === 'function') {
                    await window.emergencyInitDatabase();
                    const c2 = (typeof window.getEmergencyClient === 'function') ? window.getEmergencyClient() : null;
                    if (c2 && typeof c2.from === 'function') return c2;
                }
            } catch (_) {}
            return null;
        }

        // çŠ¶æ€è¾…åŠ©ï¼šæ ‡å‡†åŒ–æ”¶ç›Š/æç°çŠ¶æ€
        function parseStatusFlags(raw){
            const s = (raw||'').toString().toLowerCase();
            const isRejected = ['rejected','reject','fail','failed','canceled','cancelled','å·²æ‹’ç»','å·²å–æ¶ˆ','æ’¤é”€','ä½œåºŸ'].some(k=> s.includes(k));
            const isCompleted = ['completed','complete','success','done','å·²å®Œæˆ','å·²å…¥è´¦','æˆåŠŸ'].some(k=> s.includes(k));
            const isPending = !isRejected && !isCompleted && ['pending','review','å®¡æ ¸','åœ¨é€”','å¤„ç†ä¸­','processing','process','ç­‰å¾…','å¾…'].some(k=> s.includes(k));
            return { isRejected, isCompleted, isPending };
        }

        // ä»localStorageè·å–æ”¶ç›Šæ•°æ®
        function getEarningsFromLocalStorage() {
            const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
            const username = currentUser.username || currentUser.ç”¨æˆ·å || currentUser.id || currentUser.ç”¨æˆ·ID;
            
            if (!username) {
                console.warn('æœªæ‰¾åˆ°ç”¨æˆ·å');
                return [];
            }

            // è·å–ç®¡ç†ç³»ç»Ÿæ·»åŠ çš„æ”¶ç›Šæ•°æ®
            const earnings = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith('earning_')) {
                    try {
                        const earning = JSON.parse(localStorage.getItem(key));
                        // æ£€æŸ¥æ˜¯å¦å±äºå½“å‰ç”¨æˆ·
                        if (earning.username === username || earning.ç”¨æˆ·å === username) {
                            earnings.push(earning);
                        }
                    } catch (e) {
                        console.warn('è§£ææ”¶ç›Šæ•°æ®å¤±è´¥:', key, e);
                    }
                }
            }
            
            return earnings;
        }

        // è®¡ç®—æ€»æ”¶ç›Šå’Œä»Šæ—¥æ”¶ç›Š
        async function calculateEarnings() {
            try {
                // æ˜¾ç¤ºåŒæ­¥åŠ¨ç”»
                document.getElementById('sync-status-text').textContent = 'æ­£åœ¨åŒæ­¥æ•°æ®...';
                document.querySelector('.sync-icon').style.animation = 'spin 1s linear infinite';
                
                const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
                const userId = currentUser.id || currentUser.ç”¨æˆ·ID;
                
                if (!userId) {
                    console.warn('æœªæ‰¾åˆ°ç”¨æˆ·ID');
                    return { totalEarnings: 0, todayEarnings: 0 };
                }

                let earnings = [];
                let supabaseWorking = false;
                let hasLocalEarnings = false;

                // å…ˆå°è¯•ä» Supabase è·å–æ•°æ®
                try {
                    const client = await ensureClient();
                    if (client && typeof window.dbQuery === 'function') {
                        const res = await window.dbQuery((c)=> c
                            .from('earnings')
                            .select('*')
                            .eq('user_id', userId)
                        );
                        earnings = res.data || [];
                        supabaseWorking = true;
                        console.log('ä» Supabase è·å–æ”¶ç›Šæ•°æ®:', earnings.length);
                    }
                } catch (error) {
                    console.warn('Supabase è·å–æ”¶ç›Šå¤±è´¥:', error);
                }

                // åˆå¹¶æœ¬åœ°å›é€€æ”¶ç›Šï¼ˆå³ä½¿äº‘ç«¯å¯ç”¨ä¹Ÿè¦åˆå¹¶ï¼Œç¡®ä¿æ–°å¢æœ¬åœ°è®°å½•å¯è§ï¼‰
                try {
                    const localAdds = [];
                    for (let i = 0; i < localStorage.length; i++) {
                        const key = localStorage.key(i);
                        if (key && key.startsWith('earning_')) {
                            try {
                                const e = JSON.parse(localStorage.getItem(key));
                                const uid = e.user_id || e.userId || e.ç”¨æˆ·ID;
                                const uname = e.username || e.ç”¨æˆ·å;
                                if (String(uid) === String(userId) || String(uname) === String(username)) {
                                    localAdds.push(e);
                                }
                            } catch (_) {}
                        }
                    }
                    if (!supabaseWorking && localAdds.length === 0) {
                        // å…œåº•ï¼šæ—§æ ¼å¼
                        earnings = getEarningsFromLocalStorage();
                    } else {
                        if (localAdds.length > 0) {
                            hasLocalEarnings = true;
                            earnings = [...earnings, ...localAdds];
                        }
                    }
                    console.log('åˆå¹¶æœ¬åœ°æ”¶ç›Šåæ¡æ•°:', earnings.length, 'æœ¬åœ°æ–°å¢:', localAdds.length);
                } catch (_) {}

                // è®¡ç®—æ€»æ”¶ç›Šå’Œä»Šæ—¥æ”¶ç›Š
                let totalEarnings = 0;
                let todayEarnings = 0;
                const today = new Date();
                today.setHours(0, 0, 0, 0);

                earnings.forEach(earning => {
                    // ä»…ç»Ÿè®¡æœªæ’¤é”€ï¼ˆérejected/canceledï¼‰çš„æ”¶ç›Š
                    const { isRejected } = parseStatusFlags(earning.status || earning.çŠ¶æ€);
                    if (isRejected) return;
                    const amount = parseFloat(earning.amount || earning.é‡‘é¢ || earning.æ”¶ç›Šé‡‘é¢ || 0);
                    totalEarnings += amount;

                    const createdAt = new Date(earning.created_at || earning.åˆ›å»ºæ—¶é—´ || earning.date || earning.æ—¶é—´);
                    if (createdAt >= today) {
                        todayEarnings += amount;
                    }
                });

                // è·å–æç°æ€»é¢
                let totalWithdrawals = 0;
                
                if (supabaseWorking) {
                    // ä» Supabase è·å–æç°æ•°æ®
                    try {
                        const client = await ensureClient();
                        if (client && typeof window.dbQuery === 'function') {
                            const res = await window.dbQuery((c)=> c
                                .from('withdrawals')
                                .select('*')
                                .eq('user_id', userId)
                            );
                            const withdrawals = res.data || [];
                            withdrawals.forEach(withdrawal => {
                                const amount = parseFloat(withdrawal.amount || withdrawal.é‡‘é¢ || 0);
                                const { isRejected, isCompleted, isPending } = parseStatusFlags(withdrawal.status || withdrawal.çŠ¶æ€);
                                if (!isRejected && (isCompleted || isPending)) totalWithdrawals += amount;
                            });
                        }
                    } catch (error) {
                        console.warn('è·å–æç°è®°å½•å¤±è´¥:', error);
                    }
                } else {
                    // ä» localStorage è·å–æç°æ•°æ®
                    const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
                    const username = currentUser.username || currentUser.ç”¨æˆ·å || currentUser.id || currentUser.ç”¨æˆ·ID;
                    
                    for (let i = 0; i < localStorage.length; i++) {
                        const key = localStorage.key(i);
                        if (key && key.startsWith('withdrawal_')) {
                            try {
                                const withdrawal = JSON.parse(localStorage.getItem(key));
                                if (withdrawal.username === username || withdrawal.ç”¨æˆ·å === username) {
                                    const amount = parseFloat(withdrawal.amount || withdrawal.é‡‘é¢ || withdrawal.æç°é‡‘é¢ || 0);
                                    const statusText = (withdrawal.status || withdrawal.çŠ¶æ€ || '').toString().toLowerCase();
                                    const isRejected = ['rejected','fail','failed','å·²æ‹’ç»','å®¡æ ¸ä¸é€šè¿‡','æœªé€šè¿‡','å¤±è´¥'].some(k=> statusText.includes(k));
                                    const isCompleted = ['completed','paid','success','å·²åˆ°è´¦','å·²å®Œæˆ','å·²æ‰“æ¬¾','å·²æç°'].some(k=> statusText.includes(k));
                                    const isPending = ['pending','review','å®¡æ ¸ä¸­','å¾…å®¡æ ¸','å¤„ç†ä¸­','åœ¨é€”','processing','process'].some(k=> statusText.includes(k));
                                    if (!isRejected && (isCompleted || isPending)) {
                                        totalWithdrawals += amount;
                                    }
                                }
                            } catch (e) {
                                console.warn('è§£ææç°æ•°æ®å¤±è´¥:', key, e);
                            }
                        }
                    }
                }

                // è®¡ç®—å®é™…å¯æç°é‡‘é¢
                // äº‘ç«¯ä½™é¢ä¼˜å…ˆï¼šè‹¥ users.wallet_balance å­˜åœ¨,ä»¥å…¶ä¸ºå‡†ï¼Œé¿å…ç«¯ä¾§ä¸åå°ä¸åŒæ­¥
                let withdrawableAmount = totalEarnings - totalWithdrawals;
                if (supabaseWorking && !hasLocalEarnings) {
                    try {
                        const client = await ensureClient();
                        if (client && typeof window.dbQuery === 'function') {
                            const ures = await window.dbQuery((c)=> c.from('users').select('wallet_balance').eq('id', userId).single());
                            const cloud = parseFloat((ures && ures.data && ures.data.wallet_balance) || NaN);
                            if (isFinite(cloud)) withdrawableAmount = cloud;
                        }
                    } catch(_) {}
                }

                // æ›´æ–°æ˜¾ç¤º - ä½¿ç”¨åŠ¨ç”»æ•ˆæœ
                animateNumberUpdate('withdrawable-amount', parseFloat(document.getElementById('withdrawable-amount').textContent), withdrawableAmount);
                animateNumberUpdate('total-income', parseFloat(document.getElementById('total-income').textContent), totalEarnings);
                animateNumberUpdate('today-income', parseFloat(document.getElementById('today-income').textContent), todayEarnings);
                
                // åŒæ­¥ä½™é¢åˆ°localStorageå’Œç”¨æˆ·æ•°æ®
                currentUser.wallet_balance = withdrawableAmount;
                currentUser.é’±åŒ…ä½™é¢ = withdrawableAmount;
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                localStorage.setItem('wallet_balance', withdrawableAmount.toString());
                localStorage.setItem('é’±åŒ…ä½™é¢', withdrawableAmount.toString());

                // åŒæ­¥ä½™é¢åˆ°æ‰€æœ‰é¡µé¢
                if (window.syncBalanceAcrossPages) {
                    await window.syncBalanceAcrossPages();
                }

                // æ›´æ–°åŒæ­¥çŠ¶æ€
                document.querySelector('.sync-icon').style.animation = '';
                if (supabaseWorking) {
                    document.getElementById('sync-status-text').textContent = 'æ•°æ®å·²åŒæ­¥ (äº‘ç«¯)';
                } else {
                    document.getElementById('sync-status-text').textContent = 'æ•°æ®å·²åŒæ­¥ (æœ¬åœ°)';
                }
                
                return { totalEarnings, todayEarnings, withdrawableAmount };
            } catch (error) {
                console.error('è®¡ç®—æ”¶ç›Šå¤±è´¥:', error);
                document.getElementById('sync-status-text').textContent = 'åŒæ­¥å¤±è´¥ï¼Œè¯·é‡è¯•';
                document.querySelector('.sync-icon').style.animation = '';
                return { totalEarnings: 0, todayEarnings: 0, withdrawableAmount: 0 };
            }
        }
        
        // æ•°å­—åŠ¨ç”»æ›´æ–°
        function animateNumberUpdate(elementId, fromValue, toValue) {
            const element = document.getElementById(elementId);
            const duration = 1000; // 1ç§’åŠ¨ç”»
            const steps = 60; // 60å¸§
            const stepValue = (toValue - fromValue) / steps;
            let currentValue = fromValue;
            let currentStep = 0;
            
            const animate = () => {
                if (currentStep < steps) {
                    currentValue += stepValue;
                    element.textContent = Math.max(0, currentValue).toFixed(2);
                    currentStep++;
                    requestAnimationFrame(animate);
                } else {
                    element.textContent = Math.max(0, toValue).toFixed(2);
                }
            };
            
            animate();
        }

        
        // æ ¼å¼åŒ–æ—¶é—´
        function formatTime(timeString) {
            if (!timeString) return 'åˆšåˆš';
            try {
                const date = new Date(timeString);
                const now = new Date();
                const diff = now - date;
                
                if (diff < 60000) return 'åˆšåˆš';
                if (diff < 3600000) return Math.floor(diff / 60000) + 'åˆ†é’Ÿå‰';
                if (diff < 86400000) return Math.floor(diff / 3600000) + 'å°æ—¶å‰';
                if (diff < 2592000000) return Math.floor(diff / 86400000) + 'å¤©å‰';
                
                return date.toLocaleDateString('zh-CN', {
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            } catch (error) {
                return timeString;
            }
        }
        
        // æ˜¾ç¤ºæç°æ¨¡æ€æ¡†
        function showWithdrawModal() {
            showToast('æç°åŠŸèƒ½å¼€å‘ä¸­ï¼Œæ•¬è¯·æœŸå¾…ï¼', 'info');
        }
        
        // Tabåˆ‡æ¢å‡½æ•°
        function switchTab(tabName) {
            // æ›´æ–°Tabæ¿€æ´»çŠ¶æ€
            document.querySelectorAll('.tab-item').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // æ›´æ–°å†…å®¹æ˜¾ç¤º
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(tabName + '-content').classList.add('active');
            
            // æ ¹æ®TabåŠ è½½å¯¹åº”æ•°æ®
            if (tabName === 'my-data') {
                loadMyData();
            } else if (tabName === 'activity') {
                loadActivityEarnings();
            } else if (tabName === 'team') {
                loadTeamData();
            }
        }
        
        // åŠ è½½æˆ‘çš„æ•°æ®ï¼ˆæŒ‰ä»»åŠ¡åˆ†ç»„ç»Ÿè®¡ï¼‰
        async function loadMyData() {
            try {
                const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
                const userId = currentUser.id || currentUser.ç”¨æˆ·ID;
                
                if (!userId) {
                    console.warn('æœªæ‰¾åˆ°ç”¨æˆ·ID');
                    return;
                }

                let earnings = [];

                // ä»Supabaseè·å–æ•°æ®
                try {
                    const client = await ensureClient();
                    if (client && typeof window.dbQuery === 'function') {
                        const res = await window.dbQuery((c)=> c
                            .from('earnings')
                            .select('*')
                            .eq('user_id', userId)
                        );
                        earnings = res.data || [];
                    }
                } catch (error) {
                    console.warn('Supabaseè·å–å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°æ•°æ®:', error);
                }
                
                // åˆå¹¶æœ¬åœ°æ•°æ®
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key && key.startsWith('earning_')) {
                        try {
                            const e = JSON.parse(localStorage.getItem(key));
                            const uid = e.user_id || e.userId || e.ç”¨æˆ·ID;
                            if (String(uid) === String(userId)) {
                                earnings.push(e);
                            }
                        } catch (_) {}
                    }
                }
                
                // æŒ‰ä»»åŠ¡ç±»å‹åˆ†ç»„ç»Ÿè®¡ï¼ˆåªç»Ÿè®¡æ­£å¸¸ä»»åŠ¡ï¼Œæ’é™¤æ´»åŠ¨å’Œå›¢é•¿æ”¶ç›Šï¼‰
                const taskStats = {};
                earnings.forEach(earning => {
                    const { isRejected } = parseStatusFlags(earning.status || earning.çŠ¶æ€);
                    if (isRejected) return;
                    
                    const taskName = earning.task_name || earning.ä»»åŠ¡åç§° || 'æœªçŸ¥ä»»åŠ¡';
                    
                    // æ’é™¤æ´»åŠ¨æ”¶ç›Šå’Œå›¢é•¿æ”¶ç›Š
                    if (taskName.includes('æ´»åŠ¨') || taskName.includes('å›¢é•¿') || 
                        taskName.includes('åˆ†æˆ') || taskName.includes('é‚€è¯·å¥–åŠ±') || 
                        taskName.includes('é¦–æ¬¡æç°')) {
                        return; // è·³è¿‡è¿™äº›ç‰¹æ®Šæ”¶ç›Š
                    }
                    
                    const baseTask = taskName.split('-')[0]; // å»æ‰å…³é”®è¯éƒ¨åˆ†
                    
                    if (!taskStats[baseTask]) {
                        taskStats[baseTask] = {
                            taskName: baseTask,
                            totalOrders: 0,
                            completedOrders: 0,
                            totalEarnings: 0
                        };
                    }
                    
                    taskStats[baseTask].totalOrders += 1;
                    const { isCompleted } = parseStatusFlags(earning.status || earning.çŠ¶æ€);
                    if (isCompleted) {
                        taskStats[baseTask].completedOrders += 1;
                    }
                    taskStats[baseTask].totalEarnings += parseFloat(earning.amount || earning.é‡‘é¢ || 0);
                });
                
                // æ¸²æŸ“ä»»åŠ¡ç»Ÿè®¡å¡ç‰‡
                renderTaskStats(Object.values(taskStats));
                
            } catch (error) {
                console.error('åŠ è½½æˆ‘çš„æ•°æ®å¤±è´¥:', error);
                showErrorInTab('my-data-list', 'åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•');
            }
        }
        
        // æ¸²æŸ“ä»»åŠ¡ç»Ÿè®¡å¡ç‰‡
        function renderTaskStats(stats) {
            const container = document.getElementById('my-data-list');
            
            if (!stats || stats.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-chart-line"></i>
                        <h3>æš‚æ— ä»»åŠ¡æ•°æ®</h3>
                        <p>æ‚¨è¿˜æ²¡æœ‰å®Œæˆä»»åŠ¡ï¼Œå¼€å§‹åšä»»åŠ¡èµšå–æ”¶ç›Šå§ï¼</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            stats.forEach((stat, index) => {
                const taskEmoji = getTaskEmoji(stat.taskName);
                html += `
                    <div class="task-stats-card fade-in" style="animation-delay:${index*0.1}s;">
                        <div class="task-header">
                            <div class="task-name">
                                <div class="task-icon">${taskEmoji}</div>
                                ${stat.taskName}
                            </div>
                            <div class="view-detail-btn" onclick="viewTaskDetail('${stat.taskName}')">
                                æŸ¥çœ‹æ˜ç»†
                                <i class="fas fa-chevron-right" style="font-size: 12px;"></i>
                            </div>
                        </div>
                        <div class="task-stats-grid">
                            <div class="stat-box">
                                <div class="stat-number">${stat.totalOrders}</div>
                                <div class="stat-desc">å½“å‰å•é‡</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-number">${stat.completedOrders}</div>
                                <div class="stat-desc">å½“å‰æˆå•é‡</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-number earnings">Â¥${stat.totalEarnings.toFixed(2)}</div>
                                <div class="stat-desc">å½“å‰æ”¶ç›Š</div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        // è·å–ä»»åŠ¡å¯¹åº”çš„emojiå›¾æ ‡
        function getTaskEmoji(taskName) {
            const emojiMap = {
                'çŸ¥ä¹æ‹‰æ´»': 'ğŸ“±',
                'çŸ¥ä¹ä¼šå‘˜': 'ğŸ“',
                'å¤¸å…‹ç½‘ç›˜': 'â˜ï¸',
                'æ‚Ÿç©ºæœç´¢': 'ğŸ”',
                'X-RAYæœç´¢': 'ğŸ”',
                'KKç½‘ç›˜': 'ğŸ’¾'
            };
            return emojiMap[taskName] || 'ğŸ“Š';
        }
        
        // æŸ¥çœ‹ä»»åŠ¡æ˜ç»†
        async function viewTaskDetail(taskName) {
            try {
                const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
                const userId = currentUser.id || currentUser.ç”¨æˆ·ID;
                
                if (!userId) {
                    showToast('æœªæ‰¾åˆ°ç”¨æˆ·ä¿¡æ¯', 'error');
                    return;
                }
                
                // è·å–è¯¥ä»»åŠ¡çš„æ‰€æœ‰æ”¶ç›Šè®°å½•
                let earnings = [];
                
                try {
                    const client = await ensureClient();
                    if (client && typeof window.dbQuery === 'function') {
                        const res = await window.dbQuery((c)=> c
                            .from('earnings')
                            .select('*')
                            .eq('user_id', userId)
                            .ilike('task_name', `%${taskName}%`)
                            .order('created_at', { ascending: false })
                        );
                        earnings = res.data || [];
                    }
                } catch (error) {
                    console.warn('ä»æ•°æ®åº“è·å–å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°æ•°æ®:', error);
                }

                // åˆå¹¶æœ¬åœ°æ•°æ®
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key && key.startsWith('earning_')) {
                        try {
                            const e = JSON.parse(localStorage.getItem(key));
                            const uid = e.user_id || e.userId || e.ç”¨æˆ·ID;
                            const tn = e.task_name || e.ä»»åŠ¡åç§° || '';
                            if (String(uid) === String(userId) && tn.includes(taskName)) {
                                earnings.push(e);
                            }
                        } catch (_) {}
                    }
                }
                
                // å»é‡
                const earningsMap = new Map();
                earnings.forEach(e => {
                    const key = e.id || `${e.task_name}_${e.created_at}_${e.amount}`;
                    if (!earningsMap.has(key)) {
                        earningsMap.set(key, e);
                    }
                });
                
                const uniqueEarnings = Array.from(earningsMap.values());
                
                // æ˜¾ç¤ºæ˜ç»†æ¨¡æ€æ¡†
                showTaskDetailModal(taskName, uniqueEarnings);
                
            } catch (error) {
                console.error('æŸ¥çœ‹ä»»åŠ¡æ˜ç»†å¤±è´¥:', error);
                showToast('åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
            }
        }
        
        // æ˜¾ç¤ºä»»åŠ¡æ˜ç»†æ¨¡æ€æ¡†
        function showTaskDetailModal(taskName, earnings) {
            const modal = document.getElementById('taskDetailModal');
            if (!modal) return;
            
            // è®¾ç½®æ ‡é¢˜
            document.getElementById('taskDetailTitle').textContent = `${taskName} - ä»»åŠ¡æ˜ç»†`;
            
            // æ¸²æŸ“æ˜ç»†åˆ—è¡¨
            const container = document.getElementById('taskDetailList');
            if (!earnings || earnings.length === 0) {
                container.innerHTML = `
                    <div class="empty-state" style="padding: 40px 20px;">
                        <i class="fas fa-clipboard-list" style="font-size: 48px; color: #ccc;"></i>
                        <p style="margin-top: 16px; color: #999;">æš‚æ— æ˜ç»†è®°å½•</p>
                    </div>
                `;
            } else {
                let html = '';
                earnings.forEach((earning, index) => {
                    html += renderTaskDetailItem(earning, taskName, index);
                });
                container.innerHTML = html;
            }
            
            // æ˜¾ç¤ºæ¨¡æ€æ¡†
            modal.style.display = 'flex';
        }
        
        // æ¸²æŸ“å•æ¡ä»»åŠ¡æ˜ç»†
        function renderTaskDetailItem(earning, taskName, index) {
            const amount = parseFloat(earning.amount || earning.é‡‘é¢ || 0);
            const createdAt = earning.created_at || earning.åˆ›å»ºæ—¶é—´ || new Date().toISOString();
            const description = earning.description || earning.æè¿° || '';
            const fullTaskName = earning.task_name || earning.ä»»åŠ¡åç§° || taskName;
            
            // è§£ædescriptionä¸­çš„è¯¦ç»†ä¿¡æ¯
            let detailsHtml = '';
            let hasJsonData = false;
            
            try {
                const details = JSON.parse(description);
                hasJsonData = true;
                
                if (taskName.includes('KKæœç´¢')) {
                    if (details.keyword) {
                        detailsHtml += `<div class="detail-item"><span class="detail-label">å…³é”®è¯:</span> ${details.keyword}</div>`;
                    }
                    if (details.pullNew !== undefined || details.pull_new_count !== undefined) {
                        const pullNew = details.pullNew || details.pull_new_count || 0;
                        detailsHtml += `<div class="detail-item"><span class="detail-label">æ‹‰æ–°é‡:</span> ${pullNew}äºº</div>`;
                    }
                    if (details.pullActive !== undefined || details.pull_active_count !== undefined) {
                        const pullActive = details.pullActive || details.pull_active_count || 0;
                        detailsHtml += `<div class="detail-item"><span class="detail-label">æ‹‰å¤±æ´»:</span> ${pullActive}äºº</div>`;
                    }
                    if (details.pullOld !== undefined || details.pull_old_count !== undefined) {
                        const pullOld = details.pullOld || details.pull_old_count || 0;
                        detailsHtml += `<div class="detail-item"><span class="detail-label">æ‹‰æ´»é‡:</span> ${pullOld}äºº</div>`;
                    }
                } else if (taskName.includes('KKç½‘ç›˜')) {
                    if (details.quarkUid) {
                        detailsHtml += `<div class="detail-item"><span class="detail-label">å¤¸å…‹UID:</span> ${details.quarkUid}</div>`;
                    }
                    if (details.realName || details.username) {
                        detailsHtml += `<div class="detail-item"><span class="detail-label">ç”¨æˆ·å:</span> ${details.realName || details.username}</div>`;
                    }
                    if (details.mobilePullNew !== undefined) {
                        detailsHtml += `<div class="detail-item"><span class="detail-label">ç§»åŠ¨æ‹‰æ–°:</span> ${details.mobilePullNew}äºº</div>`;
                    }
                    if (details.pcPullNew !== undefined) {
                        detailsHtml += `<div class="detail-item"><span class="detail-label">PCæ‹‰æ–°:</span> ${details.pcPullNew}äºº</div>`;
                    }
                    if (details.transferCount !== undefined) {
                        detailsHtml += `<div class="detail-item"><span class="detail-label">è½¬å­˜é‡:</span> ${details.transferCount}æ¬¡</div>`;
                    }
                    if (details.memberCommission !== undefined) {
                        detailsHtml += `<div class="detail-item"><span class="detail-label">ä¼šå‘˜ä½£é‡‘:</span> Â¥${parseFloat(details.memberCommission).toFixed(2)}</div>`;
                    }
                } else if (taskName.includes('wç©º') || taskName.includes('æ‚Ÿç©º')) {
                    if (details.keyword) {
                        detailsHtml += `<div class="detail-item"><span class="detail-label">å…³é”®è¯:</span> ${details.keyword}</div>`;
                    }
                    if (details.pullNew !== undefined) {
                        detailsHtml += `<div class="detail-item"><span class="detail-label">æ‹‰æ–°é‡:</span> ${details.pullNew}äºº</div>`;
                    }
                } else if (taskName.includes('X-RAY') || taskName.includes('xé›·') || taskName.includes('é›·æµè§ˆå™¨')) {
                    if (details.keyword) {
                        detailsHtml += `<div class="detail-item"><span class="detail-label">å…³é”®è¯:</span> ${details.keyword}</div>`;
                    }
                    if (details.pullNew10 !== undefined || details.pull_new_1_10 !== undefined) {
                        detailsHtml += `<div class="detail-item"><span class="detail-label">æ‹‰æ–°1-10äºº:</span> ${details.pullNew10 || details.pull_new_1_10 || 0}äºº</div>`;
                    }
                    if (details.pullNew100 !== undefined || details.pull_new_10_100 !== undefined) {
                        detailsHtml += `<div class="detail-item"><span class="detail-label">æ‹‰æ–°10-100äºº:</span> ${details.pullNew100 || details.pull_new_10_100 || 0}äºº</div>`;
                    }
                    if (details.pullNew200 !== undefined || details.pull_new_100_200 !== undefined) {
                        detailsHtml += `<div class="detail-item"><span class="detail-label">æ‹‰æ–°100-200äºº:</span> ${details.pullNew200 || details.pull_new_100_200 || 0}äºº</div>`;
                    }
                    if (details.pullNew1000 !== undefined || details.pull_new_200_1000 !== undefined) {
                        detailsHtml += `<div class="detail-item"><span class="detail-label">æ‹‰æ–°200-1000äºº:</span> ${details.pullNew1000 || details.pull_new_200_1000 || 0}äºº</div>`;
                    }
                                }
                            } catch (e) {
                // å¦‚æœdescriptionä¸æ˜¯JSONï¼Œå°è¯•ä»task_nameä¸­æå–ä¿¡æ¯
                hasJsonData = false;
            }
            
            // å¦‚æœæ²¡æœ‰JSONæ•°æ®æˆ–JSONæ•°æ®ä¸ºç©ºï¼Œå°è¯•ä»task_nameä¸­æå–ä¿¡æ¯
            if (!detailsHtml || detailsHtml.trim() === '') {
                // ä»task_nameä¸­æå–å…³é”®è¯ï¼ˆæ ¼å¼å¦‚ï¼šKKæœç´¢-æ–‡åˆ›æ¢ç´¢(æ‹‰æ–°5,æ‹‰æ´»3)ï¼‰
                const keywordMatch = fullTaskName.match(/[-â€“](.*?)(?:\(|$)/);
                if (keywordMatch && keywordMatch[1]) {
                    detailsHtml += `<div class="detail-item"><span class="detail-label">å…³é”®è¯:</span> ${keywordMatch[1].trim()}</div>`;
                }
                
                // æå–æ‹¬å·ä¸­çš„è¯¦ç»†ä¿¡æ¯
                const detailsMatch = fullTaskName.match(/\((.*?)\)/);
                if (detailsMatch && detailsMatch[1]) {
                    const parts = detailsMatch[1].split(/[,ï¼Œ]/);
                    parts.forEach(part => {
                        const trimmed = part.trim();
                        if (trimmed) {
                            // å°è¯•è§£æ"æ‹‰æ–°5"è¿™æ ·çš„æ ¼å¼
                            const countMatch = trimmed.match(/(æ‹‰æ–°|æ‹‰æ´»|æ‹‰å¤±æ´»|æ‹‰æ—§|ç§»åŠ¨æ‹‰æ–°|PCæ‹‰æ–°|è½¬å­˜)(\d+)/);
                            if (countMatch) {
                                const label = countMatch[1];
                                const value = countMatch[2];
                                detailsHtml += `<div class="detail-item"><span class="detail-label">${label}:</span> ${value}äºº</div>`;
                            } else {
                                // å…¶ä»–æ ¼å¼çš„è¯¦æƒ…
                                detailsHtml += `<div class="detail-item"><span class="detail-label">è¯¦æƒ…:</span> ${trimmed}</div>`;
                            }
                        }
                    });
                }
                
                // å¦‚æœæœ‰åŸå§‹descriptionæ–‡æœ¬ï¼Œä¹Ÿæ˜¾ç¤º
                if (description && description.trim() && !hasJsonData) {
                    detailsHtml += `<div class="detail-item"><span class="detail-label">å¤‡æ³¨:</span> ${description}</div>`;
                }
            }
            
            // å¦‚æœè¿˜æ˜¯æ²¡æœ‰ä»»ä½•ä¿¡æ¯ï¼Œæ˜¾ç¤ºé»˜è®¤æç¤º
            if (!detailsHtml || detailsHtml.trim() === '') {
                detailsHtml = `
                    <div class="detail-item"><span class="detail-label">ä»»åŠ¡åç§°:</span> ${fullTaskName}</div>
                    <div class="detail-item" style="color: #999; font-size: 13px; margin-top: 8px;">
                        <i class="fas fa-info-circle"></i> è¯¥è®°å½•æš‚æ— è¯¦ç»†æ•°æ®
                    </div>
                `;
            }
            
            return `
                <div class="task-detail-card fade-in" style="animation-delay:${index*0.05}s;">
                    <div class="detail-header">
                        <div class="detail-amount">Â¥${amount.toFixed(2)}</div>
                        <div class="detail-time">
                            <i class="fas fa-clock"></i>
                            ${formatTime(createdAt)}
                        </div>
                    </div>
                    <div class="detail-body">
                        ${detailsHtml}
                    </div>
                </div>
            `;
        }
        
        // å…³é—­ä»»åŠ¡æ˜ç»†æ¨¡æ€æ¡†
        function closeTaskDetailModal() {
            const modal = document.getElementById('taskDetailModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }
        
        // åŠ è½½æ´»åŠ¨æ”¶ç›Š
        async function loadActivityEarnings() {
            try {
                const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
                const userId = currentUser.id || currentUser.ç”¨æˆ·ID;
                
                if (!userId) {
                    showErrorInTab('activity-list', 'æœªæ‰¾åˆ°ç”¨æˆ·ä¿¡æ¯');
                    return;
                }
                
                let earnings = [];
                
                // ä»Supabaseè·å–æ”¶ç›Šæ•°æ®
                try {
                    const client = await ensureClient();
                    if (client && typeof window.dbQuery === 'function') {
                        const res = await window.dbQuery((c)=> c
                            .from('earnings')
                            .select('*')
                            .eq('user_id', userId)
                            .order('created_at', { ascending: false })
                        );
                        earnings = res.data || [];
                    }
                } catch (error) {
                    console.warn('Supabaseè·å–å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°æ•°æ®:', error);
                }
                
                // åˆå¹¶æœ¬åœ°æ•°æ®
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key && key.startsWith('earning_')) {
                        try {
                            const e = JSON.parse(localStorage.getItem(key));
                            const uid = e.user_id || e.userId || e.ç”¨æˆ·ID;
                            if (String(uid) === String(userId)) {
                                earnings.push(e);
                            }
                        } catch (_) {}
                    }
                }
                
                // ç­›é€‰å‡ºæ´»åŠ¨æ”¶ç›Šï¼ˆtask_nameåŒ…å«"æ´»åŠ¨"çš„è®°å½•ï¼‰
                const activities = [];
                earnings.forEach(earning => {
                    const { isRejected } = parseStatusFlags(earning.status || earning.çŠ¶æ€);
                    if (isRejected) return;
                    
                    const taskName = earning.task_name || earning.ä»»åŠ¡åç§° || '';
                    
                    // åªè¦åŒ…å«"æ´»åŠ¨"å…³é”®è¯çš„æ”¶ç›Š
                    if (taskName.includes('æ´»åŠ¨')) {
                        activities.push({
                            activity_name: taskName,
                            reward_amount: earning.amount || earning.é‡‘é¢ || 0,
                            created_at: earning.created_at || earning.åˆ›å»ºæ—¶é—´,
                            status: earning.status || earning.çŠ¶æ€
                        });
                    }
                });

                // æŒ‰æ—¶é—´æ’åº
                activities.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

                renderActivityEarnings(activities);

            } catch (error) {
                console.error('åŠ è½½æ´»åŠ¨æ”¶ç›Šå¤±è´¥:', error);
                showErrorInTab('activity-list', 'åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•');
            }
        }
        
        // æ¸²æŸ“æ´»åŠ¨æ”¶ç›Š
        function renderActivityEarnings(activities) {
            const container = document.getElementById('activity-list');
            
            if (!activities || activities.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-gift"></i>
                        <h3>æš‚æ— æ´»åŠ¨æ”¶ç›Š</h3>
                        <p>å‚ä¸å¹³å°æ´»åŠ¨å³å¯è·å¾—å¥–åŠ±</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            activities.forEach((activity, index) => {
                html += `
                    <div class="record-card fade-in" style="animation-delay:${index*0.08}s;">
                        <div class="record-row">
                            <div class="record-icon earning">
                                <i class="fas fa-gift"></i>
                            </div>
                            <div class="record-body">
                                <div class="record-title">${activity.activity_name || 'æ´»åŠ¨å¥–åŠ±'}</div>
                                <div class="record-sub">
                                    <span class="chip status-ok">å·²å‘æ”¾</span>
                                    <span class="record-time">${formatTime(activity.created_at)}</span>
                                </div>
                            </div>
                            <div class="record-right">
                                <div class="amount earning">+Â¥${parseFloat(activity.reward_amount || 0).toFixed(2)}</div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        // åŠ è½½å›¢é˜Ÿæ•°æ®
        async function loadTeamData() {
            try {
                const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
                const userId = currentUser.id || currentUser.ç”¨æˆ·ID;
                
                // æ£€æŸ¥æ˜¯å¦æ˜¯å›¢é•¿
                const isLeader = localStorage.getItem('user_is_leader') === 'true';
                if (!isLeader) {
                    document.getElementById('team-list').innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-crown" style="color: #fbbf24;"></i>
                            <h3>å¼€é€šå›¢é•¿æƒé™</h3>
                            <p>å³å¯æŸ¥çœ‹å›¢é˜Ÿåˆ†æˆæ”¶ç›Š</p>
                            <button onclick="contactAdmin()" style="padding: 12px 24px; background: #667eea; color: white; border: none; border-radius: 12px; cursor: pointer; margin-top: 16px;">
                                <i class="fas fa-phone" style="margin-right: 8px;"></i>
                                è”ç³»ç®¡ç†å‘˜
                            </button>
                        </div>
                    `;
                    return;
                }
                
                if (!userId) {
                    showErrorInTab('team-list', 'æœªæ‰¾åˆ°ç”¨æˆ·ä¿¡æ¯');
                    return;
                }
                
                let earnings = [];
                
                // ä»Supabaseè·å–æ”¶ç›Šæ•°æ®
                try {
                    const client = await ensureClient();
                    if (client && typeof window.dbQuery === 'function') {
                        const res = await window.dbQuery((c)=> c
                            .from('earnings')
                            .select('*')
                            .eq('user_id', userId)
                            .order('created_at', { ascending: false })
                        );
                        earnings = res.data || [];
                    }
                } catch (error) {
                    console.warn('Supabaseè·å–å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°æ•°æ®:', error);
                }
                
                // åˆå¹¶æœ¬åœ°æ•°æ®
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key && key.startsWith('earning_')) {
                        try {
                            const e = JSON.parse(localStorage.getItem(key));
                            const uid = e.user_id || e.userId || e.ç”¨æˆ·ID;
                            if (String(uid) === String(userId)) {
                                earnings.push(e);
                            }
                        } catch (_) {}
                    }
                }
                
                // ç­›é€‰å‡ºå›¢é˜Ÿåˆ†æˆæ”¶ç›Šï¼ˆtask_nameåŒ…å«"å›¢é•¿"ã€"åˆ†æˆ"ã€"é‚€è¯·"ç­‰å…³é”®è¯çš„è®°å½•ï¼‰
                const teamEarnings = [];
                earnings.forEach(earning => {
                    const { isRejected } = parseStatusFlags(earning.status || earning.çŠ¶æ€);
                    if (isRejected) return;
                    
                    const taskName = earning.task_name || earning.ä»»åŠ¡åç§° || '';
                    const description = earning.description || earning.ä»»åŠ¡æè¿° || '';
                    
                    // åªè¦åŒ…å«å›¢é˜Ÿç›¸å…³å…³é”®è¯çš„æ”¶ç›Š
                    if (taskName.includes('å›¢é•¿') || taskName.includes('åˆ†æˆ') || 
                        taskName.includes('é‚€è¯·å¥–åŠ±') || taskName.includes('é¦–æ¬¡æç°') ||
                        description.includes('å›¢é˜Ÿ') || description.includes('ä¸‹çº§')) {
                        teamEarnings.push(earning);
                    }
                });
                
                // æŒ‰æ—¶é—´æ’åº
                teamEarnings.sort((a, b) => new Date(b.created_at || b.åˆ›å»ºæ—¶é—´) - new Date(a.created_at || a.åˆ›å»ºæ—¶é—´));
                
                renderTeamEarnings(teamEarnings);
                
            } catch (error) {
                console.error('åŠ è½½å›¢é˜Ÿæ•°æ®å¤±è´¥:', error);
                showErrorInTab('team-list', 'åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•');
            }
        }
        
        // æ¸²æŸ“å›¢é˜Ÿæ”¶ç›Š
        function renderTeamEarnings(earnings) {
            const container = document.getElementById('team-list');
            
            if (!earnings || earnings.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-users"></i>
                        <h3>æš‚æ— å›¢é˜Ÿæ”¶ç›Š</h3>
                        <p>é‚€è¯·å¥½å‹åŠ å…¥å›¢é˜Ÿå³å¯è·å¾—åˆ†æˆæ”¶ç›Š</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            earnings.forEach((earning, index) => {
                const taskName = earning.task_name || earning.ä»»åŠ¡åç§° || 'å›¢é˜Ÿæ”¶ç›Š';
                const amount = parseFloat(earning.amount || earning.é‡‘é¢ || 0);
                const createdAt = earning.created_at || earning.åˆ›å»ºæ—¶é—´;
                
                // åˆ¤æ–­æ”¶ç›Šç±»å‹
                let icon = 'fa-users';
                let label = 'å›¢é˜Ÿåˆ†æˆ';
                if (taskName.includes('é¦–æ¬¡æç°') || taskName.includes('é‚€è¯·å¥–åŠ±')) {
                    icon = 'fa-gift';
                    label = 'é‚€è¯·å¥–åŠ±';
                }
                
                html += `
                    <div class="record-card fade-in" style="animation-delay:${index*0.08}s;">
                        <div class="record-row">
                            <div class="record-icon earning">
                                <i class="fas ${icon}"></i>
                            </div>
                            <div class="record-body">
                                <div class="record-title">${taskName}</div>
                                <div class="record-sub">
                                    <span class="chip status-ok">${label}</span>
                                    <span class="record-time">${formatTime(createdAt)}</span>
                                </div>
                            </div>
                            <div class="record-right">
                                <div class="amount earning">+Â¥${amount.toFixed(2)}</div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        // åœ¨Tabä¸­æ˜¾ç¤ºé”™è¯¯
        function showErrorInTab(containerId, message) {
            const container = document.getElementById(containerId);
            container.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-exclamation-triangle" style="color: #ef4444;"></i>
                    <h3 style="color: #ef4444;">åŠ è½½å¤±è´¥</h3>
                    <p>${message}</p>
                </div>
            `;
        }
        
        // è”ç³»ç®¡ç†å‘˜
        function contactAdmin() {
            showToast('è¯·è”ç³»ç®¡ç†å‘˜å¼€é€šå›¢é•¿æƒé™', 'info');
        }
        

        // æ˜¾ç¤ºæç¤ºæ¶ˆæ¯
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            const bgColor = {
                'success': '#10b981',
                'error': '#ef4444',
                'info': '#374151'
            }[type] || '#374151';
            
            toast.style.cssText = `
                position: fixed;
                top: 100px;
                left: 50%;
                transform: translateX(-50%);
                background: ${bgColor};
                color: white;
                padding: 12px 24px;
                border-radius: 12px;
                font-size: 14px;
                font-weight: 500;
                z-index: 1000;
                box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
                opacity: 0;
                transition: opacity 0.3s ease;
            `;
            toast.textContent = message;
            
            document.body.appendChild(toast);
            
            requestAnimationFrame(() => {
                toast.style.opacity = '1';
            });
            
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => {
                    if (document.body.contains(toast)) {
                        document.body.removeChild(toast);
                    }
                }, 300);
            }, 3000);
        }

        // é¡µé¢åˆå§‹åŒ–
        async function initializePage() {
            try {
                // ç­‰å¾…SupabaseåŠ è½½
                await waitForSupabase();
                
                // æ£€æŸ¥ç™»å½•çŠ¶æ€
                const isLoggedIn = await checkUserLogin();
                if (!isLoggedIn) return;

                // åˆå§‹åŒ–Supabase
                await initializeSupabase();

                // è®¡ç®—æ”¶ç›Šå¹¶åŠ è½½æ•°æ®
                await calculateEarnings();
                await loadMyData(); // é»˜è®¤åŠ è½½"æˆ‘çš„æ•°æ®"

                // è®¾ç½®å®šæ—¶åˆ·æ–°
                setInterval(calculateEarnings, 60000); // æ¯åˆ†é’Ÿåˆ·æ–°ä¸€æ¬¡

            } catch (error) {
                console.error('é¡µé¢åˆå§‹åŒ–å¤±è´¥:', error);
                document.getElementById('sync-status-text').textContent = 'åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•';
            }
        }

        // å½“DOMåŠ è½½å®Œæˆåå¼€å§‹åˆå§‹åŒ–
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializePage);
        } else {
            initializePage();
        }

        // é¡µé¢è·å¾—ç„¦ç‚¹æ—¶åˆ·æ–°æ•°æ®
        window.addEventListener('focus', () => {
            calculateEarnings();
            // åˆ·æ–°å½“å‰æ¿€æ´»çš„Tabæ•°æ®
            const activeTab = document.querySelector('.tab-item.active');
            if (activeTab) {
                const tabText = activeTab.textContent.trim();
                if (tabText === 'æˆ‘çš„æ•°æ®') loadMyData();
                else if (tabText === 'æ´»åŠ¨æ”¶ç›Š') loadActivityEarnings();
                else if (tabText === 'å›¢é˜Ÿæ•°æ®') loadTeamData();
            }
        });

        // é¡µé¢å¯è§æ€§æ”¹å˜æ—¶åˆ·æ–°æ•°æ®
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden) {
                calculateEarnings();
                // åˆ·æ–°å½“å‰æ¿€æ´»çš„Tabæ•°æ®
                const activeTab = document.querySelector('.tab-item.active');
                if (activeTab) {
                    const tabText = activeTab.textContent.trim();
                    if (tabText === 'æˆ‘çš„æ•°æ®') loadMyData();
                    else if (tabText === 'æ´»åŠ¨æ”¶ç›Š') loadActivityEarnings();
                    else if (tabText === 'å›¢é˜Ÿæ•°æ®') loadTeamData();
                }
            }
        });

        // è·³è½¬åˆ°æˆ‘çš„é’±åŒ…é¡µé¢
        function goToWallet() {
            // æ·»åŠ åŠ è½½åŠ¨ç”»æ•ˆæœ
            const button = event.target.closest('.action-btn');
            if (button) {
                button.style.opacity = '0.7';
                button.style.transform = 'scale(0.95)';
            }
            
            // çŸ­æš‚å»¶è¿Ÿåè·³è½¬ï¼Œæä¾›è§†è§‰åé¦ˆ
            setTimeout(() => {
                window.location.href = 'my-wallet.html';
            }, 150);
        }
    </script>

    <!-- ä»»åŠ¡æ˜ç»†æ¨¡æ€æ¡† -->
    <div id="taskDetailModal" class="task-detail-modal" style="display: none;">
        <div class="modal-overlay" onclick="closeTaskDetailModal()"></div>
        <div class="modal-container">
            <div class="modal-header">
                <h3 id="taskDetailTitle">ä»»åŠ¡æ˜ç»†</h3>
                <button class="close-btn" onclick="closeTaskDetailModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" id="taskDetailList">
                <!-- æ˜ç»†åˆ—è¡¨å°†åŠ¨æ€åŠ è½½åˆ°è¿™é‡Œ -->
            </div>
        </div>
    </div>

    <style>
        /* ä»»åŠ¡æ˜ç»†æ¨¡æ€æ¡† - å…¨å±æ˜¾ç¤º */
        .task-detail-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 9999;
            display: flex;
            align-items: stretch;
            justify-content: center;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            animation: fadeIn 0.3s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .modal-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: transparent;
        }
        
        .modal-container {
            position: relative;
            background: linear-gradient(to bottom, #ffffff 0%, #f8f9fa 100%);
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            animation: slideInUp 0.3s ease-out;
            overflow: hidden;
        }
        
        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .modal-header {
            padding: 20px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            flex-shrink: 0;
        }
        
        .modal-header h3 {
            font-size: 20px;
            font-weight: 600;
            color: white;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .modal-header h3::before {
            content: 'ğŸ“‹';
            font-size: 24px;
        }
        
        .close-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid rgba(255, 255, 255, 0.3);
            background: rgba(255, 255, 255, 0.2);
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            font-size: 18px;
        }
        
        .close-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
            transform: scale(1.1);
        }
        
        .close-btn:active {
            transform: scale(0.95);
        }
        
        .modal-body {
            padding: 20px;
            overflow-y: auto;
            flex: 1;
            -webkit-overflow-scrolling: touch;
        }
        
        .task-detail-card {
            background: white;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
            border: 1px solid #e9ecef;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            transition: all 0.2s;
        }
        
        .task-detail-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            transform: translateY(-2px);
        }
        
        .detail-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
            padding-bottom: 16px;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .detail-amount {
            font-size: 28px;
            font-weight: 700;
            color: #10b981;
            text-shadow: 0 1px 2px rgba(16, 185, 129, 0.1);
        }
        
        .detail-time {
            font-size: 13px;
            color: #6c757d;
            display: flex;
            align-items: center;
            gap: 6px;
            background: #f8f9fa;
            padding: 6px 12px;
            border-radius: 12px;
        }
        
        .detail-time i {
            color: #667eea;
        }
        
        .detail-body {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .detail-item {
            font-size: 15px;
            color: #495057;
            display: flex;
            align-items: flex-start;
            line-height: 1.6;
        }
        
        .detail-label {
            font-weight: 600;
            color: #667eea;
            margin-right: 12px;
            min-width: 90px;
            flex-shrink: 0;
        }
        
        /* ç©ºçŠ¶æ€æ ·å¼ */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }
        
        .empty-state i {
            font-size: 64px;
            color: #ddd;
            margin-bottom: 16px;
        }
        
        .empty-state h3 {
            font-size: 18px;
            color: #666;
            margin-bottom: 8px;
        }
        
        .empty-state p {
            font-size: 14px;
            color: #999;
        }
        
        /* ç§»åŠ¨ç«¯ä¼˜åŒ– */
        @media (max-width: 640px) {
            .modal-header {
                padding: 16px;
            }
            
            .modal-header h3 {
                font-size: 18px;
            }
            
            .modal-body {
                padding: 16px;
            }
            
            .task-detail-card {
                padding: 16px;
                margin-bottom: 12px;
            }
            
            .detail-amount {
                font-size: 24px;
            }
            
            .detail-time {
                font-size: 12px;
                padding: 4px 10px;
            }
            
            .detail-label {
                min-width: 70px;
                font-size: 14px;
            }
            
            .detail-item {
                font-size: 14px;
            }
        }
        
        /* æ»šåŠ¨æ¡ç¾åŒ– */
        .modal-body::-webkit-scrollbar {
            width: 8px;
        }
        
        .modal-body::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        
        .modal-body::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }
        
        .modal-body::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
    </style>
</body>
</html>