<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è„šæœ¬ä¼˜åŒ–ä¿®å¤éªŒè¯å·¥å…·</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        
        .test-container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .test-header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .test-status {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            margin: 5px;
            font-weight: 500;
        }
        
        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .status-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .status-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }
        
        .test-log {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
            margin: 10px 0;
        }
        
        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        
        .btn:hover {
            background: #0056b3;
        }
        
        .btn-success {
            background: #28a745;
        }
        
        .btn-danger {
            background: #dc3545;
        }
        
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: #007bff;
            width: 0%;
            transition: width 0.3s ease;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <div class="test-header">
            <h1>ğŸ”§ è„šæœ¬ä¼˜åŒ–ä¿®å¤éªŒè¯å·¥å…·</h1>
            <p>æµ‹è¯•Supabaseæ•°æ®åº“è¿æ¥å’Œè„šæœ¬åŠ è½½ä¼˜åŒ–æ•ˆæœ</p>
            <div id="overallStatus"></div>
        </div>

        <div class="test-section">
            <h3>ğŸ“‹ æµ‹è¯•è¿›åº¦</h3>
            <div class="progress-bar">
                <div id="progressFill" class="progress-fill"></div>
            </div>
            <div id="progressText">å‡†å¤‡å¼€å§‹æµ‹è¯•...</div>
        </div>

        <div class="test-section">
            <h3>ğŸ” è„šæœ¬åŠ è½½çŠ¶æ€æ£€æŸ¥</h3>
            <div id="scriptStatus"></div>
        </div>

        <div class="test-section">
            <h3>ğŸ”— æ•°æ®åº“è¿æ¥æµ‹è¯•</h3>
            <div id="dbStatus"></div>
            <button id="testDbBtn" class="btn">æµ‹è¯•æ•°æ®åº“è¿æ¥</button>
        </div>

        <div class="test-section">
            <h3>ğŸ“Š åŠŸèƒ½æµ‹è¯•</h3>
            <div id="functionStatus"></div>
            <button id="testFunctionsBtn" class="btn">æµ‹è¯•æ ¸å¿ƒåŠŸèƒ½</button>
        </div>

        <div class="test-section">
            <h3>ğŸ“ è¯¦ç»†æ—¥å¿—</h3>
            <button id="clearLogBtn" class="btn btn-danger">æ¸…é™¤æ—¥å¿—</button>
            <div id="testLog" class="test-log"></div>
        </div>
    </div>

    <!-- åŠ è½½ä¿®å¤åçš„è„šæœ¬ -->
    <script src="supabase-loader.js"></script>
    <script src="database.js"></script>

    <script>
        class FixVerificationTool {
            constructor() {
                this.tests = [];
                this.currentTest = 0;
                this.log = document.getElementById('testLog');
                this.setupEventListeners();
                this.startVerification();
            }

            setupEventListeners() {
                document.getElementById('testDbBtn').addEventListener('click', () => this.testDatabase());
                document.getElementById('testFunctionsBtn').addEventListener('click', () => this.testFunctions());
                document.getElementById('clearLogBtn').addEventListener('click', () => this.clearLog());
            }

            log(message, type = 'info') {
                const timestamp = new Date().toLocaleTimeString();
                const logEntry = `[${timestamp}] ${message}`;
                this.logElement.textContent += logEntry + '\n';
                this.logElement.scrollTop = this.logElement.scrollHeight;
                
                console.log(logEntry);
            }

            get logElement() {
                return this.log;
            }

            clearLog() {
                this.logElement.textContent = '';
            }

            updateProgress(current, total) {
                const percentage = Math.round((current / total) * 100);
                document.getElementById('progressFill').style.width = percentage + '%';
                document.getElementById('progressText').textContent = `æµ‹è¯•è¿›åº¦: ${current}/${total} (${percentage}%)`;
            }

            setStatus(elementId, message, type) {
                const element = document.getElementById(elementId);
                element.innerHTML = `<div class="test-status status-${type}">${message}</div>`;
            }

            async startVerification() {
                this.log('ğŸš€ å¼€å§‹è„šæœ¬ä¼˜åŒ–ä¿®å¤éªŒè¯...', 'info');
                
                // æµ‹è¯•1: è„šæœ¬åŠ è½½æ£€æŸ¥
                await this.checkScriptLoading();
                
                // æµ‹è¯•2: è‡ªåŠ¨æ•°æ®åº“è¿æ¥æµ‹è¯•
                await this.testDatabase();
                
                // æµ‹è¯•3: åŠŸèƒ½æµ‹è¯•
                await this.testFunctions();
                
                this.generateFinalReport();
            }

            async checkScriptLoading() {
                this.log('ğŸ” æ£€æŸ¥è„šæœ¬åŠ è½½çŠ¶æ€...', 'info');
                this.updateProgress(1, 4);
                
                let issues = [];
                let successes = [];
                
                // æ£€æŸ¥supabase-loader.js
                if (typeof window.ensureSupabaseLoaded === 'function') {
                    successes.push('âœ… supabase-loader.js åŠ è½½æˆåŠŸ');
                } else {
                    issues.push('âŒ supabase-loader.js æœªæ­£ç¡®åŠ è½½');
                }
                
                // æ£€æŸ¥database.js
                if (typeof window.initSupabase === 'function') {
                    successes.push('âœ… database.js åŠ è½½æˆåŠŸ');
                } else {
                    issues.push('âŒ database.js æœªæ­£ç¡®åŠ è½½');
                }
                
                // æ£€æŸ¥å·²åˆ é™¤çš„æ–‡ä»¶æ˜¯å¦ç¡®å®ä¸å­˜åœ¨
                if (typeof window.supabaseJs === 'undefined') {
                    successes.push('âœ… supabase-wrapper.js å·²æˆåŠŸç§»é™¤');
                } else {
                    issues.push('âš ï¸ supabase-wrapper.js å¯èƒ½ä»ç„¶å­˜åœ¨');
                }
                
                const statusHtml = successes.concat(issues).map(msg => 
                    `<div class="test-status ${msg.startsWith('âœ…') ? 'status-success' : 
                      msg.startsWith('âš ï¸') ? 'status-warning' : 'status-error'}">${msg}</div>`
                ).join('');
                
                document.getElementById('scriptStatus').innerHTML = statusHtml;
                
                this.log(`è„šæœ¬æ£€æŸ¥å®Œæˆ: ${successes.length} æˆåŠŸ, ${issues.length} é—®é¢˜`, 
                    issues.length === 0 ? 'success' : 'warning');
            }

            async testDatabase() {
                this.log('ğŸ”— å¼€å§‹æ•°æ®åº“è¿æ¥æµ‹è¯•...', 'info');
                this.updateProgress(2, 4);
                
                try {
                    // ç­‰å¾…SupabaseåŠ è½½
                    if (typeof window.ensureSupabaseLoaded === 'function') {
                        this.log('â³ ç­‰å¾…Supabase SDKåŠ è½½...', 'info');
                        await window.ensureSupabaseLoaded();
                        this.log('âœ… Supabase SDKåŠ è½½å®Œæˆ', 'success');
                    }
                    
                    // æ£€æŸ¥æ•°æ®åº“åˆå§‹åŒ–
                    if (typeof window.initSupabase === 'function') {
                        this.log('â³ åˆå§‹åŒ–æ•°æ®åº“è¿æ¥...', 'info');
                        await window.initSupabase();
                        
                        if (window.isDatabaseReady && window.isDatabaseReady()) {
                            this.log('âœ… æ•°æ®åº“åˆå§‹åŒ–æˆåŠŸ', 'success');
                            this.setStatus('dbStatus', 'âœ… æ•°æ®åº“è¿æ¥æ­£å¸¸', 'success');
                        } else {
                            throw new Error('æ•°æ®åº“æœªæ­£ç¡®åˆå§‹åŒ–');
                        }
                    } else {
                        throw new Error('initSupabase å‡½æ•°ä¸å¯ç”¨');
                    }
                    
                } catch (error) {
                    this.log(`âŒ æ•°æ®åº“è¿æ¥æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                    this.setStatus('dbStatus', `âŒ æ•°æ®åº“è¿æ¥å¤±è´¥: ${error.message}`, 'error');
                }
            }

            async testFunctions() {
                this.log('ğŸ“Š å¼€å§‹åŠŸèƒ½æµ‹è¯•...', 'info');
                this.updateProgress(3, 4);
                
                let passedTests = 0;
                let totalTests = 4;
                
                // æµ‹è¯•1: æ£€æŸ¥æ ¸å¿ƒå‡½æ•°
                const coreFunctions = ['registerUser', 'loginUser', 'getUserById', 'updateUserPoints'];
                for (const func of coreFunctions) {
                    if (typeof window[func] === 'function') {
                        this.log(`âœ… ${func} å‡½æ•°å¯ç”¨`, 'success');
                        passedTests++;
                    } else {
                        this.log(`âŒ ${func} å‡½æ•°ä¸å¯ç”¨`, 'error');
                    }
                }
                
                const statusMessage = `åŠŸèƒ½æµ‹è¯•å®Œæˆ: ${passedTests}/${totalTests} é€šè¿‡`;
                const statusType = passedTests === totalTests ? 'success' : 
                                 passedTests > totalTests / 2 ? 'warning' : 'error';
                                 
                this.setStatus('functionStatus', statusMessage, statusType);
                this.log(statusMessage, statusType);
            }

            generateFinalReport() {
                this.updateProgress(4, 4);
                this.log('ğŸ“‹ ç”Ÿæˆæœ€ç»ˆæŠ¥å‘Š...', 'info');
                
                const dbStatus = document.getElementById('dbStatus').textContent.includes('âœ…');
                const scriptStatus = !document.getElementById('scriptStatus').textContent.includes('âŒ');
                const functionStatus = document.getElementById('functionStatus').textContent.includes('âœ…');
                
                const overallSuccess = dbStatus && scriptStatus && functionStatus;
                
                let reportMessage;
                let reportType;
                
                if (overallSuccess) {
                    reportMessage = 'ğŸ‰ ä¿®å¤éªŒè¯æˆåŠŸï¼æ‰€æœ‰æµ‹è¯•é€šè¿‡';
                    reportType = 'success';
                } else {
                    reportMessage = 'âš ï¸ ä¿®å¤éªŒè¯éƒ¨åˆ†å®Œæˆï¼Œå­˜åœ¨ä¸€äº›é—®é¢˜';
                    reportType = 'warning';
                }
                
                this.setStatus('overallStatus', reportMessage, reportType);
                this.log('='.repeat(50), 'info');
                this.log(reportMessage, reportType);
                this.log('='.repeat(50), 'info');
                
                // æä¾›ä¿®å¤å»ºè®®
                if (!overallSuccess) {
                    this.log('ğŸ”§ ä¿®å¤å»ºè®®:', 'info');
                    if (!dbStatus) {
                        this.log('- æ£€æŸ¥Supabaseé…ç½®å’Œç½‘ç»œè¿æ¥', 'warning');
                    }
                    if (!scriptStatus) {
                        this.log('- æ£€æŸ¥è„šæœ¬æ–‡ä»¶æ˜¯å¦æ­£ç¡®åŠ è½½', 'warning');
                    }
                    if (!functionStatus) {
                        this.log('- æ£€æŸ¥æ•°æ®åº“å‡½æ•°å®šä¹‰', 'warning');
                    }
                }
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆåå¯åŠ¨éªŒè¯
        document.addEventListener('DOMContentLoaded', function() {
            new FixVerificationTool();
        });
    </script>
</body>
</html>








































































