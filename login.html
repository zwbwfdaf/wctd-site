<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#3b82f6">
    <title>ç”¨æˆ·ç™»å½• - æ–‡åˆ›é‚¦</title>
    <!-- æ¡Œé¢åº”ç”¨å¯åŠ¨å™¨ -->
    <script src="app-launcher.js"></script>
    <!-- ç´§æ€¥æ•°æ®åº“ä¿®å¤å™¨ -->
    <script src="emergency-database-fix.js"></script>
    <!-- ç§»é™¤å¤–éƒ¨CDNä¾èµ–ï¼Œä½¿ç”¨å†…è”æ ·å¼ç¡®ä¿åœ¨å—é™ç½‘ç»œç¯å¢ƒä¸‹å¯è®¿é—® -->
    <link rel="stylesheet" href="theme.css">
    <style>
        :root {
            --primary-color: #ff7a45;
            --primary-light: #fff0e6;
            --gradient-start: #ff7a45;
            --gradient-end: #ff9500;
            --text-primary: #333;
            --text-secondary: #666;
        }

        body {
            background: #F8EDE3;
            min-height: 100vh;
            font-family: 'PingFang SC', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            position: relative;
            overflow: hidden;
        }
        
        body::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" width="100" height="100" opacity="0.1"><path d="M50 0 L100 50 L50 100 L0 50 Z" fill="%23D2B48C"/></svg>');
            background-size: 400px 400px;
            opacity: 0.1;
            z-index: -1;
        }
        
        .login-container {
            background: transparent;
            border-radius: 0;
            box-shadow: none;
            position: relative;
            overflow: visible;
            padding: 20px;
        }
        
        .form-input {
            border: 2px solid #f0f0f0;
            border-radius: 16px;
            transition: all 0.3s ease;
            padding: 14px 18px;
            background: rgba(255, 255, 255, 0.9);
            font-size: 15px;
        }
        
        .form-input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(255, 122, 69, 0.1);
            outline: none;
            background: white;
        }
        
        .form-input::placeholder {
            color: #999;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
            border-radius: 16px;
            padding: 16px 24px;
            font-weight: 600;
            transition: all 0.3s ease;
            border: none;
            position: relative;
            overflow: hidden;
        }
        
        .btn-primary::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.2), transparent);
            transform: translateX(-100%);
            transition: transform 0.5s ease;
        }
        
        .btn-primary:hover::before {
            transform: translateX(100%);
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(255, 122, 69, 0.3);
        }
        
        .form-switch {
            color: var(--primary-color);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            display: inline-block;
        }
        
        .form-switch::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            width: 100%;
            height: 2px;
            background: linear-gradient(to right, var(--gradient-start), var(--gradient-end));
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }
        
        .form-switch:hover::after {
            transform: scaleX(1);
        }
        
        .form-switch:hover {
            color: var(--gradient-end);
        }
        
        .error-message,
        .success-message {
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 20px;
            display: none;
            animation: slideIn 0.3s ease;
            position: relative;
            overflow: hidden;
            font-size: 14px;
            line-height: 1.5;
        }
        
        @keyframes slideIn {
            from {
                transform: translateY(-10px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        .error-message {
            background: rgba(254, 226, 226, 0.8);
            border: 1px solid rgba(254, 202, 202, 0.5);
            color: #dc2626;
            backdrop-filter: blur(8px);
        }
        
        .success-message {
            background: rgba(220, 252, 231, 0.8);
            border: 1px solid rgba(187, 247, 208, 0.5);
            color: #16a34a;
            backdrop-filter: blur(8px);
        }
        
        .error-message::before,
        .success-message::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
        }
        
        .error-message::before {
            background: linear-gradient(to bottom, #ef4444, #dc2626);
        }
        
        .success-message::before {
            background: linear-gradient(to bottom, #22c55e, #16a34a);
        }
        
        .error-message i,
        .success-message i {
            margin-right: 8px;
            font-size: 16px;
        }
        
        /* ç½‘ç»œçŠ¶æ€æŒ‡ç¤ºå™¨ */
        .network-indicator {
            padding: 12px 16px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 500;
            display: flex;
            align-items: center;
            transition: all 0.3s ease;
            animation: slideIn 0.3s ease;
        }
        
        .network-online {
            background: rgba(220, 252, 231, 0.8);
            border: 1px solid rgba(187, 247, 208, 0.5);
            color: #16a34a;
            backdrop-filter: blur(8px);
        }
        
        .network-offline {
            background: rgba(254, 226, 226, 0.8);
            border: 1px solid rgba(254, 202, 202, 0.5);
            color: #dc2626;
            backdrop-filter: blur(8px);
        }
        
        .network-indicator i {
            margin-right: 8px;
            font-size: 16px;
        }
        
        /* ä¿¡æ¯æ¶ˆæ¯æ ·å¼ */
        .info-message {
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 20px;
            display: none;
            animation: slideIn 0.3s ease;
            position: relative;
            overflow: hidden;
            font-size: 14px;
            line-height: 1.5;
            background: rgba(219, 234, 254, 0.8);
            border: 1px solid rgba(147, 197, 253, 0.5);
            color: #1e40af;
            backdrop-filter: blur(8px);
        }
        
        .info-message::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: linear-gradient(to bottom, #3b82f6, #1e40af);
        }
        
        .info-message i {
            margin-right: 8px;
            font-size: 16px;
        }
        
        /* Tailwind CSS åŸºç¡€ç±»æ›¿ä»£ */
        .hidden { display: none !important; }
        .flex { display: flex; }
        .items-center { align-items: center; }
        .justify-center { justify-content: center; }
        .justify-between { justify-content: space-between; }
        .text-left { text-align: left; }
        .text-center { text-align: center; }
        .text-xl { font-size: 1.25rem; line-height: 1.75rem; }
        .text-3xl { font-size: 1.875rem; line-height: 2.25rem; }
        .text-sm { font-size: 0.875rem; line-height: 1.25rem; }
        .font-normal { font-weight: 400; }
        .font-bold { font-weight: 700; }
        .font-medium { font-weight: 500; }
        .font-semibold { font-weight: 600; }
        .text-gray-600 { color: rgb(75 85 99); }
        .text-gray-700 { color: rgb(55 65 81); }
        .text-gray-900 { color: rgb(17 24 39); }
        .text-blue-500 { color: rgb(59 130 246); }
        .text-blue-700 { color: rgb(29 78 216); }
        .text-orange-500 { color: rgb(249 115 22); }
        .text-orange-600 { color: rgb(234 88 12); }
        .text-white { color: rgb(255 255 255); }
        .mb-2 { margin-bottom: 0.5rem; }
        .mb-4 { margin-bottom: 1rem; }
        .mb-6 { margin-bottom: 1.5rem; }
        .mb-8 { margin-bottom: 2rem; }
        .mt-4 { margin-top: 1rem; }
        .mt-6 { margin-top: 1.5rem; }
        .mr-2 { margin-right: 0.5rem; }
        .p-4 { padding: 1rem; }
        .p-6 { padding: 1.5rem; }
        .block { display: block; }
        .w-full { width: 100%; }
        .max-w-md { max-width: 28rem; }
        .min-h-screen { min-height: 100vh; }
        .bg-green-500 { background-color: rgb(34 197 94); }
        
        /* FontAwesome å›¾æ ‡æ›¿ä»£ */
        .fas, .fa { 
            font-style: normal; 
            font-variant: normal; 
            text-rendering: auto; 
            line-height: 1;
            display: inline-block;
            font-size: inherit;
        }
        .fa-sign-in-alt::before { content: "ğŸ”‘"; }
        .fa-user-plus::before { content: "ğŸ‘¤"; }
        .fa-search::before { content: "ğŸ”"; }
        .fa-check::before { content: "âœ…"; }
        .fa-check-circle::before { content: "âœ…"; }
        .fa-exclamation-triangle::before { content: "âš ï¸"; }
        .fa-info-circle::before { content: "â„¹ï¸"; }
        .fa-exclamation-circle::before { content: "â—"; }
        .fa-spinner::before { content: "â³"; }
        .fa-key::before { content: "ğŸ”‘"; }
        .fa-wifi::before { content: "ğŸ“¶"; }
        .fa-wifi-slash::before { content: "ğŸ“µ"; }
        .fa-spin { animation: fa-spin 2s infinite linear; }
        .fa-pulse { animation: fa-spin 1s infinite steps(8); }
        
        @keyframes fa-spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(359deg); }
        }
    </style>
</head>
<body class="flex items-center justify-center p-4">
    <div class="login-container w-full max-w-md p-6">
        <!-- ç™»å½•è¡¨å• -->
        <div id="login-form">
            <div class="text-left mb-8">
                <h1 class="text-xl font-normal text-gray-600 mb-4">ç™»å½•</h1>
                <h2 class="text-3xl font-bold text-gray-900 mb-8">æ–‡åˆ›é‚¦</h2>
            </div>
            
            <!-- ç½‘ç»œçŠ¶æ€æŒ‡ç¤ºå™¨ -->
            <div id="network-status" class="network-indicator mb-4" style="display: none;">
                <i class="fas fa-wifi mr-2"></i>
                <span>æ£€æŸ¥ç½‘ç»œçŠ¶æ€...</span>
            </div>
            
            <div class="error-message" id="login-error"></div>
            <div class="success-message" id="login-success"></div>
            
            <form id="login-form-content">
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-medium mb-2" for="login-username">
                        ç”¨æˆ·å
                    </label>
                    <input type="text" id="login-username" class="form-input w-full" placeholder="è¯·è¾“å…¥ç”¨æˆ·å" required>
                </div>
                
                <div class="mb-6">
                    <div class="flex justify-between items-center mb-2">
                        <label class="block text-gray-700 text-sm font-medium" for="login-password">
                            å¯†ç 
                        </label>
                        <a href="#" class="text-sm text-blue-500 hover:text-blue-700" id="forgot-password-link">å¿˜è®°å¯†ç ï¼Ÿ</a>
                    </div>
                    <input type="password" id="login-password" class="form-input w-full" placeholder="è¯·è¾“å…¥å¯†ç " required>
                </div>
                
                <button type="submit" class="btn-primary w-full text-white">
                    <i class="fas fa-sign-in-alt mr-2"></i>ç™»å½•
                </button>
            </form>
            
            <div class="mt-6 text-center">
                <p class="text-gray-600">
                    è¿˜æ²¡æœ‰è´¦æˆ·ï¼Ÿ
                    <span class="form-switch" id="show-register">ç«‹å³æ³¨å†Œ</span>
                </p>
            </div>
        </div>
        
        <!-- æ³¨å†Œè¡¨å• -->
        <div id="register-form" class="hidden">
            <div class="text-left mb-8">
                <h1 class="text-xl font-normal text-gray-600 mb-4">æ³¨å†Œ</h1>
                <h2 class="text-3xl font-bold text-gray-900 mb-8">æ–‡åˆ›é‚¦</h2>
            </div>
            
            <div class="error-message" id="register-error"></div>
            <div class="success-message" id="register-success"></div>
            
            <form id="register-form-content">
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-medium mb-2" for="register-username">
                        ç”¨æˆ·å
                    </label>
                    <input type="text" id="register-username" class="form-input w-full" placeholder="è¯·è¾“å…¥ç”¨æˆ·åï¼ˆè‡³å°‘3ä¸ªå­—ç¬¦ï¼‰" required minlength="3">
                </div>
                
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-medium mb-2" for="register-password">
                        å¯†ç 
                    </label>
                    <input type="password" id="register-password" class="form-input w-full" placeholder="è¯·è¾“å…¥å¯†ç ï¼ˆè‡³å°‘6ä¸ªå­—ç¬¦ï¼‰" required minlength="6">
                </div>
                
                <div class="mb-6">
                    <label class="block text-gray-700 text-sm font-medium mb-2" for="register-confirm-password">
                        ç¡®è®¤å¯†ç 
                    </label>
                    <input type="password" id="register-confirm-password" class="form-input w-full" placeholder="è¯·å†æ¬¡è¾“å…¥å¯†ç " required>
                </div>
                
                <div class="mb-6">
                    <label class="block text-gray-700 text-sm font-medium mb-2" for="register-invite-code">
                        é‚€è¯·ç ï¼ˆå¯é€‰ï¼‰
                    </label>
                    <input type="text" id="register-invite-code" class="form-input w-full" placeholder="å¦‚ï¼šRXXXXXXXï¼ˆæ²¡æœ‰å¯ç•™ç©ºï¼‰">
                </div>
                
                <button type="submit" class="btn-primary w-full text-white">
                    <i class="fas fa-user-plus mr-2"></i>æ³¨å†Œ
                </button>
            </form>
            
            <div class="mt-6 text-center">
                <p class="text-gray-600">
                    å·²æœ‰è´¦æˆ·ï¼Ÿ
                    <span class="form-switch" id="show-login">ç«‹å³ç™»å½•</span>
                </p>
            </div>
        </div>
        
        <!-- å¿˜è®°å¯†ç è¡¨å• -->
        <div id="forgot-password-form" class="hidden">
            <div class="text-left mb-8">
                <h1 class="text-xl font-normal text-gray-600 mb-4">é‡ç½®å¯†ç </h1>
                <h2 class="text-3xl font-bold text-gray-900 mb-8">æ–‡åˆ›é‚¦</h2>
            </div>
            
            <div class="error-message" id="forgot-password-error"></div>
            <div class="success-message" id="forgot-password-success"></div>
            
            <form id="forgot-password-form-content">
                <div class="mb-6">
                    <label class="block text-gray-700 text-sm font-medium mb-2" for="forgot-password-username">
                        ç”¨æˆ·å
                    </label>
                    <input type="text" id="forgot-password-username" class="form-input w-full" placeholder="è¯·è¾“å…¥æ‚¨çš„ç”¨æˆ·å" required>
                </div>
                
                <!-- æ–°å¯†ç è¾“å…¥åŒºåŸŸï¼ˆåˆå§‹éšè—ï¼‰ -->
                <div id="new-password-section" class="mb-6 hidden">
                    <label class="block text-gray-700 text-sm font-medium mb-2" for="new-password">
                        æ–°å¯†ç 
                    </label>
                    <input type="password" id="new-password" class="form-input w-full" placeholder="è¯·è¾“å…¥æ–°å¯†ç " required>
                </div>
                
                <button type="button" id="check-username-btn" class="btn-primary w-full text-white flex items-center justify-center">
                    <i class="fas fa-search mr-2"></i>éªŒè¯ç”¨æˆ·å
                </button>
                
                <button type="submit" id="submit-new-password-btn" class="btn-primary w-full text-white flex items-center justify-center mt-4 hidden">
                    <i class="fas fa-check mr-2"></i>ç¡®è®¤ä¿®æ”¹
                </button>
            </form>
            
            <div class="mt-6 text-center">
                <a href="#" class="text-orange-500 hover:text-orange-600" id="back-to-login">è¿”å›ç™»å½•</a>
            </div>
        </div>
    </div>

    <!-- åŠ è½½Supabase UMD æ„å»ºï¼ˆå›ºå®šç‰ˆæœ¬ï¼‰ with resilient loader -->
    <script src="supabase-loader.js"></script>
    <script>
        // Attempt to load Supabase from multiple CDNs before using
        document.addEventListener('DOMContentLoaded', function(){
            if (typeof ensureSupabaseLoaded === 'function') {
                ensureSupabaseLoaded().then(function(){
                    console.log('âœ… Supabase UMD loaded via loader');
                }).catch(function(err){
                    console.error('âŒ Supabase loader failed:', err);
                });
            }
        });
    </script>
    <!-- ç™»å½•çŠ¶æ€ç®¡ç†å™¨ -->
    <script src="login-status-manager.js"></script>
    <script>
        // ä½¿ç”¨UMDå…¨å±€supabaseå¯¹è±¡è¿›è¡Œåˆå§‹åŒ–
        
        // Supabaseé…ç½®
        const LOGIN_SUPABASE_URL = 'https://ybrveusbwjusnrzgfnok.supabase.co';
        const LOGIN_SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlicnZldXNid2p1c25yemdmbm9rIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY0ODU1NjIsImV4cCI6MjA3MjA2MTU2Mn0.JKPSUli-q9wRuDagE6kwltLk9XgfygE8yznm-Ca82Qk';
        
        // æ•°æ®åº“å­—æ®µå
        let usernameField = 'username';
        let passwordField = 'password';
        let pointsField = 'points';
        let tableStructureDetected = false;
        
        // åŠ¨æ€åŠ è½½Supabaseå®¢æˆ·ç«¯
        let supabase;
        
        // æœ¬åœ°å­˜å‚¨å®‰å…¨å°è£…ï¼ˆå…¼å®¹éšç§æ¨¡å¼/å—é™ç¯å¢ƒï¼‰
        const __memStore = {};
        function safeLocalSet(key, value) {
            try { localStorage.setItem(key, value); } catch (e) { __memStore[key] = value; }
        }
        function safeLocalGet(key) {
            try { const v = localStorage.getItem(key); return v !== null ? v : (__memStore[key] ?? null); }
            catch (e) { return __memStore[key] ?? null; }
        }
        function safeLocalRemove(key) {
            try { localStorage.removeItem(key); } catch (e) { delete __memStore[key]; }
        }
        function safeSessionClear() {
            try { sessionStorage.clear(); } catch (e) {}
        }
        
        // Supabase REST æœ€å°åŒ…è£…ï¼ˆå½“CDNè¢«é˜»æ–­æ—¶ä½¿ç”¨ï¼Œæ— éœ€å¤–éƒ¨SDKï¼‰
        function createSupabaseRestClient(baseUrl, anonKey) {
            const REST_BASE = baseUrl.replace(/\/$/, '') + '/rest/v1';
            
            // å¢å¼ºé”™è¯¯å¤„ç†å’Œé‡è¯•æœºåˆ¶
            async function fetchWithRetry(url, options, retries = 2) {
                for (let i = 0; i <= retries; i++) {
                    try {
                        const controller = new AbortController();
                        const timeoutId = setTimeout(() => controller.abort(), 10000); // 10ç§’è¶…æ—¶
                        
                        const response = await fetch(url, {
                            ...options,
                            signal: controller.signal,
                            headers: {
                                ...options.headers,
                                'Cache-Control': 'no-cache',
                                'Pragma': 'no-cache'
                            }
                        });
                        
                        clearTimeout(timeoutId);
                        return response;
                    } catch (error) {
                        if (i === retries) {
                            // æœ€åä¸€æ¬¡é‡è¯•å¤±è´¥ï¼ŒæŠ›å‡ºæ›´è¯¦ç»†çš„é”™è¯¯
                            if (error.name === 'AbortError') {
                                throw new Error('è¯·æ±‚è¶…æ—¶ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
                            } else if (error.message.includes('Failed to fetch')) {
                                throw new Error('æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–ç¨åé‡è¯•');
                            } else {
                                throw error;
                            }
                        }
                        // é‡è¯•å‰ç­‰å¾…
                        await new Promise(resolve => setTimeout(resolve, 1000 * (i + 1)));
                    }
                }
            }
            
            function from(table) {
                const state = {
                    table: table,
                    selectColumns: '*',
                    filters: [],
                    limitCount: null,
                    count: undefined,
                    single: false,
                    returnRepresentation: false,
                    body: null,
                    method: 'GET',
                    updateData: null
                };
                
                function buildQuery() {
                    const params = new URLSearchParams();
                    if (state.selectColumns) params.set('select', state.selectColumns);
                    if (state.limitCount != null) params.set('limit', String(state.limitCount));
                    state.filters.forEach(([col, op, val]) => {
                        params.append(col, op + '.' + encodeURIComponent(val));
                    });
                    return params.toString();
                }
                
                function buildHeaders() {
                    const headers = {
                        'apikey': anonKey,
                        'Authorization': 'Bearer ' + anonKey,
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    };
                    if (state.returnRepresentation) {
                        headers['Prefer'] = (headers['Prefer'] ? headers['Prefer'] + ',' : '') + 'return=representation';
                    }
                    if (state.count) {
                        headers['Prefer'] = (headers['Prefer'] ? headers['Prefer'] + ',' : '') + ('count=' + state.count);
                    }
                    return headers;
                }
                
                async function doSelect() {
                    const qs = buildQuery();
                    const url = REST_BASE + '/' + encodeURIComponent(state.table) + (qs ? ('?' + qs) : '');
                    try {
                        const res = await fetchWithRetry(url, { method: 'GET', headers: buildHeaders() });
                        if (!res.ok) {
                            let errorMsg = res.statusText;
                            try {
                                const errorText = await res.text();
                                if (errorText) {
                                    const errorData = JSON.parse(errorText);
                                    errorMsg = errorData.message || errorData.hint || errorText;
                                }
                            } catch (e) {
                                // è§£æé”™è¯¯ä¿¡æ¯å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤æ¶ˆæ¯
                            }
                            
                            if (res.status === 401) {
                                errorMsg = 'APIå¯†é’¥æ— æ•ˆæˆ–å·²è¿‡æœŸ';
                            } else if (res.status === 403) {
                                errorMsg = 'æƒé™ä¸è¶³ï¼Œæ— æ³•è®¿é—®æ•°æ®';
                            } else if (res.status === 404) {
                                errorMsg = 'æ•°æ®è¡¨ä¸å­˜åœ¨æˆ–APIç«¯ç‚¹é”™è¯¯';
                            }
                            
                            return { data: null, error: { message: errorMsg, code: String(res.status) } };
                        }
                        const data = await res.json();
                        if (state.single) {
                            return { data: data && data.length > 0 ? data[0] : null, error: null };
                        }
                        return { data, error: null };
                    } catch (e) {
                        return { data: null, error: { message: e.message || 'Network error' } };
                    }
                }
                
                async function doInsert() {
                    const url = REST_BASE + '/' + encodeURIComponent(state.table);
                    try {
                        const res = await fetchWithRetry(url, { 
                            method: 'POST', 
                            headers: buildHeaders(), 
                            body: JSON.stringify(state.body) 
                        });
                        if (!res.ok) {
                            let errorMsg = res.statusText;
                            try {
                                const errorText = await res.text();
                                if (errorText) {
                                    const errorData = JSON.parse(errorText);
                                    errorMsg = errorData.message || errorData.hint || errorText;
                                }
                            } catch (e) {}
                            return { data: null, error: { message: errorMsg, code: String(res.status) } };
                        }
                        const data = state.returnRepresentation ? await res.json() : null;
                        return { data, error: null };
                    } catch (e) {
                        return { data: null, error: { message: e.message || 'Network error' } };
                    }
                }
                
                async function doUpdate() {
                    const qs = buildQuery();
                    const url = REST_BASE + '/' + encodeURIComponent(state.table) + (qs ? ('?' + qs) : '');
                    try {
                        const res = await fetchWithRetry(url, { 
                            method: 'PATCH', 
                            headers: buildHeaders(), 
                            body: JSON.stringify(state.updateData) 
                        });
                        if (!res.ok) {
                            let errorMsg = res.statusText;
                            try {
                                const errorText = await res.text();
                                if (errorText) {
                                    const errorData = JSON.parse(errorText);
                                    errorMsg = errorData.message || errorData.hint || errorText;
                                }
                            } catch (e) {}
                            return { data: null, error: { message: errorMsg, code: String(res.status) } };
                        }
                        const data = state.returnRepresentation ? await res.json() : null;
                        return { data, error: null };
                    } catch (e) {
                        return { data: null, error: { message: e.message || 'Network error' } };
                    }
                }
                
                const builder = {
                    select(columns = '*', opts = {}) {
                        state.selectColumns = columns || '*';
                        if (opts && opts.count) state.count = opts.count;
                        return this;
                    },
                    eq(col, val) { state.filters.push([col, 'eq', val]); return this; },
                    limit(n) { state.limitCount = n; return this; },
                    single() { state.single = true; return doSelect(); },
                    insert(rows) {
                        state.method = 'POST';
                        state.body = rows;
                        const chain = {
                            select() { state.returnRepresentation = true; return doInsert(); },
                            then(res, rej) { state.returnRepresentation = false; return doInsert().then(res, rej); }
                        };
                        return chain;
                    },
                    update(partial) {
                        state.method = 'PATCH';
                        state.updateData = partial;
                        const chain = {
                            eq(col, val) { state.filters.push([col, 'eq', val]); return this; },
                            select() { state.returnRepresentation = true; return doUpdate(); },
                            then(res, rej) { return doUpdate().then(res, rej); }
                        };
                        return chain;
                    },
                    then(res, rej) { return doSelect().then(res, rej); }
                };
                return builder;
            }
            return { from };
        }
        
        // ç”ŸæˆUUID v4ï¼ˆç”¨äºæ»¡è¶³idéç©ºçº¦æŸä¸”ä¸æ”¹åŠ¨æ•°æ®åº“ç»“æ„ï¼‰
        function generateUUIDv4() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                const r = Math.random() * 16 | 0;
                const v = c === 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }
        
        // åˆå§‹åŒ–Supabaseå®¢æˆ·ç«¯ï¼ˆç­‰å¾…SupabaseåŠ è½½å®Œæˆï¼‰
        function initSupabase() {
            try {
                console.log('ğŸ” åˆå§‹åŒ–å®‰å…¨ç™»å½•ç³»ç»Ÿ...');
                const init = () => {
                    const { createClient } = window.supabase;
                    supabase = createClient(LOGIN_SUPABASE_URL, LOGIN_SUPABASE_ANON_KEY);
                    console.log('âœ… Supabaseè¿æ¥æˆåŠŸ');
                
                    // è®¾ç½®ç™»å½•çŠ¶æ€ç®¡ç†å™¨çš„Supabaseå®¢æˆ·ç«¯
                    if (window.LoginStatusManager) {
                        window.LoginStatusManager.setSupabaseClient(supabase);
                        console.log('âœ… ç™»å½•çŠ¶æ€ç®¡ç†å™¨å·²é…ç½®');
                    }
                
                // æ£€æµ‹æ•°æ®åº“è¡¨ç»“æ„
                detectTableStructure();
                
                    // æ˜¾ç¤ºç½‘ç»œçŠ¶æ€
                    updateNetworkStatusDisplay();
                };
                
                // ç­‰å¾…Supabase UMDå¯ç”¨
                if (window.supabase && typeof window.supabase.createClient === 'function') {
                    init();
                } else if (typeof ensureSupabaseLoaded === 'function') {
                    ensureSupabaseLoaded().then(init).catch((e) => {
                        console.warn('âš ï¸ UMDåŠ è½½å¤±è´¥ï¼Œåˆ‡æ¢åˆ°RESTå›é€€æ¨¡å¼:', e && e.message);
                        // ä½¿ç”¨RESTå›é€€å®¢æˆ·ç«¯ï¼Œä¿éšœä½ç½‘ç¯å¢ƒå¯ç”¨
                        supabase = createSupabaseRestClient(LOGIN_SUPABASE_URL, LOGIN_SUPABASE_ANON_KEY);
                        if (window.LoginStatusManager) {
                            window.LoginStatusManager.setSupabaseClient(supabase);
                        }
                        detectTableStructure();
                        updateNetworkStatusDisplay();
                    });
                } else {
                    console.warn('âš ï¸ æœªå‘ç°UMDåŠ è½½å™¨ï¼Œç›´æ¥ä½¿ç”¨RESTå›é€€æ¨¡å¼');
                    supabase = createSupabaseRestClient(LOGIN_SUPABASE_URL, LOGIN_SUPABASE_ANON_KEY);
                    if (window.LoginStatusManager) {
                        window.LoginStatusManager.setSupabaseClient(supabase);
                    }
                    detectTableStructure();
                    updateNetworkStatusDisplay();
                }
                
            } catch (error) {
                console.error('âŒ å®‰å…¨ç™»å½•ç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥:', error);
                // æ˜¾ç¤ºæ›´å…·ä½“çš„é”™è¯¯ä¿¡æ¯
                const errorMsg = error.message.includes('network') ? 'ç½‘ç»œè¿æ¥å¤±è´¥' : 
                                error.message.includes('fetch') ? 'CDNèµ„æºåŠ è½½å¤±è´¥' :
                                error.message.includes('CORS') ? 'è·¨åŸŸè®¿é—®è¢«æ‹¦æˆª' : 
                                'ç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•';
                
                if (window.LoginStatusManager) {
                    window.LoginStatusManager.setState('server_error', errorMsg);
                } else {
                    // å¦‚æœçŠ¶æ€ç®¡ç†å™¨ä¹Ÿæ²¡åŠ è½½æˆåŠŸï¼Œç›´æ¥æ˜¾ç¤ºé”™è¯¯
                    const errorDiv = document.getElementById('login-error');
                    if (errorDiv) {
                        errorDiv.innerHTML = `<i class="fas fa-exclamation-triangle mr-2"></i>${errorMsg}`;
                        errorDiv.style.display = 'block';
                    }
                }
            }
        }
        
        // æ›´æ–°ç½‘ç»œçŠ¶æ€æ˜¾ç¤º
        function updateNetworkStatusDisplay() {
            const networkStatus = document.getElementById('network-status');
            if (networkStatus) {
                networkStatus.style.display = 'flex';
                if (navigator.onLine) {
                    networkStatus.className = 'network-indicator network-online mb-4';
                    networkStatus.innerHTML = '<i class="fas fa-wifi mr-2"></i><span>ç½‘ç»œè¿æ¥æ­£å¸¸</span>';
                } else {
                    networkStatus.className = 'network-indicator network-offline mb-4';
                    networkStatus.innerHTML = '<i class="fas fa-wifi-slash mr-2"></i><span>ç½‘ç»œè¿æ¥æ–­å¼€</span>';
                }
                
                // 3ç§’åéšè—ç½‘ç»œçŠ¶æ€
                setTimeout(() => {
                    if (navigator.onLine) {
                        networkStatus.style.display = 'none';
                    }
                }, 3000);
            }
        }
        
        // ç®€åŒ–çš„é”™è¯¯å¤„ç† - ä¸æ˜¾ç¤ºè¯Šæ–­ä¿¡æ¯
        function setupErrorHandling() {
            // é™é»˜å¤„ç†é”™è¯¯ï¼Œè®°å½•åˆ°æ§åˆ¶å°ä½†ä¸æ˜¾ç¤ºç»™ç”¨æˆ·
            window.addEventListener('error', function (e) {
                console.log('é¡µé¢é”™è¯¯:', e.message);
            });
            window.addEventListener('unhandledrejection', function (e) {
                console.log('Promiseé”™è¯¯:', e.reason);
            });
        }
        
        // æ£€æµ‹æ•°æ®åº“è¡¨ç»“æ„
        async function detectTableStructure() {
            try {
                // é™é»˜æ£€æµ‹æ•°æ®åº“è¡¨ç»“æ„
                const { data, error } = await supabase
                    .from('users')
                    .select('*')
                    .limit(1);
                
                if (error) {
                    // é™é»˜å¤„ç†é”™è¯¯
                    return;
                }
                
                if (data && data.length > 0) {
                    const fields = Object.keys(data[0]);
                    // æ£€æµ‹å­—æ®µç±»å‹
                    
                    // åˆ¤æ–­ä½¿ç”¨çš„æ˜¯ä¸­æ–‡å­—æ®µåè¿˜æ˜¯è‹±æ–‡å­—æ®µå
                    if (fields.includes('ç”¨æˆ·å')) {
                        usernameField = 'ç”¨æˆ·å';
                        passwordField = 'å¯†ç ';
                        pointsField = 'ç§¯åˆ†';
                        // ä½¿ç”¨ä¸­æ–‡å­—æ®µå
                    } else {
                        usernameField = 'username';
                        passwordField = 'password';
                        pointsField = 'points';
                        // ä½¿ç”¨è‹±æ–‡å­—æ®µå
                    }
                    
                    tableStructureDetected = true;
                } else {
                    // ä½¿ç”¨é»˜è®¤è‹±æ–‡å­—æ®µå
                }
            } catch (error) {
                // é™é»˜å¤„ç†é”™è¯¯
            }
        }
        
        // åˆå§‹åŒ–
        initSupabase();
        
        // é¡µé¢åˆ‡æ¢
        document.getElementById('show-register').addEventListener('click', function() {
            document.getElementById('login-form').classList.add('hidden');
            document.getElementById('register-form').classList.remove('hidden');
            document.getElementById('forgot-password-form').classList.add('hidden');
            clearMessages();
        });
        document.getElementById('show-login').addEventListener('click', function() {
            document.getElementById('login-form').classList.remove('hidden');
            document.getElementById('register-form').classList.add('hidden');
            document.getElementById('forgot-password-form').classList.add('hidden');
            clearMessages();
        });
        document.getElementById('back-to-login').addEventListener('click', function() {
            document.getElementById('login-form').classList.remove('hidden');
            document.getElementById('register-form').classList.add('hidden');
            document.getElementById('forgot-password-form').classList.add('hidden');
            clearMessages();
        });
        document.getElementById('forgot-password-link').addEventListener('click', function(e) {
            e.preventDefault();
            document.getElementById('login-form').classList.add('hidden');
            document.getElementById('register-form').classList.add('hidden');
            document.getElementById('forgot-password-form').classList.remove('hidden');
            clearMessages();
        });
        
        function clearMessages() {
            document.getElementById('login-error').style.display = 'none';
            document.getElementById('login-success').style.display = 'none';
            document.getElementById('register-error').style.display = 'none';
            document.getElementById('register-success').style.display = 'none';
            document.getElementById('forgot-password-error').style.display = 'none';
            document.getElementById('forgot-password-success').style.display = 'none';
        }

        // ç®€å•çš„æ¶ˆæ¯å±•ç¤ºåŠ©æ‰‹ï¼ˆæ³¨å†Œ/ç™»å½•é€šç”¨ï¼‰
        function showError(scope, message) {
            const errorEl = scope === 'register' ? document.getElementById('register-error') : document.getElementById('login-error');
            const successEl = scope === 'register' ? document.getElementById('register-success') : document.getElementById('login-success');
            if (successEl) successEl.style.display = 'none';
            if (errorEl) {
                errorEl.innerHTML = `<i class="fas fa-exclamation-triangle mr-2"></i>${message}`;
                errorEl.style.display = 'block';
            }
        }
        function showSuccess(scope, message) {
            const errorEl = scope === 'register' ? document.getElementById('register-error') : document.getElementById('login-error');
            const successEl = scope === 'register' ? document.getElementById('register-success') : document.getElementById('login-success');
            if (errorEl) errorEl.style.display = 'none';
            if (successEl) {
                successEl.innerHTML = `<i class="fas fa-check-circle mr-2"></i>${message}`;
                successEl.style.display = 'block';
            }
        }

        // æ³¨å†Œè¡¨å•æäº¤
        document.getElementById('register-form-content').addEventListener('submit', async function(e) {
            e.preventDefault();
            const username = document.getElementById('register-username').value.trim();
            const password = document.getElementById('register-password').value;
            const confirmPassword = document.getElementById('register-confirm-password').value;
            const inviteCode = (document.getElementById('register-invite-code')?.value||'').trim();
            if (!username || !password || !confirmPassword) { showError('register', 'è¯·å¡«å†™æ‰€æœ‰å­—æ®µ'); return; }
            if (username.length < 3) { showError('register', 'ç”¨æˆ·åè‡³å°‘éœ€è¦3ä¸ªå­—ç¬¦'); return; }
            if (password.length < 6) { showError('register', 'å¯†ç è‡³å°‘éœ€è¦6ä¸ªå­—ç¬¦'); return; }
            if (password !== confirmPassword) { showError('register', 'ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´'); return; }
            try {
                const user = await registerUser(username, password);
                if (user) {
                    try{
                        const urlParams = new URLSearchParams(window.location.search);
                        const urlCode = urlParams.get('code') || '';
                        const code = inviteCode || urlCode;
                        if (code) { await processInviteBinding(code, user, supabase); }
                    }catch(_){ }
                    showSuccess('register', 'æ³¨å†ŒæˆåŠŸï¼æ­£åœ¨è·³è½¬åˆ°ç™»å½•é¡µé¢...');
                    document.getElementById('register-form-content').reset();
                    setTimeout(() => { document.getElementById('show-login').click(); }, 1500);
                }
            } catch (error) {
                if ((error.message||'').includes('duplicate')) { showError('register', 'ç”¨æˆ·åå·²å­˜åœ¨ï¼Œè¯·é€‰æ‹©å…¶ä»–ç”¨æˆ·å'); }
                else { showError('register', 'æ³¨å†Œå¤±è´¥ï¼š' + error.message); }
            }
        });

        // å¤„ç†é‚€è¯·ç ç»‘å®š
        async function processInviteBinding(code, user, client){
            try{
                const inviterId = code; // ä¿ç•™åŸæœ‰çŸ­ç /IDé€»è¾‘ï¼Œä¸ä½œå¼ºæ ¡éªŒ
                if(!client || !user || !user.id) return;
                try{ await client.rpc('exec_sql', { sql_query: "CREATE TABLE IF NOT EXISTS public.referrals (id uuid default gen_random_uuid() primary key, inviter_id text, invitee_id text, created_at timestamptz default now()); ALTER TABLE public.referrals ENABLE ROW LEVEL SECURITY; DROP POLICY IF EXISTS referrals_select ON public.referrals; CREATE POLICY referrals_select ON public.referrals FOR SELECT TO anon USING (true); DROP POLICY IF EXISTS referrals_insert ON public.referrals; CREATE POLICY referrals_insert ON public.referrals FOR INSERT TO anon WITH CHECK (true);" }); }catch(_){ }
                await client.from('referrals').insert([{ inviter_id: inviterId, invitee_id: user.id }]);
                try{ const cu = JSON.parse(localStorage.getItem('currentUser')||'{}'); cu.invited_by = inviterId; localStorage.setItem('currentUser', JSON.stringify(cu)); }catch(_){ }
            }catch(_){ }
        }
    </script>
    
    <!-- ğŸ”§ ç®€åŒ–ä¿®å¤ï¼šåªä¿ç•™å¿…è¦çš„çœŸå®æ•°æ®åº“è¿æ¥ -->
    <script>
        // ç¡®ä¿ä½¿ç”¨çœŸå®Supabaseè¿æ¥ï¼Œæ¸…ç†æ‰€æœ‰å¯èƒ½çš„å†²çª
        console.log('ğŸ”§ ç®€åŒ–ä¿®å¤å¯åŠ¨ - æ¸…ç†è„šæœ¬å†²çª');
        
        // ç­‰å¾…é¡µé¢åŠ è½½å®ŒæˆåéªŒè¯Supabaseè¿æ¥
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                if (window.supabase && typeof window.supabase.from === 'function') {
                    console.log('âœ… SupabaseçœŸå®è¿æ¥å·²å°±ç»ª');
                    
                    // æµ‹è¯•æ•°æ®åº“è¿æ¥
                    testDatabaseConnection();
                } else {
                    console.error('âŒ Supabaseè¿æ¥å¤±è´¥');
                }
            }, 1000);
        });
        
        // æµ‹è¯•æ•°æ®åº“è¿æ¥
        async function testDatabaseConnection() {
            try {
                const { data, error } = await supabase
                    .from('users')
                    .select('*', { count: 'exact', head: true });
                
                if (error) {
                    console.error('âŒ æ•°æ®åº“è¿æ¥æµ‹è¯•å¤±è´¥:', error);
                } else {
                    console.log(`âœ… æ•°æ®åº“è¿æ¥æ­£å¸¸ï¼Œç”¨æˆ·è¡¨æœ‰ ${data?.count || 0} æ¡è®°å½•`);
                }
            } catch (err) {
                console.error('âŒ æ•°æ®åº“è¿æ¥å¼‚å¸¸:', err);
            }
        }
        
        // å¼ºåˆ¶ä½¿ç”¨æ ‡å‡†å­—æ®µåï¼Œé¿å…æ£€æµ‹é”™è¯¯
        window.addEventListener('load', function() {
            // å¼ºåˆ¶è®¾ç½®ä¸ºæ ‡å‡†è‹±æ–‡å­—æ®µå
            usernameField = 'username';
            passwordField = 'password';
            pointsField = 'points';
            tableStructureDetected = true;
            
            console.log('ğŸ”§ å¼ºåˆ¶ä½¿ç”¨æ ‡å‡†å­—æ®µå: username, password, points');
        });
    </script>
</body>
</html>

