<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🚨 强制缓存突破测试</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; padding: 20px; background: #f8f9fa; }
        .container { max-width: 800px; margin: 0 auto; }
        .status { padding: 15px; margin: 10px 0; border-radius: 8px; font-weight: 500; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .btn { background: #007bff; color: white; border: none; padding: 12px 20px; border-radius: 6px; cursor: pointer; margin: 5px; font-size: 14px; }
        .btn:hover { background: #0056b3; }
        .btn-success { background: #28a745; }
        .btn-danger { background: #dc3545; }
        .log { background: #2d3748; color: #e2e8f0; padding: 15px; border-radius: 8px; font-family: 'Courier New', monospace; font-size: 13px; max-height: 300px; overflow-y: auto; white-space: pre-wrap; margin: 10px 0; }
        .highlight { background: #ffeaa7; padding: 20px; border-radius: 8px; margin: 20px 0; border-left: 4px solid #f39c12; }
    </style>
</head>
<body>
    <div class="container">
        <h1>🚨 强制缓存突破测试工具</h1>
        <p>此工具将强制绕过所有缓存层，直接测试修复效果</p>

        <div class="highlight">
            <h3>🎯 当前任务：验证emergency-database-fix.js是否生效</h3>
            <p>由于缓存问题，修复文件可能没有立即生效。我们将使用多种方法强制突破缓存。</p>
        </div>

        <div id="testResults"></div>
        
        <div style="margin: 20px 0;">
            <button class="btn btn-success" onclick="testCacheBypass()">🚀 测试缓存突破</button>
            <button class="btn btn-danger" onclick="forceLoadFix()">⚡ 强制加载修复</button>
            <button class="btn" onclick="testAllMethods()">🔍 全面测试</button>
            <button class="btn" onclick="clearLog()">🗑️ 清除日志</button>
        </div>

        <div id="testLog" class="log"></div>
    </div>

    <script>
        const timestamp = Date.now();
        const cacheBreaker = Math.random().toString(36).substring(2);
        
        function log(message, type = 'info') {
            const logDiv = document.getElementById('testLog');
            const time = new Date().toLocaleTimeString();
            const prefix = type === 'success' ? '✅' : type === 'error' ? '❌' : type === 'warning' ? '⚠️' : 'ℹ️';
            logDiv.innerHTML += `[${time}] ${prefix} ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }

        function showStatus(message, type) {
            const resultsDiv = document.getElementById('testResults');
            resultsDiv.innerHTML += `<div class="status ${type}">${message}</div>`;
        }

        function clearLog() {
            document.getElementById('testLog').innerHTML = '';
            document.getElementById('testResults').innerHTML = '';
        }

        // 方法1: 测试缓存突破URL
        async function testCacheBypass() {
            log('🚀 开始缓存突破测试...', 'info');
            
            const testUrls = [
                `emergency-database-fix.js?v=${timestamp}&cache=bypass&t=${cacheBreaker}`,
                `emergency-database-fix.js?_=${timestamp}&nocache=1&r=${Math.random()}`,
                `emergency-database-fix.js?bust=${Date.now()}&force=true&rand=${Math.floor(Math.random()*999999)}`
            ];
            
            for (let i = 0; i < testUrls.length; i++) {
                const url = testUrls[i];
                try {
                    log(`🔍 测试URL ${i+1}: ${url}`, 'info');
                    
                    const response = await fetch(url, {
                        method: 'GET',
                        cache: 'no-cache',
                        headers: {
                            'Cache-Control': 'no-cache, no-store, must-revalidate',
                            'Pragma': 'no-cache',
                            'Expires': '0'
                        }
                    });
                    
                    if (response.ok) {
                        const content = await response.text();
                        if (content.includes('emergencyInitDatabase')) {
                            log(`✅ URL ${i+1} 成功获取到修复文件内容`, 'success');
                            showStatus(`✅ 缓存突破成功 - 修复文件可访问`, 'success');
                            
                            // 尝试动态加载
                            await dynamicLoadScript(url);
                            return;
                        } else {
                            log(`❌ URL ${i+1} 内容不正确`, 'error');
                        }
                    } else {
                        log(`❌ URL ${i+1} 返回状态: ${response.status}`, 'error');
                    }
                } catch (error) {
                    log(`❌ URL ${i+1} 请求失败: ${error.message}`, 'error');
                }
            }
            
            showStatus(`❌ 所有缓存突破尝试都失败`, 'error');
        }

        // 方法2: 强制加载修复脚本
        async function forceLoadFix() {
            log('⚡ 强制加载修复脚本...', 'info');
            
            try {
                // 移除现有的脚本
                const existingScripts = document.querySelectorAll('script[src*="emergency-database-fix"]');
                existingScripts.forEach(script => script.remove());
                
                // 清除相关全局变量
                delete window.emergencyInitDatabase;
                delete window.supabaseClient;
                delete window.emergencyDBReady;
                
                const cacheBreakUrl = `emergency-database-fix.js?force=${Date.now()}&bypass=all&r=${Math.random()}`;
                
                await dynamicLoadScript(cacheBreakUrl);
                
            } catch (error) {
                log(`❌ 强制加载失败: ${error.message}`, 'error');
                showStatus(`❌ 强制加载修复脚本失败`, 'error');
            }
        }

        // 动态加载脚本
        function dynamicLoadScript(url) {
            return new Promise((resolve, reject) => {
                log(`📦 动态加载脚本: ${url}`, 'info');
                
                const script = document.createElement('script');
                script.src = url;
                script.async = false;
                
                script.onload = function() {
                    log('✅ 脚本加载成功', 'success');
                    
                    // 检查关键函数是否可用
                    if (typeof window.emergencyInitDatabase === 'function') {
                        log('✅ emergencyInitDatabase 函数已加载', 'success');
                        showStatus('✅ 紧急修复脚本加载成功', 'success');
                        
                        // 尝试初始化
                        initializeEmergencyFix();
                        resolve();
                    } else {
                        log('❌ emergencyInitDatabase 函数未找到', 'error');
                        showStatus('❌ 修复脚本加载不完整', 'error');
                        reject(new Error('函数未加载'));
                    }
                };
                
                script.onerror = function() {
                    log('❌ 脚本加载失败', 'error');
                    showStatus('❌ 无法加载修复脚本', 'error');
                    reject(new Error('脚本加载失败'));
                };
                
                document.head.appendChild(script);
            });
        }

        // 初始化紧急修复
        async function initializeEmergencyFix() {
            log('🔧 初始化紧急修复...', 'info');
            
            try {
                await window.emergencyInitDatabase();
                log('✅ 紧急修复初始化成功', 'success');
                showStatus('🎉 数据库修复完成！刷新页面查看效果', 'success');
                
                // 提示用户刷新
                setTimeout(() => {
                    if (confirm('修复完成！是否刷新页面查看效果？')) {
                        location.reload(true);
                    }
                }, 2000);
                
            } catch (error) {
                log(`❌ 紧急修复初始化失败: ${error.message}`, 'error');
                showStatus(`❌ 修复初始化失败: ${error.message}`, 'error');
            }
        }

        // 全面测试
        async function testAllMethods() {
            log('🔍 开始全面测试...', 'info');
            clearLog();
            
            // 测试1: 检查当前环境
            log('=== 环境检查 ===', 'info');
            log(`当前时间: ${new Date().toISOString()}`, 'info');
            log(`页面URL: ${location.href}`, 'info');
            log(`用户代理: ${navigator.userAgent}`, 'info');
            
            // 测试2: 检查现有全局变量
            log('=== 全局变量检查 ===', 'info');
            log(`window.supabase: ${typeof window.supabase}`, 'info');
            log(`window.emergencyInitDatabase: ${typeof window.emergencyInitDatabase}`, 'info');
            log(`window.supabaseClient: ${typeof window.supabaseClient}`, 'info');
            
            // 测试3: 缓存突破
            log('=== 缓存突破测试 ===', 'info');
            await testCacheBypass();
            
            // 测试4: 如果失败，尝试强制加载
            if (typeof window.emergencyInitDatabase !== 'function') {
                log('=== 强制加载测试 ===', 'info');
                await forceLoadFix();
            }
        }

        // 页面加载完成后显示状态
        document.addEventListener('DOMContentLoaded', function() {
            log('🚀 强制缓存突破工具已启动', 'info');
            showStatus('准备进行缓存突破测试...', 'info');
        });
    </script>
</body>
</html>









































































