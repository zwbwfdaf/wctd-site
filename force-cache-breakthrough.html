<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸš¨ å¼ºåˆ¶ç¼“å­˜çªç ´æµ‹è¯•</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; padding: 20px; background: #f8f9fa; }
        .container { max-width: 800px; margin: 0 auto; }
        .status { padding: 15px; margin: 10px 0; border-radius: 8px; font-weight: 500; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .btn { background: #007bff; color: white; border: none; padding: 12px 20px; border-radius: 6px; cursor: pointer; margin: 5px; font-size: 14px; }
        .btn:hover { background: #0056b3; }
        .btn-success { background: #28a745; }
        .btn-danger { background: #dc3545; }
        .log { background: #2d3748; color: #e2e8f0; padding: 15px; border-radius: 8px; font-family: 'Courier New', monospace; font-size: 13px; max-height: 300px; overflow-y: auto; white-space: pre-wrap; margin: 10px 0; }
        .highlight { background: #ffeaa7; padding: 20px; border-radius: 8px; margin: 20px 0; border-left: 4px solid #f39c12; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸš¨ å¼ºåˆ¶ç¼“å­˜çªç ´æµ‹è¯•å·¥å…·</h1>
        <p>æ­¤å·¥å…·å°†å¼ºåˆ¶ç»•è¿‡æ‰€æœ‰ç¼“å­˜å±‚ï¼Œç›´æ¥æµ‹è¯•ä¿®å¤æ•ˆæœ</p>

        <div class="highlight">
            <h3>ğŸ¯ å½“å‰ä»»åŠ¡ï¼šéªŒè¯emergency-database-fix.jsæ˜¯å¦ç”Ÿæ•ˆ</h3>
            <p>ç”±äºç¼“å­˜é—®é¢˜ï¼Œä¿®å¤æ–‡ä»¶å¯èƒ½æ²¡æœ‰ç«‹å³ç”Ÿæ•ˆã€‚æˆ‘ä»¬å°†ä½¿ç”¨å¤šç§æ–¹æ³•å¼ºåˆ¶çªç ´ç¼“å­˜ã€‚</p>
        </div>

        <div id="testResults"></div>
        
        <div style="margin: 20px 0;">
            <button class="btn btn-success" onclick="testCacheBypass()">ğŸš€ æµ‹è¯•ç¼“å­˜çªç ´</button>
            <button class="btn btn-danger" onclick="forceLoadFix()">âš¡ å¼ºåˆ¶åŠ è½½ä¿®å¤</button>
            <button class="btn" onclick="testAllMethods()">ğŸ” å…¨é¢æµ‹è¯•</button>
            <button class="btn" onclick="clearLog()">ğŸ—‘ï¸ æ¸…é™¤æ—¥å¿—</button>
        </div>

        <div id="testLog" class="log"></div>
    </div>

    <script>
        const timestamp = Date.now();
        const cacheBreaker = Math.random().toString(36).substring(2);
        
        function log(message, type = 'info') {
            const logDiv = document.getElementById('testLog');
            const time = new Date().toLocaleTimeString();
            const prefix = type === 'success' ? 'âœ…' : type === 'error' ? 'âŒ' : type === 'warning' ? 'âš ï¸' : 'â„¹ï¸';
            logDiv.innerHTML += `[${time}] ${prefix} ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }

        function showStatus(message, type) {
            const resultsDiv = document.getElementById('testResults');
            resultsDiv.innerHTML += `<div class="status ${type}">${message}</div>`;
        }

        function clearLog() {
            document.getElementById('testLog').innerHTML = '';
            document.getElementById('testResults').innerHTML = '';
        }

        // æ–¹æ³•1: æµ‹è¯•ç¼“å­˜çªç ´URL
        async function testCacheBypass() {
            log('ğŸš€ å¼€å§‹ç¼“å­˜çªç ´æµ‹è¯•...', 'info');
            
            const testUrls = [
                `emergency-database-fix.js?v=${timestamp}&cache=bypass&t=${cacheBreaker}`,
                `emergency-database-fix.js?_=${timestamp}&nocache=1&r=${Math.random()}`,
                `emergency-database-fix.js?bust=${Date.now()}&force=true&rand=${Math.floor(Math.random()*999999)}`
            ];
            
            for (let i = 0; i < testUrls.length; i++) {
                const url = testUrls[i];
                try {
                    log(`ğŸ” æµ‹è¯•URL ${i+1}: ${url}`, 'info');
                    
                    const response = await fetch(url, {
                        method: 'GET',
                        cache: 'no-cache',
                        headers: {
                            'Cache-Control': 'no-cache, no-store, must-revalidate',
                            'Pragma': 'no-cache',
                            'Expires': '0'
                        }
                    });
                    
                    if (response.ok) {
                        const content = await response.text();
                        if (content.includes('emergencyInitDatabase')) {
                            log(`âœ… URL ${i+1} æˆåŠŸè·å–åˆ°ä¿®å¤æ–‡ä»¶å†…å®¹`, 'success');
                            showStatus(`âœ… ç¼“å­˜çªç ´æˆåŠŸ - ä¿®å¤æ–‡ä»¶å¯è®¿é—®`, 'success');
                            
                            // å°è¯•åŠ¨æ€åŠ è½½
                            await dynamicLoadScript(url);
                            return;
                        } else {
                            log(`âŒ URL ${i+1} å†…å®¹ä¸æ­£ç¡®`, 'error');
                        }
                    } else {
                        log(`âŒ URL ${i+1} è¿”å›çŠ¶æ€: ${response.status}`, 'error');
                    }
                } catch (error) {
                    log(`âŒ URL ${i+1} è¯·æ±‚å¤±è´¥: ${error.message}`, 'error');
                }
            }
            
            showStatus(`âŒ æ‰€æœ‰ç¼“å­˜çªç ´å°è¯•éƒ½å¤±è´¥`, 'error');
        }

        // æ–¹æ³•2: å¼ºåˆ¶åŠ è½½ä¿®å¤è„šæœ¬
        async function forceLoadFix() {
            log('âš¡ å¼ºåˆ¶åŠ è½½ä¿®å¤è„šæœ¬...', 'info');
            
            try {
                // ç§»é™¤ç°æœ‰çš„è„šæœ¬
                const existingScripts = document.querySelectorAll('script[src*="emergency-database-fix"]');
                existingScripts.forEach(script => script.remove());
                
                // æ¸…é™¤ç›¸å…³å…¨å±€å˜é‡
                delete window.emergencyInitDatabase;
                delete window.supabaseClient;
                delete window.emergencyDBReady;
                
                const cacheBreakUrl = `emergency-database-fix.js?force=${Date.now()}&bypass=all&r=${Math.random()}`;
                
                await dynamicLoadScript(cacheBreakUrl);
                
            } catch (error) {
                log(`âŒ å¼ºåˆ¶åŠ è½½å¤±è´¥: ${error.message}`, 'error');
                showStatus(`âŒ å¼ºåˆ¶åŠ è½½ä¿®å¤è„šæœ¬å¤±è´¥`, 'error');
            }
        }

        // åŠ¨æ€åŠ è½½è„šæœ¬
        function dynamicLoadScript(url) {
            return new Promise((resolve, reject) => {
                log(`ğŸ“¦ åŠ¨æ€åŠ è½½è„šæœ¬: ${url}`, 'info');
                
                const script = document.createElement('script');
                script.src = url;
                script.async = false;
                
                script.onload = function() {
                    log('âœ… è„šæœ¬åŠ è½½æˆåŠŸ', 'success');
                    
                    // æ£€æŸ¥å…³é”®å‡½æ•°æ˜¯å¦å¯ç”¨
                    if (typeof window.emergencyInitDatabase === 'function') {
                        log('âœ… emergencyInitDatabase å‡½æ•°å·²åŠ è½½', 'success');
                        showStatus('âœ… ç´§æ€¥ä¿®å¤è„šæœ¬åŠ è½½æˆåŠŸ', 'success');
                        
                        // å°è¯•åˆå§‹åŒ–
                        initializeEmergencyFix();
                        resolve();
                    } else {
                        log('âŒ emergencyInitDatabase å‡½æ•°æœªæ‰¾åˆ°', 'error');
                        showStatus('âŒ ä¿®å¤è„šæœ¬åŠ è½½ä¸å®Œæ•´', 'error');
                        reject(new Error('å‡½æ•°æœªåŠ è½½'));
                    }
                };
                
                script.onerror = function() {
                    log('âŒ è„šæœ¬åŠ è½½å¤±è´¥', 'error');
                    showStatus('âŒ æ— æ³•åŠ è½½ä¿®å¤è„šæœ¬', 'error');
                    reject(new Error('è„šæœ¬åŠ è½½å¤±è´¥'));
                };
                
                document.head.appendChild(script);
            });
        }

        // åˆå§‹åŒ–ç´§æ€¥ä¿®å¤
        async function initializeEmergencyFix() {
            log('ğŸ”§ åˆå§‹åŒ–ç´§æ€¥ä¿®å¤...', 'info');
            
            try {
                await window.emergencyInitDatabase();
                log('âœ… ç´§æ€¥ä¿®å¤åˆå§‹åŒ–æˆåŠŸ', 'success');
                showStatus('ğŸ‰ æ•°æ®åº“ä¿®å¤å®Œæˆï¼åˆ·æ–°é¡µé¢æŸ¥çœ‹æ•ˆæœ', 'success');
                
                // æç¤ºç”¨æˆ·åˆ·æ–°
                setTimeout(() => {
                    if (confirm('ä¿®å¤å®Œæˆï¼æ˜¯å¦åˆ·æ–°é¡µé¢æŸ¥çœ‹æ•ˆæœï¼Ÿ')) {
                        location.reload(true);
                    }
                }, 2000);
                
            } catch (error) {
                log(`âŒ ç´§æ€¥ä¿®å¤åˆå§‹åŒ–å¤±è´¥: ${error.message}`, 'error');
                showStatus(`âŒ ä¿®å¤åˆå§‹åŒ–å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // å…¨é¢æµ‹è¯•
        async function testAllMethods() {
            log('ğŸ” å¼€å§‹å…¨é¢æµ‹è¯•...', 'info');
            clearLog();
            
            // æµ‹è¯•1: æ£€æŸ¥å½“å‰ç¯å¢ƒ
            log('=== ç¯å¢ƒæ£€æŸ¥ ===', 'info');
            log(`å½“å‰æ—¶é—´: ${new Date().toISOString()}`, 'info');
            log(`é¡µé¢URL: ${location.href}`, 'info');
            log(`ç”¨æˆ·ä»£ç†: ${navigator.userAgent}`, 'info');
            
            // æµ‹è¯•2: æ£€æŸ¥ç°æœ‰å…¨å±€å˜é‡
            log('=== å…¨å±€å˜é‡æ£€æŸ¥ ===', 'info');
            log(`window.supabase: ${typeof window.supabase}`, 'info');
            log(`window.emergencyInitDatabase: ${typeof window.emergencyInitDatabase}`, 'info');
            log(`window.supabaseClient: ${typeof window.supabaseClient}`, 'info');
            
            // æµ‹è¯•3: ç¼“å­˜çªç ´
            log('=== ç¼“å­˜çªç ´æµ‹è¯• ===', 'info');
            await testCacheBypass();
            
            // æµ‹è¯•4: å¦‚æœå¤±è´¥ï¼Œå°è¯•å¼ºåˆ¶åŠ è½½
            if (typeof window.emergencyInitDatabase !== 'function') {
                log('=== å¼ºåˆ¶åŠ è½½æµ‹è¯• ===', 'info');
                await forceLoadFix();
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆåæ˜¾ç¤ºçŠ¶æ€
        document.addEventListener('DOMContentLoaded', function() {
            log('ğŸš€ å¼ºåˆ¶ç¼“å­˜çªç ´å·¥å…·å·²å¯åŠ¨', 'info');
            showStatus('å‡†å¤‡è¿›è¡Œç¼“å­˜çªç ´æµ‹è¯•...', 'info');
        });
    </script>
</body>
</html>









































































