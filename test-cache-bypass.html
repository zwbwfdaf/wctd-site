<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¼“å­˜ç»•è¿‡æµ‹è¯•</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; padding: 20px; background: #f8f9fa; }
        .status { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .log { background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 4px; padding: 15px; margin: 10px 0; font-family: monospace; max-height: 300px; overflow-y: auto; }
    </style>
</head>
<body>
    <h1>ğŸ” ç¼“å­˜ç»•è¿‡æµ‹è¯•å·¥å…·</h1>
    <p>æ­¤å·¥å…·ç”¨äºæµ‹è¯•ä¿®å¤æ–‡ä»¶æ˜¯å¦å·²æ­£ç¡®éƒ¨ç½²ï¼Œç»•è¿‡æµè§ˆå™¨å’ŒCDNç¼“å­˜</p>
    
    <div id="testResults"></div>
    <div id="testLog" class="log"></div>

    <script>
        function log(message) {
            const logDiv = document.getElementById('testLog');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.innerHTML += `[${timestamp}] ${message}<br>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }

        function showStatus(message, type) {
            const resultsDiv = document.getElementById('testResults');
            resultsDiv.innerHTML += `<div class="status ${type}">${message}</div>`;
        }

        // æµ‹è¯•ç´§æ€¥ä¿®å¤æ–‡ä»¶æ˜¯å¦å­˜åœ¨
        async function testEmergencyFile() {
            log('ğŸ” æµ‹è¯• emergency-database-fix.js æ˜¯å¦å­˜åœ¨...');
            
            try {
                // æ·»åŠ æ—¶é—´æˆ³ç»•è¿‡ç¼“å­˜
                const timestamp = new Date().getTime();
                const response = await fetch(`emergency-database-fix.js?v=${timestamp}&cache=bypass`, {
                    method: 'HEAD',
                    cache: 'no-cache',
                    headers: {
                        'Cache-Control': 'no-cache',
                        'Pragma': 'no-cache'
                    }
                });
                
                if (response.ok) {
                    log('âœ… emergency-database-fix.js æ–‡ä»¶å­˜åœ¨');
                    showStatus('âœ… ç´§æ€¥ä¿®å¤æ–‡ä»¶å·²éƒ¨ç½²', 'success');
                    return true;
                } else {
                    log(`âŒ emergency-database-fix.js ä¸å­˜åœ¨ (çŠ¶æ€: ${response.status})`);
                    showStatus('âŒ ç´§æ€¥ä¿®å¤æ–‡ä»¶æœªæ‰¾åˆ°', 'error');
                    return false;
                }
            } catch (error) {
                log(`âŒ æµ‹è¯•å¤±è´¥: ${error.message}`);
                showStatus('âŒ æ— æ³•æ£€æµ‹ç´§æ€¥ä¿®å¤æ–‡ä»¶', 'error');
                return false;
            }
        }

        // æµ‹è¯•æ—§æ–‡ä»¶æ˜¯å¦å·²åˆ é™¤
        async function testOldFiles() {
            log('ğŸ” æ£€æŸ¥æ—§æ–‡ä»¶æ˜¯å¦å·²åˆ é™¤...');
            
            const oldFiles = ['database.js', 'supabase-loader.js', 'supabase-config.js', 'supabase-wrapper.js'];
            let deletedCount = 0;
            
            for (const file of oldFiles) {
                try {
                    const timestamp = new Date().getTime();
                    const response = await fetch(`${file}?v=${timestamp}`, {
                        method: 'HEAD',
                        cache: 'no-cache'
                    });
                    
                    if (response.ok) {
                        log(`âš ï¸ ${file} ä»ç„¶å­˜åœ¨ï¼ˆåº”è¯¥åˆ é™¤ï¼‰`);
                        showStatus(`âš ï¸ æ—§æ–‡ä»¶ ${file} ä»ç„¶å­˜åœ¨`, 'warning');
                    } else {
                        log(`âœ… ${file} å·²åˆ é™¤`);
                        deletedCount++;
                    }
                } catch (error) {
                    log(`âœ… ${file} å·²åˆ é™¤æˆ–ä¸å¯è®¿é—®`);
                    deletedCount++;
                }
            }
            
            if (deletedCount === oldFiles.length) {
                showStatus('âœ… æ‰€æœ‰æ—§æ–‡ä»¶å·²æ­£ç¡®åˆ é™¤', 'success');
            }
        }

        // å°è¯•åŠ¨æ€åŠ è½½ç´§æ€¥ä¿®å¤
        async function loadEmergencyFix() {
            log('ğŸš¨ å°è¯•åŠ¨æ€åŠ è½½ç´§æ€¥ä¿®å¤...');
            
            try {
                const timestamp = new Date().getTime();
                const script = document.createElement('script');
                script.src = `emergency-database-fix.js?v=${timestamp}&cache=bypass`;
                script.onload = () => {
                    log('âœ… ç´§æ€¥ä¿®å¤è„šæœ¬åŠ è½½æˆåŠŸ');
                    
                    if (typeof window.emergencyInitDatabase === 'function') {
                        log('âœ… ç´§æ€¥ä¿®å¤å‡½æ•°å¯ç”¨');
                        showStatus('âœ… ç´§æ€¥ä¿®å¤ç³»ç»Ÿæ¿€æ´»', 'success');
                        
                        // å°è¯•åˆå§‹åŒ–
                        window.emergencyInitDatabase().then(() => {
                            log('âœ… æ•°æ®åº“åˆå§‹åŒ–æˆåŠŸ');
                            showStatus('âœ… æ•°æ®åº“è¿æ¥å·²æ¢å¤', 'success');
                        }).catch(error => {
                            log(`âŒ æ•°æ®åº“åˆå§‹åŒ–å¤±è´¥: ${error.message}`);
                            showStatus('âŒ æ•°æ®åº“ä»ç„¶æ— æ³•è¿æ¥', 'error');
                        });
                    } else {
                        log('âŒ ç´§æ€¥ä¿®å¤å‡½æ•°ä¸å¯ç”¨');
                        showStatus('âŒ ç´§æ€¥ä¿®å¤æœªæ­£ç¡®åŠ è½½', 'error');
                    }
                };
                script.onerror = () => {
                    log('âŒ ç´§æ€¥ä¿®å¤è„šæœ¬åŠ è½½å¤±è´¥');
                    showStatus('âŒ æ— æ³•åŠ è½½ç´§æ€¥ä¿®å¤', 'error');
                };
                
                document.head.appendChild(script);
            } catch (error) {
                log(`âŒ åŠ¨æ€åŠ è½½å¤±è´¥: ${error.message}`);
                showStatus('âŒ åŠ¨æ€åŠ è½½å¤±è´¥', 'error');
            }
        }

        // æ£€æŸ¥ç¼“å­˜çŠ¶æ€
        function checkCacheHeaders() {
            log('ğŸ“‹ æ£€æŸ¥å½“å‰é¡µé¢ç¼“å­˜çŠ¶æ€...');
            log(`Cache-Control: ${document.head.querySelector('meta[http-equiv="Cache-Control"]')?.content || 'æœªè®¾ç½®'}`);
            log(`å½“å‰æ—¶é—´: ${new Date().toISOString()}`);
            log(`é¡µé¢URL: ${location.href}`);
        }

        // å¼€å§‹æµ‹è¯•
        async function runTests() {
            log('ğŸš€ å¼€å§‹ç¼“å­˜ç»•è¿‡æµ‹è¯•...');
            checkCacheHeaders();
            
            await testEmergencyFile();
            await testOldFiles();
            await loadEmergencyFix();
            
            log('ğŸ æµ‹è¯•å®Œæˆ');
        }

        // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨å¼€å§‹æµ‹è¯•
        document.addEventListener('DOMContentLoaded', runTests);
    </script>
</body>
</html>










































































