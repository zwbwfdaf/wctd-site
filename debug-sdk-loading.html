<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SDK加载调试工具</title>
    <style>
        body { font-family: monospace; padding: 20px; background: #f5f5f5; }
        .log { background: #000; color: #0f0; padding: 15px; border-radius: 5px; margin: 10px 0; max-height: 400px; overflow-y: auto; }
        .btn { background: #007bff; color: white; border: none; padding: 10px 15px; margin: 5px; border-radius: 3px; cursor: pointer; }
        .error { color: #f00; }
        .success { color: #0a0; }
        .warning { color: #fa0; }
    </style>
</head>
<body>
    <h1>🔍 Supabase SDK加载调试工具</h1>
    <button class="btn" onclick="testMethod1()">测试方法1: 直接CDN加载</button>
    <button class="btn" onclick="testMethod2()">测试方法2: 使用loader.js</button>
    <button class="btn" onclick="testMethod3()">测试方法3: 备用CDN</button>
    <button class="btn" onclick="clearLog()">清除日志</button>
    
    <div id="log" class="log"></div>

    <script>
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : '';
            logDiv.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }

        // 方法1: 直接CDN加载
        async function testMethod1() {
            log('🔥 方法1: 直接从CDN加载Supabase SDK', 'info');
            
            try {
                // 移除现有script
                const existingScript = document.querySelector('script[src*="supabase"]');
                if (existingScript) {
                    existingScript.remove();
                    log('移除现有Supabase脚本', 'info');
                }
                
                // 清除全局变量
                delete window.supabase;
                
                const script = document.createElement('script');
                script.src = 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js';
                script.async = false; // 同步加载
                
                script.onload = function() {
                    log('✅ CDN脚本加载成功', 'success');
                    if (window.supabase) {
                        log('✅ window.supabase 可用', 'success');
                        if (typeof window.supabase.createClient === 'function') {
                            log('✅ createClient 函数可用', 'success');
                            testConnection();
                        } else {
                            log('❌ createClient 函数不可用', 'error');
                        }
                    } else {
                        log('❌ window.supabase 不可用', 'error');
                    }
                };
                
                script.onerror = function() {
                    log('❌ CDN脚本加载失败', 'error');
                };
                
                document.head.appendChild(script);
                log('开始加载CDN脚本...', 'info');
                
            } catch (error) {
                log(`❌ 方法1失败: ${error.message}`, 'error');
            }
        }

        // 方法2: 使用现有loader.js
        async function testMethod2() {
            log('🔥 方法2: 使用supabase-loader.js', 'info');
            
            try {
                if (typeof window.ensureSupabaseLoaded === 'function') {
                    log('✅ ensureSupabaseLoaded 函数可用', 'success');
                    await window.ensureSupabaseLoaded();
                    log('✅ ensureSupabaseLoaded 执行完成', 'success');
                    
                    if (window.supabase && typeof window.supabase.createClient === 'function') {
                        log('✅ Supabase SDK加载成功', 'success');
                        testConnection();
                    } else {
                        log('❌ Supabase SDK加载失败', 'error');
                    }
                } else {
                    log('❌ ensureSupabaseLoaded 函数不可用', 'error');
                    log('尝试直接加载 supabase-loader.js...', 'info');
                    
                    const script = document.createElement('script');
                    script.src = 'supabase-loader.js';
                    script.onload = () => {
                        log('✅ supabase-loader.js 加载成功', 'success');
                        setTimeout(() => testMethod2(), 1000); // 重试
                    };
                    script.onerror = () => {
                        log('❌ supabase-loader.js 加载失败', 'error');
                    };
                    document.head.appendChild(script);
                }
            } catch (error) {
                log(`❌ 方法2失败: ${error.message}`, 'error');
            }
        }

        // 方法3: 备用CDN
        async function testMethod3() {
            log('🔥 方法3: 使用备用CDN', 'info');
            
            const cdnUrls = [
                'https://unpkg.com/@supabase/supabase-js@2/dist/umd/supabase.js',
                'https://cdn.skypack.dev/@supabase/supabase-js@2',
                'https://esm.sh/@supabase/supabase-js@2'
            ];
            
            for (const url of cdnUrls) {
                try {
                    log(`尝试加载: ${url}`, 'info');
                    
                    // 移除现有script
                    const existingScript = document.querySelector('script[src*="supabase"]');
                    if (existingScript) existingScript.remove();
                    delete window.supabase;
                    
                    await new Promise((resolve, reject) => {
                        const script = document.createElement('script');
                        script.src = url;
                        script.onload = resolve;
                        script.onerror = reject;
                        document.head.appendChild(script);
                    });
                    
                    if (window.supabase && typeof window.supabase.createClient === 'function') {
                        log(`✅ 成功从备用CDN加载: ${url}`, 'success');
                        testConnection();
                        return;
                    } else {
                        log(`❌ 从 ${url} 加载失败`, 'error');
                    }
                    
                } catch (error) {
                    log(`❌ ${url} 加载错误: ${error.message}`, 'error');
                }
            }
            
            log('❌ 所有备用CDN都失败', 'error');
        }

        // 测试数据库连接
        async function testConnection() {
            log('🔗 测试数据库连接...', 'info');
            
            try {
                const SUPABASE_URL = 'https://ybrveusbwjusnrzgfnok.supabase.co';
                const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlicnZldXNid2p1c25yemdmbm9rIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY0ODU1NjIsImV4cCI6MjA3MjA2MTU2Mn0.JKPSUli-q9wRuDagE6kwltLk9XgfygE8yznm-Ca82Qk';
                
                log('创建Supabase客户端...', 'info');
                const client = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                log('✅ Supabase客户端创建成功', 'success');
                
                log('测试数据库查询...', 'info');
                const { data, error } = await client
                    .from('users')
                    .select('id')
                    .limit(1);
                
                if (error) {
                    log(`⚠️ 数据库查询有错误，但连接可能正常: ${error.message}`, 'warning');
                    if (error.message.includes('relation "users" does not exist')) {
                        log('✅ 连接正常，只是用户表不存在', 'success');
                    }
                } else {
                    log('✅ 数据库连接和查询都成功', 'success');
                }
                
            } catch (error) {
                log(`❌ 数据库连接测试失败: ${error.message}`, 'error');
            }
        }

        // 页面加载时显示当前状态
        document.addEventListener('DOMContentLoaded', function() {
            log('🚀 SDK调试工具已启动', 'info');
            log('当前环境检查:', 'info');
            log(`- window.supabase: ${typeof window.supabase}`, window.supabase ? 'success' : 'error');
            log(`- ensureSupabaseLoaded: ${typeof window.ensureSupabaseLoaded}`, typeof window.ensureSupabaseLoaded === 'function' ? 'success' : 'error');
            log(`- 用户代理: ${navigator.userAgent}`, 'info');
            log(`- 当前域名: ${location.hostname}`, 'info');
        });
    </script>
</body>
</html>







































































