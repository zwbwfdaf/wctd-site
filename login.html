<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#3b82f6">
    <title>Áî®Êà∑ÁôªÂΩï - ÊñáÂàõÈÇ¶</title>
    <!-- Ê°åÈù¢Â∫îÁî®ÂêØÂä®Âô® -->
    <script src="app-launcher.js"></script>
    <!-- Á¥ßÊÄ•Êï∞ÊçÆÂ∫ì‰øÆÂ§çÂô® -->
    <script src="emergency-database-fix.js"></script>
    <!-- ÁßªÈô§Â§ñÈÉ®CDN‰æùËµñÔºå‰ΩøÁî®ÂÜÖËÅîÊ†∑ÂºèÁ°Æ‰øùÂú®ÂèóÈôêÁΩëÁªúÁéØÂ¢É‰∏ãÂèØËÆøÈóÆ -->
    <link rel="stylesheet" href="theme.css">
    <style>
        :root {
            --primary-color: #ff7a45;
            --primary-light: #fff0e6;
            --gradient-start: #ff7a45;
            --gradient-end: #ff9500;
            --text-primary: #333;
            --text-secondary: #666;
        }

        body {
            background: #F8EDE3;
            min-height: 100vh;
            font-family: 'PingFang SC', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            position: relative;
            overflow: hidden;
        }
        
        body::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" width="100" height="100" opacity="0.1"><path d="M50 0 L100 50 L50 100 L0 50 Z" fill="%23D2B48C"/></svg>');
            background-size: 400px 400px;
            opacity: 0.1;
            z-index: -1;
        }
        
        .login-container {
            background: transparent;
            border-radius: 0;
            box-shadow: none;
            position: relative;
            overflow: visible;
            padding: 20px;
        }
        
        .form-input {
            border: 2px solid #f0f0f0;
            border-radius: 16px;
            transition: all 0.3s ease;
            padding: 14px 18px;
            background: rgba(255, 255, 255, 0.9);
            font-size: 15px;
        }
        
        .form-input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(255, 122, 69, 0.1);
            outline: none;
            background: white;
        }
        
        .form-input::placeholder {
            color: #999;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
            border-radius: 16px;
            padding: 16px 24px;
            font-weight: 600;
            transition: all 0.3s ease;
            border: none;
            position: relative;
            overflow: hidden;
        }
        
        .btn-primary::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.2), transparent);
            transform: translateX(-100%);
            transition: transform 0.5s ease;
        }
        
        .btn-primary:hover::before {
            transform: translateX(100%);
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(255, 122, 69, 0.3);
        }
        
        .form-switch {
            color: var(--primary-color);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            display: inline-block;
        }
        
        .form-switch::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            width: 100%;
            height: 2px;
            background: linear-gradient(to right, var(--gradient-start), var(--gradient-end));
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }
        
        .form-switch:hover::after {
            transform: scaleX(1);
        }
        
        .form-switch:hover {
            color: var(--gradient-end);
        }
        
        .error-message,
        .success-message {
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 20px;
            display: none;
            animation: slideIn 0.3s ease;
            position: relative;
            overflow: hidden;
            font-size: 14px;
            line-height: 1.5;
        }
        
        @keyframes slideIn {
            from {
                transform: translateY(-10px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        .error-message {
            background: rgba(254, 226, 226, 0.8);
            border: 1px solid rgba(254, 202, 202, 0.5);
            color: #dc2626;
            backdrop-filter: blur(8px);
        }
        
        .success-message {
            background: rgba(220, 252, 231, 0.8);
            border: 1px solid rgba(187, 247, 208, 0.5);
            color: #16a34a;
            backdrop-filter: blur(8px);
        }
        
        .error-message::before,
        .success-message::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
        }
        
        .error-message::before {
            background: linear-gradient(to bottom, #ef4444, #dc2626);
        }
        
        .success-message::before {
            background: linear-gradient(to bottom, #22c55e, #16a34a);
        }
        
        .error-message i,
        .success-message i {
            margin-right: 8px;
            font-size: 16px;
        }
        
        /* ÁΩëÁªúÁä∂ÊÄÅÊåáÁ§∫Âô® */
        .network-indicator {
            padding: 12px 16px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 500;
            display: flex;
            align-items: center;
            transition: all 0.3s ease;
            animation: slideIn 0.3s ease;
        }
        
        .network-online {
            background: rgba(220, 252, 231, 0.8);
            border: 1px solid rgba(187, 247, 208, 0.5);
            color: #16a34a;
            backdrop-filter: blur(8px);
        }
        
        .network-offline {
            background: rgba(254, 226, 226, 0.8);
            border: 1px solid rgba(254, 202, 202, 0.5);
            color: #dc2626;
            backdrop-filter: blur(8px);
        }
        
        .network-indicator i {
            margin-right: 8px;
            font-size: 16px;
        }
        
        /* ‰ø°ÊÅØÊ∂àÊÅØÊ†∑Âºè */
        .info-message {
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 20px;
            display: none;
            animation: slideIn 0.3s ease;
            position: relative;
            overflow: hidden;
            font-size: 14px;
            line-height: 1.5;
            background: rgba(219, 234, 254, 0.8);
            border: 1px solid rgba(147, 197, 253, 0.5);
            color: #1e40af;
            backdrop-filter: blur(8px);
        }
        
        .info-message::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: linear-gradient(to bottom, #3b82f6, #1e40af);
        }
        
        .info-message i {
            margin-right: 8px;
            font-size: 16px;
        }
        
        /* Tailwind CSS Âü∫Á°ÄÁ±ªÊõø‰ª£ */
        .hidden { display: none !important; }
        .flex { display: flex; }
        .items-center { align-items: center; }
        .justify-center { justify-content: center; }
        .justify-between { justify-content: space-between; }
        .text-left { text-align: left; }
        .text-center { text-align: center; }
        .text-xl { font-size: 1.25rem; line-height: 1.75rem; }
        .text-3xl { font-size: 1.875rem; line-height: 2.25rem; }
        .text-sm { font-size: 0.875rem; line-height: 1.25rem; }
        .font-normal { font-weight: 400; }
        .font-bold { font-weight: 700; }
        .font-medium { font-weight: 500; }
        .font-semibold { font-weight: 600; }
        .text-gray-600 { color: rgb(75 85 99); }
        .text-gray-700 { color: rgb(55 65 81); }
        .text-gray-900 { color: rgb(17 24 39); }
        .text-blue-500 { color: rgb(59 130 246); }
        .text-blue-700 { color: rgb(29 78 216); }
        .text-orange-500 { color: rgb(249 115 22); }
        .text-orange-600 { color: rgb(234 88 12); }
        .text-white { color: rgb(255 255 255); }
        .mb-2 { margin-bottom: 0.5rem; }
        .mb-4 { margin-bottom: 1rem; }
        .mb-6 { margin-bottom: 1.5rem; }
        .mb-8 { margin-bottom: 2rem; }
        .mt-4 { margin-top: 1rem; }
        .mt-6 { margin-top: 1.5rem; }
        .mr-2 { margin-right: 0.5rem; }
        .p-4 { padding: 1rem; }
        .p-6 { padding: 1.5rem; }
        .block { display: block; }
        .w-full { width: 100%; }
        .max-w-md { max-width: 28rem; }
        .min-h-screen { min-height: 100vh; }
        .bg-green-500 { background-color: rgb(34 197 94); }
        
        /* FontAwesome ÂõæÊ†áÊõø‰ª£ */
        .fas, .fa { 
            font-style: normal; 
            font-variant: normal; 
            text-rendering: auto; 
            line-height: 1;
            display: inline-block;
            font-size: inherit;
        }
        .fa-sign-in-alt::before { content: "üîë"; }
        .fa-user-plus::before { content: "üë§"; }
        .fa-search::before { content: "üîç"; }
        .fa-check::before { content: "‚úÖ"; }
        .fa-check-circle::before { content: "‚úÖ"; }
        .fa-exclamation-triangle::before { content: "‚ö†Ô∏è"; }
        .fa-info-circle::before { content: "‚ÑπÔ∏è"; }
        .fa-exclamation-circle::before { content: "‚ùó"; }
        .fa-spinner::before { content: "‚è≥"; }
        .fa-key::before { content: "üîë"; }
        .fa-wifi::before { content: "üì∂"; }
        .fa-wifi-slash::before { content: "üìµ"; }
        .fa-spin { animation: fa-spin 2s infinite linear; }
        .fa-pulse { animation: fa-spin 1s infinite steps(8); }
        
        @keyframes fa-spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(359deg); }
        }
    </style>
</head>
<body class="flex items-center justify-center p-4">
    <div class="login-container w-full max-w-md p-6">
        <!-- ÁôªÂΩïË°®Âçï -->
        <div id="login-form">
            <div class="text-left mb-8">
                <h1 class="text-xl font-normal text-gray-600 mb-4">ÁôªÂΩï</h1>
                <h2 class="text-3xl font-bold text-gray-900 mb-8">ÊñáÂàõÈÇ¶</h2>
            </div>
            
            <!-- ÁΩëÁªúÁä∂ÊÄÅÊåáÁ§∫Âô® -->
            <div id="network-status" class="network-indicator mb-4" style="display: none;">
                <i class="fas fa-wifi mr-2"></i>
                <span>Ê£ÄÊü•ÁΩëÁªúÁä∂ÊÄÅ...</span>
            </div>
            
            <div class="error-message" id="login-error"></div>
            <div class="success-message" id="login-success"></div>
            
            <form id="login-form-content">
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-medium mb-2" for="login-username">
                        Áî®Êà∑Âêç
                    </label>
                    <input type="text" id="login-username" class="form-input w-full" placeholder="ËØ∑ËæìÂÖ•Áî®Êà∑Âêç" required>
                </div>
                
                <div class="mb-6">
                    <div class="flex justify-between items-center mb-2">
                        <label class="block text-gray-700 text-sm font-medium" for="login-password">
                            ÂØÜÁ†Å
                        </label>
                        <a href="#" class="text-sm text-blue-500 hover:text-blue-700" id="forgot-password-link">ÂøòËÆ∞ÂØÜÁ†ÅÔºü</a>
                    </div>
                    <input type="password" id="login-password" class="form-input w-full" placeholder="ËØ∑ËæìÂÖ•ÂØÜÁ†Å" required>
                </div>
                
                <button type="submit" class="btn-primary w-full text-white">
                    <i class="fas fa-sign-in-alt mr-2"></i>ÁôªÂΩï
                </button>
            </form>
            
            <div class="mt-6 text-center">
                <p class="text-gray-600">
                    ËøòÊ≤°ÊúâË¥¶Êà∑Ôºü
                    <span class="form-switch" id="show-register">Á´ãÂç≥Ê≥®ÂÜå</span>
                </p>
            </div>
        </div>
        
        <!-- Ê≥®ÂÜåË°®Âçï -->
        <div id="register-form" class="hidden">
            <div class="text-left mb-8">
                <h1 class="text-xl font-normal text-gray-600 mb-4">Ê≥®ÂÜå</h1>
                <h2 class="text-3xl font-bold text-gray-900 mb-8">ÊñáÂàõÈÇ¶</h2>
            </div>
            
            <div class="error-message" id="register-error"></div>
            <div class="success-message" id="register-success"></div>
            
            <form id="register-form-content">
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-medium mb-2" for="register-username">
                        Áî®Êà∑Âêç
                    </label>
                    <input type="text" id="register-username" class="form-input w-full" placeholder="ËØ∑ËæìÂÖ•Áî®Êà∑ÂêçÔºàËá≥Â∞ë3‰∏™Â≠óÁ¨¶Ôºâ" required minlength="3">
                </div>
                
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-medium mb-2" for="register-password">
                        ÂØÜÁ†Å
                    </label>
                    <input type="password" id="register-password" class="form-input w-full" placeholder="ËØ∑ËæìÂÖ•ÂØÜÁ†ÅÔºàËá≥Â∞ë6‰∏™Â≠óÁ¨¶Ôºâ" required minlength="6">
                </div>
                
                <div class="mb-6">
                    <label class="block text-gray-700 text-sm font-medium mb-2" for="register-confirm-password">
                        Á°ÆËÆ§ÂØÜÁ†Å
                    </label>
                    <input type="password" id="register-confirm-password" class="form-input w-full" placeholder="ËØ∑ÂÜçÊ¨°ËæìÂÖ•ÂØÜÁ†Å" required>
                </div>
                
                <div class="mb-6">
                    <label class="block text-gray-700 text-sm font-medium mb-2" for="register-invite-code">
                        ÈÇÄËØ∑Á†ÅÔºàÂèØÈÄâÔºâ
                    </label>
                    <input type="text" id="register-invite-code" class="form-input w-full" placeholder="Â¶ÇÔºöRXXXXXXXÔºàÊ≤°ÊúâÂèØÁïôÁ©∫Ôºâ">
                </div>
                
                <button type="submit" class="btn-primary w-full text-white">
                    <i class="fas fa-user-plus mr-2"></i>Ê≥®ÂÜå
                </button>
            </form>
            
            <div class="mt-6 text-center">
                <p class="text-gray-600">
                    Â∑≤ÊúâË¥¶Êà∑Ôºü
                    <span class="form-switch" id="show-login">Á´ãÂç≥ÁôªÂΩï</span>
                </p>
            </div>
        </div>
        
        <!-- ÂøòËÆ∞ÂØÜÁ†ÅË°®Âçï -->
        <div id="forgot-password-form" class="hidden">
            <div class="text-left mb-8">
                <h1 class="text-xl font-normal text-gray-600 mb-4">ÈáçÁΩÆÂØÜÁ†Å</h1>
                <h2 class="text-3xl font-bold text-gray-900 mb-8">ÊñáÂàõÈÇ¶</h2>
            </div>
            
            <div class="error-message" id="forgot-password-error"></div>
            <div class="success-message" id="forgot-password-success"></div>
            
            <form id="forgot-password-form-content">
                <div class="mb-6">
                    <label class="block text-gray-700 text-sm font-medium mb-2" for="forgot-password-username">
                        Áî®Êà∑Âêç
                    </label>
                    <input type="text" id="forgot-password-username" class="form-input w-full" placeholder="ËØ∑ËæìÂÖ•ÊÇ®ÁöÑÁî®Êà∑Âêç" required>
                </div>
                
                <!-- Êñ∞ÂØÜÁ†ÅËæìÂÖ•Âå∫ÂüüÔºàÂàùÂßãÈöêËóèÔºâ -->
                <div id="new-password-section" class="mb-6 hidden">
                    <label class="block text-gray-700 text-sm font-medium mb-2" for="new-password">
                        Êñ∞ÂØÜÁ†Å
                    </label>
                    <input type="password" id="new-password" class="form-input w-full" placeholder="ËØ∑ËæìÂÖ•Êñ∞ÂØÜÁ†Å" required>
                </div>
                
                <button type="button" id="check-username-btn" class="btn-primary w-full text-white flex items-center justify-center">
                    <i class="fas fa-search mr-2"></i>È™åËØÅÁî®Êà∑Âêç
                </button>
                
                <button type="submit" id="submit-new-password-btn" class="btn-primary w-full text-white flex items-center justify-center mt-4 hidden">
                    <i class="fas fa-check mr-2"></i>Á°ÆËÆ§‰øÆÊîπ
                </button>
            </form>
            
            <div class="mt-6 text-center">
                <a href="#" class="text-orange-500 hover:text-orange-600" id="back-to-login">ËøîÂõûÁôªÂΩï</a>
            </div>
        </div>
    </div>

    <!-- Âä†ËΩΩSupabase UMD ÊûÑÂª∫ÔºàÂõ∫ÂÆöÁâàÊú¨Ôºâ with resilient loader -->
    <script src="supabase-loader.js"></script>
    <script>
        // Attempt to load Supabase from multiple CDNs before using
        document.addEventListener('DOMContentLoaded', function(){
            if (typeof ensureSupabaseLoaded === 'function') {
                ensureSupabaseLoaded().then(function(){
                    console.log('‚úÖ Supabase UMD loaded via loader');
                }).catch(function(err){
                    console.error('‚ùå Supabase loader failed:', err);
                });
            }
        });
    </script>
    <!-- ÁôªÂΩïÁä∂ÊÄÅÁÆ°ÁêÜÂô® -->
    <script src="login-status-manager.js"></script>
    <script>
        // ‰ΩøÁî®UMDÂÖ®Â±ÄsupabaseÂØπË±°ËøõË°åÂàùÂßãÂåñ
        
        // SupabaseÈÖçÁΩÆ
        const LOGIN_SUPABASE_URL = 'https://ybrveusbwjusnrzgfnok.supabase.co';
        const LOGIN_SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlicnZldXNid2p1c25yemdmbm9rIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY0ODU1NjIsImV4cCI6MjA3MjA2MTU2Mn0.JKPSUli-q9wRuDagE6kwltLk9XgfygE8yznm-Ca82Qk';
        
        // Êï∞ÊçÆÂ∫ìÂ≠óÊÆµÂêç
        let usernameField = 'username';
        let passwordField = 'password';
        let pointsField = 'points';
        let tableStructureDetected = false;
        
        // Âä®ÊÄÅÂä†ËΩΩSupabaseÂÆ¢Êà∑Á´Ø
        let supabase;
        
        // Êú¨Âú∞Â≠òÂÇ®ÂÆâÂÖ®Â∞ÅË£ÖÔºàÂÖºÂÆπÈöêÁßÅÊ®°Âºè/ÂèóÈôêÁéØÂ¢ÉÔºâ
        const __memStore = {};
        function safeLocalSet(key, value) {
            try { localStorage.setItem(key, value); } catch (e) { __memStore[key] = value; }
        }
        function safeLocalGet(key) {
            try { const v = localStorage.getItem(key); return v !== null ? v : (__memStore[key] ?? null); }
            catch (e) { return __memStore[key] ?? null; }
        }
        function safeLocalRemove(key) {
            try { localStorage.removeItem(key); } catch (e) { delete __memStore[key]; }
        }
        function safeSessionClear() {
            try { sessionStorage.clear(); } catch (e) {}
        }
        
        // Supabase REST ÊúÄÂ∞èÂåÖË£ÖÔºàÂΩìCDNË¢´ÈòªÊñ≠Êó∂‰ΩøÁî®ÔºåÊó†ÈúÄÂ§ñÈÉ®SDKÔºâ
        function createSupabaseRestClient(baseUrl, anonKey) {
            const REST_BASE = baseUrl.replace(/\/$/, '') + '/rest/v1';
            
            // Â¢ûÂº∫ÈîôËØØÂ§ÑÁêÜÂíåÈáçËØïÊú∫Âà∂
            async function fetchWithRetry(url, options, retries = 2) {
                for (let i = 0; i <= retries; i++) {
                    try {
                        const controller = new AbortController();
                        const timeoutId = setTimeout(() => controller.abort(), 10000); // 10ÁßíË∂ÖÊó∂
                        
                        const response = await fetch(url, {
                            ...options,
                            signal: controller.signal,
                            headers: {
                                ...options.headers,
                                'Cache-Control': 'no-cache',
                                'Pragma': 'no-cache'
                            }
                        });
                        
                        clearTimeout(timeoutId);
                        return response;
                    } catch (error) {
                        if (i === retries) {
                            // ÊúÄÂêé‰∏ÄÊ¨°ÈáçËØïÂ§±Ë¥•ÔºåÊäõÂá∫Êõ¥ËØ¶ÁªÜÁöÑÈîôËØØ
                            if (error.name === 'AbortError') {
                                throw new Error('ËØ∑Ê±ÇË∂ÖÊó∂ÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúËøûÊé•');
                            } else if (error.message.includes('Failed to fetch')) {
                                throw new Error('Êó†Ê≥ïËøûÊé•Âà∞ÊúçÂä°Âô®ÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúÊàñÁ®çÂêéÈáçËØï');
                            } else {
                                throw error;
                            }
                        }
                        // ÈáçËØïÂâçÁ≠âÂæÖ
                        await new Promise(resolve => setTimeout(resolve, 1000 * (i + 1)));
                    }
                }
            }
            
            function from(table) {
                const state = {
                    table: table,
                    selectColumns: '*',
                    filters: [],
                    limitCount: null,
                    count: undefined,
                    single: false,
                    returnRepresentation: false,
                    body: null,
                    method: 'GET',
                    updateData: null
                };
                
                function buildQuery() {
                    const params = new URLSearchParams();
                    if (state.selectColumns) params.set('select', state.selectColumns);
                    if (state.limitCount != null) params.set('limit', String(state.limitCount));
                    state.filters.forEach(([col, op, val]) => {
                        params.append(col, op + '.' + encodeURIComponent(val));
                    });
                    return params.toString();
                }
                
                function buildHeaders() {
                    const headers = {
                        'apikey': anonKey,
                        'Authorization': 'Bearer ' + anonKey,
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    };
                    if (state.returnRepresentation) {
                        headers['Prefer'] = (headers['Prefer'] ? headers['Prefer'] + ',' : '') + 'return=representation';
                    }
                    if (state.count) {
                        headers['Prefer'] = (headers['Prefer'] ? headers['Prefer'] + ',' : '') + ('count=' + state.count);
                    }
                    return headers;
                }
                
                async function doSelect() {
                    const qs = buildQuery();
                    const url = REST_BASE + '/' + encodeURIComponent(state.table) + (qs ? ('?' + qs) : '');
                    try {
                        const res = await fetchWithRetry(url, { method: 'GET', headers: buildHeaders() });
                        if (!res.ok) {
                            let errorMsg = res.statusText;
                            try {
                                const errorText = await res.text();
                                if (errorText) {
                                    const errorData = JSON.parse(errorText);
                                    errorMsg = errorData.message || errorData.hint || errorText;
                                }
                            } catch (e) {
                                // Ëß£ÊûêÈîôËØØ‰ø°ÊÅØÂ§±Ë¥•Ôºå‰ΩøÁî®ÈªòËÆ§Ê∂àÊÅØ
                            }
                            
                            if (res.status === 401) {
                                errorMsg = 'APIÂØÜÈí•Êó†ÊïàÊàñÂ∑≤ËøáÊúü';
                            } else if (res.status === 403) {
                                errorMsg = 'ÊùÉÈôê‰∏çË∂≥ÔºåÊó†Ê≥ïËÆøÈóÆÊï∞ÊçÆ';
                            } else if (res.status === 404) {
                                errorMsg = 'Êï∞ÊçÆË°®‰∏çÂ≠òÂú®ÊàñAPIÁ´ØÁÇπÈîôËØØ';
                            }
                            
                            return { data: null, error: { message: errorMsg, code: String(res.status) } };
                        }
                        const data = await res.json();
                        if (state.single) {
                            return { data: data && data.length > 0 ? data[0] : null, error: null };
                        }
                        return { data, error: null };
                    } catch (e) {
                        return { data: null, error: { message: e.message || 'Network error' } };
                    }
                }
                
                async function doInsert() {
                    const url = REST_BASE + '/' + encodeURIComponent(state.table);
                    try {
                        const res = await fetchWithRetry(url, { 
                            method: 'POST', 
                            headers: buildHeaders(), 
                            body: JSON.stringify(state.body) 
                        });
                        if (!res.ok) {
                            let errorMsg = res.statusText;
                            try {
                                const errorText = await res.text();
                                if (errorText) {
                                    const errorData = JSON.parse(errorText);
                                    errorMsg = errorData.message || errorData.hint || errorText;
                                }
                            } catch (e) {}
                            return { data: null, error: { message: errorMsg, code: String(res.status) } };
                        }
                        const data = state.returnRepresentation ? await res.json() : null;
                        return { data, error: null };
                    } catch (e) {
                        return { data: null, error: { message: e.message || 'Network error' } };
                    }
                }
                
                async function doUpdate() {
                    const qs = buildQuery();
                    const url = REST_BASE + '/' + encodeURIComponent(state.table) + (qs ? ('?' + qs) : '');
                    try {
                        const res = await fetchWithRetry(url, { 
                            method: 'PATCH', 
                            headers: buildHeaders(), 
                            body: JSON.stringify(state.updateData) 
                        });
                        if (!res.ok) {
                            let errorMsg = res.statusText;
                            try {
                                const errorText = await res.text();
                                if (errorText) {
                                    const errorData = JSON.parse(errorText);
                                    errorMsg = errorData.message || errorData.hint || errorText;
                                }
                            } catch (e) {}
                            return { data: null, error: { message: errorMsg, code: String(res.status) } };
                        }
                        const data = state.returnRepresentation ? await res.json() : null;
                        return { data, error: null };
                    } catch (e) {
                        return { data: null, error: { message: e.message || 'Network error' } };
                    }
                }
                
                const builder = {
                    select(columns = '*', opts = {}) {
                        state.selectColumns = columns || '*';
                        if (opts && opts.count) state.count = opts.count;
                        return this;
                    },
                    eq(col, val) { state.filters.push([col, 'eq', val]); return this; },
                    limit(n) { state.limitCount = n; return this; },
                    single() { state.single = true; return doSelect(); },
                    insert(rows) {
                        state.method = 'POST';
                        state.body = rows;
                        const chain = {
                            select() { state.returnRepresentation = true; return doInsert(); },
                            then(res, rej) { state.returnRepresentation = false; return doInsert().then(res, rej); }
                        };
                        return chain;
                    },
                    update(partial) {
                        state.method = 'PATCH';
                        state.updateData = partial;
                        const chain = {
                            eq(col, val) { state.filters.push([col, 'eq', val]); return this; },
                            select() { state.returnRepresentation = true; return doUpdate(); },
                            then(res, rej) { return doUpdate().then(res, rej); }
                        };
                        return chain;
                    },
                    then(res, rej) { return doSelect().then(res, rej); }
                };
                return builder;
            }
            return { from };
        }
        
        // ÁîüÊàêUUID v4ÔºàÁî®‰∫éÊª°Ë∂≥idÈùûÁ©∫Á∫¶Êùü‰∏î‰∏çÊîπÂä®Êï∞ÊçÆÂ∫ìÁªìÊûÑÔºâ
        function generateUUIDv4() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                const r = Math.random() * 16 | 0;
                const v = c === 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }
        
        // ÂàùÂßãÂåñSupabaseÂÆ¢Êà∑Á´ØÔºàÁ≠âÂæÖSupabaseÂä†ËΩΩÂÆåÊàêÔºâ
        function initSupabase() {
            try {
                console.log('üîê ÂàùÂßãÂåñÂÆâÂÖ®ÁôªÂΩïÁ≥ªÁªü...');
                const init = () => {
                    const { createClient } = window.supabase;
                    supabase = createClient(LOGIN_SUPABASE_URL, LOGIN_SUPABASE_ANON_KEY);
                    console.log('‚úÖ SupabaseËøûÊé•ÊàêÂäü');
                
                    // ËÆæÁΩÆÁôªÂΩïÁä∂ÊÄÅÁÆ°ÁêÜÂô®ÁöÑSupabaseÂÆ¢Êà∑Á´Ø
                    if (window.LoginStatusManager) {
                        window.LoginStatusManager.setSupabaseClient(supabase);
                        console.log('‚úÖ ÁôªÂΩïÁä∂ÊÄÅÁÆ°ÁêÜÂô®Â∑≤ÈÖçÁΩÆ');
                    }
                
                // Ê£ÄÊµãÊï∞ÊçÆÂ∫ìË°®ÁªìÊûÑ
                detectTableStructure();
                
                    // ÊòæÁ§∫ÁΩëÁªúÁä∂ÊÄÅ
                    updateNetworkStatusDisplay();
                };
                
                // Á≠âÂæÖSupabase UMDÂèØÁî®
                if (window.supabase && typeof window.supabase.createClient === 'function') {
                    init();
                } else if (typeof ensureSupabaseLoaded === 'function') {
                    ensureSupabaseLoaded().then(init).catch((e) => {
                        console.warn('‚ö†Ô∏è UMDÂä†ËΩΩÂ§±Ë¥•ÔºåÂàáÊç¢Âà∞RESTÂõûÈÄÄÊ®°Âºè:', e && e.message);
                        // ‰ΩøÁî®RESTÂõûÈÄÄÂÆ¢Êà∑Á´ØÔºå‰øùÈöú‰ΩéÁΩëÁéØÂ¢ÉÂèØÁî®
                        supabase = createSupabaseRestClient(LOGIN_SUPABASE_URL, LOGIN_SUPABASE_ANON_KEY);
                        if (window.LoginStatusManager) {
                            window.LoginStatusManager.setSupabaseClient(supabase);
                        }
                        detectTableStructure();
                        updateNetworkStatusDisplay();
                    });
                } else {
                    console.warn('‚ö†Ô∏è Êú™ÂèëÁé∞UMDÂä†ËΩΩÂô®ÔºåÁõ¥Êé•‰ΩøÁî®RESTÂõûÈÄÄÊ®°Âºè');
                    supabase = createSupabaseRestClient(LOGIN_SUPABASE_URL, LOGIN_SUPABASE_ANON_KEY);
                    if (window.LoginStatusManager) {
                        window.LoginStatusManager.setSupabaseClient(supabase);
                    }
                    detectTableStructure();
                    updateNetworkStatusDisplay();
                }
                
            } catch (error) {
                console.error('‚ùå ÂÆâÂÖ®ÁôªÂΩïÁ≥ªÁªüÂàùÂßãÂåñÂ§±Ë¥•:', error);
                // ÊòæÁ§∫Êõ¥ÂÖ∑‰ΩìÁöÑÈîôËØØ‰ø°ÊÅØ
                const errorMsg = error.message.includes('network') ? 'ÁΩëÁªúËøûÊé•Â§±Ë¥•' : 
                                error.message.includes('fetch') ? 'CDNËµÑÊ∫êÂä†ËΩΩÂ§±Ë¥•' :
                                error.message.includes('CORS') ? 'Ë∑®ÂüüËÆøÈóÆË¢´Êã¶Êà™' : 
                                'Á≥ªÁªüÂàùÂßãÂåñÂ§±Ë¥•ÔºåËØ∑Âà∑Êñ∞È°µÈù¢ÈáçËØï';
                
                if (window.LoginStatusManager) {
                    window.LoginStatusManager.setState('server_error', errorMsg);
                } else {
                    // Â¶ÇÊûúÁä∂ÊÄÅÁÆ°ÁêÜÂô®‰πüÊ≤°Âä†ËΩΩÊàêÂäüÔºåÁõ¥Êé•ÊòæÁ§∫ÈîôËØØ
                    const errorDiv = document.getElementById('login-error');
                    if (errorDiv) {
                        errorDiv.innerHTML = `<i class="fas fa-exclamation-triangle mr-2"></i>${errorMsg}`;
                        errorDiv.style.display = 'block';
                    }
                }
            }
        }
        
        // Êõ¥Êñ∞ÁΩëÁªúÁä∂ÊÄÅÊòæÁ§∫
        function updateNetworkStatusDisplay() {
            const networkStatus = document.getElementById('network-status');
            if (networkStatus) {
                networkStatus.style.display = 'flex';
                if (navigator.onLine) {
                    networkStatus.className = 'network-indicator network-online mb-4';
                    networkStatus.innerHTML = '<i class="fas fa-wifi mr-2"></i><span>ÁΩëÁªúËøûÊé•Ê≠£Â∏∏</span>';
                } else {
                    networkStatus.className = 'network-indicator network-offline mb-4';
                    networkStatus.innerHTML = '<i class="fas fa-wifi-slash mr-2"></i><span>ÁΩëÁªúËøûÊé•Êñ≠ÂºÄ</span>';
                }
                
                // 3ÁßíÂêéÈöêËóèÁΩëÁªúÁä∂ÊÄÅ
                setTimeout(() => {
                    if (navigator.onLine) {
                        networkStatus.style.display = 'none';
                    }
                }, 3000);
            }
        }
        
        // ÁÆÄÂåñÁöÑÈîôËØØÂ§ÑÁêÜ - ‰∏çÊòæÁ§∫ËØäÊñ≠‰ø°ÊÅØ
        function setupErrorHandling() {
            // ÈùôÈªòÂ§ÑÁêÜÈîôËØØÔºåËÆ∞ÂΩïÂà∞ÊéßÂà∂Âè∞‰ΩÜ‰∏çÊòæÁ§∫ÁªôÁî®Êà∑
            window.addEventListener('error', function (e) {
                console.log('È°µÈù¢ÈîôËØØ:', e.message);
            });
            window.addEventListener('unhandledrejection', function (e) {
                console.log('PromiseÈîôËØØ:', e.reason);
            });
        }
        
        // Ê£ÄÊµãÊï∞ÊçÆÂ∫ìË°®ÁªìÊûÑ
        async function detectTableStructure() {
            try {
                // ÈùôÈªòÊ£ÄÊµãÊï∞ÊçÆÂ∫ìË°®ÁªìÊûÑ
                const { data, error } = await supabase
                    .from('users')
                    .select('*')
                    .limit(1);
                
                if (error) {
                    // ÈùôÈªòÂ§ÑÁêÜÈîôËØØ
                    return;
                }
                
                if (data && data.length > 0) {
                    const fields = Object.keys(data[0]);
                    // Ê£ÄÊµãÂ≠óÊÆµÁ±ªÂûã
                    
                    // Âà§Êñ≠‰ΩøÁî®ÁöÑÊòØ‰∏≠ÊñáÂ≠óÊÆµÂêçËøòÊòØËã±ÊñáÂ≠óÊÆµÂêç
                    if (fields.includes('Áî®Êà∑Âêç')) {
                        usernameField = 'Áî®Êà∑Âêç';
                        passwordField = 'ÂØÜÁ†Å';
                        pointsField = 'ÁßØÂàÜ';
                        // ‰ΩøÁî®‰∏≠ÊñáÂ≠óÊÆµÂêç
                    } else {
                        usernameField = 'username';
                        passwordField = 'password';
                        pointsField = 'points';
                        // ‰ΩøÁî®Ëã±ÊñáÂ≠óÊÆµÂêç
                    }
                    
                    tableStructureDetected = true;
                } else {
                    // ‰ΩøÁî®ÈªòËÆ§Ëã±ÊñáÂ≠óÊÆµÂêç
                }
            } catch (error) {
                // ÈùôÈªòÂ§ÑÁêÜÈîôËØØ
            }
        }
        
        // ÂàùÂßãÂåñ
        initSupabase();
        
        // È°µÈù¢ÂàáÊç¢
        document.getElementById('show-register').addEventListener('click', function() {
            document.getElementById('login-form').classList.add('hidden');
            document.getElementById('register-form').classList.remove('hidden');
            document.getElementById('forgot-password-form').classList.add('hidden');
            clearMessages();
        });
        document.getElementById('show-login').addEventListener('click', function() {
            document.getElementById('login-form').classList.remove('hidden');
            document.getElementById('register-form').classList.add('hidden');
            document.getElementById('forgot-password-form').classList.add('hidden');
            clearMessages();
        });
        document.getElementById('back-to-login').addEventListener('click', function() {
            document.getElementById('login-form').classList.remove('hidden');
            document.getElementById('register-form').classList.add('hidden');
            document.getElementById('forgot-password-form').classList.add('hidden');
            clearMessages();
        });
        document.getElementById('forgot-password-link').addEventListener('click', function(e) {
            e.preventDefault();
            document.getElementById('login-form').classList.add('hidden');
            document.getElementById('register-form').classList.add('hidden');
            document.getElementById('forgot-password-form').classList.remove('hidden');
            clearMessages();
        });
        
        function clearMessages() {
            document.getElementById('login-error').style.display = 'none';
            document.getElementById('login-success').style.display = 'none';
            document.getElementById('register-error').style.display = 'none';
            document.getElementById('register-success').style.display = 'none';
            document.getElementById('forgot-password-error').style.display = 'none';
            document.getElementById('forgot-password-success').style.display = 'none';
        }

        // ÁÆÄÂçïÁöÑÊ∂àÊÅØÂ±ïÁ§∫Âä©ÊâãÔºàÊ≥®ÂÜå/ÁôªÂΩïÈÄöÁî®Ôºâ
        function showError(scope, message) {
            const errorEl = scope === 'register' ? document.getElementById('register-error') : document.getElementById('login-error');
            const successEl = scope === 'register' ? document.getElementById('register-success') : document.getElementById('login-success');
            if (successEl) successEl.style.display = 'none';
            if (errorEl) {
                errorEl.innerHTML = `<i class="fas fa-exclamation-triangle mr-2"></i>${message}`;
                errorEl.style.display = 'block';
            }
        }
        function showSuccess(scope, message) {
            const errorEl = scope === 'register' ? document.getElementById('register-error') : document.getElementById('login-error');
            const successEl = scope === 'register' ? document.getElementById('register-success') : document.getElementById('login-success');
            if (errorEl) errorEl.style.display = 'none';
            if (successEl) {
                successEl.innerHTML = `<i class="fas fa-check-circle mr-2"></i>${message}`;
                successEl.style.display = 'block';
            }
        }

        // Ê≥®ÂÜåË°®ÂçïÊèê‰∫§
        document.getElementById('register-form-content').addEventListener('submit', async function(e) {
            e.preventDefault();
            const username = document.getElementById('register-username').value.trim();
            const password = document.getElementById('register-password').value;
            const confirmPassword = document.getElementById('register-confirm-password').value;
            const inviteCode = (document.getElementById('register-invite-code')?.value||'').trim();
            if (!username || !password || !confirmPassword) { showError('register', 'ËØ∑Â°´ÂÜôÊâÄÊúâÂ≠óÊÆµ'); return; }
            if (username.length < 3) { showError('register', 'Áî®Êà∑ÂêçËá≥Â∞ëÈúÄË¶Å3‰∏™Â≠óÁ¨¶'); return; }
            if (password.length < 6) { showError('register', 'ÂØÜÁ†ÅËá≥Â∞ëÈúÄË¶Å6‰∏™Â≠óÁ¨¶'); return; }
            if (password !== confirmPassword) { showError('register', '‰∏§Ê¨°ËæìÂÖ•ÁöÑÂØÜÁ†Å‰∏ç‰∏ÄËá¥'); return; }
            try {
                const user = await registerUser(username, password);
                if (user) {
                    try{
                        const urlParams = new URLSearchParams(window.location.search);
                        const urlCode = urlParams.get('code') || '';
                        const code = inviteCode || urlCode;
                        if (code) { await processInviteBinding(code, user, supabase); }
                    }catch(_){ }
                    showSuccess('register', 'Ê≥®ÂÜåÊàêÂäüÔºÅÊ≠£Âú®Ë∑≥ËΩ¨Âà∞ÁôªÂΩïÈ°µÈù¢...');
                    document.getElementById('register-form-content').reset();
                    setTimeout(() => { document.getElementById('show-login').click(); }, 1500);
                }
            } catch (error) {
                if ((error.message||'').includes('duplicate')) { showError('register', 'Áî®Êà∑ÂêçÂ∑≤Â≠òÂú®ÔºåËØ∑ÈÄâÊã©ÂÖ∂‰ªñÁî®Êà∑Âêç'); }
                else { showError('register', 'Ê≥®ÂÜåÂ§±Ë¥•Ôºö' + error.message); }
            }
        });

        // Â§ÑÁêÜÈÇÄËØ∑Á†ÅÁªëÂÆö
        async function processInviteBinding(code, user, client){
            try{
                const inviterId = code; // ‰øùÁïôÂéüÊúâÁü≠Á†Å/IDÈÄªËæëÔºå‰∏ç‰ΩúÂº∫Ê†°È™å
                if(!client || !user || !user.id) return;
                try{ await client.rpc('exec_sql', { sql_query: "CREATE TABLE IF NOT EXISTS public.referrals (id uuid default gen_random_uuid() primary key, inviter_id text, invitee_id text, created_at timestamptz default now()); ALTER TABLE public.referrals ENABLE ROW LEVEL SECURITY; DROP POLICY IF EXISTS referrals_select ON public.referrals; CREATE POLICY referrals_select ON public.referrals FOR SELECT TO anon USING (true); DROP POLICY IF EXISTS referrals_insert ON public.referrals; CREATE POLICY referrals_insert ON public.referrals FOR INSERT TO anon WITH CHECK (true);" }); }catch(_){ }
                await client.from('referrals').insert([{ inviter_id: inviterId, invitee_id: user.id }]);
                try{ const cu = JSON.parse(localStorage.getItem('currentUser')||'{}'); cu.invited_by = inviterId; localStorage.setItem('currentUser', JSON.stringify(cu)); }catch(_){ }
            }catch(_){ }
        }
    </script>
    
    <!-- üîß ÁÆÄÂåñ‰øÆÂ§çÔºöÂè™‰øùÁïôÂøÖË¶ÅÁöÑÁúüÂÆûÊï∞ÊçÆÂ∫ìËøûÊé• -->
    <script>
        // Á°Æ‰øù‰ΩøÁî®ÁúüÂÆûSupabaseËøûÊé•ÔºåÊ∏ÖÁêÜÊâÄÊúâÂèØËÉΩÁöÑÂÜ≤Á™Å
        console.log('üîß ÁÆÄÂåñ‰øÆÂ§çÂêØÂä® - Ê∏ÖÁêÜËÑöÊú¨ÂÜ≤Á™Å');
        
        // Á≠âÂæÖÈ°µÈù¢Âä†ËΩΩÂÆåÊàêÂêéÈ™åËØÅSupabaseËøûÊé•
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                if (window.supabase && typeof window.supabase.from === 'function') {
                    console.log('‚úÖ SupabaseÁúüÂÆûËøûÊé•Â∑≤Â∞±Áª™');
                    
                    // ÊµãËØïÊï∞ÊçÆÂ∫ìËøûÊé•
                    testDatabaseConnection();
                } else {
                    console.error('‚ùå SupabaseËøûÊé•Â§±Ë¥•');
                }
            }, 1000);
        });
        
        // ÊµãËØïÊï∞ÊçÆÂ∫ìËøûÊé•
        async function testDatabaseConnection() {
            try {
                const { data, error } = await supabase
                    .from('users')
                    .select('*', { count: 'exact', head: true });
                
                if (error) {
                    console.error('‚ùå Êï∞ÊçÆÂ∫ìËøûÊé•ÊµãËØïÂ§±Ë¥•:', error);
                } else {
                    console.log(`‚úÖ Êï∞ÊçÆÂ∫ìËøûÊé•Ê≠£Â∏∏ÔºåÁî®Êà∑Ë°®Êúâ ${data?.count || 0} Êù°ËÆ∞ÂΩï`);
                }
            } catch (err) {
                console.error('‚ùå Êï∞ÊçÆÂ∫ìËøûÊé•ÂºÇÂ∏∏:', err);
            }
        }
        
        // Âº∫Âà∂‰ΩøÁî®Ê†áÂáÜÂ≠óÊÆµÂêçÔºåÈÅøÂÖçÊ£ÄÊµãÈîôËØØ
        window.addEventListener('load', function() {
            // Âº∫Âà∂ËÆæÁΩÆ‰∏∫Ê†áÂáÜËã±ÊñáÂ≠óÊÆµÂêç
            usernameField = 'username';
            passwordField = 'password';
            pointsField = 'points';
            tableStructureDetected = true;
            
            console.log('üîß Âº∫Âà∂‰ΩøÁî®Ê†áÂáÜÂ≠óÊÆµÂêç: username, password, points');
        });
    </script>
</body>
</html>

