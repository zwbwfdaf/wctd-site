<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>我的收益 - 文创邦</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="theme.css">
    <style>
        .earnings-container {
            background-color: #ffb366;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .earnings-header {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .earnings-subheader {
            color: #666;
            margin-bottom: 15px;
            font-size: 14px;
        }
        
        .earnings-amount {
            font-size: 36px;
            font-weight: bold;
            margin-bottom: 20px;
        }
        
        .earnings-stats {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        
        .stat-label {
            font-size: 14px;
            color: #555;
        }
        
        .stat-value {
            font-size: 18px;
            font-weight: bold;
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding: 0 10px;
        }
        
        .section-title {
            font-size: 18px;
            font-weight: bold;
        }
        
        .section-link {
            color: #3b82f6;
            font-size: 14px;
        }
        
        .earnings-record {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .task-info {
            flex: 1;
        }
        
        .task-name {
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .task-date {
            color: #666;
            font-size: 12px;
        }
        
        .earnings-amount.positive {
            color: #10b981;
            font-weight: bold;
            margin-right: 10px;
        }
        
        .earnings-amount.negative {
            color: #ef4444;
            font-weight: bold;
            margin-right: 10px;
        }
        
        .task-status {
            color: #6b7280;
            font-size: 12px;
            text-align: right;
            width: 60px;
        }
        
        .date-filter {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background-color: #f9fafb;
            border-radius: 10px;
            margin-bottom: 15px;
        }
        
        .withdraw-button {
            background: linear-gradient(135deg, #3b82f6 0%, #6366f1 100%);
            color: white;
            padding: 12px 20px;
            border-radius: 12px;
            font-weight: bold;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .withdraw-button:active {
            transform: scale(0.98);
        }
        
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .tab {
            flex: 1;
            text-align: center;
            padding: 12px 0;
            font-weight: bold;
            color: #6b7280;
        }
        
        .tab.active {
            color: #3b82f6;
            border-bottom: 2px solid #3b82f6;
        }
        
        .stat-box {
            background-color: white;
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .stat-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
        }
        
        .stat-icon.blue {
            background-color: #e0f2fe;
            color: #3b82f6;
        }
        
        .stat-icon.green {
            background-color: #dcfce7;
            color: #10b981;
        }
        
        .stat-icon.purple {
            background-color: #f3e8ff;
            color: #8b5cf6;
        }
        
        .stat-icon.yellow {
            background-color: #fef3c7;
            color: #f59e0b;
        }
        
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: white;
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            border-top: 1px solid #e5e7eb;
        }
        
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: #6b7280;
            font-size: 12px;
        }
        
        .nav-item.active {
            color: #3b82f6;
        }
        
        .nav-icon {
            font-size: 20px;
            margin-bottom: 4px;
        }
        
        .admin-panel {
            background-color: #f3f4f6;
            border-radius: 12px;
            padding: 15px;
            margin-top: 20px;
            display: none;
        }
        
        .admin-panel h3 {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .form-group {
            margin-bottom: 12px;
        }
        
        .form-label {
            display: block;
            font-size: 14px;
            margin-bottom: 5px;
        }
        
        .form-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
        }
        
        .admin-button {
            background-color: #3b82f6;
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            border: none;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen pb-16">
    <div class="container mx-auto px-4 py-6">
        <header class="flex justify-between items-center mb-6">
            <div class="text-lg font-bold">收益中心</div>
            <div class="flex items-center text-sm">
                <span id="username">加载中...</span>
                <span class="mx-2">|</span>
                <span>积分: <span id="user-points">0</span></span>
                <button id="logout-button" class="ml-4 text-blue-600">
                    <i class="fas fa-sign-out-alt mr-1"></i> 退出
                </button>
            </div>
        </header>
        
        <main>
            <!-- 收益概览 -->
            <div class="earnings-container">
                <div class="earnings-subheader">可提现收益</div>
                <div class="earnings-amount withdrawable-earnings">¥0.00</div>
                <div class="flex justify-end">
                    <button class="withdraw-button">
                        申请提现
                    </button>
                </div>
                
                <div class="earnings-stats mt-4">
                    <div>
                        <div class="stat-label">我的收益</div>
                        <div class="stat-value total-earnings">¥0.00</div>
                    </div>
                    <div>
                        <div class="stat-label">今日我的收益</div>
                        <div class="stat-value today-earnings">¥0.00</div>
                    </div>
                </div>
            </div>
            
            <!-- 标签页 -->
            <div class="tabs">
                <div class="tab active" data-tab="data">我的数据</div>
                <div class="tab" data-tab="activities">活动收益</div>
            </div>
            
            <!-- 日期筛选 -->
            <div class="date-filter">
                <div id="start-date">2025-08-28</div>
                <div>—</div>
                <div id="end-date">2025-08-29</div>
                <button id="clear-date" class="ml-2 text-gray-500">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <!-- 数据统计 -->
            <div class="grid grid-cols-2 gap-4 mb-6">
                <div class="stat-box">
                    <div class="stat-icon blue">
                        <i class="fas fa-user-friends"></i>
                    </div>
                    <div>
                        <div class="text-gray-500 text-sm">推广人数</div>
                        <div class="font-bold text-lg" id="promotion-count">0</div>
                    </div>
                </div>
                
                <div class="stat-box">
                    <div class="stat-icon green">
                        <i class="fas fa-tasks"></i>
                    </div>
                    <div>
                        <div class="text-gray-500 text-sm">完成任务</div>
                        <div class="font-bold text-lg completed-tasks-count">0</div>
                    </div>
                </div>
                
                <div class="stat-box">
                    <div class="stat-icon purple">
                        <i class="fas fa-coins"></i>
                    </div>
                    <div>
                        <div class="text-gray-500 text-sm">累计收益</div>
                        <div class="font-bold text-lg total-earnings">¥0.00</div>
                    </div>
                </div>
                
                <div class="stat-box">
                    <div class="stat-icon yellow">
                        <i class="fas fa-star"></i>
                    </div>
                    <div>
                        <div class="text-gray-500 text-sm">我的等级</div>
                        <div class="font-bold text-lg" id="user-level">LV1</div>
                    </div>
                </div>
            </div>
            
            <!-- 收益记录 -->
            <div class="section-header">
                <div class="section-title">收益记录</div>
                <a href="#" class="section-link">查看更多</a>
            </div>
            
            <div class="bg-white rounded-lg shadow-sm overflow-hidden">
                <div id="earnings-list" class="earnings-list">
                    <!-- 收益记录将在这里动态生成 -->
                    <div class="p-4 text-center text-gray-500">加载中...</div>
                </div>
            </div>
            
            <!-- 管理员功能面板 -->
            <div id="admin-panel" class="admin-panel">
                <h3>管理员功能</h3>
                <div class="form-group">
                    <label class="form-label" for="task-name">任务名称</label>
                    <input type="text" id="task-name" class="form-input" placeholder="输入任务名称">
                </div>
                <div class="form-group">
                    <label class="form-label" for="amount">金额 (元)</label>
                    <input type="number" id="amount" class="form-input" placeholder="输入金额" step="0.01">
                </div>
                <div class="form-group">
                    <label class="form-label" for="description">描述 (可选)</label>
                    <input type="text" id="description" class="form-input" placeholder="输入描述信息">
                </div>
                <button id="add-earning" class="admin-button">添加收益记录</button>
            </div>
        </main>
    </div>
    
    <!-- 底部导航 -->
    <nav class="bottom-nav">
        <a href="index.html" class="nav-item">
            <i class="fas fa-home nav-icon"></i>
            <span>首页</span>
        </a>
        <a href="ranking.html" class="nav-item">
            <i class="fas fa-trophy nav-icon"></i>
            <span>榜单</span>
        </a>
        <a href="income.html" class="nav-item active">
            <i class="fas fa-chart-line nav-icon"></i>
            <span>收益</span>
        </a>
        <a href="profile.html" class="nav-item">
            <i class="fas fa-user nav-icon"></i>
            <span>我的</span>
        </a>
    </nav>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="earnings-realtime.js"></script>
    <script>
        // Supabase配置
        const SUPABASE_URL = 'https://ybrveusbwjusnrzgfnok.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlicnZldXNid2p1c25yemdmbm9rIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY0ODU1NjIsImV4cCI6MjA3MjA2MTU2Mn0.JKPSUli-q9wRuDagE6kwltLk9XgfygE8yznm-Ca82Qk';
        const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // 全局变量
        let currentUser = null;
        let isAdmin = false;
        let earningsRealtimeController = null;
        
        // 页面加载时初始化
        document.addEventListener('DOMContentLoaded', async () => {
            // 检查用户登录状态
            await checkUserLogin();
            
            // 初始化日期选择器
            initDatePicker();
            
            // 初始化标签页
            initTabs();
            
            // 设置退出按钮事件
            document.getElementById('logout-button').addEventListener('click', handleLogout);
            
            // 设置管理员功能
            document.getElementById('add-earning').addEventListener('click', handleAddEarning);
            
            // 注册双击事件以显示管理员面板
            document.querySelector('.earnings-container').addEventListener('dblclick', toggleAdminPanel);
        });
        
        // 检查用户登录状态
        async function checkUserLogin() {
            try {
                // 从本地存储获取用户信息
                const storedUser = localStorage.getItem('currentUser');
                if (!storedUser) {
                    // 未登录，跳转到登录页面
                    window.location.href = 'login.html';
                    return;
                }
                
                currentUser = JSON.parse(storedUser);
                
                // 显示用户信息
                document.getElementById('username').textContent = currentUser.username || currentUser.用户名 || '用户';
                document.getElementById('user-points').textContent = currentUser.points || currentUser.积分 || '0';
                
                // 根据积分设置等级
                const points = currentUser.points || currentUser.积分 || 0;
                let level = 'LV1';
                if (points >= 1000) level = 'LV5';
                else if (points >= 500) level = 'LV4';
                else if (points >= 200) level = 'LV3';
                else if (points >= 50) level = 'LV2';
                
                document.getElementById('user-level').textContent = level;
                
                // 设置管理员状态（这里简单示例：用户名中包含"admin"即为管理员）
                isAdmin = (currentUser.username && currentUser.username.toLowerCase().includes('admin')) || 
                         (currentUser.用户名 && currentUser.用户名.toLowerCase().includes('admin'));
                
                // 初始化收益实时更新功能
                initEarningsModule();
                
            } catch (error) {
                console.error('检查登录状态出错:', error);
                alert('登录状态异常，请重新登录');
                window.location.href = 'login.html';
            }
        }
        
        // 初始化收益实时更新模块
        function initEarningsModule() {
            if (!currentUser || !currentUser.id) {
                console.error('无法初始化收益模块：用户ID不存在');
                return;
            }
            
            // 设置收益更新回调
            const onEarningsUpdate = (payload) => {
                // 播放通知声音或显示提示
                if (payload.eventType === 'INSERT') {
                    showNotification('收到新的收益！');
                }
            };
            
            // 初始化实时收益更新
            earningsRealtimeController = window.EarningsModule.initEarningsRealtime(
                supabase,
                currentUser.id,
                onEarningsUpdate
            );
        }
        
        // 初始化日期选择器
        function initDatePicker() {
            // 设置默认日期为当前日期和前一天
            const today = new Date();
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);
            
            // 格式化日期为YYYY-MM-DD
            document.getElementById('start-date').textContent = formatDate(yesterday);
            document.getElementById('end-date').textContent = formatDate(today);
            
            // 清除日期筛选按钮
            document.getElementById('clear-date').addEventListener('click', () => {
                document.getElementById('start-date').textContent = '';
                document.getElementById('end-date').textContent = '';
            });
        }
        
        // 格式化日期
        function formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        
        // 初始化标签页
        function initTabs() {
            const tabs = document.querySelectorAll('.tab');
            
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    // 移除所有标签的active类
                    tabs.forEach(t => t.classList.remove('active'));
                    
                    // 添加当前标签的active类
                    tab.classList.add('active');
                    
                    // 处理标签切换逻辑
                    const tabName = tab.dataset.tab;
                    handleTabChange(tabName);
                });
            });
        }
        
        // 处理标签切换
        function handleTabChange(tabName) {
            // 根据标签名称实现不同的逻辑
            console.log('切换到标签:', tabName);
            
            // 在实际应用中可以根据标签显示不同内容
        }
        
        // 处理退出登录
        function handleLogout() {
            // 清除本地存储的用户信息
            localStorage.removeItem('currentUser');
            
            // 停止实时更新
            if (earningsRealtimeController) {
                earningsRealtimeController.stop();
            }
            
            // 跳转到登录页面
            window.location.href = 'login.html';
        }
        
        // 显示通知
        function showNotification(message) {
            // 简单实现，实际应用可以使用更漂亮的通知组件
            const notification = document.createElement('div');
            notification.style.position = 'fixed';
            notification.style.top = '20px';
            notification.style.left = '50%';
            notification.style.transform = 'translateX(-50%)';
            notification.style.backgroundColor = '#10b981';
            notification.style.color = 'white';
            notification.style.padding = '10px 20px';
            notification.style.borderRadius = '8px';
            notification.style.boxShadow = '0 4px 6px rgba(0, 0, 0, 0.1)';
            notification.style.zIndex = '1000';
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            // 3秒后自动移除
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transition = 'opacity 0.5s ease';
                
                // 完全移除元素
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 500);
            }, 3000);
        }
        
        // 切换管理员面板显示
        function toggleAdminPanel() {
            const adminPanel = document.getElementById('admin-panel');
            
            if (!isAdmin) {
                // 如果用户不是管理员，连续点击5次启用管理员模式
                if (!window.adminClickCount) window.adminClickCount = 0;
                window.adminClickCount++;
                
                if (window.adminClickCount >= 5) {
                    isAdmin = true;
                    showNotification('管理员模式已启用');
                    window.adminClickCount = 0;
                }
                return;
            }
            
            // 切换显示状态
            if (adminPanel.style.display === 'block') {
                adminPanel.style.display = 'none';
            } else {
                adminPanel.style.display = 'block';
            }
        }
        
        // 处理添加收益记录
        async function handleAddEarning() {
            if (!isAdmin || !currentUser || !currentUser.id) {
                showNotification('无权限或用户未登录');
                return;
            }
            
            // 获取表单数据
            const taskName = document.getElementById('task-name').value.trim();
            const amountStr = document.getElementById('amount').value.trim();
            const description = document.getElementById('description').value.trim();
            
            // 验证数据
            if (!taskName) {
                showNotification('请输入任务名称');
                return;
            }
            
            if (!amountStr) {
                showNotification('请输入金额');
                return;
            }
            
            const amount = parseFloat(amountStr);
            if (isNaN(amount)) {
                showNotification('金额必须是有效数字');
                return;
            }
            
            try {
                // 添加收益记录
                const result = await window.EarningsModule.addEarningRecord(
                    supabase,
                    currentUser.id,
                    taskName,
                    amount,
                    description
                );
                
                if (!result.success) {
                    throw new Error(result.error || '添加收益记录失败');
                }
                
                // 更新用户积分（将收益金额四舍五入转为积分）
                const pointsToAdd = Math.round(amount);
                await window.EarningsModule.updateUserPoints(
                    supabase,
                    currentUser.id,
                    pointsToAdd
                );
                
                // 清空表单
                document.getElementById('task-name').value = '';
                document.getElementById('amount').value = '';
                document.getElementById('description').value = '';
                
                showNotification('成功添加收益记录');
                
            } catch (error) {
                console.error('添加收益记录失败:', error);
                showNotification('操作失败: ' + error.message);
            }
        }
    </script>
</body>
</html>