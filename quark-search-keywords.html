<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>申请推广关键词</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f6f7fb; min-height: 100vh; color: #333; overflow-x: hidden; }
        .header { display: flex; align-items: center; justify-content: space-between; padding: 15px 20px; background: #ffffff; border-bottom: 1px solid #f0f2f5; position: sticky; top: 0; z-index: 100; }
        .back-btn { width: 40px; height: 40px; border-radius: 50%; background: rgba(102,126,234,0.1); color: #667eea; display: flex; align-items: center; justify-content: center; text-decoration: none; font-size: 18px; font-weight: bold; transition: all .3s ease; }
        .back-btn:hover { background: rgba(102,126,234,0.2); transform: translateX(-2px); }
        .header-title { font-size: 18px; font-weight: 600; color: #333; flex: 1; text-align: center; margin: 0 15px; }
        .help-btn { width: 40px; height: 40px; border-radius: 50%; background: rgba(102,126,234,0.1); color: #667eea; border: none; display: flex; align-items: center; justify-content: center; font-size: 16px; cursor: pointer; transition: all .3s ease; }
        .help-btn:hover { background: rgba(102,126,234,0.2); transform: scale(1.05); }
        .main-content { padding: 16px; max-width: 600px; margin: 0 auto; }
        .intro-card { background: #ffffff; border-radius: 12px; padding: 16px; margin-bottom: 16px; display: flex; align-items: center; gap: 14px; border: 1px solid #eef2f7; }
        .intro-icon { font-size: 28px; color: #8b5cf6; }
        .intro-text h3 { font-size: 20px; color: #333; margin-bottom: 8px; }
        .intro-text p { color: #666; font-size: 14px; line-height: 1.5; }
        .selection-card { background: #ffffff; border-radius: 12px; padding: 8px 0; margin-bottom: 12px; border: 1px solid #eef2f7; animation: fadeInUp .6s ease forwards; }
        .card-header { display: flex; align-items: center; justify-content: space-between; padding: 12px 12px 0 12px; }
        .card-icon { font-size: 18px; color: #ff6b6b; }
        .card-header h3 { font-size: 16px; color: #333; font-weight: 700; }
        .options-grid { display:flex; gap:10px; flex-wrap:wrap; padding: 8px 12px 12px; }
        .option-pill { padding:10px 14px; border-radius:9999px; border:2px solid rgba(102,126,234,0.2); background:#fff; color:#374151; font-weight:700; font-size:14px; cursor:pointer; user-select:none; transition: transform .18s ease, box-shadow .18s ease, border-color .18s ease, background-color .18s ease, color .18s ease; position:relative; overflow:hidden; -webkit-tap-highlight-color: rgba(0,0,0,0); outline:0; display:inline-flex; align-items:center; gap:8px; }
        .option-pill i { font-size:16px; color:#94a3b8; }
        .option-pill:hover { transform: translateY(-1px); box-shadow: 0 6px 14px rgba(99,102,241,.12); }
        .option-pill:active { transform: scale(.96); outline:0; }
        .option-pill.active { border-color:#ff7a45; background:#fff7ed; color:#b45309; box-shadow: 0 8px 18px rgba(255,122,69,.18); }
        .option-pill.active i{ color:#ff7a45; }
        .option-pill .ripple { position:absolute; border-radius:50%; transform:scale(0); animation:ripple .5s ease-out; background: rgba(255,122,69,.25); pointer-events:none; }
        @keyframes ripple { to { transform: scale(6); opacity: 0; } }
        .form-group { margin-bottom: 25px; }
        .form-label { display: block; margin-bottom: 10px; font-weight: 600; color: #333; font-size: 16px; }
        .required { color: #e74c3c; margin-left: 4px; }
        .form-input, .form-textarea { width: 100%; padding: 16px 20px; border: 2px solid rgba(102,126,234,0.2); border-radius: 16px; font-size: 16px; background: rgba(255,255,255,0.9); backdrop-filter: blur(10px); transition: all .3s ease; color: #333; font-family: inherit; }
        .form-input:focus, .form-textarea:focus { outline: none; border-color: #667eea; background: rgba(255,255,255,0.95); box-shadow: 0 0 0 4px rgba(102,126,234,0.1); }
        .form-textarea { min-height: 120px; resize: vertical; line-height: 1.5; }
        .submit-btn { width: 100%; padding: 14px; background: #ff7a45; color: #fff; border: none; border-radius: 12px; font-size: 18px; font-weight: 700; cursor: pointer; transition: all .2s ease; margin-top: 12px; -webkit-tap-highlight-color: rgba(0,0,0,0); outline:0; }
        .submit-btn:hover { filter: brightness(0.98); }
        .submit-btn:focus, .submit-btn:active { outline:0; box-shadow:none; }
        .submit-btn:disabled { opacity: .7; cursor: not-allowed; transform: none; }
        @media (max-width:480px){ .main-content{ padding:15px; } .options-grid{ grid-template-columns:1fr 1fr; } }
        @keyframes fadeInUp{ from{opacity:0; transform:translateY(30px);} to{opacity:1; transform:translateY(0);} }
    </style>
</head>
<body>
    <div class="header">
        <a href="quark-search-task.html" class="back-btn">←</a>
        <div class="header-title">申请推广关键词</div>
        <button class="help-btn">?</button>
    </div>
    <div class="main-content">
        <div class="intro-card">
            <i class="fas fa-rocket intro-icon"></i>
            <div class="intro-text">
                <h3>申请推广资格</h3>
                <p>填写以下信息，我们将尽快审核您的申请</p>
            </div>
        </div>
        <form id="promotionForm">
            <div class="selection-card">
                <div class="card-header"><i class="fas fa-star card-icon"></i><h3>推广经验</h3></div>
                <div class="options-grid" id="experienceOptions">
                    <div class="option-pill" data-value="正在学习中"><i class="fas fa-seedling"></i><span>正在学习中</span></div>
                    <div class="option-pill" data-value="我很有经验"><i class="fas fa-medal"></i><span>我很有经验</span></div>
                </div>
            </div>
            <div class="selection-card">
                <div class="card-header"><i class="fas fa-share-alt card-icon"></i><h3>推广平台</h3></div>
                <div class="options-grid" id="platformOptions">
                    <div class="option-pill" data-value="抖音平台"><i class="fab fa-tiktok"></i><span>抖音平台</span></div>
                    <div class="option-pill" data-value="微信朋友圈"><i class="fab fa-weixin"></i><span>微信朋友圈</span></div>
                    <div class="option-pill" data-value="快手平台"><i class="fas fa-bolt"></i><span>快手平台</span></div>
                    <div class="option-pill" data-value="QQ群/空间"><i class="fab fa-qq"></i><span>QQ群/空间</span></div>
                </div>
            </div>
            <div class="selection-card">
                <div class="card-header"><i class="fas fa-book card-icon"></i><h3>内容类型</h3></div>
                <div class="options-grid" id="contentTypeOptions">
                    <div class="option-pill" data-value="学习资源"><i class="fas fa-book-open"></i><span>学习资源</span></div>
                    <div class="option-pill" data-value="娱乐内容"><i class="fas fa-film"></i><span>娱乐内容</span></div>
                </div>
            </div>

            <button type="submit" class="submit-btn" id="submitButton">提交申请</button>
        </form>
    </div>
    <!-- Supabase SDK for database operations -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Keyword Sync Manager -->
    <script src="keyword-sync-manager.js"></script>
    <script>
    (function(){
        const appState = { selectedExperience:null, selectedPlatform:null, selectedContentType:null, currentUser:null, supabase:null };
        
        // Supabase configuration (direct)
        const SUPABASE_URL = 'https://ybrveusbwjusnrzgfnok.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlicnZldXNid2p1c25yemdmbm9rIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY0ODU1NjIsImV4cCI6MjA3MjA2MTU2Mn0.JKPSUli-q9wRuDagE6kwltLk9XgfygE8yznm-Ca82Qk';
        
        document.addEventListener('DOMContentLoaded', () => { 
            initSupabase(); 
            initUser(); 
            bindSelections(); 
            bindSubmit(); 
            bindHelp(); 
        });
        
        // Initialize Supabase client
        function initSupabase(){
            try{
                if(typeof window.supabase !== 'undefined'){
                    appState.supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                    console.log('✅ Supabase客户端初始化成功');
                } else {
                    console.warn('⚠️ Supabase SDK未加载，将只使用localStorage');
                }
            } catch(error){
                console.error('❌ Supabase初始化失败:', error);
            }
        }
        
        function initUser(){ 
            try{ 
                const u = localStorage.getItem('currentUser'); 
                appState.currentUser = u? JSON.parse(u) : { id:'555', username:'555' }; 
                if(!u) localStorage.setItem('currentUser', JSON.stringify(appState.currentUser)); 
            }catch(_){
                appState.currentUser = { id:'555', username:'555' };
            } 
        }
        
        function bindSelections(){ 
            single('experienceOptions', v=>appState.selectedExperience=v); 
            single('platformOptions', v=>appState.selectedPlatform=v); 
            single('contentTypeOptions', v=>appState.selectedContentType=v); 
        }
        
        function single(id, cb){ 
            const c=document.getElementById(id); 
            if(!c) return; 
            const opts=c.querySelectorAll('.option-pill'); 
            opts.forEach(o=>o.addEventListener('click', function(e){ 
                opts.forEach(x=>x.classList.remove('active')); 
                this.classList.add('active');
                cb && cb(this.getAttribute('data-value'));
                // ripple
                try{
                    const r=document.createElement('span'); r.className='ripple';
                    const rect=this.getBoundingClientRect(); const size=Math.max(rect.width, rect.height);
                    r.style.width=r.style.height=size+'px';
                    r.style.left=(e.clientX-rect.left-size/2)+'px';
                    r.style.top=(e.clientY-rect.top-size/2)+'px';
                    this.appendChild(r); setTimeout(()=>r.remove(),520);
                }catch(_){ }
            })); 
        }
        
        function bindSubmit(){ 
            const form=document.getElementById('promotionForm'); 
            const btn=document.getElementById('submitButton'); 
            form.addEventListener('submit', e=>{ 
                e.preventDefault();
                if(!validate()) return; 
                btn.disabled=true; 
                btn.innerHTML='<i class="fas fa-spinner fa-spin"></i> 提交中...'; 
                submit(); 
            }); 
        }
        
        function validate(){ 
            if(!appState.selectedExperience){
                alert('请选择您的推广经验');
                return false;
            }
            if(!appState.selectedPlatform){
                alert('请选择推广平台');
                return false;
            }
            if(!appState.selectedContentType){
                alert('请选择内容类型');
                return false;
            }
            return true;
        }

        // Enhanced submit function with sync manager
        async function submit(){ 
            const id='KW'+Date.now().toString().slice(-8); 
            const data={ 
                id, 
                    username: appState.currentUser.username,
                    userId: appState.currentUser.id,
                    experience: appState.selectedExperience,
                    channel: appState.selectedPlatform,
                    category: appState.selectedContentType,
                    status: 'pending',
                    submitTime: new Date().toISOString(),
                    created_at: new Date().toISOString()
                };
                
            console.log('📝 准备提交申请数据:', data);
            
            // Use KeywordSyncManager for reliable data saving
            if(window.KeywordSyncManager){
                try{
                    const result = await window.KeywordSyncManager.saveKeywordApplication(data);
                    
                    if(result.databaseSaved){
                        showToast('申请提交成功，管理员将尽快审核', 'success');
                    } else if(result.localSaved && result.needsSync){
                        showToast('申请已保存，将在网络恢复后自动同步到服务器', 'info');
                    } else if(result.localSaved){
                        showToast('申请已保存到本地', 'warning');
                    } else {
                        throw new Error('保存失败');
                    }
                    
                    // Show sync status if needed
                    const syncStatus = window.KeywordSyncManager.getSyncStatus();
                    if(syncStatus.hasPendingData && syncStatus.pendingCount > 1){
                        setTimeout(() => {
                            showToast(`您有 ${syncStatus.pendingCount} 条申请待同步`, 'info');
                        }, 2000);
                    }
                    
                    setTimeout(()=>{ 
                        window.location.href='application-success.html'; 
                    }, 1500);
                    
                } catch(error){
                    console.error('❌ 保存申请失败:', error);
                    showToast('申请提交失败，请重试', 'error');
                    const btn = document.getElementById('submitButton');
                    btn.disabled = false;
                    btn.innerHTML = '提交申请';
                }
            } else {
                // Fallback to original method if sync manager not available
                console.warn('⚠️ 同步管理器不可用，使用原始保存方法');
                await submitFallback(data);
            }
        }
        
        // Fallback submit method
        async function submitFallback(data){
            let saved = false;
            
            // Try database first
            if(appState.supabase){
                try{
                    const dbData = {
                        id: data.id,
                        user_id: data.userId,
                        username: data.username,
                        keywords: '',
                        experience: data.experience,
                        promotion_channel: data.channel,
                        task_type: 'KK搜索任务',
                        status: data.status,
                        created_at: data.created_at,
                        updated_at: data.created_at
                    };
                    
                    const { error } = await appState.supabase
                        .from('keyword_applications')
                        .insert([dbData]);
                    
                    if(!error){
                        saved = true;
                        showToast('申请提交成功', 'success');
                    }
                } catch(e){}
            }
            
            // Save to localStorage
            try{ 
                const userKey='keywords_'+appState.currentUser.id; 
                const ud=JSON.parse(localStorage.getItem(userKey)||'[]'); 
                ud.push(data); 
                localStorage.setItem(userKey, JSON.stringify(ud)); 
                
                const gk='promotionApplications'; 
                const gd=JSON.parse(localStorage.getItem(gk)||'[]'); 
                gd.push(data); 
                localStorage.setItem(gk, JSON.stringify(gd));
                
                if(!saved){
                    showToast('申请已保存到本地', 'warning');
                }
                saved = true;
            }catch(_){}
            
            if(saved){
                setTimeout(()=>{ 
                    window.location.href='application-success.html'; 
                }, 1500);
            } else {
                showToast('申请提交失败，请重试', 'error');
                const btn = document.getElementById('submitButton');
                btn.disabled = false;
                btn.innerHTML = '提交申请';
            }
        }
        
        function bindHelp(){ 
            const b=document.querySelector('.help-btn'); 
            if(!b) return; 
            b.addEventListener('click',()=>alert('申请说明:\n1. 选择推广经验\n2. 选择推广平台\n3. 选择内容类型\n4. 提交申请等待审核')); 
        }
        
        // Toast notification function
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            const bgColor = {
                'success': '#10b981',
                'error': '#ef4444',
                'warning': '#f59e0b',
                'info': '#3b82f6'
            }[type] || '#3b82f6';
            
            toast.style.cssText = `
                position: fixed;
                top: 100px;
                left: 50%;
                transform: translateX(-50%);
                background: ${bgColor};
                color: white;
                padding: 12px 24px;
                border-radius: 12px;
                font-size: 14px;
                font-weight: 500;
                z-index: 10000;
                box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
                opacity: 0;
                transition: opacity 0.3s ease;
                max-width: 300px;
                text-align: center;
            `;
            toast.textContent = message;
            
            document.body.appendChild(toast);
            
            requestAnimationFrame(() => {
                toast.style.opacity = '1';
            });
            
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => {
                    if (document.body.contains(toast)) {
                        document.body.removeChild(toast);
                    }
                }, 300);
            }, 3000);
        }
    })();
    </script>
</body>
</html>




