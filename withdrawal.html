<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#4f46e5">
    <title>ç”³è¯·æç°</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="mobile-optimizations.css">
    <link rel="stylesheet" href="theme.css">
    <link rel="manifest" href="mobile-manifest.json">
    <link rel="preconnect" href="https://ybrveusbwjusnrzgfnok.supabase.co">
    <link rel="dns-prefetch" href="https://ybrveusbwjusnrzgfnok.supabase.co">
    <style>
        body {
            background-color: #f5f7fa;
            font-family: 'PingFang SC', 'Helvetica Neue', Arial, sans-serif;
        }
        
        .top-bar {
            background: linear-gradient(135deg, #4f46e5 0%, #6366f1 100%);
            padding-top: env(safe-area-inset-top);
            padding-bottom: 12px;
        }
        
        .nav-button {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            cursor: pointer;
        }
        
        .form-section {
            background: white;
            border-radius: 16px;
            margin: 16px;
            padding: 16px;
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        
        .form-input {
            background-color: #f8fafc;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            padding: 12px 16px;
            width: 100%;
            font-size: 16px;
            outline: none;
        }
        
        .form-input:focus {
            border-color: #6366f1;
            box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2);
        }
        
        .submit-btn {
            background: linear-gradient(135deg, #4f46e5 0%, #6366f1 100%);
            color: white;
            border: none;
            width: 100%;
            padding: 14px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            margin-top: 20px;
        }
        
        .submit-btn:disabled,
        .submit-btn[data-disabled="true"] {
            background: #9ca3af !important;
            opacity: 0.7;
            cursor: not-allowed;
        }
        
        .info-list {
            padding: 0;
            list-style: none;
        }
        
        .info-list li {
            position: relative;
            padding-left: 20px;
            margin-bottom: 12px;
            color: #64748b;
            font-size: 14px;
            line-height: 1.6;
        }
        
        .info-list li:before {
            content: "â€¢";
            position: absolute;
            left: 0;
            color: #94a3b8;
        }
        
        .withdraw-info {
            font-size: 14px;
            color: #64748b;
            padding: 12px 0;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .payment-method li::before {
            content: "â€¢";
            color: #3b5de7;
            font-weight: bold;
            margin-right: 0.5rem;
        }
        
        .qr-upload {
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: border-color 0.2s;
        }
        
        .qr-upload:hover {
            border-color: #3b5de7;
        }
        
        .qr-upload.dragover {
            border-color: #3b5de7;
            background-color: rgba(59, 93, 231, 0.05);
        }
        
        .qr-preview {
            max-width: 200px;
            max-height: 200px;
            margin: 1rem auto;
            border-radius: 8px;
        }
        
        /* æç°æ–¹å¼é€‰æ‹©æ ·å¼ */
        .payment-option {
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .payment-option.active {
            border-color: #3b5de7;
            background-color: #eff6ff;
            color: #1d4ed8;
        }
        
        .payment-option:not(.active):hover {
            border-color: #94a3b8;
            background-color: #f8fafc;
        }
        
        .hidden {
            display: none !important;
        }
        
        /* æç°çŠ¶æ€ä¿¡æ¯ */
        .status-message {
            margin-top: 12px;
            padding: 10px 12px;
            border-radius: 10px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .status-pending {
            background: #eef2ff;
            color: #3730a3;
            border: 1px solid #c7d2fe;
        }
        .status-processing {
            background: #eff6ff;
            color: #1d4ed8;
            border: 1px solid #bfdbfe;
        }
        .status-success {
            background: #ecfdf5;
            color: #065f46;
            border: 1px solid #a7f3d0;
        }
        .status-failed {
            background: #fef2f2;
            color: #991b1b;
            border: 1px solid #fecaca;
        }
        
        /* ğŸ‰ æˆåŠŸæ•ˆæœæ ·å¼ */
        .success-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            animation: fadeIn 0.3s ease-in;
        }
        
        .success-modal {
            background: white;
            border-radius: 16px;
            padding: 32px 24px;
            text-align: center;
            max-width: 320px;
            width: 90%;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            animation: scaleIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        
        .success-icon {
            width: 80px;
            height: 80px;
            margin: 0 auto 20px;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: bounceIn 0.6s ease-out 0.2s both;
        }
        
        .success-icon i {
            font-size: 36px;
            color: white;
        }
        
        .success-title {
            font-size: 20px;
            font-weight: 600;
            color: #111827;
            margin-bottom: 12px;
        }
        
        .success-message {
            font-size: 14px;
            color: #6b7280;
            margin-bottom: 24px;
            line-height: 1.5;
        }
        
        .success-button {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            padding: 12px 32px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .success-button:hover {
            transform: translateY(-1px);
        }
        
        .success-badge {
            display: inline-flex;
            align-items: center;
            background: #dcfce7;
            color: #16a34a;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            margin-left: 8px;
            animation: slideInRight 0.5s ease-out;
        }
        
        .success-badge i {
            margin-right: 4px;
            font-size: 10px;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes scaleIn {
            from { 
                opacity: 0;
                transform: scale(0.8);
            }
            to { 
                opacity: 1;
                transform: scale(1);
            }
        }
        
        @keyframes bounceIn {
            0% {
                opacity: 0;
                transform: scale(0.3);
            }
            50% {
                opacity: 1;
                transform: scale(1.1);
            }
            100% {
                opacity: 1;
                transform: scale(1);
            }
        }
        
        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        /* å¾®ä¿¡æ”¶æ¬¾ç ä¸Šä¼ è¿›åº¦ä¸çŠ¶æ€ */
        .upload-status {
            margin-top: 10px;
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 10px;
            padding: 10px 12px;
        }
        .upload-status .progress {
            width: 100%;
            background: #eef2ff;
            border-radius: 8px;
            overflow: hidden;
            height: 10px;
        }
        .upload-status .progress-bar {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, #60a5fa, #3b82f6);
            transition: width 0.2s ease;
        }
        .upload-status .progress-text {
            margin-top: 8px;
            font-size: 12px;
            color: #374151;
        }

        /* ğŸ“± æ‰‹æœºç«¯ä¸“ç”¨Toastæ ·å¼ - ç›´æ¥åº•éƒ¨æ˜¾ç¤º */
        .toast-container {
            position: fixed;
            bottom: 120px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 350px;
            z-index: 99999;
        }

        .toast-message {
            padding: 16px 20px;
            border-radius: 12px;
            color: white;
            font-weight: 500;
            font-size: 16px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.4);
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.3s ease;
            display: none;
            width: 100%;
            text-align: center;
            margin: 0;
            min-width: auto;
        }

        .toast-message.show {
            display: block;
            opacity: 1;
            transform: translateY(0);
        }
    </style>
    <style>
    /* å¼ºåˆ¶éšè—æµè§ˆå™¨è®¾å¤‡æ¨¡å¼çš„è§¦æ‘¸ç‚¹å åŠ ï¼ˆé¿å…è¯¯è®¤ä¸ºåœ¨è½¬åœˆï¼‰ */
    body .devtools-touch, body .devtools-touch-point, body ._devtools-touch-point_ {
        display: none !important;
        opacity: 0 !important;
    }
/* æ°¸ä¹…å…³é—­é¡µé¢å†…åŠ è½½é®ç½©çš„å¯è§æ€§ä¸ç‚¹å‡»æ‹¦æˆª */
#loadingIndicator{ display:none !important; pointer-events:none !important; background:transparent !important; }
    </style>
</head>
<body class="page-transition">
    <!-- Toastæ¶ˆæ¯æç¤ºå®¹å™¨ -->
    <div class="toast-container">
        <div class="toast-message" id="toastMessage"></div>
    </div>

    <!-- åŠ è½½æŒ‡ç¤ºå™¨ -->
    <div class="loading-container" id="loadingIndicator" style="display: none;">
        <!-- å½»åº•ç§»é™¤è§†è§‰ä¸Šçš„è½¬åœˆï¼Œä¿ç•™å®¹å™¨ç”¨äºç‚¹å‡»å±è”½ -->
        <div style="display:none"></div>
    </div>

    <!-- é¡¶éƒ¨çŠ¶æ€æ  -->
    <div class="top-bar text-white p-4">
        <div class="flex items-center justify-between">
            <div class="flex items-center">
                <button onclick="history.back()" class="nav-button mr-3">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <div class="flex items-center">
                    <span class="text-lg font-medium">ç”³è¯·æç°</span>
                </div>
            </div>
            <button class="nav-button">
                <i class="fas fa-ellipsis-h"></i>
            </button>
        </div>
    </div>
    
    <!-- ä¸»ä½“å†…å®¹ -->
    <div class="mt-4">
        <!-- æç°æ–¹å¼é€‰æ‹© -->
        <div class="form-section">
            <h3 class="text-gray-800 font-medium mb-4">æç°æ–¹å¼</h3>
            <div class="flex space-x-3 mb-4">
                <button id="alipay-option" class="payment-option active flex-1 py-3 px-4 rounded-lg border-2 border-blue-500 bg-blue-50 text-blue-700 font-medium">
                    <i class="fab fa-alipay mr-2"></i>æ”¯ä»˜å®
                </button>
                <button id="wechat-option" class="payment-option flex-1 py-3 px-4 rounded-lg border-2 border-gray-200 bg-white text-gray-600 font-medium">
                    <i class="fab fa-weixin mr-2"></i>å¾®ä¿¡
                </button>
            </div>
        </div>

        <!-- æ”¯ä»˜å®æç°ä¿¡æ¯ -->
        <div id="alipay-section" class="form-section">
            <div class="section-header">
                <span class="text-gray-800 font-medium flex items-center">
                    æ”¯ä»˜å®æç°ä¿¡æ¯
                    <span id="alipay-status-badge" class="ml-2 px-2 py-1 text-xs rounded-full bg-red-100 text-red-600">
                        âŒ æœªè®¾ç½®
                    </span>
                </span>
                <a href="#" id="change-alipay-btn" class="text-blue-500 text-sm flex items-center">
                    ä¿®æ”¹ <i class="fas fa-chevron-right ml-1 text-xs"></i>
                </a>
            </div>
            
            <div class="flex justify-between items-center">
                <div>
                    <p class="text-sm text-gray-500">æ”¯ä»˜å®è´¦å·</p>
                    <p id="alipay-account" class="text-base text-gray-800 font-medium mt-1">è¯·å…ˆè®¾ç½®</p>
                </div>
                <div>
                    <p class="text-sm text-gray-500">çœŸå®å§“å</p>
                    <p id="user-real-name" class="text-base text-gray-800 font-medium mt-1">è¯·å…ˆè®¾ç½®</p>
                </div>
            </div>
            
            <!-- è®¾ç½®æç¤º -->
            <div id="alipay-setup-hint" class="mt-3 p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
                <div class="flex items-center">
                    <i class="fas fa-exclamation-triangle text-yellow-500 mr-2"></i>
                    <span class="text-sm text-yellow-700">
                        è¯·å…ˆç‚¹å‡»"ä¿®æ”¹"è®¾ç½®æ”¯ä»˜å®è´¦å·å’ŒçœŸå®å§“åï¼Œè®¾ç½®å®Œæˆåå³å¯æç°
                    </span>
                </div>
            </div>
        </div>

        <!-- å¾®ä¿¡æç°ä¿¡æ¯ -->
        <div id="wechat-section" class="form-section hidden">
            <div class="section-header">
                <span class="text-gray-800 font-medium">å¾®ä¿¡æç°ä¿¡æ¯</span>
                <a href="#" id="change-wechat-btn" class="text-blue-500 text-sm flex items-center">
                    ä¿®æ”¹ <i class="fas fa-chevron-right ml-1 text-xs"></i>
                </a>
            </div>
            
            <div class="text-center">
                <p class="text-sm text-gray-500 mb-3">æ”¶æ¬¾ç </p>
                <div id="qr-code-display" class="mb-3">
                    <p class="text-gray-400">è¯·å…ˆä¸Šä¼ æ”¶æ¬¾ç </p>
                </div>
                <!-- ä¸Šä¼ çŠ¶æ€æ ï¼ˆå†…é¡µå±•ç¤ºï¼‰ -->
                <div id="wechat-upload-status" class="upload-status hidden" aria-live="polite">
                    <div class="progress"><div class="progress-bar" id="wechat-upload-bar"></div></div>
                    <div class="progress-text" id="wechat-upload-text">å¾…ä¸Šä¼ </div>
                </div>
            </div>
        </div>
        
        <!-- æç°é‡‘é¢ -->
        <div class="form-section">
            <h3 class="text-gray-800 font-medium mb-4">æç°é‡‘é¢</h3>
            <div class="flex items-center mb-4">
                <span class="text-2xl font-bold mr-2">Â¥</span>
                <input type="number" id="withdraw-amount" class="form-input text-xl" placeholder="è¾“å…¥æç°é‡‘é¢" step="0.01" min="10">
            </div>
            
            <div class="withdraw-info flex justify-between items-center">
                <span>å½“å‰å¯æç°é‡‘é¢<span id="withdrawable-amount" class="font-medium text-gray-800">0.00</span>å…ƒ</span>
                <a href="#" id="withdraw-all-btn" class="text-blue-500">å…¨éƒ¨æç°</a>
            </div>
            
            <!-- æç°è¯´æ˜ -->
            <ul class="info-list mt-4">
                <li>è¯·è®¤çœŸå¡«å†™ç›¸å…³è´¦å·ä¿¡æ¯ï¼Œä»¥å…æ‰“æ¬¾å¤±è´¥ï¼›</li>
                <li>æ¯æ¬¡æç°é‡‘é¢ä¸èƒ½ä½äº10å…ƒï¼›</li>
                <li>åŒæ—¶åªèƒ½æœ‰ä¸€ç¬”æç°ï¼Œéœ€æ‰“æ¬¾ä¹‹åæ‰èƒ½æç°ï¼›</li>
                <li>æç°ä¼šåœ¨3ä¸ªå·¥ä½œæ—¥å†…å®Œæˆæ‰“æ¬¾ï¼ŒèŠ‚å‡æ—¥é¡ºå»¶ã€‚</li>
            </ul>
            
            <!-- æç°çŠ¶æ€æ˜¾ç¤ºåŒºåŸŸ -->
            <div id="withdraw-status" class="status-message hidden status-pending">
                <i id="withdraw-status-icon" class="fas fa-info-circle"></i>
                <span id="withdraw-status-text">å¾…å¤„ç†</span>
            </div>
            
            <button id="submit-withdrawal-btn" class="submit-btn" data-disabled="true">æç°</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // åˆå§‹åŒ– Supabase å®¢æˆ·ç«¯
        console.log('å¼€å§‹åˆå§‹åŒ–Supabaseå®¢æˆ·ç«¯...');
        const SUPABASE_URL = 'https://ybrveusbwjusnrzgfnok.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlicnZldXNid2p1c25yemdmbm9rIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY0ODU1NjIsImV4cCI6MjA3MjA2MTU2Mn0.JKPSUli-q9wRuDagE6kwltLk9XgfygE8yznm-Ca82Qk';
        // ä¿å­˜supabaseå¯¹è±¡ä»¥ä¾¿å…¶ä»–è„šæœ¬ä½¿ç”¨
        window.supabaseJs = window.supabase;
        // åˆ›å»ºSupabaseå®¢æˆ·ç«¯
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        // å°†åˆ›å»ºçš„å®¢æˆ·ç«¯æŒ‚è½½åˆ°å…¨å±€
        window.supabase = supabase;
        console.log('Supabaseå®¢æˆ·ç«¯åˆå§‹åŒ–å®Œæˆ');
    </script>
    <script defer src="mobile-optimizer.js"></script>
    <script defer src="mobile-interactions.js"></script>
    <script src="wallet-synchronizer.js"></script>
    <script src="fix-wallet-inconsistency.js"></script>
    <script src="fix-withdrawals-table-missing.js"></script>
    <script src="mobile-withdrawal.js"></script>
    <script src="update-mobile-withdrawal.js"></script>
    <script>
        // å…¨å±€å˜é‡
        let currentUser = null;
        let withdrawableAmount = 0;
        
        // æç°çŠ¶æ€ç®¡ç†å™¨
        const WithdrawalStatus = (() => {
            const states = { pending: 'pending', processing: 'processing', success: 'success', failed: 'failed' };
            const icons = { pending: 'fas fa-info-circle', processing: 'fas fa-spinner fa-spin', success: 'fas fa-check-circle', failed: 'fas fa-times-circle' };
            function setState(state, text) {
                const box = document.getElementById('withdraw-status');
                const label = document.getElementById('withdraw-status-text');
                const icon = document.getElementById('withdraw-status-icon');
                if (!box || !label || !icon) return;
                box.classList.remove('hidden','status-pending','status-processing','status-success','status-failed');
                box.classList.add('status-message', `status-${state}`);
                label.textContent = text ||
                    (state === 'processing' ? 'æç°ä¸­ï¼Œè¯·ç¨å€™...' : state === 'success' ? 'æç°æˆåŠŸï¼Œå·²æäº¤å®¡æ ¸' : state === 'failed' ? 'æç°å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•' : 'å¾…å¤„ç†');
                icon.className = icons[state] || icons.pending;
            }
            return {
                states,
                pending: (msg) => setState(states.pending, msg),
                processing: (msg) => setState(states.processing, msg),
                success: (msg) => setState(states.success, msg),
                failed: (msg) => setState(states.failed, msg)
            };
        })();

        // =====================
        // æ”¯ä»˜æ•°æ®åŒæ­¥ä¸ä¸€è‡´æ€§æ£€æŸ¥
        // =====================
        const PaymentDataSync = (() => {
            let fieldMap = { idField: 'id', alipayField: 'alipay_account', nameField: 'real_name', availableFields: [] };
            const altAlipayField = 'æ”¯ä»˜å®è´¦å·';
            const altNameField = 'çœŸå®å§“å';
            const altIdField = 'ç”¨æˆ·ID';
            
            function isReady() {
                return !!(window.supabase && typeof window.supabase.from === 'function');
            }
            
            async function detectFields() {
                if (!isReady()) return fieldMap;
                try {
                    const { data, error } = await window.supabase.from('users').select('*').limit(1);
                    if (error || !Array.isArray(data)) return fieldMap;
                    const sample = data[0] || {};
                    const keys = Object.keys(sample);
                    fieldMap.availableFields = keys;
                    fieldMap.idField = keys.includes(altIdField) ? altIdField : 'id';
                    fieldMap.alipayField = keys.includes(altAlipayField) ? altAlipayField : 'alipay_account';
                    fieldMap.nameField = keys.includes(altNameField) ? altNameField : 'real_name';
                } catch (_) {
                    // å¿½ç•¥æ£€æµ‹å¼‚å¸¸ï¼Œä¿ç•™é»˜è®¤æ˜ å°„
                }
                return fieldMap;
            }
            
            function validate(account, name) {
                if (!account || !name) return { ok: false, message: 'ä¿¡æ¯ä¸å®Œæ•´' };
                const trimmedAcc = String(account).trim();
                const trimmedName = String(name).trim();
                if (trimmedAcc.length < 3) return { ok: false, message: 'æ”¯ä»˜å®è´¦å·è¿‡çŸ­' };
                if (trimmedName.length < 2) return { ok: false, message: 'çœŸå®å§“åè¿‡çŸ­' };
                return { ok: true };
            }
            
            async function readBack(userId) {
                const map = await detectFields();
                const { data, error } = await window.supabase
                    .from('users')
                    .select('*')
                    .eq(map.idField, userId)
                    .single();
                return { data, error };
            }
            
            async function syncAlipayInfo(user, account, name) {
                if (!isReady()) return { ok: false, error: new Error('supabaseæœªå°±ç»ª') };
                const v = validate(account, name);
                if (!v.ok) return { ok: false, error: new Error(v.message) };
                const map = await detectFields();
                const userId = user.id || user[altIdField];
                if (!userId) return { ok: false, error: new Error('ç”¨æˆ·IDç¼ºå¤±') };
                
                // ä»…æ›´æ–°å·²å­˜åœ¨å­—æ®µï¼›è‹¥ä¸­è‹±å­—æ®µåŒæ—¶å­˜åœ¨ï¼ŒåŒæ—¶å†™å…¥ä¸¤ä»½ä»¥å…¼å®¹åå°è¯»å–
                const updateData = {};
                const keys = map.availableFields || [];
                const hasEnAlipay = keys.includes('alipay_account');
                const hasZhAlipay = keys.includes(altAlipayField);
                const hasEnName = keys.includes('real_name');
                const hasZhName = keys.includes(altNameField);
                if (hasEnAlipay) updateData['alipay_account'] = account;
                if (hasZhAlipay) updateData[altAlipayField] = account;
                if (hasEnName) updateData['real_name'] = name;
                if (hasZhName) updateData[altNameField] = name;
                if (Object.keys(updateData).length === 0) {
                    return { ok: false, error: new Error('æœåŠ¡å™¨ç¼ºå°‘æ‰€éœ€å­—æ®µ') };
                }
                
                const { error: updErr } = await window.supabase
                    .from('users')
                    .update(updateData)
                    .eq(map.idField, userId)
                    .select();
                if (updErr) return { ok: false, error: updErr };
                
                // å›è¯»æ ¡éªŒ
                const { data: row, error: readErr } = await readBack(userId);
                if (readErr) return { ok: false, error: readErr };
                const serverAcc = row['alipay_account'] ?? row[altAlipayField];
                const serverName = row['real_name'] ?? row[altNameField];
                const ok = serverAcc === account && serverName === name;
                return { ok, data: row };
            }
            
            async function ensureConsistency(user) {
                if (!isReady() || !user) return;
                const map = await detectFields();
                const userId = user.id || user[altIdField];
                if (!userId) return;
                try {
                    const { data: row } = await readBack(userId);
                    if (!row) return;
                    const serverAcc = row[map.alipayField] ?? row[altAlipayField];
                    const serverName = row[map.nameField] ?? row[altNameField];
                    const localAcc = user.alipay_account || user[altAlipayField];
                    const localName = user.real_name || user[altNameField];
                    
                    // ä»¥æœåŠ¡ç«¯ä¸ºå‡†è¿›è¡Œå¯¹é½
                    if ((serverAcc && serverAcc !== localAcc) || (serverName && serverName !== localName)) {
                        user.alipay_account = serverAcc || localAcc || '';
                        user.real_name = serverName || localName || '';
                        user[altAlipayField] = user.alipay_account;
                        user[altNameField] = user.real_name;
                        localStorage.setItem('currentUser', JSON.stringify(user));
                        updateAlipayDisplay(user.alipay_account, user.real_name);
                    }
                } catch (_) { /* å¿½ç•¥ */ }
            }
            
            return { isReady, detectFields, validate, syncAlipayInfo, ensureConsistency };
        })();

        // =====================
        // æç°è®°å½•å›å¡«ï¼ˆä¿è¯åå°å¯è§ï¼‰
        // =====================
        const WithdrawalBackfill = (() => {
            let availableFields = [];
            async function detectFields() {
                try {
                    const { data, error } = await window.supabase
                        .from('withdrawals')
                        .select('*')
                        .limit(1);
                    if (!error && Array.isArray(data)) {
                        availableFields = Object.keys(data[0] || {});
                    }
                } catch (_) {}
                return availableFields;
            }
            function buildUpdate(account, name, paymentMethod) {
                const fields = {};
                if (availableFields.includes('alipay_account')) fields['alipay_account'] = account;
                if (availableFields.includes('real_name')) fields['real_name'] = name;
                if (availableFields.includes('payment_method')) fields['payment_method'] = paymentMethod || 'alipay';
                return fields;
            }
            async function backfillPendingForUser(userId, account, name) {
                if (!window.supabase || !userId) return;
                await detectFields();
                const updateData = buildUpdate(account, name, 'alipay');
                if (Object.keys(updateData).length === 0) return; // æ— å¯ç”¨å­—æ®µæ—¶è·³è¿‡
                try {
                    await window.supabase
                        .from('withdrawals')
                        .update(updateData)
                        .eq('user_id', userId)
                        .eq('status', 'pending');
                    console.log('âœ… å·²å›å¡«æç°è®°å½•æ”¯ä»˜å­—æ®µ');
                } catch (e) {
                    console.warn('å›å¡«æç°è®°å½•å¤±è´¥:', e?.message || e);
                }
            }
            return { backfillPendingForUser };
        })();

        // =====================
        // æç°æ–¹å¼åŒæ­¥ä¸ä¸€è‡´æ€§æ£€æŸ¥
        // =====================
        const WithdrawalMethodSync = (() => {
            let detected = null;
            async function detectWithdrawalsFields() {
                if (detected) return detected;
                try {
                    const { data, error } = await window.supabase
                        .from('withdrawals')
                        .select('*')
                        .limit(1);
                    const sample = (!error && Array.isArray(data) && data[0]) ? data[0] : {};
                    const keys = Object.keys(sample);
                    detected = {
                        hasPaymentMethod: keys.includes('payment_method') || keys.includes('method') || keys.includes('æç°æ–¹å¼'),
                        methodField: keys.includes('payment_method') ? 'payment_method' : (keys.includes('method') ? 'method' : (keys.includes('æç°æ–¹å¼') ? 'æç°æ–¹å¼' : null)),
                        hasAlipayAccount: keys.includes('alipay_account'),
                        hasRealName: keys.includes('real_name'),
                        hasWechatQR: keys.includes('wechat_qr_code') || keys.includes('qr_code_url'),
                        keys
                    };
                } catch (e) {
                    detected = { hasPaymentMethod: true, methodField: 'payment_method', hasAlipayAccount: true, hasRealName: true, hasWechatQR: true, keys: [] };
                }
                // ç»“æœç¼“å­˜ï¼Œé¿å…é‡å¤æŸ¥è¯¢
                try { localStorage.setItem('withdrawals_fields_cache', JSON.stringify(detected)); } catch (_) {}
                return detected;
            }
            function getSelectedMethod() {
                const isWechatSelected = document.getElementById('wechat-option')?.classList.contains('active');
                return isWechatSelected ? 'wechat' : 'alipay';
            }
            function validateForMethod(method, user) {
                if (method === 'wechat') {
                    const wechatQR = user.wechat_qr_code || user['å¾®ä¿¡æ”¶æ¬¾ç '];
                    if (!wechatQR) return { ok: false, message: 'è¯·å…ˆä¸Šä¼ å¾®ä¿¡æ”¶æ¬¾ç ' };
                } else {
                    const alipayAcc = user.alipay_account || user['æ”¯ä»˜å®è´¦å·'];
                    const realName = user.real_name || user['çœŸå®å§“å'];
                    if (!alipayAcc || !realName) return { ok: false, message: 'è¯·å…ˆè®¾ç½®æ”¯ä»˜å®è´¦å·å’ŒçœŸå®å§“å' };
                }
                return { ok: true };
            }
            async function buildInsertPayload(base) {
                const fields = await detectWithdrawalsFields();
                const method = getSelectedMethod();
                const payload = { ...base };
                if (fields.methodField) payload[fields.methodField] = method;
                // å°½å¯èƒ½å¸¦ä¸Šæ”¯ä»˜ä¿¡æ¯ï¼Œè®©åå°ç«‹åˆ»å¯è§
                const alipayAcc = currentUser.alipay_account || currentUser['æ”¯ä»˜å®è´¦å·'] || '';
                const realName = currentUser.real_name || currentUser['çœŸå®å§“å'] || '';
                const wechatQR = currentUser.wechat_qr_code || currentUser['å¾®ä¿¡æ”¶æ¬¾ç '] || '';
                if (fields.hasAlipayAccount) payload['alipay_account'] = alipayAcc;
                if (fields.hasRealName) payload['real_name'] = realName;
                if (fields.hasWechatQR) payload['wechat_qr_code'] = wechatQR;
                return payload;
            }
            async function ensureRecordHasMethod(withdrawalId) {
                const fields = await detectWithdrawalsFields();
                if (!fields.methodField || !withdrawalId) return;
                const method = getSelectedMethod();
                try {
                    const { error } = await window.supabase
                        .from('withdrawals')
                        .update({ [fields.methodField]: method })
                        .eq('id', withdrawalId);
                    if (!error) console.log('âœ… å·²è¡¥å†™æç°æ–¹å¼åˆ°è®°å½•:', withdrawalId, method);
                } catch (e) {
                    console.warn('å›å¡«æç°æ–¹å¼å¤±è´¥:', e?.message || e);
                }
            }
            function rememberSelection() {
                try { localStorage.setItem('selected_payment_method', getSelectedMethod()); } catch (_) {}
            }
            return { detectWithdrawalsFields, getSelectedMethod, validateForMethod, buildInsertPayload, ensureRecordHasMethod, rememberSelection };
        })();
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('æç°é¡µé¢åŠ è½½å®Œæˆï¼Œåˆå§‹åŒ–...');
            // åˆå§‹çŠ¶æ€
            WithdrawalStatus.pending('å¾…å¤„ç†');
            try { hideLoading(); } catch(_) {}
            
            // ğŸš¨ é¡µé¢åŠ è½½æ—¶ç«‹å³å¼ºåˆ¶è®¾ç½®Toastä½ç½®
            const toastContainer = document.querySelector('.toast-container');
            if (toastContainer) {
                console.log('ğŸ”§ é¡µé¢åŠ è½½æ—¶å¼ºåˆ¶è®¾ç½®Toaståˆ°åº•éƒ¨ä½ç½®');
                toastContainer.style.position = 'fixed';
                toastContainer.style.top = 'auto';
                toastContainer.style.bottom = '120px';
                toastContainer.style.left = '50%';
                toastContainer.style.transform = 'translateX(-50%)';
                toastContainer.style.width = '90%';
                toastContainer.style.maxWidth = '350px';
                toastContainer.style.zIndex = '99999';
                
                // ç”Ÿäº§ç¯å¢ƒä¸æ·»åŠ ä»»ä½•è¾¹æ¡†æ ‡è¯†
                
                // 3ç§’åç§»é™¤çº¢è‰²è¾¹æ¡†
                setTimeout(() => {
                    toastContainer.style.border = '';
                    console.log('ğŸ”„ çº¢è‰²è¾¹æ¡†å·²ç§»é™¤');
                }, 3000);
            } else {
                console.error('âŒ æ‰¾ä¸åˆ°toast-containerå…ƒç´ ');
            }
            
            // æ£€æŸ¥ç”¨æˆ·ç™»å½•çŠ¶æ€
            await checkUserLogin();
            try { hideLoading(); } catch(_) {}
            
            // åŠ è½½ç”¨æˆ·è´¦æˆ·ä¿¡æ¯
            loadAccountInfo();
            
            // ç»‘å®šè¡¨å•äº‹ä»¶
            bindFormEvents();
            
            // ç»‘å®šæç°æ–¹å¼åˆ‡æ¢äº‹ä»¶
            bindPaymentMethodEvents();
            
            // ğŸ¯ é¡µé¢åŠ è½½å®Œæˆåå¼ºåˆ¶åŒæ­¥é‡‘é¢æ˜¾ç¤º
            setTimeout(() => {
                console.log('ğŸ”§ é¡µé¢åŠ è½½å®Œæˆï¼Œå¼ºåˆ¶åŒæ­¥é‡‘é¢æ˜¾ç¤º');
                const amountInput = document.getElementById('withdraw-amount');
                const amountDisplay = document.getElementById('withdrawable-amount');
                
                if (amountInput && amountDisplay && withdrawableAmount > 0) {
                    // å¦‚æœè¾“å…¥æ¡†ä¸ºç©ºæˆ–æ˜¾ç¤º0.00ï¼Œåˆ™è®¾ç½®ä¸ºå¯æç°é‡‘é¢
                    const currentValue = parseFloat(amountInput.value) || 0;
                    if (currentValue === 0) {
                        amountInput.value = withdrawableAmount.toFixed(2);
                        console.log('âœ… é¡µé¢åŠ è½½å®Œæˆåå·²åŒæ­¥è¾“å…¥æ¡†é‡‘é¢:', withdrawableAmount.toFixed(2));
                    }
                }
            }, 1000);
        });
        
        // æ£€æŸ¥ç”¨æˆ·ç™»å½•çŠ¶æ€
        async function checkUserLogin() {
            const userDataStr = localStorage.getItem('currentUser');
            
            if (!userDataStr) {
                // ç”¨æˆ·æœªç™»å½•ï¼Œé‡å®šå‘åˆ°ç™»å½•é¡µé¢
                window.location.href = 'login.html';
                return;
            }
            
            // è§£æç”¨æˆ·æ•°æ®
            currentUser = JSON.parse(userDataStr);
            console.log('å½“å‰ç™»å½•ç”¨æˆ·:', currentUser);
            // å¯åŠ¨ä¸€æ¬¡ä¸æœåŠ¡ç«¯çš„æ•°æ®å¯¹é½ï¼Œé¿å…æ˜¾ç¤ºè¿‡æœŸä¿¡æ¯
            PaymentDataSync.ensureConsistency(currentUser);
            
            // è·å–å¯æç°é‡‘é¢
            await loadWithdrawableAmount();
        }
        
        // åŠ è½½ç”¨æˆ·è´¦æˆ·ä¿¡æ¯
        function loadAccountInfo() {
            console.log('ğŸ“‹ åŠ è½½ç”¨æˆ·è´¦æˆ·ä¿¡æ¯...');
            
            // æ–°æ³¨å†Œç”¨æˆ·é»˜è®¤æ²¡æœ‰è®¾ç½®æ”¯ä»˜å®å’Œå¾®ä¿¡ä¿¡æ¯
            const alipayAccount = currentUser.alipay_account || currentUser.æ”¯ä»˜å®è´¦å· || '';
            const realName = currentUser.real_name || currentUser.çœŸå®å§“å || '';
            const wechatQRCode = currentUser.wechat_qr_code || currentUser.å¾®ä¿¡æ”¶æ¬¾ç  || '';
            
            console.log('ğŸ’³ æ”¯ä»˜å®ä¿¡æ¯çŠ¶æ€:', {
                account: alipayAccount ? 'å·²è®¾ç½®' : 'æœªè®¾ç½®',
                name: realName ? 'å·²è®¾ç½®' : 'æœªè®¾ç½®',
                complete: !!(alipayAccount && realName)
            });
            
            // æ›´æ–°æ”¯ä»˜å®ä¿¡æ¯æ˜¾ç¤ºå’ŒçŠ¶æ€
            const statusBadge = document.getElementById('alipay-status-badge');
            const setupHint = document.getElementById('alipay-setup-hint');
            
            if (alipayAccount && realName) {
                // âœ… æ”¯ä»˜å®ä¿¡æ¯å®Œæ•´
                document.getElementById('alipay-account').textContent = alipayAccount;
                document.getElementById('user-real-name').textContent = realName;
                
                // æ›´æ–°çŠ¶æ€å¾½ç« ä¸ºç»¿è‰²
                if (statusBadge) {
                    statusBadge.className = 'ml-2 px-2 py-1 text-xs rounded-full bg-green-100 text-green-600';
                    statusBadge.textContent = 'âœ… å·²è®¾ç½®';
                }
                
                // éšè—è®¾ç½®æç¤º
                if (setupHint) {
                    setupHint.style.display = 'none';
                }
                
                console.log('âœ… æ”¯ä»˜å®ä¿¡æ¯å®Œæ•´ï¼Œå·²æ›´æ–°æ˜¾ç¤ºå’ŒçŠ¶æ€');
            } else {
                // âŒ æ”¯ä»˜å®ä¿¡æ¯ä¸å®Œæ•´
                document.getElementById('alipay-account').textContent = 'è¯·å…ˆè®¾ç½®';
                document.getElementById('user-real-name').textContent = 'è¯·å…ˆè®¾ç½®';
                
                // æ›´æ–°çŠ¶æ€å¾½ç« ä¸ºçº¢è‰²
                if (statusBadge) {
                    statusBadge.className = 'ml-2 px-2 py-1 text-xs rounded-full bg-red-100 text-red-600';
                    statusBadge.textContent = 'âŒ æœªè®¾ç½®';
                }
                
                // æ˜¾ç¤ºè®¾ç½®æç¤º
                if (setupHint) {
                    setupHint.style.display = 'block';
                }
                
                // å¦‚æœé»˜è®¤é€‰æ‹©æ”¯ä»˜å®ä½†æ²¡æœ‰è®¾ç½®ä¿¡æ¯ï¼Œç¦ç”¨æç°æŒ‰é’®å¹¶æç¤º
                if (document.getElementById('alipay-option').classList.contains('active')) {
                    const submitBtn = document.getElementById('submit-withdrawal-btn');
                    submitBtn.setAttribute('data-disabled', 'true');
                    console.log('âš ï¸ æ”¯ä»˜å®ä¿¡æ¯æœªè®¾ç½®ï¼Œç¦ç”¨æç°æŒ‰é’®');
                    
                    // 3ç§’åæ˜¾ç¤ºè®¾ç½®æç¤º
                    setTimeout(() => {
                        showToast('ğŸ’¡ è¯·å…ˆç‚¹å‡»"ä¿®æ”¹"è®¾ç½®æ”¯ä»˜å®ä¿¡æ¯æ‰èƒ½æç°', 'warning');
                    }, 2000);
                }
            }
            
            console.log('ğŸ“± å¾®ä¿¡ä¿¡æ¯çŠ¶æ€:', {
                qrCode: wechatQRCode ? 'å·²è®¾ç½®' : 'æœªè®¾ç½®'
            });
            
            // æ›´æ–°å¾®ä¿¡æ”¶æ¬¾ç æ˜¾ç¤º
            if (wechatQRCode) {
                document.getElementById('qr-code-display').innerHTML = `<img src="${wechatQRCode}" alt="å¾®ä¿¡æ”¶æ¬¾ç " class="qr-preview">`;
                console.log('âœ… å¾®ä¿¡æ”¶æ¬¾ç å·²è®¾ç½®');
            } else {
                document.getElementById('qr-code-display').innerHTML = '<p class="text-gray-400">è¯·å…ˆä¸Šä¼ æ”¶æ¬¾ç </p>';
                console.log('âš ï¸ å¾®ä¿¡æ”¶æ¬¾ç æœªè®¾ç½®');
                
                // å¦‚æœé€‰æ‹©å¾®ä¿¡æç°ä½†æ²¡æœ‰ä¸Šä¼ æ”¶æ¬¾ç ï¼Œç¦ç”¨æç°æŒ‰é’®å¹¶æ·»åŠ æç¤º
                if (document.getElementById('wechat-option').classList.contains('active')) {
                    const submitBtn = document.getElementById('submit-withdrawal-btn');
                    submitBtn.setAttribute('data-disabled', 'true');
                    console.log('âš ï¸ å¾®ä¿¡æ”¶æ¬¾ç æœªè®¾ç½®ï¼Œç¦ç”¨æç°æŒ‰é’®');
                }
            }
        }
        
        // åŠ è½½ç”¨æˆ·å¯æç°é‡‘é¢
        async function loadWithdrawableAmount() {
            try {
                console.log('åŠ è½½ç”¨æˆ·å¯æç°é‡‘é¢...');
                showLoading();
                
                // è·å–ç”¨æˆ·ID
                const userId = currentUser.id || currentUser.ç”¨æˆ·ID;
                
                if (!userId) {
                    console.error('æ— æ³•è·å–ç”¨æˆ·ID');
                    hideLoading();
                    return;
                }
                
                // åˆ›å»ºä¸€ä¸ªæœ¬åœ°å¤‡ä»½æ•°æ®å˜é‡ï¼Œä»¥ç¡®ä¿APIé”™è¯¯æ—¶ä»èƒ½æ˜¾ç¤ºæ•°æ®
                let localBackupAmount = 0;
                
                // å°è¯•ä»æœ¬åœ°å­˜å‚¨ä¸­è·å–å¤‡ä»½é‡‘é¢
                try {
                    const backupData = localStorage.getItem('withdrawable_amount_backup');
                    if (backupData) {
                        const parsedData = JSON.parse(backupData);
                        if (parsedData.userId === userId && parsedData.amount) {
                            localBackupAmount = parseFloat(parsedData.amount);
                            console.log('å·²ä»æœ¬åœ°å¤‡ä»½è·å–å¯æç°é‡‘é¢:', localBackupAmount);
                        }
                    }
                } catch (backupError) {
                    console.warn('è¯»å–æœ¬åœ°å¤‡ä»½é‡‘é¢å¤±è´¥:', backupError);
                }
                
                // å®ç°å¤šç§APIè°ƒç”¨æ–¹æ³•ä½œä¸ºå¤‡é€‰æ–¹æ¡ˆ
                
                // æ–¹æ³•1: æ­£ç¡®è®¡ç®—å¯æç°é‡‘é¢ï¼ˆæ€»æ”¶ç›Š - æ€»æç°ï¼‰
                let method1Success = false;
                try {
                    console.log('ğŸ”„ æ–¹æ³•1ï¼šä½¿ç”¨ä¸é’±åŒ…é¡µé¢ä¸€è‡´çš„è®¡ç®—é€»è¾‘...');
                    
                    // è·å–æ‰€æœ‰å·²å®Œæˆçš„æ”¶ç›Šè®°å½•
                    const { data: earnings, error: earningsError } = await window.supabase
                        .from('earnings')
                        .select('*')
                        .eq('user_id', userId)
                        .or('status.eq.å·²å®Œæˆ,status.eq.completed');
                        
                    if (earningsError) {
                        throw new Error('è·å–æ”¶ç›Šè®°å½•å¤±è´¥: ' + earningsError.message);
                    }
                    
                    // è®¡ç®—æ€»æ”¶ç›Š
                    let totalEarnings = 0;
                    earnings?.forEach(earning => {
                        const amount = parseFloat(earning.amount || earning.é‡‘é¢ || 0);
                        totalEarnings += amount;
                    });
                    
                    // è·å–æ‰€æœ‰æç°è®°å½•
                    const { data: withdrawals, error: withdrawalsError } = await window.supabase
                        .from('withdrawals')
                        .select('*')
                        .eq('user_id', userId);
                        
                    if (withdrawalsError) {
                        throw new Error('è·å–æç°è®°å½•å¤±è´¥: ' + withdrawalsError.message);
                    }
                    
                    // è®¡ç®—æ€»æç°
                    let totalWithdrawn = 0;
                    withdrawals?.forEach(withdrawal => {
                        const amount = parseFloat(withdrawal.amount || withdrawal.é‡‘é¢ || 0);
                        totalWithdrawn += amount;
                    });
                    
                    // è®¡ç®—å®é™…å¯æç°ä½™é¢ï¼ˆä¸é’±åŒ…é¡µé¢é€»è¾‘ä¸€è‡´ï¼‰
                    withdrawableAmount = totalEarnings - totalWithdrawn;
                    
                    console.log('ğŸ’° æ”¶ç›Šè®¡ç®—è¯¦æƒ…:', {
                        totalEarnings: totalEarnings,
                        totalWithdrawn: totalWithdrawn,
                        withdrawableAmount: withdrawableAmount,
                        earningsCount: earnings?.length || 0,
                        withdrawalsCount: withdrawals?.length || 0
                    });
                    
                    console.log('âœ… æ–¹æ³•1æˆåŠŸï¼šè®¡ç®—å¯æç°é‡‘é¢:', withdrawableAmount);
                    method1Success = true;
                    
                    // ä¿å­˜åˆ°æœ¬åœ°å¤‡ä»½
                    saveLocalBackup(userId, withdrawableAmount);
                    
                } catch (method1Error) {
                    console.error('âŒ æ–¹æ³•1å¼‚å¸¸ï¼š', method1Error);
                }
                
                // æ–¹æ³•2: ä½¿ç”¨RPCå‡½æ•°
                if (!method1Success) {
                    try {
                        const { data: rpcData, error: rpcError } = await window.supabase
                            .rpc('get_withdrawable_amount', { user_id_param: userId });
                            
                        if (!rpcError && rpcData !== null) {
                            withdrawableAmount = parseFloat(rpcData);
                            console.log('æ–¹æ³•2æˆåŠŸï¼šä»RPCè·å–å¯æç°é‡‘é¢:', withdrawableAmount);
                            
                            // ä¿å­˜åˆ°æœ¬åœ°å¤‡ä»½
                            saveLocalBackup(userId, withdrawableAmount);
                        } else {
                            console.warn('æ–¹æ³•2å¤±è´¥ï¼šRPCè°ƒç”¨å¤±è´¥:', rpcError);
                        }
                    } catch (method2Error) {
                        console.error('æ–¹æ³•2å¼‚å¸¸ï¼š', method2Error);
                    }
                }
                
                // æ–¹æ³•3: ä»ç”¨æˆ·è¡¨ä¸­è·å–
                if (!method1Success) {
                    try {
                        const { data: userData, error: userError } = await window.supabase
                            .from('users')
                            .select('*')
                            .eq(userId.includes('-') ? 'id' : 'ç”¨æˆ·ID', userId)
                            .single();
                            
                        if (!userError && userData) {
                            const walletField = getWalletField(userData);
                            withdrawableAmount = parseFloat(userData[walletField] || 0);
                            console.log('æ–¹æ³•3æˆåŠŸï¼šä»ç”¨æˆ·è¡¨è·å–å¯æç°é‡‘é¢:', withdrawableAmount);
                            
                            // ä¿å­˜åˆ°æœ¬åœ°å¤‡ä»½
                            saveLocalBackup(userId, withdrawableAmount);
                        } else {
                            console.warn('æ–¹æ³•3å¤±è´¥ï¼šè·å–ç”¨æˆ·æ•°æ®å¤±è´¥:', userError);
                        }
                    } catch (method3Error) {
                        console.error('æ–¹æ³•3å¼‚å¸¸ï¼š', method3Error);
                    }
                }
                
                // å¦‚æœæ‰€æœ‰æ–¹æ³•éƒ½å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°å¤‡ä»½
                if (!method1Success && isNaN(withdrawableAmount) || withdrawableAmount === 0) {
                    console.log('æ‰€æœ‰APIæ–¹æ³•éƒ½å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°å¤‡ä»½é‡‘é¢:', localBackupAmount);
                    withdrawableAmount = localBackupAmount;
                    
                    // å¦‚æœæœ¬åœ°å¤‡ä»½ä¹Ÿæ²¡æœ‰ï¼Œåˆ™ä½¿ç”¨ç”¨æˆ·æ•°æ®ä¸­çš„é’±åŒ…ä½™é¢
                    if (withdrawableAmount === 0) {
                        const walletField = getWalletField(currentUser);
                        withdrawableAmount = parseFloat(currentUser[walletField] || 0);
                        console.log('ä½¿ç”¨ç”¨æˆ·æ•°æ®ä¸­çš„é’±åŒ…ä½™é¢ä½œä¸ºå¯æç°é‡‘é¢:', withdrawableAmount);
                    }
                }
                
                console.log('æœ€ç»ˆè®¡ç®—çš„å¯æç°é‡‘é¢:', withdrawableAmount);
                
                // ğŸ’¾ ç¡®ä¿æ•°æ®åŒæ­¥åˆ°localStorageï¼ˆç§»é™¤ç¡¬ç¼–ç æ¢å¤é€»è¾‘ï¼‰
                if (withdrawableAmount >= 0) {
                    // æ›´æ–°ç”¨æˆ·æ•°æ®ä¸­çš„é’±åŒ…ä½™é¢
                    if (currentUser) {
                        const walletField = getWalletField(currentUser);
                        currentUser[walletField] = withdrawableAmount;
                        // åŒæ—¶æ›´æ–°å„ç§å¯èƒ½çš„å­—æ®µå
                        currentUser.wallet_balance = withdrawableAmount;
                        currentUser.é’±åŒ…ä½™é¢ = withdrawableAmount;
                        localStorage.setItem('currentUser', JSON.stringify(currentUser));
                        console.log('âœ… ç”¨æˆ·æ•°æ®å·²åŒæ­¥åˆ°localStorage');
                    }
                    
                    // ä¿å­˜å¤‡ä»½æ•°æ®
                    const userId = currentUser ? (currentUser.id || currentUser.ç”¨æˆ·ID) : 'user_' + Date.now();
                    saveLocalBackup(userId, withdrawableAmount);
                } else {
                    console.warn('âš ï¸ è®¡ç®—å‡ºçš„å¯æç°é‡‘é¢ä¸ºè´Ÿæ•°:', withdrawableAmount);
                    withdrawableAmount = 0; // ç¡®ä¿ä¸æ˜¾ç¤ºè´Ÿæ•°
                }
                
                // æ›´æ–°æ˜¾ç¤º
                updateAmountDisplay();
                
                hideLoading();
            } catch (error) {
                console.error('åŠ è½½å¯æç°é‡‘é¢æ—¶å‡ºé”™:', error);
                hideLoading();
                
                // ä½¿ç”¨é»˜è®¤å€¼æˆ–æœ¬åœ°å­˜å‚¨çš„å¤‡ä»½å€¼
                try {
                    const backupData = localStorage.getItem('withdrawable_amount_backup');
                    if (backupData) {
                        const parsedData = JSON.parse(backupData);
                        if (parsedData.userId === (currentUser.id || currentUser.ç”¨æˆ·ID)) {
                            withdrawableAmount = parseFloat(parsedData.amount);
                            console.log('ä½¿ç”¨æœ¬åœ°å¤‡ä»½çš„å¯æç°é‡‘é¢:', withdrawableAmount);
                        }
                    }
                } catch (backupError) {
                    console.warn('è¯»å–æœ¬åœ°å¤‡ä»½é‡‘é¢å¤±è´¥:', backupError);
                    withdrawableAmount = 0;
                }
                
                // ğŸ’¡ å¦‚æœä½™é¢ä¸º0ï¼Œæ˜¾ç¤ºæç¤ºä¿¡æ¯ä½†ä¸å¼ºåˆ¶ä¿®æ”¹
                if (withdrawableAmount === 0) {
                    console.log('â„¹ï¸ å½“å‰å¯æç°ä½™é¢ä¸º0ï¼Œå¯èƒ½çš„åŸå› ï¼š');
                    console.log('   - æ²¡æœ‰å·²å®Œæˆçš„æ”¶ç›Šè®°å½•');
                    console.log('   - æ‰€æœ‰æ”¶ç›Šéƒ½å·²æç°');
                    console.log('   - æ•°æ®åº“è¿æ¥é—®é¢˜');
                    
                    // å°è¯•ä»localStorageè·å–é’±åŒ…é¡µé¢çš„ä½™é¢è¿›è¡Œå¯¹æ¯”
                    const walletBalance = localStorage.getItem('wallet_balance');
                    if (walletBalance && parseFloat(walletBalance) > 0) {
                        console.log('ğŸ’¡ é’±åŒ…é¡µé¢æ˜¾ç¤ºä½™é¢:', walletBalance, 'ä½†æç°é¡µé¢è®¡ç®—ä¸º0ï¼Œå»ºè®®æ£€æŸ¥æ•°æ®ä¸€è‡´æ€§');
                    }
                }
                
                updateAmountDisplay();
            }
        }
        
        // ä¿å­˜æœ¬åœ°å¤‡ä»½
        function saveLocalBackup(userId, amount) {
            try {
                const backupData = {
                    userId: userId,
                    amount: amount,
                    timestamp: new Date().getTime()
                };
                
                localStorage.setItem('withdrawable_amount_backup', JSON.stringify(backupData));
                console.log('å¯æç°é‡‘é¢å·²ä¿å­˜åˆ°æœ¬åœ°å¤‡ä»½');
            } catch (error) {
                console.error('ä¿å­˜æœ¬åœ°å¤‡ä»½å¤±è´¥:', error);
            }
        }
        
        // æ›´æ–°é‡‘é¢æ˜¾ç¤º - åŒæ­¥æ›´æ–°è¾“å…¥æ¡†å’Œæ˜¾ç¤ºé‡‘é¢
        function updateAmountDisplay() {
            const amountDisplay = document.getElementById('withdrawable-amount');
            const amountInput = document.getElementById('withdraw-amount');
            
            if (amountDisplay) {
                amountDisplay.textContent = withdrawableAmount.toFixed(2);
            }
            
            // ğŸ¯ åŒæ­¥æ›´æ–°è¾“å…¥æ¡†ï¼Œè®©ä¸¤è¾¹é‡‘é¢ä¸€è‡´
            if (amountInput && withdrawableAmount > 0) {
                // å¦‚æœè¾“å…¥æ¡†ä¸ºç©ºæˆ–è€…ä¸º0ï¼Œåˆ™è®¾ç½®ä¸ºå¯æç°é‡‘é¢
                const currentValue = parseFloat(amountInput.value) || 0;
                if (currentValue === 0) {
                    amountInput.value = withdrawableAmount.toFixed(2);
                    console.log('âœ… å·²åŒæ­¥è¾“å…¥æ¡†é‡‘é¢ä¸º:', withdrawableAmount.toFixed(2));
                }
            }
        }
        
        // è·å–é’±åŒ…å­—æ®µå
        function getWalletField(userData) {
            const possibleFields = ['wallet_balance', 'é’±åŒ…ä½™é¢', 'balance', 'ä½™é¢', 'wallet'];
            
            for (const field of possibleFields) {
                if (field in userData && userData[field] !== null) {
                    return field;
                }
            }
            
            return 'wallet_balance'; // é»˜è®¤å­—æ®µå
        }
        
        // ç»‘å®šè¡¨å•äº‹ä»¶
        function bindFormEvents() {
            const amountInput = document.getElementById('withdraw-amount');
            const withdrawAllBtn = document.getElementById('withdraw-all-btn');
            const submitBtn = document.getElementById('submit-withdrawal-btn');
            const changeAlipayBtn = document.getElementById('change-alipay-btn');
            const changeWechatBtn = document.getElementById('change-wechat-btn');
            const alipaySection = document.getElementById('alipay-section');
            const wechatSection = document.getElementById('wechat-section');
            
            // ğŸ¯ æŒ‰ç”¨æˆ·è¦æ±‚ï¼šåªåœ¨ç‚¹å‡»æ—¶æ˜¾ç¤ºè­¦å‘Šï¼Œè¾“å…¥æ—¶åªæ§åˆ¶æŒ‰é’®çŠ¶æ€
            // é‡‘é¢è¾“å…¥äº‹ä»¶ - ä»…æ§åˆ¶æŒ‰é’®çŠ¶æ€ï¼Œä¸æ˜¾ç¤ºè­¦å‘Š
            amountInput.addEventListener('input', function() {
                const value = parseFloat(this.value);
                console.log('ç”¨æˆ·è¾“å…¥é‡‘é¢:', value);
                
                // æ ¡éªŒè¾“å…¥é‡‘é¢ - åªæ§åˆ¶æŒ‰é’®çŠ¶æ€ï¼Œä¸æ˜¾ç¤ºè­¦å‘Šæç¤º
                if (!isNaN(value) && value > 0) {
                    if (value < 10) {
                        // å°äº10å…ƒæ—¶ç¦ç”¨æŒ‰é’®ï¼Œä½†ä¸æ˜¾ç¤ºè­¦å‘Š
                        submitBtn.setAttribute('data-disabled', 'true');
                        console.log('âŒ é‡‘é¢å°äº10å…ƒï¼Œç¦ç”¨æŒ‰é’®ï¼ˆä¸æ˜¾ç¤ºè­¦å‘Šï¼‰');
                    } else if (value > withdrawableAmount) {
                        // å¤§äºå¯æç°é‡‘é¢æ—¶ç¦ç”¨æŒ‰é’®ï¼Œä½†ä¸æ˜¾ç¤ºè­¦å‘Š
                        submitBtn.setAttribute('data-disabled', 'true');
                        console.log('âŒ é‡‘é¢è¶…è¿‡ä½™é¢ï¼Œç¦ç”¨æŒ‰é’®ï¼ˆä¸æ˜¾ç¤ºè­¦å‘Šï¼‰');
                    } else {
                        // é‡‘é¢æœ‰æ•ˆï¼Œå¯ç”¨æŒ‰é’®
                        submitBtn.removeAttribute('data-disabled');
                        console.log('âœ… é‡‘é¢æœ‰æ•ˆï¼Œå¯ç”¨æç°æŒ‰é’®');
                    }
                } else {
                    submitBtn.setAttribute('data-disabled', 'true');
                    console.log('âš ï¸ æ— æ•ˆé‡‘é¢ï¼Œç¦ç”¨æŒ‰é’®');
                }
            });
            
            // å…¨éƒ¨æç°ç‚¹å‡»äº‹ä»¶
            withdrawAllBtn.addEventListener('click', function(e) {
                e.preventDefault();
                
                if (withdrawableAmount > 0) {
                    amountInput.value = withdrawableAmount.toFixed(2);
                    submitBtn.removeAttribute('data-disabled');
                } else {
                    amountInput.value = '0.00';
                    submitBtn.setAttribute('data-disabled', 'true');
                }
            });
            
            // ä¿®æ”¹æ”¯ä»˜å®ä¿¡æ¯ç‚¹å‡»äº‹ä»¶
            changeAlipayBtn.addEventListener('click', function(e) {
                e.preventDefault();
                showAlipaySettingsModal();
            });
            
            // ä¿®æ”¹å¾®ä¿¡ä¿¡æ¯ç‚¹å‡»äº‹ä»¶
            changeWechatBtn.addEventListener('click', function(e) {
                e.preventDefault();
                showWechatSettingsModal();
            });
            
            // ğŸš¨ ç´§æ€¥ä¿®å¤ï¼šç®€åŒ–æäº¤æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            submitBtn.addEventListener('click', async function() {
                console.log('ç”¨æˆ·ç‚¹å‡»äº†æç°æŒ‰é’®');
                
                // æ£€æŸ¥æŒ‰é’®æ˜¯å¦è¢«ç¦ç”¨ - ä½¿ç”¨åŒé‡è­¦å‘Šç¡®ä¿ç”¨æˆ·èƒ½çœ‹åˆ°
                if (submitBtn.getAttribute('data-disabled') === 'true') {
                    const amount = parseFloat(amountInput.value);
                    console.log('æŒ‰é’®è¢«ç¦ç”¨ï¼Œè¾“å…¥çš„é‡‘é¢:', amount);
                    
                    if (isNaN(amount) || amount <= 0) {
                        showToast('è¯·è¾“å…¥æœ‰æ•ˆçš„æç°é‡‘é¢', 'warning');
                        alert('âš ï¸ è¯·è¾“å…¥æœ‰æ•ˆçš„æç°é‡‘é¢');
                        console.log('æ— æ•ˆé‡‘é¢');
                    } else if (amount < 10) {
                        showToast('æç°é‡‘é¢ä¸èƒ½ä½äº10å…ƒ', 'warning');
                        alert('âš ï¸ æç°é‡‘é¢ä¸èƒ½ä½äº10å…ƒ');
                        console.log('é‡‘é¢å°äº10å…ƒ');
                    } else if (amount > withdrawableAmount) {
                        showToast('æç°é‡‘é¢ä¸èƒ½å¤§äºå¯æç°ä½™é¢', 'warning');
                        alert('âš ï¸ æç°é‡‘é¢ä¸èƒ½å¤§äºå¯æç°ä½™é¢');
                        console.log('é‡‘é¢è¶…è¿‡å¯æç°ä½™é¢');
                    } else {
                        // æ£€æŸ¥æ”¯ä»˜æ–¹å¼è®¾ç½®
                        if (document.getElementById('alipay-option').classList.contains('active')) {
                            showToast('è¯·å…ˆè®¾ç½®æ”¯ä»˜å®è´¦å·å’ŒçœŸå®å§“åæ‰èƒ½æç°', 'warning');
                            alert('âš ï¸ è¯·å…ˆè®¾ç½®æ”¯ä»˜å®è´¦å·å’ŒçœŸå®å§“åæ‰èƒ½æç°');
                        } else if (document.getElementById('wechat-option').classList.contains('active')) {
                            showToast('è¯·å…ˆä¸Šä¼ å¾®ä¿¡æ”¶æ¬¾ç æ‰èƒ½æç°', 'warning');
                            alert('âš ï¸ è¯·å…ˆä¸Šä¼ å¾®ä¿¡æ”¶æ¬¾ç æ‰èƒ½æç°');
                        }
                        console.log('æ”¯ä»˜æ–¹å¼æœªè®¾ç½®');
                    }
                    return;
                }
                
                console.log('æŒ‰é’®å¯ç”¨ï¼Œå¼€å§‹å¤„ç†æç°');
                
                const amount = parseFloat(amountInput.value);
                
                if (isNaN(amount) || amount < 10) {
                    showToast('æç°é‡‘é¢ä¸èƒ½ä½äº10å…ƒ', 'warning');
                    alert('âš ï¸ æç°é‡‘é¢ä¸èƒ½ä½äº10å…ƒ');
                    return;
                }
                
                if (amount > withdrawableAmount) {
                    showToast('æç°é‡‘é¢ä¸èƒ½å¤§äºå¯æç°ä½™é¢', 'warning');
                    alert('âš ï¸ æç°é‡‘é¢ä¸èƒ½å¤§äºå¯æç°ä½™é¢');
                    return;
                }
                
                // æ£€æŸ¥æ˜¯å¦å·²ç»è®¾ç½®æç°ä¿¡æ¯
                const isAlipaySelected = document.getElementById('alipay-option').classList.contains('active');
                const isWechatSelected = document.getElementById('wechat-option').classList.contains('active');
                
                // ğŸ”’ ä¸¥æ ¼éªŒè¯ï¼šæ ¹æ®ç”¨æˆ·é€‰æ‹©çš„æç°æ–¹å¼æ£€æŸ¥è®¾ç½®ä¿¡æ¯æ˜¯å¦å®Œæ•´
                if (isAlipaySelected) {
                    const alipayAccount = currentUser.alipay_account || currentUser.æ”¯ä»˜å®è´¦å·;
                    const realName = currentUser.real_name || currentUser.çœŸå®å§“å;
                    
                    console.log('ğŸ” éªŒè¯æ”¯ä»˜å®ä¿¡æ¯:', {
                        alipayAccount: alipayAccount ? 'å·²è®¾ç½®' : 'æœªè®¾ç½®',
                        realName: realName ? 'å·²è®¾ç½®' : 'æœªè®¾ç½®',
                        currentUser: currentUser
                    });
                    
                    if (!alipayAccount || !realName) {
                        // æ”¯ä»˜å®ä¿¡æ¯ä¸å®Œæ•´ï¼Œå¼ºåˆ¶ç”¨æˆ·è®¾ç½®
                        console.log('âŒ æ”¯ä»˜å®ä¿¡æ¯ä¸å®Œæ•´ï¼Œé˜»æ­¢æç°');
                        showToast('è¯·å…ˆå®Œæ•´è®¾ç½®æ”¯ä»˜å®è´¦å·å’ŒçœŸå®å§“åæ‰èƒ½æç°', 'error');
                        
                        // ç¡®ä¿æŒ‰é’®è¢«ç¦ç”¨
                        const submitBtn = document.getElementById('submit-withdrawal-btn');
                        if (submitBtn) {
                            submitBtn.setAttribute('data-disabled', 'true');
                        }
                        
                        // è‡ªåŠ¨æ˜¾ç¤ºè®¾ç½®å¯¹è¯æ¡†
                        setTimeout(() => {
                            showAlipaySettingsModal();
                        }, 1000);
                        return;
                    }
                    
                    // âœ… æ”¯ä»˜å®ä¿¡æ¯å®Œæ•´ï¼Œè®°å½•åˆ°æ§åˆ¶å°
                    console.log('âœ… æ”¯ä»˜å®ä¿¡æ¯éªŒè¯é€šè¿‡:', {
                        account: alipayAccount,
                        name: realName
                    });
                    
                } else if (isWechatSelected) {
                    const wechatQRCode = currentUser.wechat_qr_code || currentUser.å¾®ä¿¡æ”¶æ¬¾ç ;
                    const wechatState = WechatUploadStatus.getState();
                    
                    console.log('ğŸ” éªŒè¯å¾®ä¿¡ä¿¡æ¯:', {
                        wechatQRCode: wechatQRCode ? 'å·²è®¾ç½®' : 'æœªè®¾ç½®',
                        state: wechatState
                    });
                    
                    if (!wechatQRCode) {
                        // å¾®ä¿¡æ”¶æ¬¾ç æœªè®¾ç½®ï¼Œå¼ºåˆ¶ç”¨æˆ·è®¾ç½®
                        console.log('âŒ å¾®ä¿¡æ”¶æ¬¾ç æœªè®¾ç½®ï¼Œé˜»æ­¢æç°');
                        showToast('è¯·å…ˆä¸Šä¼ å¾®ä¿¡æ”¶æ¬¾ç æ‰èƒ½æç°', 'error');
                        
                        // ç¡®ä¿æŒ‰é’®è¢«ç¦ç”¨
                        const submitBtn = document.getElementById('submit-withdrawal-btn');
                        if (submitBtn) {
                            submitBtn.setAttribute('data-disabled', 'true');
                        }
                        
                        // è‡ªåŠ¨æ˜¾ç¤ºè®¾ç½®å¯¹è¯æ¡†
                        setTimeout(() => {
                            showWechatSettingsModal();
                        }, 1000);
                        return;
                    } else if (wechatState !== WechatUploadStatus.states.success) {
                        // æ”¶æ¬¾ç æœ‰å€¼ä½†çŠ¶æ€æœªæˆåŠŸï¼ˆä¸Šä¼ ä¸­/å¤±è´¥/æœªçŸ¥ï¼‰
                        console.log('âŒ æ”¶æ¬¾ç çŠ¶æ€æœªæˆåŠŸï¼Œé˜»æ­¢æç°');
                        const msg = wechatState === WechatUploadStatus.states.uploading
                            ? 'æ”¶æ¬¾ç æ­£åœ¨ä¸Šä¼ ï¼Œè¯·ç¨å€™å®Œæˆåå†æç°'
                            : (wechatState === WechatUploadStatus.states.failed
                                ? 'æ”¶æ¬¾ç ä¸Šä¼ å¤±è´¥ï¼Œè¯·é‡æ–°ä¸Šä¼ '
                                : 'æ”¶æ¬¾ç çŠ¶æ€å¼‚å¸¸ï¼Œè¯·é‡æ–°ä¸Šä¼ ');
                        showToast(msg, 'error');
                        const submitBtn = document.getElementById('submit-withdrawal-btn');
                        if (submitBtn) submitBtn.setAttribute('data-disabled', 'true');
                        return;
                    }
                    
                    console.log('âœ… å¾®ä¿¡ä¿¡æ¯éªŒè¯é€šè¿‡');
                }
                
                // é€šè¿‡éªŒè¯ï¼Œè°ƒç”¨æç°å¤„ç†å‡½æ•°ï¼ˆç­‰å¾…å®Œæˆï¼Œé¿å…åŠ è½½é®ç½©æ®‹ç•™ï¼‰
                WithdrawalStatus.processing('æç°ä¸­ï¼Œè¯·ç¨å€™...');
                try {
                    await processWithdrawal(amount);
                } catch(e) {
                    console.warn('æç°è¿‡ç¨‹æŠ›å‡ºå¼‚å¸¸(å·²åœ¨å†…éƒ¨å¤„ç†):', e);
                }
            });
        }
        
        // ç»‘å®šæç°æ–¹å¼åˆ‡æ¢äº‹ä»¶
        function bindPaymentMethodEvents() {
            const alipayOption = document.getElementById('alipay-option');
            const wechatOption = document.getElementById('wechat-option');
            const alipaySection = document.getElementById('alipay-section');
            const wechatSection = document.getElementById('wechat-section');
            const submitBtn = document.getElementById('submit-withdrawal-btn');
            
            // æ”¯ä»˜å®é€‰é¡¹ç‚¹å‡»äº‹ä»¶
            alipayOption.addEventListener('click', function() {
                alipayOption.classList.add('active');
                wechatOption.classList.remove('active');
                alipaySection.classList.remove('hidden');
                wechatSection.classList.add('hidden');
                
                // æ›´æ–°æŒ‰é’®æ ·å¼
                alipayOption.className = 'payment-option active flex-1 py-3 px-4 rounded-lg border-2 border-blue-500 bg-blue-50 text-blue-700 font-medium';
                wechatOption.className = 'payment-option flex-1 py-3 px-4 rounded-lg border-2 border-gray-200 bg-white text-gray-600 font-medium';
                
                // æ£€æŸ¥æ”¯ä»˜å®è´¦å·å’ŒçœŸå®å§“åæ˜¯å¦å·²è®¾ç½®
                const alipayAccount = currentUser.alipay_account || currentUser.æ”¯ä»˜å®è´¦å·;
                const realName = currentUser.real_name || currentUser.çœŸå®å§“å;
                
                // å¦‚æœæ”¯ä»˜å®ä¿¡æ¯æœªè®¾ç½®ï¼Œç¦ç”¨æç°æŒ‰é’®å¹¶æç¤º
                if (!alipayAccount || !realName) {
                    submitBtn.setAttribute('data-disabled', 'true');
                    showToast('è¯·å…ˆè®¾ç½®æ”¯ä»˜å®è´¦å·å’ŒçœŸå®å§“åæ‰èƒ½æç°', 'warning');
                    // å¯ä»¥é€‰æ‹©è‡ªåŠ¨æ˜¾ç¤ºè®¾ç½®ç•Œé¢
                    // showAlipaySettingsModal();
                } else {
                    // é‡æ–°æ£€æŸ¥æç°é‡‘é¢
                    const amountInput = document.getElementById('withdraw-amount');
                    const value = parseFloat(amountInput.value);
                    if (!isNaN(value) && value >= 10 && value <= withdrawableAmount) {
                        submitBtn.removeAttribute('data-disabled');
                    }
                }
            });
            
            // å¾®ä¿¡é€‰é¡¹ç‚¹å‡»äº‹ä»¶
            wechatOption.addEventListener('click', function() {
                wechatOption.classList.add('active');
                alipayOption.classList.remove('active');
                wechatSection.classList.remove('hidden');
                alipaySection.classList.add('hidden');
                
                // æ›´æ–°æŒ‰é’®æ ·å¼
                wechatOption.className = 'payment-option active flex-1 py-3 px-4 rounded-lg border-2 border-blue-500 bg-blue-50 text-blue-700 font-medium';
                alipayOption.className = 'payment-option flex-1 py-3 px-4 rounded-lg border-2 border-gray-200 bg-white text-gray-600 font-medium';
                
                // æ£€æŸ¥å¾®ä¿¡æ”¶æ¬¾ç æ˜¯å¦å·²è®¾ç½®
                const wechatQRCode = currentUser.wechat_qr_code || currentUser.å¾®ä¿¡æ”¶æ¬¾ç ;
                
                // å¦‚æœå¾®ä¿¡æ”¶æ¬¾ç æœªè®¾ç½®ï¼Œç¦ç”¨æç°æŒ‰é’®å¹¶æç¤º
                if (!wechatQRCode) {
                    submitBtn.setAttribute('data-disabled', 'true');
                    const state = WechatUploadStatus.getState();
                    const msg = state === WechatUploadStatus.states.uploading
                        ? 'æ”¶æ¬¾ç ä¸Šä¼ ä¸­ï¼Œè¯·ç¨å€™å®Œæˆåå†æç°'
                        : 'è¯·å…ˆä¸Šä¼ å¾®ä¿¡æ”¶æ¬¾ç æ‰èƒ½æç°';
                    showToast(msg, 'warning');
                    // å¯ä»¥é€‰æ‹©è‡ªåŠ¨æ˜¾ç¤ºè®¾ç½®ç•Œé¢
                    // showWechatSettingsModal();
                } else {
                    // é‡æ–°æ£€æŸ¥æç°é‡‘é¢
                    const amountInput = document.getElementById('withdraw-amount');
                    const value = parseFloat(amountInput.value);
                    if (!isNaN(value) && value >= 10 && value <= withdrawableAmount) {
                        // è¿˜éœ€æ ¡éªŒä¸Šä¼ çŠ¶æ€å¿…é¡»ä¸ºæˆåŠŸ
                        if (WechatUploadStatus.getState() === WechatUploadStatus.states.success) {
                            submitBtn.removeAttribute('data-disabled');
                        } else {
                            submitBtn.setAttribute('data-disabled', 'true');
                        }
                    }
                }
            });
        }
        
        // æ˜¾ç¤ºæ”¯ä»˜å®è®¾ç½®å¯¹è¯æ¡†
        function showAlipaySettingsModal() {
            // åˆ›å»ºå¯¹è¯æ¡†å…ƒç´ 
            const dialog = document.createElement('div');
            dialog.className = 'fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50';
            
            dialog.innerHTML = `
                <div class="bg-white rounded-lg w-11/12 max-w-md p-5">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">è®¾ç½®æ”¯ä»˜å®æç°ä¿¡æ¯</h3>
                    
                    <div class="mb-4">
                        <label class="block text-gray-600 text-sm font-medium mb-2">æ”¯ä»˜å®è´¦å·</label>
                        <input type="text" id="new-alipay-account" class="form-input" placeholder="è¯·è¾“å…¥æ”¯ä»˜å®è´¦å·">
                        <p class="text-xs text-gray-400 mt-1">å‡ºäºå®‰å…¨è€ƒè™‘ï¼Œè¯¥å­—æ®µåœ¨é¡µé¢ä¸Šä¼šæ˜¾ç¤ºä¸ºå ä½ç¬¦ï¼Œä¿æŠ¤æ‚¨çš„éšç§</p>
                    </div>
                    
                    <div class="mb-6">
                        <label class="block text-gray-600 text-sm font-medium mb-2">çœŸå®å§“å</label>
                        <input type="text" id="new-real-name" class="form-input" placeholder="è¯·è¾“å…¥çœŸå®å§“å">
                        <p class="text-xs text-gray-400 mt-1">å‡ºäºå®‰å…¨è€ƒè™‘ï¼Œè¯¥å­—æ®µåœ¨é¡µé¢ä¸Šä¼šæ˜¾ç¤ºä¸ºå ä½ç¬¦ï¼Œä¿æŠ¤æ‚¨çš„éšç§</p>
                    </div>
                    
                    <div class="flex justify-end">
                        <button class="px-4 py-2 text-gray-500 mr-2" id="cancel-alipay-btn">å–æ¶ˆ</button>
                        <button class="px-4 py-2 bg-blue-500 text-white rounded-md" id="confirm-alipay-btn">ç¡®è®¤</button>
                    </div>
                </div>
            `;
            
            // æ·»åŠ åˆ°é¡µé¢
            document.body.appendChild(dialog);
            
            // ç»‘å®šäº‹ä»¶
            const cancelBtn = document.getElementById('cancel-alipay-btn');
            const confirmBtn = document.getElementById('confirm-alipay-btn');
            
            cancelBtn.addEventListener('click', function() {
                document.body.removeChild(dialog);
            });
            
            confirmBtn.addEventListener('click', function() {
                const alipayAccount = document.getElementById('new-alipay-account').value.trim();
                const realName = document.getElementById('new-real-name').value.trim();
                
                if (!alipayAccount) {
                    showToast('è¯·è¾“å…¥æ”¯ä»˜å®è´¦å·', 'warning');
                    return;
                }
                
                if (!realName) {
                    showToast('è¯·è¾“å…¥çœŸå®å§“å', 'warning');
                    return;
                }
                
                // ä¿å­˜æ”¯ä»˜å®ä¿¡æ¯
                saveAlipayInfo(alipayAccount, realName);
                document.body.removeChild(dialog);
            });
        }
        
        // æ˜¾ç¤ºå¾®ä¿¡è®¾ç½®å¯¹è¯æ¡†
        function showWechatSettingsModal() {
            // åˆ›å»ºå¯¹è¯æ¡†å…ƒç´ 
            const dialog = document.createElement('div');
            dialog.className = 'fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50';
            
            dialog.innerHTML = `
                <div class="bg-white rounded-lg w-11/12 max-w-md p-5">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">è®¾ç½®å¾®ä¿¡æç°ä¿¡æ¯</h3>
                    
                    <div class="mb-4">
                        <label class="block text-gray-600 text-sm font-medium mb-2">ä¸Šä¼ æ”¶æ¬¾ç </label>
                        <div class="border-2 border-dashed border-gray-300 rounded-lg p-4 text-center cursor-pointer" id="qr-upload-area">
                            <i class="fas fa-cloud-upload-alt text-2xl text-gray-400 mb-2"></i>
                            <p class="text-gray-500">ç‚¹å‡»ä¸Šä¼ æ”¶æ¬¾ç </p>
                            <p class="text-xs text-gray-400 mt-1">æ”¯æŒ JPGã€PNG æ ¼å¼</p>
                        </div>
                        <input type="file" id="qr-file-input" accept="image/*" style="display: none;">
                    </div>
                    
                    <div class="flex justify-end">
                        <button class="px-4 py-2 text-gray-500 mr-2" id="cancel-wechat-btn">å–æ¶ˆ</button>
                        <button class="px-4 py-2 bg-green-500 text-white rounded-md" id="confirm-wechat-btn">ç¡®è®¤</button>
                    </div>
                </div>
            `;
            
            // æ·»åŠ åˆ°é¡µé¢
            document.body.appendChild(dialog);
            
            // ç»‘å®šäº‹ä»¶
            const cancelBtn = document.getElementById('cancel-wechat-btn');
            const confirmBtn = document.getElementById('confirm-wechat-btn');
            const qrUploadArea = document.getElementById('qr-upload-area');
            const qrFileInput = document.getElementById('qr-file-input');
            // æ¨¡æ€æ¡†å†…çš„ç®€æ˜“çŠ¶æ€æ¡
            let modalStatus; (function(){
                modalStatus = document.createElement('div');
                modalStatus.className = 'upload-status';
                modalStatus.innerHTML = '<div class="progress"><div class="progress-bar" style="width:0%"></div></div><div class="progress-text">å¾…ä¸Šä¼ </div>';
                const container = dialog.querySelector('.bg-white');
                container.appendChild(modalStatus);
            })();
            
            // ç‚¹å‡»ä¸Šä¼ åŒºåŸŸè§¦å‘æ–‡ä»¶é€‰æ‹©
            qrUploadArea.addEventListener('click', function() {
                qrFileInput.click();
            });
            
            // æ–‡ä»¶é€‰æ‹©äº‹ä»¶
            qrFileInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    if (file.type.startsWith('image/')) {
                        const reader = new FileReader();
                        reader.onloadstart = function(){
                            // å¯åŠ¨ä¸Šä¼ è¿›åº¦
                            const bar = modalStatus.querySelector('.progress-bar');
                            const text = modalStatus.querySelector('.progress-text');
                            bar.style.width = '10%';
                            text.textContent = 'ä¸Šä¼ ä¸­...';
                            // åˆ‡æ¢å…¨å±€çŠ¶æ€ä¸ºä¸Šä¼ ä¸­ï¼Œç¦ç”¨æç°
                            WechatUploadStatus.uploading(10);
                        };
                        reader.onprogress = function(evt){
                            if (evt.lengthComputable) {
                                const percent = Math.max(10, Math.min(95, Math.floor((evt.loaded/evt.total)*95)));
                                modalStatus.querySelector('.progress-bar').style.width = percent + '%';
                            }
                        };
                        reader.onload = function(e) {
                            qrUploadArea.innerHTML = `
                                <img src="${e.target.result}" alt="æ”¶æ¬¾ç " class="w-32 h-32 object-contain mx-auto mb-2">
                                <p class="text-green-500 text-sm">æ”¶æ¬¾ç å·²ä¸Šä¼ </p>
                            `;
                            modalStatus.querySelector('.progress-bar').style.width = '100%';
                            modalStatus.querySelector('.progress-text').textContent = 'ä¸Šä¼ æˆåŠŸ';
                            // ç­‰å¾…ä¿å­˜åˆ°æœåŠ¡å™¨å®Œæˆåå†ç½®ä¸ºæˆåŠŸï¼Œè¿™é‡Œä»…é¢„è§ˆå®Œæˆ
                        };
                        reader.readAsDataURL(file);
                    } else {
                        showToast('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶', 'warning');
                    }
                }
            });
            
            cancelBtn.addEventListener('click', function() {
                document.body.removeChild(dialog);
            });
            
            confirmBtn.addEventListener('click', function() {
                const qrFile = qrFileInput.files[0];
                if (!qrFile) {
                    showToast('è¯·å…ˆä¸Šä¼ æ”¶æ¬¾ç ', 'warning');
                    return;
                }
                
                // ä¿å­˜å¾®ä¿¡æ”¶æ¬¾ç 
                saveWechatInfo(qrFile);
                document.body.removeChild(dialog);
            });
        }
        
        // ğŸ”§ ä¿®å¤ï¼šä¿å­˜æ”¯ä»˜å®ä¿¡æ¯ï¼ˆå¢å¼ºå¥å£®æ€§ï¼‰
        async function saveAlipayInfo(account, name) {
            showLoading();
            try {
                console.log('ğŸ”„ å¼€å§‹ä¿å­˜æ”¯ä»˜å®ä¿¡æ¯(ä¸€è‡´æ€§æ ¡éªŒ+æœåŠ¡ç«¯å›è¯»)...');
                if (!currentUser) throw new Error('æœªç™»å½•');
                const result = await PaymentDataSync.syncAlipayInfo(currentUser, account, name);
                if (!result.ok) throw result.error || new Error('ä¿å­˜å¤±è´¥');
                // ä»¥æœåŠ¡ç«¯å†™å›çš„æ•°æ®å¯¹é½æœ¬åœ°
                currentUser.alipay_account = account;
                currentUser.real_name = name;
                currentUser['æ”¯ä»˜å®è´¦å·'] = account;
                currentUser['çœŸå®å§“å'] = name;
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                updateAlipayDisplay(account, name);
                // å›å¡«åˆ°æ‰€æœ‰å¾…å¤„ç†æç°è®°å½•ï¼Œä¾¿äºåå°ç«‹åˆ»æ˜¾ç¤º
                try {
                    const uid = currentUser.id || currentUser['ç”¨æˆ·ID'];
                    if (uid) await WithdrawalBackfill.backfillPendingForUser(uid, account, name);
                } catch (_) {}
                hideLoading();
                showAlipaySuccessEffect(account, name);
                showToast('æ”¯ä»˜å®ä¿¡æ¯å·²ä¿å­˜ï¼Œç°åœ¨å¯ä»¥æç°äº†ï¼', 'success');
                // å¯ç”¨æŒ‰é’®ï¼ˆè‹¥é‡‘é¢æœ‰æ•ˆï¼‰
                const submitBtn = document.getElementById('submit-withdrawal-btn');
                const amountInput = document.getElementById('withdraw-amount');
                const currentAmount = parseFloat(amountInput.value);
                if (submitBtn && !isNaN(currentAmount) && currentAmount >= 10 && currentAmount <= withdrawableAmount) {
                    submitBtn.removeAttribute('data-disabled');
                }
            } catch (error) {
                console.error('âŒ ä¿å­˜æ”¯ä»˜å®ä¿¡æ¯å¤±è´¥:', error);
                hideLoading();
                showToast('æ›´æ–°æ”¯ä»˜å®ä¿¡æ¯å¤±è´¥ï¼š' + (error.message || 'æœªçŸ¥é”™è¯¯'), 'error');
            }
        }
        
        // ğŸ”§ è¾…åŠ©å‡½æ•°ï¼šæ›´æ–°æ”¯ä»˜å®ä¿¡æ¯æ˜¾ç¤º
        function updateAlipayDisplay(account, name) {
            try {
                // æ›´æ–°æ˜¾ç¤ºçš„è´¦å·ä¿¡æ¯ï¼ˆä½¿ç”¨éƒ¨åˆ†éšè—çš„æ ¼å¼ï¼‰
                const displayAccount = account.length > 8 
                    ? account.substring(0, 3) + '****' + account.substring(account.length - 4) 
                    : account;
                
                const displayName = name.length > 0 
                    ? name.charAt(0) + '*' + (name.length > 1 ? name.charAt(name.length-1) : '')
                    : name;
                
                const accountElement = document.getElementById('alipay-account');
                const nameElement = document.getElementById('user-real-name');
                
                if (accountElement) {
                    accountElement.textContent = displayAccount;
                    console.log('âœ… æ”¯ä»˜å®è´¦å·æ˜¾ç¤ºå·²æ›´æ–°');
                }
                
                if (nameElement) {
                    nameElement.textContent = displayName;
                    console.log('âœ… çœŸå®å§“åæ˜¾ç¤ºå·²æ›´æ–°');
                }
                
                // ğŸ†• æ›´æ–°çŠ¶æ€å¾½ç« ä¸ºç»¿è‰²ï¼ˆå·²è®¾ç½®ï¼‰
                const statusBadge = document.getElementById('alipay-status-badge');
                if (statusBadge) {
                    statusBadge.className = 'ml-2 px-2 py-1 text-xs rounded-full bg-green-100 text-green-600';
                    statusBadge.textContent = 'âœ… å·²è®¾ç½®';
                    console.log('âœ… æ”¯ä»˜å®çŠ¶æ€å¾½ç« å·²æ›´æ–°ä¸ºå·²è®¾ç½®');
                }
                
                // ğŸ†• éšè—è®¾ç½®æç¤º
                const setupHint = document.getElementById('alipay-setup-hint');
                if (setupHint) {
                    setupHint.style.display = 'none';
                    console.log('âœ… æ”¯ä»˜å®è®¾ç½®æç¤ºå·²éšè—');
                }
                
            } catch (displayError) {
                console.error('âŒ æ›´æ–°æ˜¾ç¤ºå¤±è´¥:', displayError);
            }
        }
        
        // å›¾ç‰‡å‹ç¼©ï¼ˆä¿æŒæ¸…æ™°ï¼Œé™åˆ¶æœ€å¤§è¾¹ï¼‰
        function compressImage(file, maxSide = 480) {
            return new Promise((resolve, reject) => {
                const fr = new FileReader();
                fr.onload = () => {
                    const img = new Image();
                    img.onload = () => {
                        let { width, height } = img;
                        if (Math.max(width, height) > maxSide) {
                            if (width >= height) {
                                height = Math.round(height * (maxSide / width));
                                width = maxSide;
                            } else {
                                width = Math.round(width * (maxSide / height));
                                height = maxSide;
                            }
                        }
                        const canvas = document.createElement('canvas');
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        try {
                            const dataUrl = canvas.toDataURL('image/png');
                            resolve(dataUrl);
                        } catch (e) {
                            reject(e);
                        }
                    };
                    img.onerror = reject;
                    img.src = fr.result;
                };
                fr.onerror = reject;
                fr.readAsDataURL(file);
            });
        }

        // ğŸ”§ ä¿®å¤ï¼šä¿å­˜å¾®ä¿¡ä¿¡æ¯ï¼ˆå¢å¼ºå¥å£®æ€§ + å‹ç¼©ä¸Šä¼ ï¼‰
        async function saveWechatInfo(qrFile) {
            showLoading();
            try {
                console.log('ğŸ”„ å¼€å§‹ä¿å­˜å¾®ä¿¡æ”¶æ¬¾ç ...');
                const userId = currentUser.id || currentUser.ç”¨æˆ·ID;
                if (!userId) {
                    console.error('âŒ æ— æ³•è·å–ç”¨æˆ·ID:', currentUser);
                    hideLoading();
                    showToast('ç”¨æˆ·ä¿¡æ¯å¼‚å¸¸ï¼Œè¯·é‡æ–°ç™»å½•', 'error');
                    return;
                }
                console.log('ğŸ“‹ ç”¨æˆ·ID:', userId);

                // å‹ç¼©å¹¶å‡†å¤‡æ•°æ®
                WechatUploadStatus.uploading(10);
                let qrCodeData;
                try {
                    qrCodeData = await compressImage(qrFile, 640);
                    WechatUploadStatus.uploading(80);
                } catch (ce) {
                    console.warn('âš ï¸ å‹ç¼©å¤±è´¥ï¼Œä½¿ç”¨åŸå›¾:', ce?.message || ce);
                    // å›é€€åŸå›¾
                    const tmp = await new Promise((resolve, reject) => {
                        const r = new FileReader();
                        r.onload = () => resolve(r.result);
                        r.onerror = reject;
                        r.readAsDataURL(qrFile);
                    });
                    qrCodeData = tmp;
                    WechatUploadStatus.uploading(60);
                }
                console.log('ğŸ“‹ æ”¶æ¬¾ç æ•°æ®å¤§å°:', qrCodeData.length, 'å­—ç¬¦');

                // å¤šç­–ç•¥ä¿å­˜
                let saveSuccess = false;
                let saveError = null;

                // ç­–ç•¥1: è‹±æ–‡å­—æ®µ + id
                try {
                    const { error } = await window.supabase
                        .from('users')
                        .update({ wechat_qr_code: qrCodeData })
                        .eq('id', userId)
                        .select();
                    if (!error) saveSuccess = true; else saveError = error;
                } catch (e1) { saveError = e1; }

                // ç­–ç•¥2: ä¸­æ–‡å­—æ®µ + ç”¨æˆ·ID
                if (!saveSuccess) {
                    try {
                        const { error } = await window.supabase
                            .from('users')
                            .update({ 'å¾®ä¿¡æ”¶æ¬¾ç ': qrCodeData })
                            .eq('ç”¨æˆ·ID', userId)
                            .select();
                        if (!error) saveSuccess = true; else saveError = error;
                    } catch (e2) { saveError = e2; }
                }

                // ç­–ç•¥3: åŠ¨æ€æ£€æµ‹
                if (!saveSuccess) {
                    try {
                        const { data: sampleData } = await window.supabase.from('users').select('*').limit(1);
                        const available = Array.isArray(sampleData) && sampleData[0] ? Object.keys(sampleData[0]) : [];
                        let qrField = available.includes('å¾®ä¿¡æ”¶æ¬¾ç ') ? 'å¾®ä¿¡æ”¶æ¬¾ç ' : 'wechat_qr_code';
                        let idField = available.includes('ç”¨æˆ·ID') ? 'ç”¨æˆ·ID' : 'id';
                        const updateData = {}; updateData[qrField] = qrCodeData;
                        const { error } = await window.supabase.from('users').update(updateData).eq(idField, userId).select();
                        if (!error) saveSuccess = true; else saveError = error;
                    } catch (e3) { saveError = e3; }
                }

                if (!saveSuccess) {
                    hideLoading();
                    WechatUploadStatus.failed();
                    let errorMessage = 'æ›´æ–°å¾®ä¿¡æ”¶æ¬¾ç å¤±è´¥';
                    if (saveError) {
                        const msg = saveError.message || '';
                        if (msg.includes('permission')) errorMessage = 'æ•°æ®åº“æƒé™ä¸è¶³ï¼Œè¯·è”ç³»ç®¡ç†å‘˜';
                        else if (msg.includes('column') || msg.includes('å­—æ®µ')) errorMessage = 'æ•°æ®åº“å­—æ®µä¸å­˜åœ¨ï¼Œè¯·è”ç³»æŠ€æœ¯æ”¯æŒ';
                        else if (msg.includes('network') || msg.includes('fetch')) errorMessage = 'ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œåé‡è¯•';
                    }
                    showToast(errorMessage, 'error');
                    // æœ¬åœ°å…œåº•
                    currentUser.wechat_qr_code = qrCodeData;
                    currentUser['å¾®ä¿¡æ”¶æ¬¾ç '] = qrCodeData;
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    updateWechatDisplay(qrCodeData);
                    WechatUploadStatus.success();
                    showToast('æ·»åŠ æˆåŠŸ', 'success');
                    return;
                }

                // æˆåŠŸ
                currentUser.wechat_qr_code = qrCodeData;
                currentUser['å¾®ä¿¡æ”¶æ¬¾ç '] = qrCodeData;
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                updateWechatDisplay(qrCodeData);
                hideLoading();
                WechatUploadStatus.success();
                showWechatSuccessEffect();
                const submitBtn = document.getElementById('submit-withdrawal-btn');
                const amountInput = document.getElementById('withdraw-amount');
                const currentAmount = parseFloat(amountInput.value);
                if (submitBtn && !isNaN(currentAmount) && currentAmount >= 10 && currentAmount <= withdrawableAmount) {
                    submitBtn.removeAttribute('data-disabled');
                }
            } catch (error) {
                console.error('âŒ ä¿å­˜å¾®ä¿¡ä¿¡æ¯æ—¶å‘ç”Ÿæœªé¢„æœŸé”™è¯¯:', error);
                hideLoading();
                WechatUploadStatus.failed();
                showToast('ç³»ç»Ÿé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•', 'error');
            }
        }
        
        // ğŸ”§ è¾…åŠ©å‡½æ•°ï¼šæ›´æ–°å¾®ä¿¡æ”¶æ¬¾ç æ˜¾ç¤º
        function updateWechatDisplay(qrCodeData) {
            try {
                const qrDisplay = document.getElementById('qr-code-display');
                if (qrDisplay) {
                    qrDisplay.innerHTML = `
                        <img src="${qrCodeData}" alt="å¾®ä¿¡æ”¶æ¬¾ç " class="qr-preview">
                    `;
                    console.log('âœ… å¾®ä¿¡æ”¶æ¬¾ç æ˜¾ç¤ºå·²æ›´æ–°');
                }
            } catch (displayError) {
                console.error('âŒ æ›´æ–°æ”¶æ¬¾ç æ˜¾ç¤ºå¤±è´¥:', displayError);
            }
        }
        
        // å¤„ç†æç°è¯·æ±‚
        async function processWithdrawal(amount) {
            showLoading();
            // è¿›å…¥å¤„ç†ä¸­çŠ¶æ€
            WithdrawalStatus.processing('æç°ä¸­ï¼Œè¯·ç¨å€™...');
            
            try {
                console.log('å¼€å§‹å¤„ç†æç°è¯·æ±‚ï¼Œé‡‘é¢:', amount);
                
                // è·å–å½“å‰é€‰æ‹©çš„æç°æ–¹å¼
                const isAlipaySelected = document.getElementById('alipay-option').classList.contains('active');
                const isWechatSelected = document.getElementById('wechat-option').classList.contains('active');
                
                // æ£€æŸ¥æç°ä¿¡æ¯æ˜¯å¦å®Œæ•´
                if (isAlipaySelected) {
                    // æ£€æŸ¥æ”¯ä»˜å®è´¦å·å’ŒçœŸå®å§“åæ˜¯å¦å·²è®¾ç½®
                    const alipayAccount = currentUser.alipay_account || currentUser.æ”¯ä»˜å®è´¦å·;
                    const realName = currentUser.real_name || currentUser.çœŸå®å§“å;
                    
                    if (!alipayAccount || !realName) {
                        hideLoading();
                        showToast('è¯·å…ˆè®¾ç½®æ”¯ä»˜å®è´¦å·å’ŒçœŸå®å§“å', 'warning');
                        showAlipaySettingsModal(); // è‡ªåŠ¨æ˜¾ç¤ºè®¾ç½®å¯¹è¯æ¡†
                        return;
                    }
                } else if (isWechatSelected) {
                    // æ£€æŸ¥å¾®ä¿¡æ”¶æ¬¾ç æ˜¯å¦å·²è®¾ç½®
                    const wechatQRCode = currentUser.wechat_qr_code || currentUser.å¾®ä¿¡æ”¶æ¬¾ç ;
                    
                    if (!wechatQRCode) {
                        hideLoading();
                        showToast('è¯·å…ˆä¸Šä¼ å¾®ä¿¡æ”¶æ¬¾ç ', 'warning');
                        showWechatSettingsModal(); // è‡ªåŠ¨æ˜¾ç¤ºè®¾ç½®å¯¹è¯æ¡†
                        return;
                    }
                }
                
                // è®°å½•é€‰æ‹©ï¼Œä¾¿äºåç»­å›å¡«
                WithdrawalMethodSync.rememberSelection();
                // è°ƒç”¨ç§»åŠ¨ç«¯æç°å¤„ç†æ¨¡å—
                if (window.WithdrawalModule && typeof window.WithdrawalModule.processWithdrawal === 'function') {
                    await window.WithdrawalModule.processWithdrawal(amount);
                    
                    // æç°æˆåŠŸåæ›´æ–°é¡µé¢æ˜¾ç¤º
                    updatePageAfterWithdrawal(amount);
                } else {
                    // å¦‚æœæ¨¡å—ä¸å¯ç”¨ï¼Œè‡ªè¡Œå¤„ç†æç°é€»è¾‘
                    await fallbackProcessWithdrawal(amount);
                }
                
                // å¼ºåˆ¶å…³é—­åŠ è½½æŒ‡ç¤ºå™¨ï¼Œé¿å…æ®‹ç•™
                try { hideLoading(); } catch(_) {}
                
            } catch (error) {
                console.error('æç°å¤„ç†å¤±è´¥:', error);
                hideLoading(); // åªæœ‰åœ¨å‡ºé”™æ—¶æ‰éšè—åŠ è½½æŒ‡ç¤ºå™¨
                WithdrawalStatus.failed('æç°å¤±è´¥ï¼š' + (error.message || 'æœªçŸ¥é”™è¯¯'));
                showToast('æç°å¤±è´¥: ' + (error.message || 'æœªçŸ¥é”™è¯¯'), 'error');
            }
        }
        
        // æç°æˆåŠŸåæ›´æ–°é¡µé¢æ˜¾ç¤º
        function updatePageAfterWithdrawal(amount) {
            try {
                // æ›´æ–°å¯æç°é‡‘é¢æ˜¾ç¤º
                const withdrawableAmountElement = document.getElementById('withdrawable-amount');
                if (withdrawableAmountElement) {
                    withdrawableAmountElement.textContent = '0.00';
                }
                
                // æ¸…ç©ºæç°é‡‘é¢è¾“å…¥æ¡†
                const amountInput = document.getElementById('withdraw-amount');
                if (amountInput) {
                    amountInput.value = '';
                }
                
                // ç¦ç”¨æç°æŒ‰é’®
                const submitBtn = document.getElementById('submit-withdrawal-btn');
                if (submitBtn) {
                    submitBtn.setAttribute('data-disabled', 'true');
                }
                
                // æ˜¾ç¤ºæˆåŠŸæç¤º
                WithdrawalStatus.success('æç°æˆåŠŸï¼Œç­‰å¾…å®¡æ ¸æ‰“æ¬¾');
                showToast('æç°ç”³è¯·å·²æäº¤ï¼é‡‘é¢å·²å†»ç»“ï¼Œç­‰å¾…ç®¡ç†å‘˜å®¡æ ¸å’Œæ‰“æ¬¾', 'success');
                
                // 2ç§’åè¿”å›ä¸Šä¸€é¡µ
                setTimeout(() => {
                    history.back();
                }, 2000);
                
            } catch (error) {
                console.error('æ›´æ–°é¡µé¢æ˜¾ç¤ºæ—¶å‡ºé”™:', error);
                // å³ä½¿æ›´æ–°é¡µé¢æ˜¾ç¤ºå¤±è´¥ï¼Œä¹Ÿä¸å½±å“æç°çš„æˆåŠŸçŠ¶æ€
            }
        }
        
        // å¤‡ç”¨æç°å¤„ç†é€»è¾‘
        async function fallbackProcessWithdrawal(amount) {
            // 1. è·å–ç”¨æˆ·ID
            const userId = currentUser.id || currentUser.ç”¨æˆ·ID;
            
            if (!userId) {
                throw new Error('æ— æ³•è·å–ç”¨æˆ·ID');
            }
            
            // 2. ç¡®å®šé’±åŒ…å­—æ®µ
            const walletField = getWalletField(currentUser);
            
            // 3. åˆ›å»ºæç°è®°å½•ï¼ˆåŒ…å«æ”¯ä»˜å®ä¿¡æ¯å’Œæç°æ–¹å¼ï¼‰
            
            // ğŸ¯ è·å–å½“å‰é€‰æ‹©çš„æç°æ–¹å¼
            const isAlipaySelected = document.getElementById('alipay-option').classList.contains('active');
            const isWechatSelected = document.getElementById('wechat-option').classList.contains('active');
            const paymentMethod = isWechatSelected ? 'wechat' : 'alipay';
            
            // ğŸ¯ è·å–æ”¯ä»˜å®ä¿¡æ¯
            const alipayAccount = currentUser.alipay_account || currentUser.æ”¯ä»˜å®è´¦å· || '';
            const realName = currentUser.real_name || currentUser.çœŸå®å§“å || '';
            const wechatQRCode = currentUser.wechat_qr_code || currentUser.å¾®ä¿¡æ”¶æ¬¾ç  || '';
            
            console.log('ğŸ’³ æç°æ–¹å¼:', paymentMethod);
            console.log('ğŸ’° æ”¯ä»˜å®è´¦å·:', alipayAccount);
            console.log('ğŸ‘¤ çœŸå®å§“å:', realName);
            console.log('ğŸ“± å¾®ä¿¡æ”¶æ¬¾ç :', wechatQRCode ? 'å·²è®¾ç½®' : 'æœªè®¾ç½®');
            
            // ğŸ”§ å®¹é”™ç­–ç•¥ï¼šå…ˆå°è¯•ä¿å­˜å®Œæ•´ä¿¡æ¯ï¼Œå¤±è´¥åˆ™å›é€€åˆ°åŸºç¡€å­—æ®µ
            let insertError;
            
            // ç­–ç•¥1ï¼šå°è¯•ä¿å­˜åŒ…å«æ”¯ä»˜ä¿¡æ¯å’Œæç°æ–¹å¼çš„å®Œæ•´è®°å½•
            try {
                console.log('ğŸ”„ å°è¯•ä¿å­˜å®Œæ•´æç°è®°å½•ï¼ˆåŒ…å«æ”¯ä»˜ä¿¡æ¯ï¼‰...');
                const base = { user_id: userId, amount, status: 'pending', created_at: new Date().toISOString() };
                const payload = await WithdrawalMethodSync.buildInsertPayload(base);
                const { data, error } = await window.supabase
                    .from('withdrawals')
                    .insert([payload])
                    .select();
                    
                if (error) {
                    console.warn('âš ï¸ å®Œæ•´è®°å½•ä¿å­˜å¤±è´¥ï¼Œå¯èƒ½æ˜¯å­—æ®µä¸å­˜åœ¨:', error.message);
                    throw error; // è§¦å‘å›é€€ç­–ç•¥
                }
                
                console.log('âœ… å®Œæ•´æç°è®°å½•ä¿å­˜æˆåŠŸï¼');
                try { if (data && data[0]?.id) await WithdrawalMethodSync.ensureRecordHasMethod(data[0].id); } catch(_) {}
                
            } catch (fullInsertError) {
                console.log('ğŸ”„ å›é€€åˆ°åŸºç¡€å­—æ®µä¿å­˜ç­–ç•¥...');
                
                // ç­–ç•¥2ï¼šå›é€€åˆ°åªä¿å­˜åŸºç¡€å­—æ®µ
                try {
                    const { data, error } = await window.supabase
                        .from('withdrawals')
                        .insert([{
                            user_id: userId,
                            amount: amount,
                            status: 'pending',
                            created_at: new Date().toISOString()
                        }])
                        .select();
                        
                    if (error) {
                        throw new Error('åŸºç¡€æç°è®°å½•ä¿å­˜ä¹Ÿå¤±è´¥: ' + error.message);
                    }
                    
                    console.log('âœ… åŸºç¡€æç°è®°å½•ä¿å­˜æˆåŠŸï¼ˆæ”¯ä»˜ä¿¡æ¯å°†ä»ç”¨æˆ·è¡¨è·å–ï¼‰');
                    try { if (data && data[0]?.id) await WithdrawalMethodSync.ensureRecordHasMethod(data[0].id); } catch(_) {}
                    insertError = null;
                    
                } catch (basicInsertError) {
                    insertError = basicInsertError;
                    console.error('âŒ æ‰€æœ‰æç°è®°å½•ä¿å­˜ç­–ç•¥éƒ½å¤±è´¥äº†:', basicInsertError);
                }
            }
                
            if (insertError) {
                console.error('åˆ›å»ºæç°è®°å½•å¤±è´¥:', insertError);
            }
            
            // ğŸ”§ æ— è®ºå¦‚ä½•ï¼Œéƒ½ä¿å­˜æ”¯ä»˜æ–¹å¼ä¿¡æ¯åˆ°localStorageï¼ˆç”¨äºadminæ˜¾ç¤ºï¼‰
            try {
                const withdrawalPaymentInfo = {
                    // ä½¿ç”¨æ—¶é—´æˆ³ä½œä¸ºä¸´æ—¶IDï¼Œå› ä¸ºæˆ‘ä»¬æ— æ³•è·å–å®é™…çš„withdrawal ID
                    withdrawalId: 'fallback_' + Date.now(),
                    paymentMethod: paymentMethod,
                    alipayAccount: alipayAccount,
                    realName: realName,
                    wechatQRCode: wechatQRCode,
                    timestamp: new Date().toISOString()
                };
                
                localStorage.setItem('lastWithdrawalPaymentInfo', JSON.stringify(withdrawalPaymentInfo));
                
                const withdrawalHistory = JSON.parse(localStorage.getItem('withdrawalPaymentHistory') || '[]');
                withdrawalHistory.push(withdrawalPaymentInfo);
                if (withdrawalHistory.length > 50) {
                    withdrawalHistory.splice(0, withdrawalHistory.length - 50);
                }
                localStorage.setItem('withdrawalPaymentHistory', JSON.stringify(withdrawalHistory));
                
                console.log('âœ… æ”¯ä»˜æ–¹å¼ä¿¡æ¯å·²ä¿å­˜åˆ°localStorage (fallback):', withdrawalPaymentInfo);
            } catch (e) {
                console.warn('ä¿å­˜æ”¯ä»˜ä¿¡æ¯åˆ°localStorageå¤±è´¥:', e);
            }
            
            // 4. æ›´æ–°å¯æç°é‡‘é¢
            withdrawableAmount -= amount;
            
            // 5. æ›´æ–°ç•Œé¢æ˜¾ç¤º
            document.getElementById('withdrawable-amount').textContent = withdrawableAmount.toFixed(2);
            document.getElementById('withdraw-amount').value = '';
            document.getElementById('submit-withdrawal-btn').setAttribute('data-disabled', 'true');
            
            // æ˜¾ç¤ºæˆåŠŸæç¤º
            WithdrawalStatus.success('æç°æˆåŠŸï¼Œç­‰å¾…å®¡æ ¸æ‰“æ¬¾');
            showToast('æç°ç”³è¯·å·²æäº¤ï¼Œå°†åœ¨1-3ä¸ªå·¥ä½œæ—¥å†…åˆ°è´¦', 'success');
            
            // 2ç§’åè¿”å›ä¸Šä¸€é¡µ
            setTimeout(() => {
                history.back();
            }, 2000);
        }
        
        // æ˜¾ç¤ºåŠ è½½æŒ‡ç¤ºå™¨
        function showLoading() {
            const loading = document.getElementById('loadingIndicator');
            if (loading) {
                loading.style.display = 'flex';
            }
        }
        
        // éšè—åŠ è½½æŒ‡ç¤ºå™¨
        function hideLoading() {
            const loading = document.getElementById('loadingIndicator');
            if (loading) {
                loading.style.display = 'none';
            }
        }
        
        // ğŸš¨ å¼ºåˆ¶ä¿®å¤ï¼šToastæ˜¾ç¤ºå‡½æ•° - å¼ºåˆ¶åº•éƒ¨æ˜¾ç¤º
        function showToast(message, type = 'info') {
            console.log('ğŸš¨ showToastè¢«è°ƒç”¨:', message, type);
            
            const toast = document.getElementById('toastMessage');
            const toastContainer = document.querySelector('.toast-container');
            
            if (!toast || !toastContainer) {
                console.error('âŒ Toastå…ƒç´ ä¸å­˜åœ¨ï¼Œä½¿ç”¨alertå¤‡ç”¨');
                alert('âš ï¸ ' + message);
                return;
            }
            
            // ğŸš¨ å¼ºåˆ¶è®¾ç½®Toastå®¹å™¨ä½ç½®åˆ°åº•éƒ¨
            console.log('ğŸ”§ å¼ºåˆ¶è®¾ç½®Toastå®¹å™¨åˆ°åº•éƒ¨ä½ç½®');
            toastContainer.style.position = 'fixed';
            toastContainer.style.top = 'auto';
            toastContainer.style.bottom = '120px';
            toastContainer.style.left = '50%';
            toastContainer.style.transform = 'translateX(-50%)';
            toastContainer.style.width = '90%';
            toastContainer.style.maxWidth = '350px';
            toastContainer.style.zIndex = '99999';
            
            // ğŸš¨ å¼ºåˆ¶è®¾ç½®Toastæ¶ˆæ¯æ ·å¼
            toast.style.padding = '16px 20px';
            toast.style.borderRadius = '12px';
            toast.style.fontSize = '16px';
            toast.style.fontWeight = '500';
            toast.style.boxShadow = '0 8px 24px rgba(0,0,0,0.4)';
            toast.style.width = '100%';
            toast.style.textAlign = 'center';
            toast.style.margin = '0';
            toast.style.minWidth = 'auto';
            
            // æ¸…é™¤ä¹‹å‰çš„æ˜¾ç¤ºçŠ¶æ€
            toast.classList.remove('show');
            
            // è®¾ç½®é¢œè‰²æ ·å¼
            if (type === 'success') {
                toast.style.backgroundColor = '#10b981';
            } else if (type === 'error') {
                toast.style.backgroundColor = '#ef4444';
            } else if (type === 'warning') {
                toast.style.backgroundColor = '#f59e0b';
            } else {
                toast.style.backgroundColor = 'rgba(0,0,0,0.8)';
            }
            
            // è®¾ç½®æ¶ˆæ¯å†…å®¹
            toast.textContent = message;
            
            // ç«‹å³æ˜¾ç¤ºToast
            setTimeout(() => {
                toast.classList.add('show');
                console.log('âœ… Toastå·²å¼ºåˆ¶æ˜¾ç¤ºåœ¨åº•éƒ¨:', message);
                
                // éªŒè¯ä½ç½®
                const computedStyle = window.getComputedStyle(toastContainer);
                console.log('ğŸ” Toastä½ç½®éªŒè¯:', {
                    position: computedStyle.position,
                    top: computedStyle.top,
                    bottom: computedStyle.bottom,
                    left: computedStyle.left,
                    width: computedStyle.width
                });
            }, 10);
            
            // 3ç§’åè‡ªåŠ¨éšè—
            setTimeout(() => {
                toast.classList.remove('show');
                console.log('ğŸ”„ Toastå·²éšè—');
            }, 3000);
        }
        
        // ğŸ‰ æ˜¾ç¤ºæˆåŠŸæ•ˆæœå¼¹çª—
        function showSuccessModal(title, message, onConfirm) {
            // åˆ›å»ºæˆåŠŸå¼¹çª—
            const overlay = document.createElement('div');
            overlay.className = 'success-overlay';
            
            overlay.innerHTML = `
                <div class="success-modal">
                    <div class="success-icon">
                        <i class="fas fa-check"></i>
                    </div>
                    <h3 class="success-title">${title}</h3>
                    <p class="success-message">${message}</p>
                    <button class="success-button" onclick="closeSuccessModal(this)">
                        <i class="fas fa-thumbs-up"></i> ç¡®å®š
                    </button>
                </div>
            `;
            
            // æ·»åŠ åˆ°é¡µé¢
            document.body.appendChild(overlay);
            
            // ç»‘å®šå…³é—­äº‹ä»¶
            overlay.addEventListener('click', function(e) {
                if (e.target === overlay) {
                    closeSuccessModal(overlay);
                }
            });
            
            // è‡ªåŠ¨å…³é—­ï¼ˆ3ç§’åï¼‰
            setTimeout(() => {
                if (document.body.contains(overlay)) {
                    closeSuccessModal(overlay);
                }
            }, 3000);
            
            // å­˜å‚¨å›è°ƒå‡½æ•°
            if (onConfirm) {
                overlay._onConfirm = onConfirm;
            }
        }
        
        // å…³é—­æˆåŠŸå¼¹çª—
        function closeSuccessModal(element) {
            const overlay = element.closest ? element.closest('.success-overlay') : element;
            
            if (overlay && overlay._onConfirm) {
                overlay._onConfirm();
            }
            
            if (overlay && overlay.parentNode) {
                overlay.style.opacity = '0';
                setTimeout(() => {
                    if (overlay.parentNode) {
                        overlay.parentNode.removeChild(overlay);
                    }
                }, 200);
            }
        }
        
        // ğŸ‰ æ·»åŠ æˆåŠŸæ ‡è¯†åˆ°ä¿¡æ¯æ˜¾ç¤ºåŒºåŸŸ
        function addSuccessBadge(targetElementId, text) {
            const targetElement = document.getElementById(targetElementId);
            if (targetElement) {
                // ç§»é™¤å·²å­˜åœ¨çš„æˆåŠŸæ ‡è¯†
                const existingBadge = targetElement.parentNode.querySelector('.success-badge');
                if (existingBadge) {
                    existingBadge.remove();
                }
                
                // åˆ›å»ºæ–°çš„æˆåŠŸæ ‡è¯†
                const badge = document.createElement('span');
                badge.className = 'success-badge';
                badge.innerHTML = `<i class="fas fa-check-circle"></i>${text}`;
                
                // æ·»åŠ åˆ°ç›®æ ‡å…ƒç´ åé¢
                targetElement.parentNode.appendChild(badge);
                
                // 5ç§’åè‡ªåŠ¨ç§»é™¤
                setTimeout(() => {
                    if (badge.parentNode) {
                        badge.style.opacity = '0';
                        setTimeout(() => {
                            if (badge.parentNode) {
                                badge.parentNode.removeChild(badge);
                            }
                        }, 300);
                    }
                }, 5000);
            }
        }
        
        // ğŸ‰ æ”¯ä»˜å®ä¿¡æ¯ä¿å­˜æˆåŠŸæ•ˆæœï¼ˆç®€åŒ–ç‰ˆï¼‰
        function showAlipaySuccessEffect(account, name) {
            // ç®€å•çš„æˆåŠŸæç¤º
            showToast('ä¿®æ”¹æˆåŠŸ', 'success');
            console.log('âœ… æ”¯ä»˜å®ä¿¡æ¯ä¿®æ”¹æˆåŠŸ');
        }
        
        // ğŸ‰ å¾®ä¿¡æ”¶æ¬¾ç ä¿å­˜æˆåŠŸæ•ˆæœï¼ˆç®€åŒ–ç‰ˆï¼‰
        function showWechatSuccessEffect() {
            // ç®€å•çš„æˆåŠŸæç¤º
            showToast('æ·»åŠ æˆåŠŸ', 'success');
            console.log('âœ… å¾®ä¿¡æ”¶æ¬¾ç æ·»åŠ æˆåŠŸ');
        }

        // =====================
        // å¾®ä¿¡æ”¶æ¬¾ç ä¸Šä¼ çŠ¶æ€ç®¡ç†
        // =====================
        const WechatUploadStatus = (() => {
            const states = { idle: 'idle', uploading: 'uploading', success: 'success', failed: 'failed' };
            let currentState = states.idle;
            const textMap = {
                idle: 'å¾…ä¸Šä¼ ',
                uploading: 'ä¸Šä¼ ä¸­...',
                success: 'ä¸Šä¼ æˆåŠŸ',
                failed: 'ä¸Šä¼ å¤±è´¥'
            };
            function set(state, progress) {
                const box = document.getElementById('wechat-upload-status');
                const bar = document.getElementById('wechat-upload-bar');
                const label = document.getElementById('wechat-upload-text');
                if (!box || !bar || !label) return;
                currentState = state;
                box.classList.remove('hidden');
                label.textContent = textMap[state] || '';
                if (state === states.uploading) {
                    bar.style.width = Math.max(5, Math.min(progress || 10, 95)) + '%';
                } else if (state === states.success) {
                    bar.style.width = '100%';
                } else if (state === states.failed) {
                    bar.style.width = '0%';
                } else {
                    bar.style.width = '0%';
                }
                // æ ¹æ®çŠ¶æ€æ›´æ–°æäº¤æŒ‰é’®å¯ç”¨æ€§ï¼ˆä»…å½“é€‰æ‹©äº†å¾®ä¿¡æç°æ—¶ï¼‰
                try { updateSubmitAvailabilityForWeChat(); } catch(_) {}
            }
            return {
                idle: () => set(states.idle, 0),
                uploading: (p) => set(states.uploading, p),
                success: () => set(states.success, 100),
                failed: () => set(states.failed, 0),
                getState: () => currentState,
                states
            };
        })();

        // æ ¹æ®å¾®ä¿¡ä¸Šä¼ çŠ¶æ€ä¸é‡‘é¢æœ‰æ•ˆæ€§æ§åˆ¶æäº¤æŒ‰é’®
        function updateSubmitAvailabilityForWeChat() {
            const wechatSelected = document.getElementById('wechat-option')?.classList.contains('active');
            if (!wechatSelected) return;
            const submitBtn = document.getElementById('submit-withdrawal-btn');
            if (!submitBtn) return;
            const amountInput = document.getElementById('withdraw-amount');
            const value = parseFloat(amountInput?.value || '0');
            const amountOk = !isNaN(value) && value >= 10 && value <= withdrawableAmount;
            const qr = currentUser?.wechat_qr_code || currentUser?.['å¾®ä¿¡æ”¶æ¬¾ç '];
            const state = WechatUploadStatus.getState();
            if (!qr || state !== WechatUploadStatus.states.success || !amountOk) {
                submitBtn.setAttribute('data-disabled', 'true');
            } else {
                submitBtn.removeAttribute('data-disabled');
            }
        }
    </script>
    
    <!-- ğŸ”§ æ”¯ä»˜å®ä¿¡æ¯æ˜¾ç¤ºä¿®å¤è„šæœ¬ï¼ˆæœ¬åœ°ç‰ˆï¼Œä¸ä¾èµ–APIï¼‰ -->
    <script src="fix-alipay-display-local.js"></script>
</body>
</html>