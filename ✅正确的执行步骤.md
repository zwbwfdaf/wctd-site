# âœ… æ­£ç¡®çš„æ‰§è¡Œæ­¥éª¤ - å¤åˆ¶ç²˜è´´å³å¯

## ğŸ¯ æ‚¨é‡åˆ°çš„é”™è¯¯

```
é”™è¯¯: 22P02: ç±»å‹uuidçš„è¾“å…¥è¯­æ³•æ— æ•ˆ: "ä½ çš„user_id"
```

**åŸå› **ï¼šæ‚¨ç›´æ¥å¤åˆ¶äº† `'ä½ çš„user_id'`ï¼Œä½†è¿™ä¸æ˜¯çœŸå®çš„UUIDï¼Œéœ€è¦æ›¿æ¢ï¼

---

## âš¡ è¶…çº§ç®€å•çš„è§£å†³æ–¹æ³•

### æ–¹æ³•1ï¼šè‡ªåŠ¨æ·»åŠ ï¼ˆæœ€ç®€å•ï¼ï¼‰â­â­â­

**ç›´æ¥å¤åˆ¶ä¸‹é¢çš„SQLï¼Œç²˜è´´æ‰§è¡Œå³å¯**ï¼š

```sql
-- è‡ªåŠ¨ä¸ºå½“å‰ç™»å½•ç”¨æˆ·åˆ›å»ºå›¢é•¿
INSERT INTO leaders (user_id, level, invite_code, level1_members, total_members)
SELECT 
  auth.uid(),  -- è‡ªåŠ¨è·å–å½“å‰ç”¨æˆ·ID
  'gold',
  'TEST' || floor(random() * 1000)::text,  -- è‡ªåŠ¨ç”Ÿæˆé‚€è¯·ç 
  5,
  15
WHERE NOT EXISTS (
  SELECT 1 FROM leaders WHERE user_id = auth.uid()
);
```

**è¯´æ˜**ï¼š
- `auth.uid()` ä¼šè‡ªåŠ¨è·å–ä½ å½“å‰ç™»å½•çš„ç”¨æˆ·ID
- ä¸éœ€è¦æ‰‹åŠ¨æ›¿æ¢ä»»ä½•ä¸œè¥¿
- ç›´æ¥å¤åˆ¶ç²˜è´´æ‰§è¡Œå³å¯ï¼

---

### æ–¹æ³•2ï¼šæ‰‹åŠ¨æŸ¥è¯¢å†æ·»åŠ ï¼ˆç¨å¤æ‚ï¼‰â­â­

#### ç¬¬1æ­¥ï¼šæŸ¥è¯¢ä½ çš„ç”¨æˆ·ID

```sql
SELECT id, email FROM auth.users;
```

**æ‰§è¡Œç»“æœç¤ºä¾‹**ï¼š
```
id: 3dc76d22-4741-4c99-8c2d-b54a3d15fe5
email: zwq200394@qq.com
```

**å¤åˆ¶é‚£ä¸ªID**ï¼ˆé¼ æ ‡é€‰ä¸­â†’å³é”®å¤åˆ¶ï¼‰

#### ç¬¬2æ­¥ï¼šæ·»åŠ å›¢é•¿ï¼ˆæ›¿æ¢IDï¼‰

```sql
INSERT INTO leaders (user_id, level, invite_code, level1_members, total_members)
VALUES (
  '3dc76d22-4741-4c99-8c2d-b54a3d15fe5',  -- ç²˜è´´ä½ å¤åˆ¶çš„ID
  'gold',
  'ABC123',
  5,
  15
);
```

**æ³¨æ„**ï¼š
- âš ï¸ å¿…é¡»ç”¨**å•å¼•å·**åŒ…è£¹UUID
- âš ï¸ ç¡®ä¿æ˜¯å®Œæ•´çš„UUIDï¼ˆ36ä¸ªå­—ç¬¦ï¼ŒåŒ…å«è¿å­—ç¬¦ï¼‰
- âš ï¸ é‚€è¯·ç è¦å”¯ä¸€ï¼ˆå¦‚æœé‡å¤ä¼šæŠ¥é”™ï¼‰

---

### æ–¹æ³•3ï¼šä½¿ç”¨ä½ çš„é‚®ç®±è‡ªåŠ¨æŸ¥æ‰¾ï¼ˆæ¨èï¼ï¼‰â­â­â­

```sql
-- ç”¨é‚®ç®±è‡ªåŠ¨æŸ¥æ‰¾å¹¶æ·»åŠ 
INSERT INTO leaders (user_id, level, invite_code, level1_members, total_members)
SELECT 
  id,
  'gold',
  'EMAIL' || floor(random() * 1000)::text,
  5,
  15
FROM auth.users
WHERE email = 'zwq200394@qq.com'  -- âš ï¸ æ”¹æˆä½ çš„é‚®ç®±
LIMIT 1;
```

**ä¼˜ç‚¹**ï¼š
- ä¸éœ€è¦å¤åˆ¶ç²˜è´´UUID
- åªéœ€è¦è¾“å…¥ä½ çš„é‚®ç®±
- è‡ªåŠ¨ç”Ÿæˆå”¯ä¸€é‚€è¯·ç 

---

## ğŸ¯ æ¨èæ‰§è¡Œé¡ºåº

### ç¬¬1æ­¥ï¼šæ£€æŸ¥è¡¨æ˜¯å¦åˆ›å»ºæˆåŠŸ

```sql
-- æŸ¥çœ‹æ‰€æœ‰è¡¨
SELECT table_name FROM information_schema.tables 
WHERE table_schema = 'public' 
AND table_name LIKE 'leader%'
OR table_name = 'team_members';
```

**åº”è¯¥çœ‹åˆ°**ï¼š
- leaders
- team_members
- leader_commissions
- leader_levels

---

### ç¬¬2æ­¥ï¼šæ£€æŸ¥ç­‰çº§é…ç½®æ•°æ®

```sql
SELECT * FROM leader_levels ORDER BY required_members;
```

**åº”è¯¥çœ‹åˆ°5æ¡è®°å½•**ï¼š
```
bronze   | é’é“œå›¢é•¿ | 0   | 5.00
silver   | ç™½é“¶å›¢é•¿ | 10  | 8.00
gold     | é»„é‡‘å›¢é•¿ | 50  | 10.00
platinum | é“‚é‡‘å›¢é•¿ | 100 | 12.00
diamond  | é’»çŸ³å›¢é•¿ | 200 | 15.00
```

---

### ç¬¬3æ­¥ï¼šæ·»åŠ è‡ªå·±ä¸ºå›¢é•¿ï¼ˆç”¨æ–¹æ³•1ï¼‰

**å¤åˆ¶ä¸‹é¢çš„SQLï¼Œç›´æ¥æ‰§è¡Œ**ï¼š

```sql
INSERT INTO leaders (user_id, level, invite_code, level1_members, total_members)
SELECT 
  auth.uid(),
  'gold',
  'AUTO' || floor(random() * 10000)::text,
  5,
  15
WHERE NOT EXISTS (
  SELECT 1 FROM leaders WHERE user_id = auth.uid()
);
```

**å¦‚æœçœ‹åˆ° "INSERT 0 1" å°±æˆåŠŸäº†ï¼**

---

### ç¬¬4æ­¥ï¼šéªŒè¯æ˜¯å¦æ·»åŠ æˆåŠŸ

```sql
SELECT 
  id,
  user_id,
  level,
  invite_code,
  total_members,
  created_at
FROM leaders;
```

**åº”è¯¥èƒ½çœ‹åˆ°ä¸€æ¡ä½ çš„è®°å½•ï¼**

---

### ç¬¬5æ­¥ï¼šï¼ˆå¯é€‰ï¼‰æ·»åŠ ä¸€äº›æµ‹è¯•æˆå‘˜

```sql
-- æŸ¥çœ‹æ‰€æœ‰ç”¨æˆ·
SELECT id, email FROM auth.users;

-- å¦‚æœæœ‰å…¶ä»–ç”¨æˆ·ï¼Œå¯ä»¥æ·»åŠ ä¸ºå›¢é˜Ÿæˆå‘˜
-- æ›¿æ¢ä¸‹é¢çš„ä¸¤ä¸ªID
INSERT INTO team_members (leader_id, member_id, level, contribution)
SELECT 
  (SELECT id FROM leaders WHERE user_id = auth.uid()),  -- ä½ çš„å›¢é•¿ID
  'å…¶ä»–ç”¨æˆ·çš„user_id',  -- æ›¿æ¢æˆå…¶ä»–ç”¨æˆ·ID
  1,
  50.00;
```

---

### ç¬¬6æ­¥ï¼šï¼ˆå¯é€‰ï¼‰æ·»åŠ æµ‹è¯•ä½£é‡‘

```sql
-- æ·»åŠ æµ‹è¯•ä½£é‡‘è®°å½•
INSERT INTO leader_commissions (leader_id, type, amount, source_user_id, source_description)
SELECT 
  (SELECT id FROM leaders WHERE user_id = auth.uid()),
  'level1',
  50.00,
  auth.uid(),  -- æš‚æ—¶ç”¨è‡ªå·±çš„ID
  'æµ‹è¯•ä½£é‡‘è®°å½•'
;
```

---

## ğŸ” å¸¸è§é”™è¯¯å’Œè§£å†³

### é”™è¯¯1ï¼šUUIDæ ¼å¼æ— æ•ˆ

**é”™è¯¯æç¤º**ï¼š
```
ç±»å‹uuidçš„è¾“å…¥è¯­æ³•æ— æ•ˆ: "ä½ çš„user_id"
```

**åŸå› **ï¼šæ²¡æœ‰æ›¿æ¢æˆçœŸå®çš„UUID

**è§£å†³**ï¼šä½¿ç”¨æ–¹æ³•1çš„è‡ªåŠ¨SQLï¼ˆ`auth.uid()`ï¼‰

---

### é”™è¯¯2ï¼šé‚€è¯·ç é‡å¤

**é”™è¯¯æç¤º**ï¼š
```
duplicate key value violates unique constraint
```

**åŸå› **ï¼šé‚€è¯·ç å·²å­˜åœ¨

**è§£å†³**ï¼šæ›´æ¢é‚€è¯·ç ï¼Œæ¯”å¦‚æ”¹æˆ 'TEST456'

---

### é”™è¯¯3ï¼šç”¨æˆ·å·²æ˜¯å›¢é•¿

**æç¤º**ï¼š
```
INSERT 0 0
```

**åŸå› **ï¼šè¯¥ç”¨æˆ·å·²ç»åœ¨leadersè¡¨ä¸­äº†

**è§£å†³**ï¼š
```sql
-- åˆ é™¤æ—§è®°å½•
DELETE FROM leaders WHERE user_id = auth.uid();

-- ç„¶åé‡æ–°æ·»åŠ 
```

---

## ğŸŠ æœ€ç®€å•çš„å®Œæ•´æµç¨‹

### ç›´æ¥å¤åˆ¶ä¸‹é¢çš„SQLï¼Œä¸€æ¬¡æ€§æ‰§è¡Œï¼š

```sql
-- ============================================
-- ä¸€é”®é…ç½®ï¼šè‡ªåŠ¨åˆ›å»ºå›¢é•¿å’Œæµ‹è¯•æ•°æ®
-- ============================================

-- 1. ä¸ºå½“å‰ç”¨æˆ·åˆ›å»ºå›¢é•¿
INSERT INTO leaders (user_id, level, invite_code, level1_members, total_members)
SELECT 
  auth.uid(),
  'gold',
  'R8da6a3N',  -- ä½ åœ¨æˆªå›¾ä¸­çœ‹åˆ°çš„é‚€è¯·ç 
  2,  -- ä½ çœ‹åˆ°çš„æˆå‘˜æ•°
  2
WHERE NOT EXISTS (SELECT 1 FROM leaders WHERE user_id = auth.uid())
RETURNING id, user_id, level, invite_code;

-- 2. æ·»åŠ ä¸€ä¸ªæµ‹è¯•ä½£é‡‘è®°å½•
INSERT INTO leader_commissions (leader_id, type, amount, source_user_id, source_description)
SELECT 
  id,
  'level1',
  50.00,
  user_id,
  'æµ‹è¯•ä½£é‡‘ - æ¥è‡ªç³»ç»Ÿ'
FROM leaders
WHERE user_id = auth.uid();

-- 3. éªŒè¯æ•°æ®
SELECT 
  'å›¢é•¿ä¿¡æ¯' as è¡¨å, 
  (SELECT COUNT(*) FROM leaders WHERE user_id = auth.uid()) as è®°å½•æ•°
UNION ALL
SELECT 'ä½£é‡‘è®°å½•', 
  (SELECT COUNT(*) FROM leader_commissions WHERE leader_id IN (SELECT id FROM leaders WHERE user_id = auth.uid()));

-- å®Œæˆï¼
```

**è¯´æ˜**ï¼š
- âœ… ä½¿ç”¨ `auth.uid()` è‡ªåŠ¨è·å–å½“å‰ç”¨æˆ·
- âœ… ä½¿ç”¨ä½ æˆªå›¾ä¸­çš„é‚€è¯·ç  `R8da6a3N`
- âœ… è®¾ç½®å›¢é˜Ÿäººæ•°ä¸º2ï¼ˆå’Œä½ æˆªå›¾ä¸€è‡´ï¼‰
- âœ… è‡ªåŠ¨æ·»åŠ æµ‹è¯•ä½£é‡‘

---

## âœ… æ‰§è¡ŒæˆåŠŸçš„æ ‡å¿—

æ‰§è¡Œååº”è¯¥çœ‹åˆ°ï¼š

```
è¡¨å      | è®°å½•æ•°
---------|-------
å›¢é•¿ä¿¡æ¯  | 1
ä½£é‡‘è®°å½•  | 1
```

è¯´æ˜å·²æˆåŠŸæ·»åŠ ï¼

---

## ğŸ“ éªŒè¯æŸ¥è¯¢

```sql
-- æŸ¥çœ‹ä½ çš„å›¢é•¿ä¿¡æ¯
SELECT * FROM leaders WHERE user_id = auth.uid();

-- æŸ¥çœ‹ä½ çš„ä½£é‡‘è®°å½•
SELECT * FROM leader_commissions 
WHERE leader_id = (SELECT id FROM leaders WHERE user_id = auth.uid());

-- æŸ¥çœ‹ç­‰çº§é…ç½®
SELECT * FROM leader_levels ORDER BY required_members;
```

---

## ğŸ¯ ä¸‹ä¸€æ­¥

æ•°æ®åº“é…ç½®å®Œæˆåï¼š

1. âœ… ä¿®æ”¹ `leader-database-connector.js` ä¸­çš„é…ç½®
2. âœ… åœ¨HTMLé¡µé¢ä¸­å¼•å…¥è„šæœ¬
3. âœ… åˆ·æ–°é¡µé¢æŸ¥çœ‹çœŸå®æ•°æ®

**è¯¦ç»†æ­¥éª¤** â†’ æŸ¥çœ‹ `â­å¿«é€Ÿé…ç½®æŒ‡å—-å¿…è¯».md`

---

**ç°åœ¨ç«‹å³æ‰§è¡Œä¸Šé¢çš„"ä¸€é”®é…ç½®"SQLï¼** ğŸš€

